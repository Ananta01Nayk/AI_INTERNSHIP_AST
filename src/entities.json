{
  "functions": {
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::setUp": {
      "name": "setUp",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef setUp(self):\n\t\tfrom erpnext.stock.doctype.stock_ledger_entry.test_stock_ledger_entry import create_items\n\n\t\tcreate_items([\"_Test Internal Transfer Item\"], uoms=[{\"uom\": \"Box\", \"conversion_factor\": 10}])\n\t\tcreate_internal_parties()\n\t\tsetup_accounts()\n\t\tmode_of_payment = frappe.get_doc(\"Mode of Payment\", \"Bank Draft\")\n\t\tset_default_account_for_mode_of_payment(mode_of_payment, \"_Test Company\", \"_Test Bank - _TC\")\n\t\tset_default_account_for_mode_of_payment(\n\t\t\tmode_of_payment, \"_Test Company with perpetual inventory\", \"_Test Bank - TCP1\"\n\t\t)\n\t\tfor company in frappe.get_all(\"Company\", pluck=\"name\"):\n\t\t\tfrappe.db.set_value(\"Company\", company, \"accounts_frozen_till_date\", None)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_invalid_rate_without_override": {
      "name": "test_invalid_rate_without_override",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_invalid_rate_without_override(self):\n\t\tfrom frappe import ValidationError\n\n\t\tfrom erpnext.accounts.doctype.sales_invoice.sales_invoice import make_inter_company_purchase_invoice\n\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=\"_Test Internal Customer 3\", company=\"_Test Company\", is_internal_customer=1, rate=100\n\t\t)\n\t\tpi = make_inter_company_purchase_invoice(si.name)\n\t\tpi.items[0].rate = 120\n\n\t\twith self.assertRaises(ValidationError) as e:\n\t\t\tpi.insert()\n\t\t\tpi.submit()\n\t\tself.assertIn(\"Rate must be same\", str(e.exception))"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::tearDown": {
      "name": "tearDown",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef tearDown(self):\n\t\tfrappe.db.rollback()"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::make": {
      "name": "make",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef make(self):\n\t\tw = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tw.is_pos = 0\n\t\tw.insert()\n\t\tw.submit()\n\t\treturn w"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::setUpClass": {
      "name": "setUpClass",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef setUpClass(cls):\n\t\tsuper().setUpClass()\n\t\tcls.enterClassContext(cls.change_settings(\"Selling Settings\", validate_selling_price=0))\n\t\tcls.make_employees()\n\t\tcls.make_sales_person()\n\t\tunlink_payment_on_cancel_of_invoice()"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::tearDownClass": {
      "name": "tearDownClass",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef tearDownClass(self):\n\t\tunlink_payment_on_cancel_of_invoice(0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_qty": {
      "name": "test_sales_invoice_qty",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_qty(self):\n\t\tsi = create_sales_invoice(qty=0, do_not_save=True)\n\t\twith self.assertRaises(InvalidQtyError):\n\t\t\tsi.save()\n\n\t\t# No error with qty=1\n\t\tsi.items[0].qty = 1\n\t\tsi.save()\n\t\tself.assertEqual(si.items[0].qty, 1)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_timestamp_change": {
      "name": "test_timestamp_change",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_timestamp_change(self):\n\t\tw = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tw.docstatus = 0\n\t\tw.insert()\n\n\t\tw2 = frappe.get_doc(w.doctype, w.name)\n\n\t\timport time\n\n\t\ttime.sleep(1)\n\t\tw.save()\n\n\t\timport time\n\n\t\ttime.sleep(1)\n\t\tself.assertRaises(frappe.TimestampMismatchError, w2.save)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_change_naming_series": {
      "name": "test_sales_invoice_change_naming_series",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_change_naming_series(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\t\tsi.insert()\n\t\tsi.naming_series = \"TEST-\"\n\n\t\tself.assertRaises(frappe.CannotChangeConstantError, si.save)\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][1])\n\t\tsi.insert()\n\t\tsi.naming_series = \"TEST-\"\n\n\t\tself.assertRaises(frappe.CannotChangeConstantError, si.save)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_add_terms_after_save": {
      "name": "test_add_terms_after_save",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_add_terms_after_save(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\t\tsi.insert()\n\n\t\tself.assertTrue(si.payment_schedule)\n\t\tself.assertEqual(getdate(si.payment_schedule[0].due_date), getdate(si.due_date))"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_calculation_base_currency": {
      "name": "test_sales_invoice_calculation_base_currency",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_calculation_base_currency(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\t\tsi.insert()\n\n\t\texpected_values = {\n\t\t\t\"keys\": [\n\t\t\t\t\"price_list_rate\",\n\t\t\t\t\"discount_percentage\",\n\t\t\t\t\"rate\",\n\t\t\t\t\"amount\",\n\t\t\t\t\"base_price_list_rate\",\n\t\t\t\t\"base_rate\",\n\t\t\t\t\"base_amount\",\n\t\t\t],\n\t\t\t\"_Test Item Home Desktop 100\": [50, 0, 50, 500, 50, 50, 500],\n\t\t\t\"_Test Item Home Desktop 200\": [150, 0, 150, 750, 150, 150, 750],\n\t\t}\n\n\t\t# check if children are saved\n\t\tself.assertEqual(len(si.get(\"items\")), len(expected_values) - 1)\n\n\t\t# check if item values are calculated\n\t\tfor d in si.get(\"items\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.item_code][i])\n\n\t\t# check net total\n\t\tself.assertEqual(si.base_net_total, 1250)\n\t\tself.assertEqual(si.net_total, 1250)\n\n\t\t# check tax calculation\n\t\texpected_values = {\n\t\t\t\"keys\": [\"tax_amount\", \"total\"],\n\t\t\t\"_Test Account Shipping Charges - _TC\": [100, 1350],\n\t\t\t\"_Test Account Customs Duty - _TC\": [125, 1475],\n\t\t\t\"_Test Account Excise Duty - _TC\": [140, 1615],\n\t\t\t\"_Test Account Education Cess - _TC\": [2.8, 1617.8],\n\t\t\t\"_Test Account S&H Education Cess - _TC\": [1.4, 1619.2],\n\t\t\t\"_Test Account CST - _TC\": [32.38, 1651.58],\n\t\t\t\"_Test Account VAT - _TC\": [156.25, 1807.83],\n\t\t\t\"_Test Account Discount - _TC\": [-180.78, 1627.05],\n\t\t}\n\n\t\tfor d in si.get(\"taxes\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.account_head][i])\n\n\t\tself.assertEqual(si.base_grand_total, 1627.05)\n\t\tself.assertEqual(si.grand_total, 1627.05)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_payment_entry_unlink_against_invoice": {
      "name": "test_payment_entry_unlink_against_invoice",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_payment_entry_unlink_against_invoice(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import get_payment_entry\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.is_pos = 0\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tpe = get_payment_entry(\"Sales Invoice\", si.name, bank_account=\"_Test Bank - _TC\")\n\t\tpe.reference_no = \"1\"\n\t\tpe.reference_date = nowdate()\n\t\tpe.paid_from_account_currency = si.currency\n\t\tpe.paid_to_account_currency = si.currency\n\t\tpe.source_exchange_rate = 1\n\t\tpe.target_exchange_rate = 1\n\t\tpe.paid_amount = si.outstanding_amount\n\t\tpe.insert()\n\t\tpe.submit()\n\n\t\tunlink_payment_on_cancel_of_invoice(0)\n\t\tsi = frappe.get_doc(\"Sales Invoice\", si.name)\n\t\tself.assertRaises(frappe.LinkExistsError, si.cancel)\n\t\tunlink_payment_on_cancel_of_invoice()"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_payment_entry_unlink_against_standalone_credit_note": {
      "name": "test_payment_entry_unlink_against_standalone_credit_note",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_payment_entry_unlink_against_standalone_credit_note(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import get_payment_entry\n\n\t\tsi1 = create_sales_invoice(rate=1000)\n\t\tsi2 = create_sales_invoice(rate=300)\n\t\tsi3 = create_sales_invoice(qty=-1, rate=300, is_return=1)\n\n\t\tpe = get_payment_entry(\"Sales Invoice\", si1.name, bank_account=\"_Test Bank - _TC\")\n\t\tpe.append(\n\t\t\t\"references\",\n\t\t\t{\n\t\t\t\t\"reference_doctype\": \"Sales Invoice\",\n\t\t\t\t\"reference_name\": si2.name,\n\t\t\t\t\"total_amount\": si2.grand_total,\n\t\t\t\t\"outstanding_amount\": si2.outstanding_amount,\n\t\t\t\t\"allocated_amount\": si2.outstanding_amount,\n\t\t\t},\n\t\t)\n\n\t\tpe.append(\n\t\t\t\"references\",\n\t\t\t{\n\t\t\t\t\"reference_doctype\": \"Sales Invoice\",\n\t\t\t\t\"reference_name\": si3.name,\n\t\t\t\t\"total_amount\": si3.grand_total,\n\t\t\t\t\"outstanding_amount\": si3.outstanding_amount,\n\t\t\t\t\"allocated_amount\": si3.outstanding_amount,\n\t\t\t},\n\t\t)\n\n\t\tpe.reference_no = \"Test001\"\n\t\tpe.reference_date = nowdate()\n\t\tpe.save()\n\t\tpe.submit()\n\n\t\tsi2.load_from_db()\n\t\tsi2.cancel()\n\n\t\tsi1.load_from_db()\n\t\tself.assertRaises(PaymentEntryUnlinkError, si1.cancel)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_calculation_export_currency": {
      "name": "test_sales_invoice_calculation_export_currency",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_calculation_export_currency(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\t\tsi.currency = \"USD\"\n\t\tsi.conversion_rate = 50\n\t\tsi.get(\"items\")[0].rate = 1\n\t\tsi.get(\"items\")[0].price_list_rate = 1\n\t\tsi.get(\"items\")[1].rate = 3\n\t\tsi.get(\"items\")[1].price_list_rate = 3\n\n\t\t# change shipping to $2\n\t\tsi.get(\"taxes\")[0].tax_amount = 2\n\t\tsi.insert()\n\n\t\texpected_values = {\n\t\t\t\"keys\": [\n\t\t\t\t\"price_list_rate\",\n\t\t\t\t\"discount_percentage\",\n\t\t\t\t\"rate\",\n\t\t\t\t\"amount\",\n\t\t\t\t\"base_price_list_rate\",\n\t\t\t\t\"base_rate\",\n\t\t\t\t\"base_amount\",\n\t\t\t],\n\t\t\t\"_Test Item Home Desktop 100\": [1, 0, 1, 10, 50, 50, 500],\n\t\t\t\"_Test Item Home Desktop 200\": [3, 0, 3, 15, 150, 150, 750],\n\t\t}\n\n\t\t# check if children are saved\n\t\tself.assertEqual(len(si.get(\"items\")), len(expected_values) - 1)\n\n\t\t# check if item values are calculated\n\t\tfor d in si.get(\"items\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.item_code][i])\n\n\t\t# check net total\n\t\tself.assertEqual(si.total, 25)\n\t\tself.assertEqual(si.base_total, 1250)\n\t\tself.assertEqual(si.net_total, 25)\n\t\tself.assertEqual(si.base_net_total, 1250)\n\n\t\t# check tax calculation\n\t\texpected_values = {\n\t\t\t\"keys\": [\"base_tax_amount\", \"base_total\", \"tax_amount\", \"total\"],\n\t\t\t\"_Test Account Shipping Charges - _TC\": [100, 1350, 2, 27],\n\t\t\t\"_Test Account Customs Duty - _TC\": [125, 1475, 2.5, 29.5],\n\t\t\t\"_Test Account Excise Duty - _TC\": [140, 1615, 2.8, 32.3],\n\t\t\t\"_Test Account Education Cess - _TC\": [3, 1618, 0.06, 32.36],\n\t\t\t\"_Test Account S&H Education Cess - _TC\": [1.5, 1619.5, 0.03, 32.39],\n\t\t\t\"_Test Account CST - _TC\": [32.5, 1652, 0.65, 33.04],\n\t\t\t\"_Test Account VAT - _TC\": [156.0, 1808.0, 3.12, 36.16],\n\t\t\t\"_Test Account Discount - _TC\": [-181.0, 1627.0, -3.62, 32.54],\n\t\t}\n\n\t\tfor d in si.get(\"taxes\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.account_head][i])\n\n\t\tself.assertEqual(si.base_grand_total, 1627.0)\n\t\tself.assertEqual(si.grand_total, 32.54)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_with_discount_and_inclusive_tax": {
      "name": "test_sales_invoice_with_discount_and_inclusive_tax",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_with_discount_and_inclusive_tax(self):\n\t\tsi = create_sales_invoice(qty=100, rate=50, do_not_save=True)\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"account_head\": \"_Test Account Service Tax - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"Service Tax\",\n\t\t\t\t\"rate\": 14,\n\t\t\t\t\"included_in_print_rate\": 1,\n\t\t\t},\n\t\t)\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"On Item Quantity\",\n\t\t\t\t\"account_head\": \"_Test Account Education Cess - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"CESS\",\n\t\t\t\t\"rate\": 5,\n\t\t\t\t\"included_in_print_rate\": 1,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\n\t\t# with inclusive tax\n\t\tself.assertEqual(si.items[0].net_amount, 3947.37)\n\t\tself.assertEqual(si.net_total, si.base_net_total)\n\t\tself.assertEqual(si.net_total, 3947.37)\n\t\tself.assertEqual(si.grand_total, 5000)\n\n\t\tsi.reload()\n\n\t\t# additional discount\n\t\tsi.discount_amount = 100\n\t\tsi.apply_discount_on = \"Net Total\"\n\t\tsi.payment_schedule = []\n\n\t\tsi.save()\n\n\t\t# with inclusive tax and additional discount\n\t\tself.assertEqual(si.net_total, 3847.37)\n\t\tself.assertEqual(si.grand_total, 4886)\n\n\t\tsi.reload()\n\n\t\t# additional discount on grand total\n\t\tsi.discount_amount = 100\n\t\tsi.apply_discount_on = \"Grand Total\"\n\t\tsi.payment_schedule = []\n\n\t\tsi.save()\n\n\t\t# with inclusive tax and additional discount\n\t\tself.assertEqual(si.net_total, 3859.65)\n\t\tself.assertEqual(si.grand_total, 4900.00)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_discount_amount": {
      "name": "test_sales_invoice_discount_amount",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_discount_amount(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][3])\n\t\tsi.discount_amount = 104.94\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"On Previous Row Amount\",\n\t\t\t\t\"account_head\": \"_Test Account Service Tax - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"Service Tax\",\n\t\t\t\t\"rate\": 10,\n\t\t\t\t\"row_id\": 8,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\n\t\texpected_values = [\n\t\t\t{\n\t\t\t\t\"item_code\": \"_Test Item Home Desktop 100\",\n\t\t\t\t\"price_list_rate\": 62.5,\n\t\t\t\t\"discount_percentage\": 0,\n\t\t\t\t\"rate\": 62.5,\n\t\t\t\t\"amount\": 625,\n\t\t\t\t\"base_price_list_rate\": 62.5,\n\t\t\t\t\"base_rate\": 62.5,\n\t\t\t\t\"base_amount\": 625,\n\t\t\t\t\"net_rate\": 46.54,\n\t\t\t\t\"net_amount\": 465.37,\n\t\t\t\t\"base_net_rate\": 46.54,\n\t\t\t\t\"base_net_amount\": 465.37,\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"item_code\": \"_Test Item Home Desktop 200\",\n\t\t\t\t\"price_list_rate\": 190.66,\n\t\t\t\t\"discount_percentage\": 0,\n\t\t\t\t\"rate\": 190.66,\n\t\t\t\t\"amount\": 953.3,\n\t\t\t\t\"base_price_list_rate\": 190.66,\n\t\t\t\t\"base_rate\": 190.66,\n\t\t\t\t\"base_amount\": 953.3,\n\t\t\t\t\"net_rate\": 139.62,\n\t\t\t\t\"net_amount\": 698.08,\n\t\t\t\t\"base_net_rate\": 139.62,\n\t\t\t\t\"base_net_amount\": 698.08,\n\t\t\t},\n\t\t]\n\n\t\t# check if children are saved\n\t\tself.assertEqual(len(si.get(\"items\")), len(expected_values))\n\n\t\t# check if item values are calculated\n\t\tfor i, d in enumerate(si.get(\"items\")):\n\t\t\tfor k, v in expected_values[i].items():\n\t\t\t\tself.assertEqual(d.get(k), v)\n\n\t\t# check net total\n\t\tself.assertEqual(si.base_net_total, 1163.45)\n\t\tself.assertEqual(si.total, 1578.3)\n\n\t\t# check tax calculation\n\t\texpected_values = {\n\t\t\t\"keys\": [\"tax_amount\", \"tax_amount_after_discount_amount\", \"total\"],\n\t\t\t\"_Test Account Excise Duty - _TC\": [140, 130.31, 1293.76],\n\t\t\t\"_Test Account Education Cess - _TC\": [2.8, 2.61, 1296.37],\n\t\t\t\"_Test Account S&H Education Cess - _TC\": [1.4, 1.30, 1297.67],\n\t\t\t\"_Test Account CST - _TC\": [27.88, 25.95, 1323.62],\n\t\t\t\"_Test Account VAT - _TC\": [156.25, 145.43, 1469.05],\n\t\t\t\"_Test Account Customs Duty - _TC\": [125, 116.34, 1585.39],\n\t\t\t\"_Test Account Shipping Charges - _TC\": [100, 100, 1685.39],\n\t\t\t\"_Test Account Discount - _TC\": [-180.33, -168.54, 1516.85],\n\t\t\t\"_Test Account Service Tax - _TC\": [-18.03, -16.85, 1500.00],\n\t\t}\n\n\t\tfor d in si.get(\"taxes\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.account_head][i])\n\n\t\tself.assertEqual(si.base_grand_total, 1500)\n\t\tself.assertEqual(si.grand_total, 1500)\n\t\tself.assertEqual(si.rounding_adjustment, 0.0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_discount_amount_gl_entry": {
      "name": "test_discount_amount_gl_entry",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_discount_amount_gl_entry(self):\n\t\tfrappe.db.set_value(\"Company\", \"_Test Company\", \"round_off_account\", \"Round Off - _TC\")\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][3])\n\t\tsi.discount_amount = 104.94\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"doctype\": \"Sales Taxes and Charges\",\n\t\t\t\t\"charge_type\": \"On Previous Row Amount\",\n\t\t\t\t\"account_head\": \"_Test Account Service Tax - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"Service Tax\",\n\t\t\t\t\"rate\": 10,\n\t\t\t\t\"row_id\": 8,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, debit, credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tself.assertTrue(gl_entries)\n\n\t\texpected_values = dict(\n\t\t\t(d[0], d)\n\t\t\tfor d in [\n\t\t\t\t[si.debit_to, 1500, 0.0],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"items\"][0][\"income_account\"], 0.0, 1163.45],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][0][\"account_head\"], 0.0, 130.31],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][1][\"account_head\"], 0.0, 2.61],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][2][\"account_head\"], 0.0, 1.30],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][3][\"account_head\"], 0.0, 25.95],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][4][\"account_head\"], 0.0, 145.43],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][5][\"account_head\"], 0.0, 116.34],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][6][\"account_head\"], 0.0, 100],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][7][\"account_head\"], 168.54, 0.0],\n\t\t\t\t[\"_Test Account Service Tax - _TC\", 16.85, 0.0],\n\t\t\t\t[\"Round Off - _TC\", 0.01, 0.0],\n\t\t\t]\n\t\t)\n\n\t\tfor gle in gl_entries:\n\t\t\tself.assertEqual(expected_values[gle.account][0], gle.account)\n\t\t\tself.assertEqual(expected_values[gle.account][1], gle.debit)\n\t\t\tself.assertEqual(expected_values[gle.account][2], gle.credit)\n\n\t\t# cancel\n\t\tsi.cancel()\n\n\t\tgle = frappe.db.sql(\n\t\t\t\"\"\"select * from `tabGL Entry`\n\t\t\twhere voucher_type='Sales Invoice' and voucher_no=%s\"\"\",\n\t\t\tsi.name,\n\t\t)\n\n\t\tself.assertTrue(gle)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_tax_calculation_with_multiple_items": {
      "name": "test_tax_calculation_with_multiple_items",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_tax_calculation_with_multiple_items(self):\n\t\tsi = create_sales_invoice(qty=84, rate=4.6, do_not_save=True)\n\t\titem_row = si.get(\"items\")[0]\n\t\tfor qty in (54, 288, 144, 430):\n\t\t\titem_row_copy = copy.deepcopy(item_row)\n\t\t\titem_row_copy.qty = qty\n\t\t\tsi.append(\"items\", item_row_copy)\n\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"account_head\": \"_Test Account VAT - _TC\",\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"VAT\",\n\t\t\t\t\"doctype\": \"Sales Taxes and Charges\",\n\t\t\t\t\"rate\": 19,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\n\t\tself.assertEqual(si.net_total, 4600)\n\n\t\tself.assertEqual(si.get(\"taxes\")[0].tax_amount, 874.0)\n\t\tself.assertEqual(si.get(\"taxes\")[0].total, 5474.0)\n\n\t\tself.assertEqual(si.grand_total, 5474.0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_tax_calculation_with_item_tax_template": {
      "name": "test_tax_calculation_with_item_tax_template",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_tax_calculation_with_item_tax_template(self):\n\t\tsi = create_sales_invoice(qty=84, rate=4.6, do_not_save=True)\n\t\titem_row = si.get(\"items\")[0]\n\n\t\tadd_items = [\n\t\t\t(54, \"_Test Account Excise Duty @ 12 - _TC\"),\n\t\t\t(288, \"_Test Account Excise Duty @ 15 - _TC\"),\n\t\t\t(144, \"_Test Account Excise Duty @ 20 - _TC\"),\n\t\t\t(430, \"_Test Item Tax Template 1 - _TC\"),\n\t\t]\n\t\tfor qty, item_tax_template in add_items:\n\t\t\titem_row_copy = copy.deepcopy(item_row)\n\t\t\titem_row_copy.qty = qty\n\t\t\titem_row_copy.item_tax_template = item_tax_template\n\t\t\tsi.append(\"items\", item_row_copy)\n\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"account_head\": \"_Test Account Excise Duty - _TC\",\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"Excise Duty\",\n\t\t\t\t\"doctype\": \"Sales Taxes and Charges\",\n\t\t\t\t\"rate\": 11,\n\t\t\t},\n\t\t)\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"account_head\": \"_Test Account Education Cess - _TC\",\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"Education Cess\",\n\t\t\t\t\"doctype\": \"Sales Taxes and Charges\",\n\t\t\t\t\"rate\": 0,\n\t\t\t},\n\t\t)\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"account_head\": \"_Test Account S&H Education Cess - _TC\",\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"S&H Education Cess\",\n\t\t\t\t\"doctype\": \"Sales Taxes and Charges\",\n\t\t\t\t\"rate\": 3,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\n\t\tself.assertEqual(si.net_total, 4600)\n\n\t\tself.assertEqual(si.get(\"taxes\")[0].tax_amount, 502.41)\n\t\tself.assertEqual(si.get(\"taxes\")[0].total, 5102.41)\n\n\t\tself.assertEqual(si.get(\"taxes\")[1].tax_amount, 197.80)\n\t\tself.assertEqual(si.get(\"taxes\")[1].total, 5300.21)\n\n\t\tself.assertEqual(si.get(\"taxes\")[2].tax_amount, 375.36)\n\t\tself.assertEqual(si.get(\"taxes\")[2].total, 5675.57)\n\n\t\tself.assertEqual(si.grand_total, 5675.57)\n\t\tself.assertEqual(si.rounding_adjustment, 0.43)\n\t\tself.assertEqual(si.rounded_total, 5676.0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_tax_calculation_with_multiple_items_and_discount": {
      "name": "test_tax_calculation_with_multiple_items_and_discount",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_tax_calculation_with_multiple_items_and_discount(self):\n\t\tsi = create_sales_invoice(qty=1, rate=75, do_not_save=True)\n\t\titem_row = si.get(\"items\")[0]\n\t\tfor rate in (500, 200, 100, 50, 50):\n\t\t\titem_row_copy = copy.deepcopy(item_row)\n\t\t\titem_row_copy.price_list_rate = rate\n\t\t\titem_row_copy.rate = rate\n\t\t\tsi.append(\"items\", item_row_copy)\n\n\t\tsi.apply_discount_on = \"Net Total\"\n\t\tsi.discount_amount = 75.0\n\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"account_head\": \"_Test Account VAT - _TC\",\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"VAT\",\n\t\t\t\t\"doctype\": \"Sales Taxes and Charges\",\n\t\t\t\t\"rate\": 24,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\n\t\tself.assertEqual(si.total, 975)\n\t\tself.assertEqual(si.net_total, 900)\n\n\t\tself.assertEqual(si.get(\"taxes\")[0].tax_amount, 216.0)\n\t\tself.assertEqual(si.get(\"taxes\")[0].total, 1116.0)\n\n\t\tself.assertEqual(si.grand_total, 1116.0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_inclusive_rate_validations": {
      "name": "test_inclusive_rate_validations",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_inclusive_rate_validations(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\t\tfor i, tax in enumerate(si.get(\"taxes\")):\n\t\t\ttax.idx = i + 1\n\n\t\tsi.get(\"items\")[0].price_list_rate = 62.5\n\t\tsi.get(\"items\")[0].price_list_rate = 191\n\t\tfor i in range(6):\n\t\t\tsi.get(\"taxes\")[i].included_in_print_rate = 1\n\n\t\t# tax type \"Actual\" cannot be inclusive\n\t\tself.assertRaises(frappe.ValidationError, si.insert)\n\n\t\t# taxes above included type 'On Previous Row Total' should also be included\n\t\tsi.get(\"taxes\")[0].included_in_print_rate = 0\n\t\tself.assertRaises(frappe.ValidationError, si.insert)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_calculation_base_currency_with_tax_inclusive_price": {
      "name": "test_sales_invoice_calculation_base_currency_with_tax_inclusive_price",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_calculation_base_currency_with_tax_inclusive_price(self):\n\t\t# prepare\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][3])\n\t\tsi.insert()\n\n\t\texpected_values = {\n\t\t\t\"keys\": [\n\t\t\t\t\"price_list_rate\",\n\t\t\t\t\"discount_percentage\",\n\t\t\t\t\"rate\",\n\t\t\t\t\"amount\",\n\t\t\t\t\"base_price_list_rate\",\n\t\t\t\t\"base_rate\",\n\t\t\t\t\"base_amount\",\n\t\t\t\t\"net_rate\",\n\t\t\t\t\"net_amount\",\n\t\t\t],\n\t\t\t\"_Test Item Home Desktop 100\": [\n\t\t\t\t62.5,\n\t\t\t\t0,\n\t\t\t\t62.5,\n\t\t\t\t625.0,\n\t\t\t\t62.5,\n\t\t\t\t62.5,\n\t\t\t\t625.0,\n\t\t\t\t50,\n\t\t\t\t499.98,\n\t\t\t],\n\t\t\t\"_Test Item Home Desktop 200\": [\n\t\t\t\t190.66,\n\t\t\t\t0,\n\t\t\t\t190.66,\n\t\t\t\t953.3,\n\t\t\t\t190.66,\n\t\t\t\t190.66,\n\t\t\t\t953.3,\n\t\t\t\t150,\n\t\t\t\t750,\n\t\t\t],\n\t\t}\n\n\t\t# check if children are saved\n\t\tself.assertEqual(len(si.get(\"items\")), len(expected_values) - 1)\n\n\t\t# check if item values are calculated\n\t\tfor d in si.get(\"items\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.item_code][i])\n\n\t\t# check net total\n\t\tself.assertEqual(si.base_net_total, si.net_total)\n\t\tself.assertEqual(si.net_total, 1249.98)\n\t\tself.assertEqual(si.total, 1578.3)\n\n\t\t# check tax calculation\n\t\texpected_values = {\n\t\t\t\"keys\": [\"tax_amount\", \"total\"],\n\t\t\t\"_Test Account Excise Duty - _TC\": [140, 1389.98],\n\t\t\t\"_Test Account Education Cess - _TC\": [2.8, 1392.78],\n\t\t\t\"_Test Account S&H Education Cess - _TC\": [1.4, 1394.18],\n\t\t\t\"_Test Account CST - _TC\": [27.88, 1422.06],\n\t\t\t\"_Test Account VAT - _TC\": [156.25, 1578.31],\n\t\t\t\"_Test Account Customs Duty - _TC\": [125, 1703.31],\n\t\t\t\"_Test Account Shipping Charges - _TC\": [100, 1803.31],\n\t\t\t\"_Test Account Discount - _TC\": [-180.33, 1622.98],\n\t\t}\n\n\t\tfor d in si.get(\"taxes\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.account_head][i])\n\n\t\tself.assertEqual(si.base_grand_total, 1622.97)\n\t\tself.assertEqual(si.grand_total, 1622.97)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_calculation_export_currency_with_tax_inclusive_price": {
      "name": "test_sales_invoice_calculation_export_currency_with_tax_inclusive_price",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_calculation_export_currency_with_tax_inclusive_price(self):\n\t\t# prepare\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][3])\n\t\tsi.currency = \"USD\"\n\t\tsi.conversion_rate = 50\n\t\tsi.get(\"items\")[0].price_list_rate = 55.56\n\t\tsi.get(\"items\")[0].discount_percentage = 10\n\t\tsi.get(\"items\")[1].price_list_rate = 187.5\n\t\tsi.get(\"items\")[1].discount_percentage = 20\n\n\t\t# change shipping to $2\n\t\tsi.get(\"taxes\")[6].tax_amount = 2\n\n\t\tsi.insert()\n\n\t\texpected_values = [\n\t\t\t{\n\t\t\t\t\"item_code\": \"_Test Item Home Desktop 100\",\n\t\t\t\t\"price_list_rate\": 55.56,\n\t\t\t\t\"discount_percentage\": 10,\n\t\t\t\t\"rate\": 50,\n\t\t\t\t\"amount\": 500,\n\t\t\t\t\"base_price_list_rate\": 2778,\n\t\t\t\t\"base_rate\": 2500,\n\t\t\t\t\"base_amount\": 25000,\n\t\t\t\t\"net_rate\": 40,\n\t\t\t\t\"net_amount\": 399.98,\n\t\t\t\t\"base_net_rate\": 2000,\n\t\t\t\t\"base_net_amount\": 19999,\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"item_code\": \"_Test Item Home Desktop 200\",\n\t\t\t\t\"price_list_rate\": 187.5,\n\t\t\t\t\"discount_percentage\": 20,\n\t\t\t\t\"rate\": 150,\n\t\t\t\t\"amount\": 750,\n\t\t\t\t\"base_price_list_rate\": 9375,\n\t\t\t\t\"base_rate\": 7500,\n\t\t\t\t\"base_amount\": 37500,\n\t\t\t\t\"net_rate\": 118.01,\n\t\t\t\t\"net_amount\": 590.05,\n\t\t\t\t\"base_net_rate\": 5900.5,\n\t\t\t\t\"base_net_amount\": 29502.5,\n\t\t\t},\n\t\t]\n\n\t\t# check if children are saved\n\t\tself.assertEqual(len(si.get(\"items\")), len(expected_values))\n\n\t\t# check if item values are calculated\n\t\tfor i, d in enumerate(si.get(\"items\")):\n\t\t\tfor key, val in expected_values[i].items():\n\t\t\t\tself.assertEqual(d.get(key), val)\n\n\t\t# check net total\n\t\tself.assertEqual(si.base_net_total, 49501.5)\n\t\tself.assertEqual(si.net_total, 990.03)\n\t\tself.assertEqual(si.total, 1250)\n\n\t\t# check tax calculation\n\t\texpected_values = {\n\t\t\t\"keys\": [\"base_tax_amount\", \"base_total\", \"tax_amount\", \"total\"],\n\t\t\t\"_Test Account Excise Duty - _TC\": [5540.0, 55041.5, 110.80, 1100.83],\n\t\t\t\"_Test Account Education Cess - _TC\": [111, 55152.5, 2.22, 1103.05],\n\t\t\t\"_Test Account S&H Education Cess - _TC\": [55.5, 55208.0, 1.11, 1104.16],\n\t\t\t\"_Test Account CST - _TC\": [1104, 56312.0, 22.08, 1126.24],\n\t\t\t\"_Test Account VAT - _TC\": [6187.5, 62499.5, 123.75, 1249.99],\n\t\t\t\"_Test Account Customs Duty - _TC\": [4950.0, 67449.5, 99.0, 1348.99],\n\t\t\t\"_Test Account Shipping Charges - _TC\": [100, 67549.5, 2, 1350.99],\n\t\t\t\"_Test Account Discount - _TC\": [-6755, 60794.5, -135.10, 1215.89],\n\t\t}\n\n\t\tfor d in si.get(\"taxes\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.account_head][i])\n\n\t\tself.assertEqual(si.base_grand_total, 60795)\n\t\tself.assertEqual(si.grand_total, 1215.90)\n\t\t# no rounding adjustment as the Smallest Currency Fraction Value of USD is 0.01\n\t\tif frappe.db.get_value(\"Currency\", \"USD\", \"smallest_currency_fraction_value\") < 0.01:\n\t\t\tself.assertEqual(si.rounding_adjustment, 0.10)\n\t\t\tself.assertEqual(si.base_rounding_adjustment, 5.0)\n\t\telse:\n\t\t\tself.assertEqual(si.rounding_adjustment, 0.0)\n\t\t\tself.assertEqual(si.base_rounding_adjustment, 0.0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_outstanding": {
      "name": "test_outstanding",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_outstanding(self):\n\t\tw = self.make()\n\t\tself.assertEqual(w.outstanding_amount, w.base_rounded_total)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_rounded_total_with_cash_discount": {
      "name": "test_rounded_total_with_cash_discount",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_rounded_total_with_cash_discount(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\n\t\titem = copy.deepcopy(si.get(\"items\")[0])\n\t\titem.update(\n\t\t\t{\n\t\t\t\t\"qty\": 1,\n\t\t\t\t\"rate\": 14960.66,\n\t\t\t}\n\t\t)\n\n\t\tsi.set(\"items\", [item])\n\t\tsi.set(\"taxes\", [])\n\t\tsi.apply_discount_on = \"Grand Total\"\n\t\tsi.is_cash_or_non_trade_discount = 1\n\t\tsi.discount_amount = 1\n\t\tsi.insert()\n\n\t\tself.assertEqual(si.grand_total, 14959.66)\n\t\tself.assertEqual(si.rounded_total, 14960)\n\t\tself.assertEqual(si.rounding_adjustment, 0.34)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_payment": {
      "name": "test_payment",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_payment(self):\n\t\tw = self.make()\n\t\tjv = frappe.get_doc(frappe.copy_doc(self.globalTestRecords[\"Journal Entry\"][0]))\n\t\tjv.get(\"accounts\")[0].reference_type = w.doctype\n\t\tjv.get(\"accounts\")[0].reference_name = w.name\n\t\tjv.insert()\n\t\tjv.submit()\n\n\t\tself.assertEqual(frappe.db.get_value(\"Sales Invoice\", w.name, \"outstanding_amount\"), 162.0)\n\n\t\tlink_data = get_dynamic_link_map().get(\"Sales Invoice\", [])\n\t\tlink_doctypes = [d.parent for d in link_data]\n\n\t\t# test case for dynamic link order\n\t\tself.assertTrue(link_doctypes.index(\"GL Entry\") > link_doctypes.index(\"Journal Entry Account\"))\n\n\t\tjv.cancel()\n\t\tself.assertEqual(frappe.db.get_value(\"Sales Invoice\", w.name, \"outstanding_amount\"), 562.0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_outstanding_on_cost_center_allocation": {
      "name": "test_outstanding_on_cost_center_allocation",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_outstanding_on_cost_center_allocation(self):\n\t\t# setup cost centers\n\t\tfrom erpnext.accounts.doctype.cost_center.test_cost_center import create_cost_center\n\t\tfrom erpnext.accounts.doctype.cost_center_allocation.test_cost_center_allocation import (\n\t\t\tcreate_cost_center_allocation,\n\t\t)\n\n\t\tcost_centers = [\n\t\t\t\"Main Cost Center 1\",\n\t\t\t\"Sub Cost Center 1\",\n\t\t\t\"Sub Cost Center 2\",\n\t\t]\n\t\tfor cc in cost_centers:\n\t\t\tcreate_cost_center(cost_center_name=cc, company=\"_Test Company\")\n\n\t\tcca = create_cost_center_allocation(\n\t\t\t\"_Test Company\",\n\t\t\t\"Main Cost Center 1 - _TC\",\n\t\t\t{\"Sub Cost Center 1 - _TC\": 60, \"Sub Cost Center 2 - _TC\": 40},\n\t\t)\n\n\t\t# make invoice\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.is_pos = 0\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import get_payment_entry\n\n\t\t# make payment - fully paid\n\t\tpe = get_payment_entry(\"Sales Invoice\", si.name, bank_account=\"_Test Bank - _TC\")\n\t\tpe.reference_no = \"1\"\n\t\tpe.reference_date = nowdate()\n\t\tpe.paid_from_account_currency = si.currency\n\t\tpe.paid_to_account_currency = si.currency\n\t\tpe.source_exchange_rate = 1\n\t\tpe.target_exchange_rate = 1\n\t\tpe.paid_amount = si.outstanding_amount\n\t\tpe.cost_center = cca.main_cost_center\n\t\tpe.insert()\n\t\tpe.submit()\n\n\t\t# cancel cost center allocation\n\t\tcca.cancel()\n\n\t\tsi.reload()\n\t\tself.assertEqual(si.outstanding_amount, 0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_gl_entry_without_perpetual_inventory": {
      "name": "test_sales_invoice_gl_entry_without_perpetual_inventory",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_gl_entry_without_perpetual_inventory(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][1])\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, debit, credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tself.assertTrue(gl_entries)\n\n\t\texpected_values = dict(\n\t\t\t(d[0], d)\n\t\t\tfor d in [\n\t\t\t\t[si.debit_to, 630.0, 0.0],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][1][\"items\"][0][\"income_account\"], 0.0, 500.0],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][1][\"taxes\"][0][\"account_head\"], 0.0, 80.0],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][1][\"taxes\"][1][\"account_head\"], 0.0, 50.0],\n\t\t\t]\n\t\t)\n\n\t\tfor _i, gle in enumerate(gl_entries):\n\t\t\tself.assertEqual(expected_values[gle.account][0], gle.account)\n\t\t\tself.assertEqual(expected_values[gle.account][1], gle.debit)\n\t\t\tself.assertEqual(expected_values[gle.account][2], gle.credit)\n\n\t\t# cancel\n\t\tsi.cancel()\n\n\t\tgle = frappe.db.sql(\n\t\t\t\"\"\"select * from `tabGL Entry`\n\t\t\twhere voucher_type='Sales Invoice' and voucher_no=%s\"\"\",\n\t\t\tsi.name,\n\t\t)\n\n\t\tself.assertTrue(gle)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_pos_gl_entry_with_perpetual_inventory": {
      "name": "test_pos_gl_entry_with_perpetual_inventory",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_pos_gl_entry_with_perpetual_inventory(self):\n\t\tmake_pos_profile(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\twrite_off_account=\"_Test Write Off - TCP1\",\n\t\t)\n\n\t\tmake_purchase_receipt(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t)\n\n\t\tpos = create_sales_invoice(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\tdo_not_save=True,\n\t\t)\n\n\t\tpos.is_pos = 1\n\t\tpos.update_stock = 1\n\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Bank Draft\", \"amount\": 50})\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 50})\n\n\t\ttaxes = get_taxes_and_charges()\n\t\tpos.taxes = []\n\t\tfor tax in taxes:\n\t\t\tpos.append(\"taxes\", tax)\n\n\t\tsi = frappe.copy_doc(pos)\n\t\tsi.insert()\n\t\tsi.submit()\n\t\tself.assertEqual(si.paid_amount, 100.0)\n\n\t\tself.validate_pos_gl_entry(si, pos, 50)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_pos_returns_with_repayment": {
      "name": "test_pos_returns_with_repayment",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_pos_returns_with_repayment(self):\n\t\tfrom erpnext.accounts.doctype.sales_invoice.sales_invoice import make_sales_return\n\n\t\tpos_profile = make_pos_profile()\n\n\t\tpos_profile.payments = []\n\t\tpos_profile.append(\"payments\", {\"default\": 1, \"mode_of_payment\": \"Cash\"})\n\n\t\tpos_profile.save()\n\n\t\tpos = create_sales_invoice(qty=10, do_not_save=True)\n\n\t\tpos.is_pos = 1\n\t\tpos.pos_profile = pos_profile.name\n\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Bank Draft\", \"amount\": 500})\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 500})\n\t\tpos.insert()\n\t\tpos.submit()\n\n\t\tpos_return = make_sales_return(pos.name)\n\n\t\tpos_return.insert()\n\t\tpos_return.submit()\n\n\t\tself.assertEqual(pos_return.get(\"payments\")[0].amount, -500)\n\t\tself.assertEqual(pos_return.get(\"payments\")[1].amount, -500)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_pos_change_amount": {
      "name": "test_pos_change_amount",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_pos_change_amount(self):\n\t\tmake_pos_profile(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\twrite_off_account=\"_Test Write Off - TCP1\",\n\t\t)\n\n\t\tmake_purchase_receipt(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t)\n\n\t\tpos = create_sales_invoice(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\tdo_not_save=True,\n\t\t)\n\n\t\tpos.is_pos = 1\n\t\tpos.update_stock = 1\n\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Bank Draft\", \"amount\": 50})\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 60})\n\n\t\tpos.write_off_outstanding_amount_automatically = 1\n\t\tpos.insert()\n\t\tpos.submit()\n\n\t\tself.assertEqual(pos.grand_total, 100.0)\n\t\tself.assertEqual(pos.write_off_amount, 0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_auto_write_off_amount": {
      "name": "test_auto_write_off_amount",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_auto_write_off_amount(self):\n\t\tmake_pos_profile(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\twrite_off_account=\"_Test Write Off - TCP1\",\n\t\t)\n\n\t\tmake_purchase_receipt(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t)\n\n\t\tpos = create_sales_invoice(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\tdo_not_save=True,\n\t\t)\n\n\t\tpos.is_pos = 1\n\t\tpos.update_stock = 1\n\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Bank Draft\", \"amount\": 50})\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 40})\n\n\t\tpos.write_off_outstanding_amount_automatically = 1\n\t\tpos.insert()\n\t\tpos.submit()\n\n\t\tself.assertEqual(pos.grand_total, 100.0)\n\t\tself.assertEqual(pos.write_off_amount, 10)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_ledger_entries_of_return_pos_invoice": {
      "name": "test_ledger_entries_of_return_pos_invoice",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_ledger_entries_of_return_pos_invoice(self):\n\t\tmake_pos_profile()\n\n\t\tpos = create_sales_invoice(do_not_save=True)\n\t\tpos.is_pos = 1\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 100})\n\t\tpos.save().submit()\n\t\tself.assertEqual(pos.outstanding_amount, 0.0)\n\t\tself.assertEqual(pos.status, \"Paid\")\n\n\t\tfrom erpnext.accounts.doctype.sales_invoice.sales_invoice import make_sales_return\n\n\t\tpos_return = make_sales_return(pos.name)\n\t\tpos_return.save().submit()\n\t\tpos_return.reload()\n\t\tpos.reload()\n\t\tself.assertEqual(pos_return.is_return, 1)\n\t\tself.assertEqual(pos_return.return_against, pos.name)\n\t\tself.assertEqual(pos_return.outstanding_amount, 0.0)\n\t\tself.assertEqual(pos_return.status, \"Return\")\n\t\tself.assertEqual(pos.outstanding_amount, 0.0)\n\t\tself.assertEqual(pos.status, \"Credit Note Issued\")\n\n\t\texpected = (\n\t\t\t(\"Cash - _TC\", 0.0, 100.0, pos_return.name, None),\n\t\t\t(\"Debtors - _TC\", 0.0, 100.0, pos_return.name, pos_return.name),\n\t\t\t(\"Debtors - _TC\", 100.0, 0.0, pos_return.name, pos_return.name),\n\t\t\t(\"Sales - _TC\", 100.0, 0.0, pos_return.name, None),\n\t\t)\n\t\tres = frappe.db.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_no\": pos_return.name, \"is_cancelled\": 0},\n\t\t\tfields=[\"account\", \"debit\", \"credit\", \"voucher_no\", \"against_voucher\"],\n\t\t\torder_by=\"account, debit, credit\",\n\t\t\tas_list=1,\n\t\t)\n\t\tself.assertEqual(expected, res)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_pos_with_no_gl_entry_for_change_amount": {
      "name": "test_pos_with_no_gl_entry_for_change_amount",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_pos_with_no_gl_entry_for_change_amount(self):\n\t\tfrappe.db.set_single_value(\"POS Settings\", \"post_change_gl_entries\", 0)\n\n\t\tmake_pos_profile(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\twrite_off_account=\"_Test Write Off - TCP1\",\n\t\t)\n\n\t\tmake_purchase_receipt(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t)\n\n\t\tpos = create_sales_invoice(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\tdo_not_save=True,\n\t\t)\n\n\t\tpos.is_pos = 1\n\t\tpos.update_stock = 1\n\n\t\ttaxes = get_taxes_and_charges()\n\t\tpos.taxes = []\n\t\tfor tax in taxes:\n\t\t\tpos.append(\"taxes\", tax)\n\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Bank Draft\", \"amount\": 50})\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 60})\n\n\t\tpos.insert()\n\t\tpos.submit()\n\n\t\tself.assertEqual(pos.grand_total, 100.0)\n\t\tself.assertEqual(pos.change_amount, 10)\n\n\t\tself.validate_pos_gl_entry(pos, pos, 60, validate_without_change_gle=True)\n\n\t\tfrappe.db.set_single_value(\"POS Settings\", \"post_change_gl_entries\", 1)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::validate_pos_gl_entry": {
      "name": "validate_pos_gl_entry",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef validate_pos_gl_entry(self, si, pos, cash_amount, validate_without_change_gle=False):\n\t\tif validate_without_change_gle:\n\t\t\tcash_amount -= pos.change_amount\n\n\t\t# check stock ledger entries\n\t\tsle = frappe.db.sql(\n\t\t\t\"\"\"select * from `tabStock Ledger Entry`\n\t\t\twhere voucher_type = 'Sales Invoice' and voucher_no = %s\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)[0]\n\t\tself.assertTrue(sle)\n\t\tself.assertEqual(\n\t\t\t[sle.item_code, sle.warehouse, sle.actual_qty], [\"_Test FG Item\", \"Stores - TCP1\", -1.0]\n\t\t)\n\n\t\t# check gl entries\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, debit, credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc, debit asc, credit asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\t\tself.assertTrue(gl_entries)\n\n\t\tstock_in_hand = get_inventory_account(\"_Test Company with perpetual inventory\")\n\t\texpected_gl_entries = sorted(\n\t\t\t[\n\t\t\t\t[si.debit_to, 100.0, 0.0],\n\t\t\t\t[pos.items[0].income_account, 0.0, 89.09],\n\t\t\t\t[\"Round Off - TCP1\", 0.0, 0.01],\n\t\t\t\t[pos.taxes[0].account_head, 0.0, 10.69],\n\t\t\t\t[pos.taxes[1].account_head, 0.0, 0.21],\n\t\t\t\t[stock_in_hand, 0.0, abs(sle.stock_value_difference)],\n\t\t\t\t[pos.items[0].expense_account, abs(sle.stock_value_difference), 0.0],\n\t\t\t\t[si.debit_to, 0.0, 50.0],\n\t\t\t\t[si.debit_to, 0.0, cash_amount],\n\t\t\t\t[\"_Test Bank - TCP1\", 50, 0.0],\n\t\t\t\t[\"Cash - TCP1\", cash_amount, 0.0],\n\t\t\t]\n\t\t)\n\n\t\tfor i, gle in enumerate(sorted(gl_entries, key=lambda gle: gle.account)):\n\t\t\tself.assertEqual(expected_gl_entries[i][0], gle.account)\n\t\t\tself.assertEqual(expected_gl_entries[i][1], gle.debit)\n\t\t\tself.assertEqual(expected_gl_entries[i][2], gle.credit)\n\n\t\tsi.cancel()\n\t\tgle = frappe.db.sql(\n\t\t\t\"\"\"select * from `tabGL Entry`\n\t\t\twhere voucher_type='Sales Invoice' and voucher_no=%s\"\"\",\n\t\t\tsi.name,\n\t\t)\n\n\t\tself.assertTrue(gle)\n\n\t\tfrappe.db.sql(\"delete from `tabPOS Profile`\")"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_bin_details_of_packed_item": {
      "name": "test_bin_details_of_packed_item",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_bin_details_of_packed_item(self):\n\t\tfrom erpnext.selling.doctype.product_bundle.test_product_bundle import make_product_bundle\n\t\tfrom erpnext.stock.doctype.item.test_item import make_item\n\n\t\t# test Update Items with product bundle\n\t\tif not frappe.db.exists(\"Item\", \"_Test Product Bundle Item New\"):\n\t\t\tbundle_item = make_item(\"_Test Product Bundle Item New\", {\"is_stock_item\": 0})\n\t\t\tbundle_item.append(\n\t\t\t\t\"item_defaults\", {\"company\": \"_Test Company\", \"default_warehouse\": \"_Test Warehouse - _TC\"}\n\t\t\t)\n\t\t\tbundle_item.save(ignore_permissions=True)\n\n\t\tmake_item(\"_Packed Item New 1\", {\"is_stock_item\": 1})\n\t\tmake_product_bundle(\"_Test Product Bundle Item New\", [\"_Packed Item New 1\"], 2)\n\n\t\tsi = create_sales_invoice(\n\t\t\titem_code=\"_Test Product Bundle Item New\",\n\t\t\tupdate_stock=1,\n\t\t\twarehouse=\"_Test Warehouse - _TC\",\n\t\t\ttransaction_date=add_days(nowdate(), -1),\n\t\t\tdo_not_submit=1,\n\t\t)\n\n\t\tmake_stock_entry(item=\"_Packed Item New 1\", target=\"_Test Warehouse - _TC\", qty=120, rate=100)\n\n\t\tbin_details = frappe.db.get_value(\n\t\t\t\"Bin\",\n\t\t\t{\"item_code\": \"_Packed Item New 1\", \"warehouse\": \"_Test Warehouse - _TC\"},\n\t\t\t[\"actual_qty\", \"projected_qty\", \"ordered_qty\"],\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tsi.transaction_date = nowdate()\n\t\tsi.save()\n\n\t\tpacked_item = si.packed_items[0]\n\t\tself.assertEqual(flt(bin_details.actual_qty), flt(packed_item.actual_qty))\n\t\tself.assertEqual(flt(bin_details.projected_qty), flt(packed_item.projected_qty))\n\t\tself.assertEqual(flt(bin_details.ordered_qty), flt(packed_item.ordered_qty))"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_pos_si_without_payment": {
      "name": "test_pos_si_without_payment",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_pos_si_without_payment(self):\n\t\tmake_pos_profile()\n\n\t\tpos = copy.deepcopy(dict(self.globalTestRecords[\"Sales Invoice\"][1]))\n\t\tpos[\"is_pos\"] = 1\n\t\tpos[\"update_stock\"] = 1\n\n\t\tsi = frappe.copy_doc(pos)\n\t\tsi.insert()\n\n\t\t# Check that the invoice cannot be submitted without payments\n\t\tself.assertRaises(frappe.ValidationError, si.submit)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_gl_entry_with_perpetual_inventory_no_item_code": {
      "name": "test_sales_invoice_gl_entry_with_perpetual_inventory_no_item_code",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_gl_entry_with_perpetual_inventory_no_item_code(self):\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\tdo_not_save=True,\n\t\t)\n\t\tsi.get(\"items\")[0].item_code = None\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, debit, credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\t\tself.assertTrue(gl_entries)\n\n\t\texpected_values = dict(\n\t\t\t(d[0], d) for d in [[\"Debtors - TCP1\", 100.0, 0.0], [\"Sales - TCP1\", 0.0, 100.0]]\n\t\t)\n\t\tfor _i, gle in enumerate(gl_entries):\n\t\t\tself.assertEqual(expected_values[gle.account][0], gle.account)\n\t\t\tself.assertEqual(expected_values[gle.account][1], gle.debit)\n\t\t\tself.assertEqual(expected_values[gle.account][2], gle.credit)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_gl_entry_with_perpetual_inventory_non_stock_item": {
      "name": "test_sales_invoice_gl_entry_with_perpetual_inventory_non_stock_item",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_gl_entry_with_perpetual_inventory_non_stock_item(self):\n\t\tsi = create_sales_invoice(item=\"_Test Non Stock Item\")\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, debit, credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\t\tself.assertTrue(gl_entries)\n\n\t\texpected_values = dict(\n\t\t\t(d[0], d)\n\t\t\tfor d in [\n\t\t\t\t[si.debit_to, 100.0, 0.0],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][1][\"items\"][0][\"income_account\"], 0.0, 100.0],\n\t\t\t]\n\t\t)\n\t\tfor _i, gle in enumerate(gl_entries):\n\t\t\tself.assertEqual(expected_values[gle.account][0], gle.account)\n\t\t\tself.assertEqual(expected_values[gle.account][1], gle.debit)\n\t\t\tself.assertEqual(expected_values[gle.account][2], gle.credit)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::_insert_purchase_receipt": {
      "name": "_insert_purchase_receipt",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef _insert_purchase_receipt(self):\n\t\tpr = frappe.copy_doc(self.globalTestRecords[\"Purchase Receipt\"][0])\n\t\tpr.naming_series = \"_T-Purchase Receipt-\"\n\t\tpr.insert()\n\t\tpr.submit()"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::_insert_delivery_note": {
      "name": "_insert_delivery_note",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef _insert_delivery_note(self):\n\t\tdn = frappe.copy_doc(self.globalTestRecords[\"Delivery Note\"][0])\n\t\tdn.naming_series = \"_T-Delivery Note-\"\n\t\tdn.insert()\n\t\tdn.submit()\n\t\treturn dn"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_with_advance": {
      "name": "test_sales_invoice_with_advance",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_with_advance(self):\n\t\tjv = frappe.copy_doc(self.globalTestRecords[\"Journal Entry\"][0])\n\t\tjv.insert()\n\t\tjv.submit()\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.allocate_advances_automatically = 0\n\t\tsi.append(\n\t\t\t\"advances\",\n\t\t\t{\n\t\t\t\t\"doctype\": \"Sales Invoice Advance\",\n\t\t\t\t\"reference_type\": \"Journal Entry\",\n\t\t\t\t\"reference_name\": jv.name,\n\t\t\t\t\"reference_row\": jv.get(\"accounts\")[0].name,\n\t\t\t\t\"advance_amount\": 400,\n\t\t\t\t\"allocated_amount\": 300,\n\t\t\t\t\"remarks\": jv.remark,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\t\tsi.submit()\n\t\tsi.load_from_db()\n\n\t\tself.assertTrue(\n\t\t\tfrappe.db.sql(\n\t\t\t\t\"\"\"select name from `tabJournal Entry Account`\n\t\t\twhere reference_name=%s\"\"\",\n\t\t\t\tsi.name,\n\t\t\t)\n\t\t)\n\n\t\tself.assertTrue(\n\t\t\tfrappe.db.sql(\n\t\t\t\t\"\"\"select name from `tabJournal Entry Account`\n\t\t\twhere reference_name=%s and credit_in_account_currency=300\"\"\",\n\t\t\t\tsi.name,\n\t\t\t)\n\t\t)\n\n\t\tself.assertEqual(si.outstanding_amount, 262.0)\n\n\t\tsi.cancel()"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_serialized": {
      "name": "test_serialized",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_serialized(self):\n\t\tfrom erpnext.stock.doctype.stock_entry.test_stock_entry import make_serialized_item\n\n\t\tse = make_serialized_item(self)\n\t\tse.load_from_db()\n\t\tserial_nos = get_serial_nos_from_bundle(se.get(\"items\")[0].serial_and_batch_bundle)\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.update_stock = 1\n\t\tsi.get(\"items\")[0].item_code = \"_Test Serialized Item With Series\"\n\t\tsi.get(\"items\")[0].qty = 1\n\t\tsi.get(\"items\")[0].warehouse = se.get(\"items\")[0].t_warehouse\n\t\tsi.get(\"items\")[0].serial_and_batch_bundle = make_serial_batch_bundle(\n\t\t\tfrappe._dict(\n\t\t\t\t{\n\t\t\t\t\t\"item_code\": si.get(\"items\")[0].item_code,\n\t\t\t\t\t\"warehouse\": si.get(\"items\")[0].warehouse,\n\t\t\t\t\t\"company\": si.company,\n\t\t\t\t\t\"qty\": 1,\n\t\t\t\t\t\"voucher_type\": \"Stock Entry\",\n\t\t\t\t\t\"serial_nos\": [serial_nos[0]],\n\t\t\t\t\t\"posting_date\": si.posting_date,\n\t\t\t\t\t\"posting_time\": si.posting_time,\n\t\t\t\t\t\"type_of_transaction\": \"Outward\",\n\t\t\t\t\t\"do_not_submit\": True,\n\t\t\t\t}\n\t\t\t)\n\t\t).name\n\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tself.assertFalse(frappe.db.get_value(\"Serial No\", serial_nos[0], \"warehouse\"))\n\n\t\treturn si"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_serialized_cancel": {
      "name": "test_serialized_cancel",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_serialized_cancel(self):\n\t\tsi = self.test_serialized()\n\t\tsi.reload()\n\t\tserial_nos = get_serial_nos_from_bundle(si.get(\"items\")[0].serial_and_batch_bundle)\n\n\t\tsi.cancel()\n\n\t\tself.assertEqual(\n\t\t\tfrappe.db.get_value(\"Serial No\", serial_nos[0], \"warehouse\"), \"_Test Warehouse - _TC\"\n\t\t)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_serial_numbers_against_delivery_note": {
      "name": "test_serial_numbers_against_delivery_note",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_serial_numbers_against_delivery_note(self):\n\t\t\"\"\"\n\t\tcheck if the sales invoice item serial numbers and the delivery note items\n\t\tserial numbers are same\n\t\t\"\"\"\n\t\tfrom erpnext.stock.doctype.delivery_note.test_delivery_note import create_delivery_note\n\t\tfrom erpnext.stock.doctype.stock_entry.test_stock_entry import make_serialized_item\n\n\t\tse = make_serialized_item(self)\n\t\tse.load_from_db()\n\t\tserial_nos = get_serial_nos_from_bundle(se.get(\"items\")[0].serial_and_batch_bundle)[0]\n\n\t\tdn = create_delivery_note(item=se.get(\"items\")[0].item_code, serial_no=[serial_nos])\n\t\tdn.submit()\n\t\tdn.load_from_db()\n\n\t\tserial_nos = get_serial_nos_from_bundle(dn.get(\"items\")[0].serial_and_batch_bundle)[0]\n\t\tself.assertTrue(get_serial_nos_from_bundle(se.get(\"items\")[0].serial_and_batch_bundle)[0])\n\n\t\tsi = make_sales_invoice(dn.name)\n\t\tsi.save()"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_return_sales_invoice": {
      "name": "test_return_sales_invoice",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_return_sales_invoice(self):\n\t\tmake_stock_entry(item_code=\"_Test Item\", target=\"Stores - TCP1\", qty=50, basic_rate=100)\n\n\t\tactual_qty_0 = get_qty_after_transaction(item_code=\"_Test Item\", warehouse=\"Stores - TCP1\")\n\n\t\tsi = create_sales_invoice(\n\t\t\tqty=5,\n\t\t\trate=500,\n\t\t\tupdate_stock=1,\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\titem_code=\"_Test Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t)\n\n\t\tactual_qty_1 = get_qty_after_transaction(item_code=\"_Test Item\", warehouse=\"Stores - TCP1\")\n\n\t\tself.assertEqual(actual_qty_0 - 5, actual_qty_1)\n\n\t\t# outgoing_rate\n\t\toutgoing_rate = (\n\t\t\tfrappe.db.get_value(\n\t\t\t\t\"Stock Ledger Entry\",\n\t\t\t\t{\"voucher_type\": \"Sales Invoice\", \"voucher_no\": si.name},\n\t\t\t\t\"stock_value_difference\",\n\t\t\t)\n\t\t\t/ 5\n\t\t)\n\n\t\t# return entry\n\t\tsi1 = create_sales_invoice(\n\t\t\tis_return=1,\n\t\t\treturn_against=si.name,\n\t\t\tqty=-2,\n\t\t\trate=500,\n\t\t\tupdate_stock=1,\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\titem_code=\"_Test Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t)\n\n\t\tactual_qty_2 = get_qty_after_transaction(item_code=\"_Test Item\", warehouse=\"Stores - TCP1\")\n\t\tself.assertEqual(actual_qty_1 + 2, actual_qty_2)\n\n\t\tincoming_rate, stock_value_difference = frappe.db.get_value(\n\t\t\t\"Stock Ledger Entry\",\n\t\t\t{\"voucher_type\": \"Sales Invoice\", \"voucher_no\": si1.name},\n\t\t\t[\"incoming_rate\", \"stock_value_difference\"],\n\t\t)\n\n\t\tself.assertEqual(flt(incoming_rate, 3), abs(flt(outgoing_rate, 3)))\n\t\tstock_in_hand_account = get_inventory_account(\n\t\t\t\"_Test Company with perpetual inventory\", si1.items[0].warehouse\n\t\t)\n\n\t\t# Check gl entry\n\t\tgle_warehouse_amount = frappe.db.get_value(\n\t\t\t\"GL Entry\",\n\t\t\t{\"voucher_type\": \"Sales Invoice\", \"voucher_no\": si1.name, \"account\": stock_in_hand_account},\n\t\t\t\"debit\",\n\t\t)\n\n\t\tself.assertEqual(gle_warehouse_amount, stock_value_difference)\n\n\t\tparty_credited = frappe.db.get_value(\n\t\t\t\"GL Entry\",\n\t\t\t{\n\t\t\t\t\"voucher_type\": \"Sales Invoice\",\n\t\t\t\t\"voucher_no\": si1.name,\n\t\t\t\t\"account\": \"Debtors - TCP1\",\n\t\t\t\t\"party\": \"_Test Customer\",\n\t\t\t},\n\t\t\t\"credit\",\n\t\t)\n\n\t\tself.assertEqual(party_credited, 1000)\n\n\t\t# Check outstanding amount\n\t\tself.assertEqual(frappe.db.get_value(\"Sales Invoice\", si1.name, \"outstanding_amount\"), -1000)\n\t\tself.assertEqual(frappe.db.get_value(\"Sales Invoice\", si.name, \"outstanding_amount\"), 2500)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_zero_qty_return_invoice_with_stock_effect": {
      "name": "test_zero_qty_return_invoice_with_stock_effect",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_zero_qty_return_invoice_with_stock_effect(self):\n\t\tcr_note = create_sales_invoice(qty=-1, rate=300, is_return=1, do_not_submit=True)\n\t\tcr_note.update_stock = True\n\t\tcr_note.items[0].qty = 0\n\t\tself.assertRaises(frappe.ValidationError, cr_note.save)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_return_invoice_with_account_mismatch": {
      "name": "test_return_invoice_with_account_mismatch",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_return_invoice_with_account_mismatch(self):\n\t\tdebtors2 = create_account(\n\t\t\tparent_account=\"Accounts Receivable - _TC\",\n\t\t\taccount_name=\"Debtors 2\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_type=\"Receivable\",\n\t\t)\n\t\tsi = create_sales_invoice(qty=1, rate=1000)\n\t\tcr_note = create_sales_invoice(\n\t\t\tqty=-1, rate=1000, is_return=1, return_against=si.name, debit_to=debtors2, do_not_save=True\n\t\t)\n\t\tself.assertRaises(frappe.ValidationError, cr_note.save)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_gle_made_when_asset_is_returned": {
      "name": "test_gle_made_when_asset_is_returned",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_gle_made_when_asset_is_returned(self):\n\t\tcreate_asset_data()\n\t\tasset = create_asset(item_code=\"Macbook Pro\")\n\n\t\tsi = create_sales_invoice(item_code=\"Macbook Pro\", asset=asset.name, qty=1, rate=90000)\n\t\treturn_si = create_sales_invoice(\n\t\t\tis_return=1,\n\t\t\treturn_against=si.name,\n\t\t\titem_code=\"Macbook Pro\",\n\t\t\tasset=asset.name,\n\t\t\tqty=-1,\n\t\t\trate=90000,\n\t\t)\n\n\t\tdisposal_account = frappe.get_cached_value(\"Company\", \"_Test Company\", \"disposal_account\")\n\n\t\t# Asset value is 100,000 but it was sold for 90,000, so there should be a loss of 10,000\n\t\tloss_for_si = frappe.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_no\": si.name, \"account\": disposal_account},\n\t\t\tfields=[\"credit\", \"debit\"],\n\t\t)[0]\n\n\t\tloss_for_return_si = frappe.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_no\": return_si.name, \"account\": disposal_account},\n\t\t\tfields=[\"credit\", \"debit\"],\n\t\t)[0]\n\n\t\tself.assertEqual(loss_for_si[\"credit\"], loss_for_return_si[\"debit\"])\n\t\tself.assertEqual(loss_for_si[\"debit\"], loss_for_return_si[\"credit\"])"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_incoming_rate_for_stand_alone_credit_note": {
      "name": "test_incoming_rate_for_stand_alone_credit_note",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_incoming_rate_for_stand_alone_credit_note(self):\n\t\treturn_si = create_sales_invoice(\n\t\t\tis_return=1,\n\t\t\tupdate_stock=1,\n\t\t\tqty=-1,\n\t\t\trate=90000,\n\t\t\tincoming_rate=10,\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t)\n\n\t\tincoming_rate = frappe.db.get_value(\n\t\t\t\"Stock Ledger Entry\", {\"voucher_no\": return_si.name}, \"incoming_rate\"\n\t\t)\n\t\tdebit_amount = frappe.db.get_value(\n\t\t\t\"GL Entry\", {\"voucher_no\": return_si.name, \"account\": \"Stock In Hand - TCP1\"}, \"debit\"\n\t\t)\n\n\t\tself.assertEqual(debit_amount, 10.0)\n\t\tself.assertEqual(incoming_rate, 10.0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_discount_on_net_total": {
      "name": "test_discount_on_net_total",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_discount_on_net_total(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\t\tsi.apply_discount_on = \"Net Total\"\n\t\tsi.discount_amount = 625\n\t\tsi.insert()\n\n\t\texpected_values = {\n\t\t\t\"keys\": [\n\t\t\t\t\"price_list_rate\",\n\t\t\t\t\"discount_percentage\",\n\t\t\t\t\"rate\",\n\t\t\t\t\"amount\",\n\t\t\t\t\"base_price_list_rate\",\n\t\t\t\t\"base_rate\",\n\t\t\t\t\"base_amount\",\n\t\t\t\t\"net_rate\",\n\t\t\t\t\"base_net_rate\",\n\t\t\t\t\"net_amount\",\n\t\t\t\t\"base_net_amount\",\n\t\t\t],\n\t\t\t\"_Test Item Home Desktop 100\": [50, 0, 50, 500, 50, 50, 500, 25, 25, 250, 250],\n\t\t\t\"_Test Item Home Desktop 200\": [150, 0, 150, 750, 150, 150, 750, 75, 75, 375, 375],\n\t\t}\n\n\t\t# check if children are saved\n\t\tself.assertEqual(len(si.get(\"items\")), len(expected_values) - 1)\n\n\t\t# check if item values are calculated\n\t\tfor d in si.get(\"items\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.item_code][i])\n\n\t\t# check net total\n\t\tself.assertEqual(si.base_total, 1250)\n\t\tself.assertEqual(si.total, 1250)\n\t\tself.assertEqual(si.base_net_total, 625)\n\t\tself.assertEqual(si.net_total, 625)\n\n\t\t# check tax calculation\n\t\texpected_values = {\n\t\t\t\"keys\": [\n\t\t\t\t\"tax_amount\",\n\t\t\t\t\"tax_amount_after_discount_amount\",\n\t\t\t\t\"base_tax_amount_after_discount_amount\",\n\t\t\t],\n\t\t\t\"_Test Account Shipping Charges - _TC\": [100, 100, 100],\n\t\t\t\"_Test Account Customs Duty - _TC\": [62.5, 62.5, 62.5],\n\t\t\t\"_Test Account Excise Duty - _TC\": [70, 70, 70],\n\t\t\t\"_Test Account Education Cess - _TC\": [1.4, 1.4, 1.4],\n\t\t\t\"_Test Account S&H Education Cess - _TC\": [0.7, 0.7, 0.7],\n\t\t\t\"_Test Account CST - _TC\": [17.19, 17.19, 17.19],\n\t\t\t\"_Test Account VAT - _TC\": [78.12, 78.12, 78.12],\n\t\t\t\"_Test Account Discount - _TC\": [-95.49, -95.49, -95.49],\n\t\t}\n\n\t\tfor d in si.get(\"taxes\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tif expected_values.get(d.account_head):\n\t\t\t\t\tself.assertEqual(d.get(k), expected_values[d.account_head][i])\n\n\t\tself.assertEqual(si.total_taxes_and_charges, 234.42)\n\t\tself.assertEqual(si.base_grand_total, 859.42)\n\t\tself.assertEqual(si.grand_total, 859.42)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_multi_currency_gle": {
      "name": "test_multi_currency_gle",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_multi_currency_gle(self):\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"_Test Receivable USD - _TC\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=50,\n\t\t)\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, account_currency, debit, credit,\n\t\t\tdebit_in_account_currency, credit_in_account_currency\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tself.assertTrue(gl_entries)\n\n\t\texpected_values = {\n\t\t\t\"_Test Receivable USD - _TC\": {\n\t\t\t\t\"account_currency\": \"USD\",\n\t\t\t\t\"debit\": 5000,\n\t\t\t\t\"debit_in_account_currency\": 100,\n\t\t\t\t\"credit\": 0,\n\t\t\t\t\"credit_in_account_currency\": 0,\n\t\t\t},\n\t\t\t\"Sales - _TC\": {\n\t\t\t\t\"account_currency\": \"INR\",\n\t\t\t\t\"debit\": 0,\n\t\t\t\t\"debit_in_account_currency\": 0,\n\t\t\t\t\"credit\": 5000,\n\t\t\t\t\"credit_in_account_currency\": 5000,\n\t\t\t},\n\t\t}\n\n\t\tfor field in (\n\t\t\t\"account_currency\",\n\t\t\t\"debit\",\n\t\t\t\"debit_in_account_currency\",\n\t\t\t\"credit\",\n\t\t\t\"credit_in_account_currency\",\n\t\t):\n\t\t\tfor _i, gle in enumerate(gl_entries):\n\t\t\t\tself.assertEqual(expected_values[gle.account][field], gle[field])\n\n\t\t# cancel\n\t\tsi.cancel()\n\n\t\tgle = frappe.db.sql(\n\t\t\t\"\"\"select name from `tabGL Entry`\n\t\t\twhere voucher_type='Sales Invoice' and voucher_no=%s\"\"\",\n\t\t\tsi.name,\n\t\t)\n\n\t\tself.assertTrue(gle)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_gle_in_transaction_currency": {
      "name": "test_gle_in_transaction_currency",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_gle_in_transaction_currency(self):\n\t\t# create multi currency sales invoice with 2 items with same income account\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"_Test Receivable USD - _TC\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=50,\n\t\t\tdo_not_submit=True,\n\t\t)\n\t\t# add 2nd item with same income account\n\t\tsi.append(\n\t\t\t\"items\",\n\t\t\t{\n\t\t\t\t\"item_code\": \"_Test Item\",\n\t\t\t\t\"qty\": 1,\n\t\t\t\t\"rate\": 80,\n\t\t\t\t\"income_account\": \"Sales - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t},\n\t\t)\n\t\tsi.submit()\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select transaction_currency, transaction_exchange_rate,\n\t\t\tdebit_in_transaction_currency, credit_in_transaction_currency\n\t\t\tfrom `tabGL Entry`\n\t\t\twhere voucher_type='Sales Invoice' and voucher_no=%s and account = 'Sales - _TC'\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\texpected_gle = {\n\t\t\t\"transaction_currency\": \"USD\",\n\t\t\t\"transaction_exchange_rate\": 50,\n\t\t\t\"debit_in_transaction_currency\": 0,\n\t\t\t\"credit_in_transaction_currency\": 180,\n\t\t}\n\n\t\tfor gle in gl_entries:\n\t\t\tfor field in expected_gle:\n\t\t\t\tself.assertEqual(expected_gle[field], gle[field])"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_invalid_currency": {
      "name": "test_invalid_currency",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_invalid_currency(self):\n\t\t# Customer currency = USD\n\n\t\t# Transaction currency cannot be INR\n\t\tsi1 = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\", debit_to=\"_Test Receivable USD - _TC\", do_not_save=True\n\t\t)\n\n\t\tself.assertRaises(InvalidCurrency, si1.save)\n\n\t\t# Transaction currency cannot be EUR\n\t\tsi2 = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"_Test Receivable USD - _TC\",\n\t\t\tcurrency=\"EUR\",\n\t\t\tconversion_rate=80,\n\t\t\tdo_not_save=True,\n\t\t)\n\n\t\tself.assertRaises(InvalidCurrency, si2.save)\n\n\t\t# Transaction currency only allowed in USD\n\t\tsi3 = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"_Test Receivable USD - _TC\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=50,\n\t\t)\n\n\t\t# Party Account currency must be in USD, as there is existing GLE with USD\n\t\tsi4 = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"Debtors - _TC\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=50,\n\t\t\tdo_not_submit=True,\n\t\t)\n\n\t\tself.assertRaises(InvalidAccountCurrency, si4.submit)\n\n\t\t# Party Account currency must be in USD, force customer currency as there is no GLE\n\n\t\tsi3.cancel()\n\t\tsi5 = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"Debtors - _TC\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=50,\n\t\t\tdo_not_submit=True,\n\t\t)\n\n\t\tself.assertRaises(InvalidAccountCurrency, si5.submit)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_create_so_with_margin": {
      "name": "test_create_so_with_margin",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_create_so_with_margin(self):\n\t\tsi = create_sales_invoice(item_code=\"_Test Item\", qty=1, do_not_submit=True)\n\t\tprice_list_rate = flt(100) * flt(si.plc_conversion_rate)\n\t\tsi.items[0].price_list_rate = price_list_rate\n\t\tsi.items[0].margin_type = \"Percentage\"\n\t\tsi.items[0].margin_rate_or_amount = 25\n\t\tsi.items[0].discount_amount = 0.0\n\t\tsi.items[0].discount_percentage = 0.0\n\t\tsi.save()\n\t\tself.assertEqual(si.get(\"items\")[0].rate, flt((price_list_rate * 25) / 100 + price_list_rate))"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_outstanding_amount_after_advance_jv_cancellation": {
      "name": "test_outstanding_amount_after_advance_jv_cancellation",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_outstanding_amount_after_advance_jv_cancellation(self):\n\t\tjv = frappe.copy_doc(self.globalTestRecords[\"Journal Entry\"][0])\n\t\tjv.accounts[0].is_advance = \"Yes\"\n\t\tjv.insert()\n\t\tjv.submit()\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.append(\n\t\t\t\"advances\",\n\t\t\t{\n\t\t\t\t\"doctype\": \"Sales Invoice Advance\",\n\t\t\t\t\"reference_type\": \"Journal Entry\",\n\t\t\t\t\"reference_name\": jv.name,\n\t\t\t\t\"reference_row\": jv.get(\"accounts\")[0].name,\n\t\t\t\t\"advance_amount\": 400,\n\t\t\t\t\"allocated_amount\": 300,\n\t\t\t\t\"remarks\": jv.remark,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\t\tsi.submit()\n\t\tsi.load_from_db()\n\n\t\t# check outstanding after advance allocation\n\t\tself.assertEqual(\n\t\t\tflt(si.outstanding_amount),\n\t\t\tflt(si.rounded_total - si.total_advance, si.precision(\"outstanding_amount\")),\n\t\t)\n\n\t\t# added to avoid Document has been modified exception\n\t\tjv = frappe.get_doc(\"Journal Entry\", jv.name)\n\t\tjv.cancel()\n\n\t\tsi.load_from_db()\n\t\t# check outstanding after advance cancellation\n\t\tself.assertEqual(\n\t\t\tflt(si.outstanding_amount),\n\t\t\tflt(si.rounded_total + si.total_advance, si.precision(\"outstanding_amount\")),\n\t\t)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_outstanding_amount_after_advance_payment_entry_cancellation": {
      "name": "test_outstanding_amount_after_advance_payment_entry_cancellation",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_outstanding_amount_after_advance_payment_entry_cancellation(self):\n\t\t\"\"\"Test impact of advance PE submission/cancellation on SI and SO.\"\"\"\n\t\tfrom erpnext.selling.doctype.sales_order.test_sales_order import make_sales_order\n\n\t\tsales_order = make_sales_order(item_code=\"138-CMS Shoe\", qty=1, price_list_rate=500)\n\t\tpe = frappe.get_doc(\n\t\t\t{\n\t\t\t\t\"doctype\": \"Payment Entry\",\n\t\t\t\t\"payment_type\": \"Receive\",\n\t\t\t\t\"party_type\": \"Customer\",\n\t\t\t\t\"party\": \"_Test Customer\",\n\t\t\t\t\"company\": \"_Test Company\",\n\t\t\t\t\"paid_from_account_currency\": \"INR\",\n\t\t\t\t\"paid_to_account_currency\": \"INR\",\n\t\t\t\t\"source_exchange_rate\": 1,\n\t\t\t\t\"target_exchange_rate\": 1,\n\t\t\t\t\"reference_no\": \"1\",\n\t\t\t\t\"reference_date\": nowdate(),\n\t\t\t\t\"received_amount\": 300,\n\t\t\t\t\"paid_amount\": 300,\n\t\t\t\t\"paid_from\": \"Debtors - _TC\",\n\t\t\t\t\"paid_to\": \"_Test Cash - _TC\",\n\t\t\t}\n\t\t)\n\t\tpe.append(\n\t\t\t\"references\",\n\t\t\t{\n\t\t\t\t\"reference_doctype\": \"Sales Order\",\n\t\t\t\t\"reference_name\": sales_order.name,\n\t\t\t\t\"total_amount\": sales_order.grand_total,\n\t\t\t\t\"outstanding_amount\": sales_order.grand_total,\n\t\t\t\t\"allocated_amount\": 300,\n\t\t\t},\n\t\t)\n\t\tpe.insert()\n\t\tpe.submit()\n\n\t\tsales_order.reload()\n\t\tself.assertEqual(sales_order.advance_paid, 300)\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.items[0].sales_order = sales_order.name\n\t\tsi.items[0].so_detail = sales_order.get(\"items\")[0].name\n\t\tsi.is_pos = 0\n\t\tsi.append(\n\t\t\t\"advances\",\n\t\t\t{\n\t\t\t\t\"doctype\": \"Sales Invoice Advance\",\n\t\t\t\t\"reference_type\": \"Payment Entry\",\n\t\t\t\t\"reference_name\": pe.name,\n\t\t\t\t\"reference_row\": pe.references[0].name,\n\t\t\t\t\"advance_amount\": 300,\n\t\t\t\t\"allocated_amount\": 300,\n\t\t\t\t\"remarks\": pe.remarks,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tsi.reload()\n\t\tpe.reload()\n\t\tsales_order.reload()\n\n\t\t# Check if SO is unlinked/replaced by SI in PE & if SO advance paid is 0\n\t\tself.assertEqual(pe.references[0].reference_name, si.name)\n\t\tself.assertEqual(sales_order.advance_paid, 300.0)\n\n\t\t# check outstanding after advance allocation\n\t\tself.assertEqual(\n\t\t\tflt(si.outstanding_amount),\n\t\t\tflt(si.rounded_total - si.total_advance, si.precision(\"outstanding_amount\")),\n\t\t)\n\n\t\tpe.cancel()\n\t\tsi.reload()\n\n\t\t# check outstanding after advance cancellation\n\t\tself.assertEqual(\n\t\t\tflt(si.outstanding_amount),\n\t\t\tflt(si.rounded_total + si.total_advance, si.precision(\"outstanding_amount\")),\n\t\t)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_multiple_uom_in_selling": {
      "name": "test_multiple_uom_in_selling",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_multiple_uom_in_selling(self):\n\t\tfrappe.db.sql(\n\t\t\t\"\"\"delete from `tabItem Price`\n\t\t\twhere price_list='_Test Price List' and item_code='_Test Item'\"\"\"\n\t\t)\n\t\titem_price = frappe.new_doc(\"Item Price\")\n\t\titem_price.price_list = \"_Test Price List\"\n\t\titem_price.item_code = \"_Test Item\"\n\t\titem_price.price_list_rate = 100\n\t\titem_price.insert()\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][1])\n\t\tsi.items[0].uom = \"_Test UOM 1\"\n\t\tsi.items[0].conversion_factor = None\n\t\tsi.items[0].price_list_rate = None\n\t\tsi.save()\n\n\t\texpected_values = {\n\t\t\t\"keys\": [\n\t\t\t\t\"price_list_rate\",\n\t\t\t\t\"stock_uom\",\n\t\t\t\t\"uom\",\n\t\t\t\t\"conversion_factor\",\n\t\t\t\t\"rate\",\n\t\t\t\t\"amount\",\n\t\t\t\t\"base_price_list_rate\",\n\t\t\t\t\"base_rate\",\n\t\t\t\t\"base_amount\",\n\t\t\t],\n\t\t\t\"_Test Item\": [1000, \"_Test UOM\", \"_Test UOM 1\", 10.0, 1000, 1000, 1000, 1000, 1000],\n\t\t}\n\n\t\t# check if the conversion_factor and price_list_rate is calculated according to uom\n\t\tfor d in si.get(\"items\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.item_code][i])"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_item_wise_tax_breakup": {
      "name": "test_item_wise_tax_breakup",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_item_wise_tax_breakup(self):\n\t\tfrappe.flags.country = \"United States\"\n\n\t\tsi = self.create_si_to_test_tax_breakup()\n\n\t\titemised_tax_data = get_itemised_tax_breakup_data(si)\n\n\t\texpected_itemised_tax = [\n\t\t\t{\n\t\t\t\t\"item\": \"_Test Item\",\n\t\t\t\t\"taxable_amount\": 10000.0,\n\t\t\t\t\"Service Tax\": {\"tax_rate\": 10.0, \"tax_amount\": 1000.0, \"taxable_amount\": 10000.0},\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"item\": \"_Test Item 2\",\n\t\t\t\t\"taxable_amount\": 5000.0,\n\t\t\t\t\"Service Tax\": {\"tax_rate\": 10.0, \"tax_amount\": 500.0, \"taxable_amount\": 5000.0},\n\t\t\t},\n\t\t]\n\n\t\tself.assertEqual(itemised_tax_data, expected_itemised_tax)\n\n\t\tfrappe.flags.country = None"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::create_si_to_test_tax_breakup": {
      "name": "create_si_to_test_tax_breakup",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef create_si_to_test_tax_breakup(self):\n\t\tsi = create_sales_invoice(qty=100, rate=50, do_not_save=True)\n\t\tsi.append(\n\t\t\t\"items\",\n\t\t\t{\n\t\t\t\t\"item_code\": \"_Test Item\",\n\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t\t\"qty\": 100,\n\t\t\t\t\"rate\": 50,\n\t\t\t\t\"income_account\": \"Sales - _TC\",\n\t\t\t\t\"expense_account\": \"Cost of Goods Sold - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t},\n\t\t)\n\t\tsi.append(\n\t\t\t\"items\",\n\t\t\t{\n\t\t\t\t\"item_code\": \"_Test Item 2\",\n\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t\t\"qty\": 100,\n\t\t\t\t\"rate\": 50,\n\t\t\t\t\"income_account\": \"Sales - _TC\",\n\t\t\t\t\"expense_account\": \"Cost of Goods Sold - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t},\n\t\t)\n\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"account_head\": \"_Test Account Service Tax - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"Service Tax\",\n\t\t\t\t\"rate\": 10,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\t\treturn si"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_company_monthly_sales": {
      "name": "test_company_monthly_sales",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_company_monthly_sales(self):\n\t\texisting_current_month_sales = frappe.get_cached_value(\n\t\t\t\"Company\", \"_Test Company\", \"total_monthly_sales\"\n\t\t)\n\n\t\tsi = create_sales_invoice()\n\t\tcurrent_month_sales = frappe.get_cached_value(\"Company\", \"_Test Company\", \"total_monthly_sales\")\n\t\tself.assertEqual(current_month_sales, existing_current_month_sales + si.base_grand_total)\n\n\t\tsi.cancel()\n\t\tcurrent_month_sales = frappe.get_cached_value(\"Company\", \"_Test Company\", \"total_monthly_sales\")\n\t\tself.assertEqual(current_month_sales, existing_current_month_sales)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_rounding_adjustment": {
      "name": "test_rounding_adjustment",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_rounding_adjustment(self):\n\t\tsi = create_sales_invoice(rate=24900, do_not_save=True)\n\t\tfor tax in [\"Tax 1\", \"Tax2\"]:\n\t\t\tsi.append(\n\t\t\t\t\"taxes\",\n\t\t\t\t{\n\t\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\t\"account_head\": \"_Test Account Service Tax - _TC\",\n\t\t\t\t\t\"description\": tax,\n\t\t\t\t\t\"rate\": 14,\n\t\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\t\"included_in_print_rate\": 1,\n\t\t\t\t},\n\t\t\t)\n\t\tsi.save()\n\t\tsi.submit()\n\t\tself.assertEqual(si.net_total, 19453.12)\n\t\tself.assertEqual(si.grand_total, 24900)\n\t\tself.assertEqual(si.total_taxes_and_charges, 5446.88)\n\t\tself.assertEqual(si.rounding_adjustment, 0.0)\n\n\t\texpected_values = dict(\n\t\t\t(d[0], d)\n\t\t\tfor d in [\n\t\t\t\t[si.debit_to, 24900, 0.0],\n\t\t\t\t[\"_Test Account Service Tax - _TC\", 0.0, 5446.88],\n\t\t\t\t[\"Sales - _TC\", 0.0, 19453.12],\n\t\t\t\t[\"Round Off - _TC\", 0.01, 0.0],\n\t\t\t]\n\t\t)\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, debit, credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tfor gle in gl_entries:\n\t\t\tself.assertEqual(expected_values[gle.account][0], gle.account)\n\t\t\tself.assertEqual(expected_values[gle.account][1], gle.debit)\n\t\t\tself.assertEqual(expected_values[gle.account][2], gle.credit)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_rounding_adjustment_2": {
      "name": "test_rounding_adjustment_2",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_rounding_adjustment_2(self):\n\t\tsi = create_sales_invoice(rate=400, do_not_save=True)\n\t\tfor rate in [400.25, 600.30, 100.65]:\n\t\t\tsi.append(\n\t\t\t\t\"items\",\n\t\t\t\t{\n\t\t\t\t\t\"item_code\": \"_Test Item\",\n\t\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t\t\t\"qty\": 1,\n\t\t\t\t\t\"rate\": rate,\n\t\t\t\t\t\"income_account\": \"Sales - _TC\",\n\t\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t},\n\t\t\t)\n\t\tfor tax_account in [\"_Test Account VAT - _TC\", \"_Test Account Service Tax - _TC\"]:\n\t\t\tsi.append(\n\t\t\t\t\"taxes\",\n\t\t\t\t{\n\t\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\t\"account_head\": tax_account,\n\t\t\t\t\t\"description\": tax_account,\n\t\t\t\t\t\"rate\": 9,\n\t\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\t\"included_in_print_rate\": 1,\n\t\t\t\t},\n\t\t\t)\n\t\tsi.save()\n\t\tsi.submit()\n\t\tself.assertEqual(si.net_total, si.base_net_total)\n\t\tself.assertEqual(si.net_total, 1272.20)\n\t\tself.assertEqual(si.grand_total, 1501.20)\n\t\tself.assertEqual(si.total_taxes_and_charges, 229)\n\t\tself.assertEqual(si.rounding_adjustment, -0.20)\n\n\t\tround_off_account = frappe.get_cached_value(\"Company\", \"_Test Company\", \"round_off_account\")\n\t\texpected_values = {\n\t\t\t\"_Test Account Service Tax - _TC\": [0.0, 114.50],\n\t\t\t\"_Test Account VAT - _TC\": [0.0, 114.50],\n\t\t\tsi.debit_to: [1501, 0.0],\n\t\t\tround_off_account: [0.20, 0.0],\n\t\t\t\"Sales - _TC\": [0.0, 1272.20],\n\t\t}\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, sum(debit) as debit, sum(credit) as credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\tgroup by account\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tfor gle in gl_entries:\n\t\t\texpected_account_values = expected_values[gle.account]\n\t\t\tself.assertEqual(expected_account_values[0], gle.debit)\n\t\t\tself.assertEqual(expected_account_values[1], gle.credit)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_rounding_adjustment_3": {
      "name": "test_rounding_adjustment_3",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_rounding_adjustment_3(self):\n\t\tfrom erpnext.accounts.doctype.accounting_dimension.test_accounting_dimension import create_dimension\n\n\t\t# Dimension creates custom field, which does an implicit DB commit as it is a DDL command\n\t\t# Ensure dimension don't have any mandatory fields\n\t\tcreate_dimension()\n\n\t\t# rollback from tearDown() happens till here\n\t\tsi = create_sales_invoice(do_not_save=True)\n\t\tsi.items = []\n\t\tfor d in [(1122, 2), (1122.01, 1), (1122.01, 1)]:\n\t\t\tsi.append(\n\t\t\t\t\"items\",\n\t\t\t\t{\n\t\t\t\t\t\"item_code\": \"_Test Item\",\n\t\t\t\t\t\"gst_hsn_code\": \"999800\",\n\t\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t\t\t\"qty\": d[1],\n\t\t\t\t\t\"rate\": d[0],\n\t\t\t\t\t\"income_account\": \"Sales - _TC\",\n\t\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t},\n\t\t\t)\n\t\tfor tax_account in [\"_Test Account VAT - _TC\", \"_Test Account Service Tax - _TC\"]:\n\t\t\tsi.append(\n\t\t\t\t\"taxes\",\n\t\t\t\t{\n\t\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\t\"account_head\": tax_account,\n\t\t\t\t\t\"description\": tax_account,\n\t\t\t\t\t\"rate\": 6,\n\t\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\t\"included_in_print_rate\": 1,\n\t\t\t\t},\n\t\t\t)\n\n\t\tsi.cost_center = \"_Test Cost Center 2 - _TC\"\n\t\tsi.location = \"Block 1\"\n\n\t\tsi.save()\n\t\tsi.submit()\n\t\tself.assertEqual(si.net_total, si.base_net_total)\n\t\tself.assertEqual(si.net_total, 4007.15)\n\t\tself.assertEqual(si.grand_total, 4488.02)\n\t\tself.assertEqual(si.total_taxes_and_charges, 480.86)\n\t\tself.assertEqual(si.rounding_adjustment, -0.02)\n\n\t\tround_off_account = frappe.get_cached_value(\"Company\", \"_Test Company\", \"round_off_account\")\n\t\texpected_values = dict(\n\t\t\t(d[0], d)\n\t\t\tfor d in [\n\t\t\t\t[si.debit_to, 4488.0, 0.0],\n\t\t\t\t[\"_Test Account Service Tax - _TC\", 0.0, 240.43],\n\t\t\t\t[\"_Test Account VAT - _TC\", 0.0, 240.43],\n\t\t\t\t[\"Sales - _TC\", 0.0, 4007.15],\n\t\t\t\t[round_off_account, 0.01, 0.0],\n\t\t\t]\n\t\t)\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, sum(debit) as debit, sum(credit) as credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\tgroup by account\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tdebit_credit_diff = 0\n\t\tfor gle in gl_entries:\n\t\t\tself.assertEqual(expected_values[gle.account][0], gle.account)\n\t\t\tself.assertEqual(expected_values[gle.account][1], gle.debit)\n\t\t\tself.assertEqual(expected_values[gle.account][2], gle.credit)\n\t\t\tdebit_credit_diff += gle.debit - gle.credit\n\n\t\tself.assertEqual(debit_credit_diff, 0)\n\n\t\tround_off_gle = frappe.db.get_value(\n\t\t\t\"GL Entry\",\n\t\t\t{\"voucher_type\": \"Sales Invoice\", \"voucher_no\": si.name, \"account\": \"Round Off - _TC\"},\n\t\t\t[\"cost_center\", \"location\"],\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tif round_off_gle:\n\t\t\tself.assertEqual(round_off_gle.cost_center, \"_Test Cost Center 2 - _TC\")\n\t\t\tself.assertEqual(round_off_gle.location, \"Block 1\")"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_with_shipping_rule": {
      "name": "test_sales_invoice_with_shipping_rule",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_with_shipping_rule(self):\n\t\tfrom erpnext.accounts.doctype.shipping_rule.test_shipping_rule import create_shipping_rule\n\n\t\tshipping_rule = create_shipping_rule(\n\t\t\tshipping_rule_type=\"Selling\", shipping_rule_name=\"Shipping Rule - Sales Invoice Test\"\n\t\t)\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\n\t\tsi.shipping_rule = shipping_rule.name\n\t\tsi.insert()\n\t\tsi.save()\n\n\t\tself.assertEqual(si.net_total, 1250)\n\n\t\tself.assertEqual(si.total_taxes_and_charges, 468.85)\n\t\tself.assertEqual(si.grand_total, 1718.85)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_create_invoice_without_terms": {
      "name": "test_create_invoice_without_terms",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_create_invoice_without_terms(self):\n\t\tsi = create_sales_invoice(do_not_save=1)\n\t\tself.assertFalse(si.get(\"payment_schedule\"))\n\n\t\tsi.insert()\n\t\tself.assertTrue(si.get(\"payment_schedule\"))"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_duplicate_due_date_in_terms": {
      "name": "test_duplicate_due_date_in_terms",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_duplicate_due_date_in_terms(self):\n\t\tsi = create_sales_invoice(do_not_save=1)\n\t\tsi.append(\"payment_schedule\", dict(due_date=\"2017-01-01\", invoice_portion=50.00, payment_amount=50))\n\t\tsi.append(\"payment_schedule\", dict(due_date=\"2017-01-01\", invoice_portion=50.00, payment_amount=50))\n\n\t\tself.assertRaises(frappe.ValidationError, si.insert)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_credit_note": {
      "name": "test_credit_note",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_credit_note(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import get_payment_entry\n\n\t\tsi = create_sales_invoice(item_code=\"_Test Item\", qty=(5 * -1), rate=500, is_return=1)\n\n\t\toutstanding_amount = get_outstanding_amount(\n\t\t\tsi.doctype, si.name, \"Debtors - _TC\", si.customer, \"Customer\"\n\t\t)\n\n\t\tself.assertEqual(si.outstanding_amount, outstanding_amount)\n\n\t\tpe = get_payment_entry(\"Sales Invoice\", si.name, bank_account=\"_Test Bank - _TC\")\n\t\tpe.reference_no = \"1\"\n\t\tpe.reference_date = nowdate()\n\t\tpe.paid_from_account_currency = si.currency\n\t\tpe.paid_to_account_currency = si.currency\n\t\tpe.source_exchange_rate = 1\n\t\tpe.target_exchange_rate = 1\n\t\tpe.paid_amount = si.grand_total * -1\n\t\tpe.insert()\n\t\tpe.submit()\n\n\t\tsi_doc = frappe.get_doc(\"Sales Invoice\", si.name)\n\t\tself.assertEqual(si_doc.outstanding_amount, 0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_with_cost_center": {
      "name": "test_sales_invoice_with_cost_center",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_with_cost_center(self):\n\t\tfrom erpnext.accounts.doctype.cost_center.test_cost_center import create_cost_center\n\n\t\tcost_center = \"_Test Cost Center for BS Account - _TC\"\n\t\tcreate_cost_center(cost_center_name=\"_Test Cost Center for BS Account\", company=\"_Test Company\")\n\n\t\tsi = create_sales_invoice_against_cost_center(cost_center=cost_center, debit_to=\"Debtors - _TC\")\n\t\tself.assertEqual(si.cost_center, cost_center)\n\n\t\texpected_values = {\n\t\t\t\"Debtors - _TC\": {\"cost_center\": cost_center},\n\t\t\t\"Sales - _TC\": {\"cost_center\": cost_center},\n\t\t}\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, cost_center, account_currency, debit, credit,\n\t\t\tdebit_in_account_currency, credit_in_account_currency\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tself.assertTrue(gl_entries)\n\n\t\tfor gle in gl_entries:\n\t\t\tself.assertEqual(expected_values[gle.account][\"cost_center\"], gle.cost_center)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_with_project_link": {
      "name": "test_sales_invoice_with_project_link",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_with_project_link(self):\n\t\tfrom erpnext.projects.doctype.project.test_project import make_project\n\n\t\tproject = make_project(\n\t\t\t{\n\t\t\t\t\"project_name\": \"Sales Invoice Project\",\n\t\t\t\t\"project_template_name\": \"Test Project Template\",\n\t\t\t\t\"start_date\": \"2020-01-01\",\n\t\t\t}\n\t\t)\n\t\titem_project = make_project(\n\t\t\t{\n\t\t\t\t\"project_name\": \"Sales Invoice Item Project\",\n\t\t\t\t\"project_template_name\": \"Test Project Template\",\n\t\t\t\t\"start_date\": \"2019-06-01\",\n\t\t\t}\n\t\t)\n\n\t\tsales_invoice = create_sales_invoice(do_not_save=1)\n\t\tsales_invoice.items[0].project = item_project.name\n\t\tsales_invoice.project = project.name\n\n\t\tsales_invoice.submit()\n\n\t\texpected_values = {\n\t\t\t\"Debtors - _TC\": {\"project\": project.name},\n\t\t\t\"Sales - _TC\": {\"project\": item_project.name},\n\t\t}\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, cost_center, project, account_currency, debit, credit,\n\t\t\tdebit_in_account_currency, credit_in_account_currency\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsales_invoice.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tself.assertTrue(gl_entries)\n\n\t\tfor gle in gl_entries:\n\t\t\tself.assertEqual(expected_values[gle.account][\"project\"], gle.project)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_without_cost_center": {
      "name": "test_sales_invoice_without_cost_center",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_without_cost_center(self):\n\t\tcost_center = \"_Test Cost Center - _TC\"\n\t\tsi = create_sales_invoice(debit_to=\"Debtors - _TC\")\n\n\t\texpected_values = {\n\t\t\t\"Debtors - _TC\": {\"cost_center\": None},\n\t\t\t\"Sales - _TC\": {\"cost_center\": cost_center},\n\t\t}\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, cost_center, account_currency, debit, credit,\n\t\t\tdebit_in_account_currency, credit_in_account_currency\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tself.assertTrue(gl_entries)\n\n\t\tfor gle in gl_entries:\n\t\t\tself.assertEqual(expected_values[gle.account][\"cost_center\"], gle.cost_center)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_deferred_revenue": {
      "name": "test_deferred_revenue",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_deferred_revenue(self):\n\t\tdeferred_account = create_account(\n\t\t\taccount_name=\"Deferred Revenue\",\n\t\t\tparent_account=\"Current Liabilities - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\titem = create_item(\"_Test Item for Deferred Accounting\")\n\t\titem.enable_deferred_revenue = 1\n\t\titem.item_defaults[0].deferred_revenue_account = deferred_account\n\t\titem.no_of_months = 12\n\t\titem.save()\n\n\t\tsi = create_sales_invoice(item=item.name, posting_date=\"2019-01-10\", do_not_submit=True)\n\t\tsi.items[0].enable_deferred_revenue = 1\n\t\tsi.items[0].service_start_date = \"2019-01-10\"\n\t\tsi.items[0].service_end_date = \"2019-03-15\"\n\t\tsi.items[0].deferred_revenue_account = deferred_account\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\tpda1 = frappe.get_doc(\n\t\t\tdoctype=\"Process Deferred Accounting\",\n\t\t\tposting_date=nowdate(),\n\t\t\tstart_date=\"2019-01-01\",\n\t\t\tend_date=\"2019-03-31\",\n\t\t\ttype=\"Income\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\tpda1.insert()\n\t\tpda1.submit()\n\n\t\texpected_gle = [\n\t\t\t[deferred_account, 33.85, 0.0, \"2019-01-31\"],\n\t\t\t[\"Sales - _TC\", 0.0, 33.85, \"2019-01-31\"],\n\t\t\t[deferred_account, 43.08, 0.0, \"2019-02-28\"],\n\t\t\t[\"Sales - _TC\", 0.0, 43.08, \"2019-02-28\"],\n\t\t\t[deferred_account, 23.07, 0.0, \"2019-03-15\"],\n\t\t\t[\"Sales - _TC\", 0.0, 23.07, \"2019-03-15\"],\n\t\t]\n\n\t\tcheck_gl_entries(self, si.name, expected_gle, \"2019-01-30\")"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_deferred_revenue_missing_account": {
      "name": "test_deferred_revenue_missing_account",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_deferred_revenue_missing_account(self):\n\t\tsi = create_sales_invoice(posting_date=\"2019-01-10\", do_not_submit=True)\n\t\tsi.items[0].enable_deferred_revenue = 1\n\t\tsi.items[0].service_start_date = \"2019-01-10\"\n\t\tsi.items[0].service_end_date = \"2019-03-15\"\n\n\t\tself.assertRaises(frappe.ValidationError, si.save)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_fixed_deferred_revenue": {
      "name": "test_fixed_deferred_revenue",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_fixed_deferred_revenue(self):\n\t\tdeferred_account = create_account(\n\t\t\taccount_name=\"Deferred Revenue\",\n\t\t\tparent_account=\"Current Liabilities - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\titem = create_item(\"_Test Item for Deferred Accounting\")\n\t\titem.enable_deferred_revenue = 1\n\t\titem.deferred_revenue_account = deferred_account\n\t\titem.no_of_months = 12\n\t\titem.save()\n\n\t\tsi = create_sales_invoice(item=item.name, posting_date=\"2019-01-16\", rate=50000, do_not_submit=True)\n\t\tsi.items[0].enable_deferred_revenue = 1\n\t\tsi.items[0].service_start_date = \"2019-01-16\"\n\t\tsi.items[0].service_end_date = \"2019-03-31\"\n\t\tsi.items[0].deferred_revenue_account = deferred_account\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\tpda1 = frappe.get_doc(\n\t\t\tdoctype=\"Process Deferred Accounting\",\n\t\t\tposting_date=\"2019-03-31\",\n\t\t\tstart_date=\"2019-01-01\",\n\t\t\tend_date=\"2019-03-31\",\n\t\t\ttype=\"Income\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\tpda1.insert()\n\t\tpda1.submit()\n\n\t\texpected_gle = [\n\t\t\t[deferred_account, 10000.0, 0.0, \"2019-01-31\"],\n\t\t\t[\"Sales - _TC\", 0.0, 10000.0, \"2019-01-31\"],\n\t\t\t[deferred_account, 20000.0, 0.0, \"2019-02-28\"],\n\t\t\t[\"Sales - _TC\", 0.0, 20000.0, \"2019-02-28\"],\n\t\t\t[deferred_account, 20000.0, 0.0, \"2019-03-31\"],\n\t\t\t[\"Sales - _TC\", 0.0, 20000.0, \"2019-03-31\"],\n\t\t]\n\n\t\tcheck_gl_entries(self, si.name, expected_gle, \"2019-01-30\")"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_validate_inter_company_transaction_address_links": {
      "name": "test_validate_inter_company_transaction_address_links",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_validate_inter_company_transaction_address_links(self):\n\t\tdef _validate_address_link(address, link_doctype, link_name):\n\t\t\treturn frappe.db.get_value(\n\t\t\t\t\"Dynamic Link\",\n\t\t\t\t{\n\t\t\t\t\t\"parent\": address,\n\t\t\t\t\t\"parenttype\": \"Address\",\n\t\t\t\t\t\"link_doctype\": link_doctype,\n\t\t\t\t\t\"link_name\": link_name,\n\t\t\t\t},\n\t\t\t\t\"parent\",\n\t\t\t)\n\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=\"Wind Power LLC\",\n\t\t\tcustomer=\"_Test Internal Customer\",\n\t\t\tdebit_to=\"Debtors - WP\",\n\t\t\twarehouse=\"Stores - WP\",\n\t\t\tincome_account=\"Sales - WP\",\n\t\t\texpense_account=\"Cost of Goods Sold - WP\",\n\t\t\tcost_center=\"Main - WP\",\n\t\t\tcurrency=\"USD\",\n\t\t\tdo_not_save=1,\n\t\t)\n\n\t\tsi.selling_price_list = \"_Test Price List Rest of the World\"\n\t\tsi.submit()\n\n\t\ttarget_doc = make_inter_company_transaction(\"Sales Invoice\", si.name)\n\t\ttarget_doc.items[0].update(\n\t\t\t{\n\t\t\t\t\"expense_account\": \"Cost of Goods Sold - _TC1\",\n\t\t\t\t\"cost_center\": \"Main - _TC1\",\n\t\t\t\t\"warehouse\": \"Stores - _TC1\",\n\t\t\t}\n\t\t)\n\t\ttarget_doc.save()\n\n\t\tif target_doc.doctype in [\"Purchase Invoice\", \"Purchase Order\"]:\n\t\t\tfor details in [\n\t\t\t\t(\"supplier_address\", \"Supplier\", target_doc.supplier),\n\t\t\t\t(\"dispatch_address\", \"Company\", target_doc.company),\n\t\t\t\t(\"shipping_address\", \"Company\", target_doc.company),\n\t\t\t\t(\"billing_address\", \"Company\", target_doc.company),\n\t\t\t]:\n\t\t\t\tif address := target_doc.get(details[0]):\n\t\t\t\t\tself.assertEqual(address, _validate_address_link(address, details[1], details[2]))\n\t\telse:\n\t\t\tfor details in [\n\t\t\t\t(\"company_address\", \"Company\", target_doc.company),\n\t\t\t\t(\"shipping_address_name\", \"Customer\", target_doc.customer),\n\t\t\t\t(\"customer_address\", \"Customer\", target_doc.customer),\n\t\t\t]:\n\t\t\t\tif address := target_doc.get(details[0]):\n\t\t\t\t\tself.assertEqual(address, _validate_address_link(address, details[1], details[2]))"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::_validate_address_link": {
      "name": "_validate_address_link",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\t\tdef _validate_address_link(address, link_doctype, link_name):\n\t\t\treturn frappe.db.get_value(\n\t\t\t\t\"Dynamic Link\",\n\t\t\t\t{\n\t\t\t\t\t\"parent\": address,\n\t\t\t\t\t\"parenttype\": \"Address\",\n\t\t\t\t\t\"link_doctype\": link_doctype,\n\t\t\t\t\t\"link_name\": link_name,\n\t\t\t\t},\n\t\t\t\t\"parent\",\n\t\t\t)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_inter_company_transaction": {
      "name": "test_inter_company_transaction",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_inter_company_transaction(self):\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=\"Wind Power LLC\",\n\t\t\tcustomer=\"_Test Internal Customer\",\n\t\t\tdebit_to=\"Debtors - WP\",\n\t\t\twarehouse=\"Stores - WP\",\n\t\t\tincome_account=\"Sales - WP\",\n\t\t\texpense_account=\"Cost of Goods Sold - WP\",\n\t\t\tcost_center=\"Main - WP\",\n\t\t\tcurrency=\"USD\",\n\t\t\tdo_not_save=1,\n\t\t)\n\n\t\tsi.selling_price_list = \"_Test Price List Rest of the World\"\n\t\tsi.submit()\n\n\t\ttarget_doc = make_inter_company_transaction(\"Sales Invoice\", si.name)\n\t\ttarget_doc.items[0].update(\n\t\t\t{\n\t\t\t\t\"expense_account\": \"Cost of Goods Sold - _TC1\",\n\t\t\t\t\"cost_center\": \"Main - _TC1\",\n\t\t\t\t\"warehouse\": \"Stores - _TC1\",\n\t\t\t}\n\t\t)\n\t\ttarget_doc.submit()\n\n\t\tself.assertEqual(target_doc.company, \"_Test Company 1\")\n\t\tself.assertEqual(target_doc.supplier, \"_Test Internal Supplier\")"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_inter_company_transaction_without_default_warehouse": {
      "name": "test_inter_company_transaction_without_default_warehouse",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_inter_company_transaction_without_default_warehouse(self):\n\t\t\"Check mapping (expense account) of inter company SI to PI in absence of default warehouse.\"\n\t\t# setup\n\t\told_negative_stock = frappe.db.get_single_value(\"Stock Settings\", \"allow_negative_stock\")\n\t\tfrappe.db.set_single_value(\"Stock Settings\", \"allow_negative_stock\", 1)\n\n\t\told_perpetual_inventory = erpnext.is_perpetual_inventory_enabled(\"_Test Company 1\")\n\t\tfrappe.local.enable_perpetual_inventory[\"_Test Company 1\"] = 1\n\n\t\tfrappe.db.set_value(\n\t\t\t\"Company\",\n\t\t\t\"_Test Company 1\",\n\t\t\t\"stock_received_but_not_billed\",\n\t\t\t\"Stock Received But Not Billed - _TC1\",\n\t\t)\n\n\t\t# begin test\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=\"Wind Power LLC\",\n\t\t\tcustomer=\"_Test Internal Customer\",\n\t\t\tdebit_to=\"Debtors - WP\",\n\t\t\twarehouse=\"Stores - WP\",\n\t\t\tincome_account=\"Sales - WP\",\n\t\t\texpense_account=\"Cost of Goods Sold - WP\",\n\t\t\tcost_center=\"Main - WP\",\n\t\t\tcurrency=\"USD\",\n\t\t\tupdate_stock=1,\n\t\t\tdo_not_save=1,\n\t\t)\n\t\tsi.selling_price_list = \"_Test Price List Rest of the World\"\n\t\tsi.submit()\n\n\t\ttarget_doc = make_inter_company_transaction(\"Sales Invoice\", si.name)\n\n\t\t# in absence of warehouse Stock Received But Not Billed is set as expense account while mapping\n\t\t# mapping is not obstructed\n\t\tself.assertIsNone(target_doc.items[0].warehouse)\n\t\tself.assertEqual(target_doc.items[0].expense_account, \"Stock Received But Not Billed - _TC1\")\n\n\t\ttarget_doc.items[0].update({\"cost_center\": \"Main - _TC1\"})\n\n\t\t# missing warehouse is validated on save, after mapping\n\t\tself.assertRaises(WarehouseMissingError, target_doc.save)\n\n\t\ttarget_doc.items[0].update({\"warehouse\": \"Stores - _TC1\"})\n\t\ttarget_doc.save()\n\n\t\t# after warehouse is set, linked account or default inventory account is set\n\t\tself.assertEqual(target_doc.items[0].expense_account, \"Stock In Hand - _TC1\")\n\n\t\t# tear down\n\t\tfrappe.local.enable_perpetual_inventory[\"_Test Company 1\"] = old_perpetual_inventory\n\t\tfrappe.db.set_single_value(\"Stock Settings\", \"allow_negative_stock\", old_negative_stock)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sle_for_target_warehouse": {
      "name": "test_sle_for_target_warehouse",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sle_for_target_warehouse(self):\n\t\tse = make_stock_entry(\n\t\t\titem_code=\"138-CMS Shoe\",\n\t\t\ttarget=\"Finished Goods - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\tqty=1,\n\t\t\tbasic_rate=500,\n\t\t)\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.customer = \"_Test Internal Customer 3\"\n\t\tsi.update_stock = 1\n\t\tsi.set_warehouse = \"Finished Goods - _TC\"\n\t\tsi.set_target_warehouse = \"Stores - _TC\"\n\t\tsi.get(\"items\")[0].warehouse = \"Finished Goods - _TC\"\n\t\tsi.get(\"items\")[0].target_warehouse = \"Stores - _TC\"\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tsles = frappe.get_all(\n\t\t\t\"Stock Ledger Entry\", filters={\"voucher_no\": si.name}, fields=[\"name\", \"actual_qty\"]\n\t\t)\n\n\t\t# check if both SLEs are created\n\t\tself.assertEqual(len(sles), 2)\n\t\tself.assertEqual(sum(d.actual_qty for d in sles), 0.0)\n\n\t\t# tear down\n\t\tsi.cancel()\n\t\tse.cancel()"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_internal_transfer_gl_entry": {
      "name": "test_internal_transfer_gl_entry",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_internal_transfer_gl_entry(self):\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tcustomer=\"_Test Internal Customer 2\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\tcurrency=\"INR\",\n\t\t\tdo_not_save=1,\n\t\t)\n\n\t\tsi.selling_price_list = \"_Test Price List Rest of the World\"\n\t\tsi.update_stock = 1\n\t\tsi.items[0].target_warehouse = \"Work In Progress - TCP1\"\n\n\t\t# Add stock to stores for successful stock transfer\n\t\tmake_stock_entry(\n\t\t\ttarget=\"Stores - TCP1\", company=\"_Test Company with perpetual inventory\", qty=1, basic_rate=100\n\t\t)\n\n\t\tadd_taxes(si)\n\t\tsi.save()\n\n\t\trate = 0.0\n\t\tfor d in si.get(\"items\"):\n\t\t\trate = get_incoming_rate(\n\t\t\t\t{\n\t\t\t\t\t\"item_code\": d.item_code,\n\t\t\t\t\t\"warehouse\": d.warehouse,\n\t\t\t\t\t\"posting_date\": si.posting_date,\n\t\t\t\t\t\"posting_time\": si.posting_time,\n\t\t\t\t\t\"qty\": -1 * flt(d.get(\"stock_qty\")),\n\t\t\t\t\t\"serial_and_batch_bundle\": d.serial_and_batch_bundle,\n\t\t\t\t\t\"company\": si.company,\n\t\t\t\t\t\"voucher_type\": \"Sales Invoice\",\n\t\t\t\t\t\"voucher_no\": si.name,\n\t\t\t\t\t\"allow_zero_valuation\": d.get(\"allow_zero_valuation\"),\n\t\t\t\t\t\"voucher_detail_no\": d.name,\n\t\t\t\t},\n\t\t\t\traise_error_if_no_rate=False,\n\t\t\t)\n\n\t\t\trate = flt(rate, 2)\n\n\t\tsi.submit()\n\n\t\ttarget_doc = make_inter_company_transaction(\"Sales Invoice\", si.name)\n\t\ttarget_doc.company = \"_Test Company with perpetual inventory\"\n\t\ttarget_doc.items[0].warehouse = \"Finished Goods - TCP1\"\n\t\tadd_taxes(target_doc)\n\t\ttarget_doc.save()\n\t\ttarget_doc.submit()\n\n\t\ttax_amount = flt(rate * (12 / 100), 2)\n\t\tsi_gl_entries = [\n\t\t\t[\"_Test Account Excise Duty - TCP1\", 0.0, tax_amount, nowdate()],\n\t\t\t[\"Unrealized Profit - TCP1\", tax_amount, 0.0, nowdate()],\n\t\t]\n\n\t\tcheck_gl_entries(self, si.name, si_gl_entries, add_days(nowdate(), -1))\n\n\t\tpi_gl_entries = [\n\t\t\t[\"_Test Account Excise Duty - TCP1\", tax_amount, 0.0, nowdate()],\n\t\t\t[\"Unrealized Profit - TCP1\", 0.0, tax_amount, nowdate()],\n\t\t]\n\n\t\t# Sale and Purchase both should be at valuation rate\n\t\tself.assertEqual(si.items[0].rate, rate)\n\t\tself.assertEqual(target_doc.items[0].rate, rate)\n\n\t\tcheck_gl_entries(\n\t\t\tself, target_doc.name, pi_gl_entries, add_days(nowdate(), -1), voucher_type=\"Purchase Invoice\"\n\t\t)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_internal_transfer_gl_precision_issues": {
      "name": "test_internal_transfer_gl_precision_issues",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_internal_transfer_gl_precision_issues(self):\n\t\t# Make a stock queue of an item with two valuations\n\n\t\t# Remove all existing stock for this\n\t\tif get_stock_balance(\"_Test Internal Transfer Item\", \"Stores - TCP1\", \"2022-04-10\"):\n\t\t\tcreate_stock_reconciliation(\n\t\t\t\titem_code=\"_Test Internal Transfer Item\",\n\t\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\t\tqty=0,\n\t\t\t\trate=0,\n\t\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\t\texpense_account=\"Stock Adjustment - TCP1\"\n\t\t\t\tif frappe.get_all(\"Stock Ledger Entry\")\n\t\t\t\telse \"Temporary Opening - TCP1\",\n\t\t\t\tposting_date=\"2020-04-10\",\n\t\t\t\tposting_time=\"14:00\",\n\t\t\t)\n\n\t\tmake_stock_entry(\n\t\t\titem_code=\"_Test Internal Transfer Item\",\n\t\t\ttarget=\"Stores - TCP1\",\n\t\t\tqty=9000000,\n\t\t\tbasic_rate=52.0,\n\t\t\tposting_date=\"2020-04-10\",\n\t\t\tposting_time=\"14:00\",\n\t\t)\n\t\tmake_stock_entry(\n\t\t\titem_code=\"_Test Internal Transfer Item\",\n\t\t\ttarget=\"Stores - TCP1\",\n\t\t\tqty=60000000,\n\t\t\tbasic_rate=52.349777,\n\t\t\tposting_date=\"2020-04-10\",\n\t\t\tposting_time=\"14:00\",\n\t\t)\n\n\t\t# Make an internal transfer Sales Invoice Stock in non stock uom to check\n\t\t# for rounding errors while converting to stock uom\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tcustomer=\"_Test Internal Customer 2\",\n\t\t\titem_code=\"_Test Internal Transfer Item\",\n\t\t\tqty=5000000,\n\t\t\tuom=\"Box\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\tcurrency=\"INR\",\n\t\t\tdo_not_save=1,\n\t\t)\n\n\t\t# Check GL Entries with precision\n\t\tsi.update_stock = 1\n\t\tsi.items[0].target_warehouse = \"Work In Progress - TCP1\"\n\t\tsi.items[0].conversion_factor = 10\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\t# Check if adjustment entry is created\n\t\tself.assertTrue(\n\t\t\tfrappe.db.exists(\n\t\t\t\t\"GL Entry\",\n\t\t\t\t{\n\t\t\t\t\t\"voucher_type\": \"Sales Invoice\",\n\t\t\t\t\t\"voucher_no\": si.name,\n\t\t\t\t\t\"remarks\": \"Rounding gain/loss Entry for Stock Transfer\",\n\t\t\t\t},\n\t\t\t)\n\t\t)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_item_tax_net_range": {
      "name": "test_item_tax_net_range",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_item_tax_net_range(self):\n\t\titem = create_item(\"T Shirt\")\n\n\t\titem.set(\"taxes\", [])\n\t\titem.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"item_tax_template\": \"_Test Account Excise Duty @ 10 - _TC\",\n\t\t\t\t\"minimum_net_rate\": 0,\n\t\t\t\t\"maximum_net_rate\": 500,\n\t\t\t},\n\t\t)\n\n\t\titem.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"item_tax_template\": \"_Test Account Excise Duty @ 12 - _TC\",\n\t\t\t\t\"minimum_net_rate\": 501,\n\t\t\t\t\"maximum_net_rate\": 1000,\n\t\t\t},\n\t\t)\n\n\t\titem.save()\n\n\t\tsales_invoice = create_sales_invoice(item=\"T Shirt\", rate=700, do_not_submit=True)\n\t\titem_tax_map = get_item_tax_map(\n\t\t\tdoc=sales_invoice,\n\t\t\ttax_template=sales_invoice.items[0].item_tax_template,\n\t\t)\n\n\t\tself.assertEqual(sales_invoice.items[0].item_tax_template, \"_Test Account Excise Duty @ 12 - _TC\")\n\t\tself.assertEqual(sales_invoice.items[0].item_tax_rate, item_tax_map)\n\n\t\t# Apply discount\n\t\tsales_invoice.apply_discount_on = \"Net Total\"\n\t\tsales_invoice.discount_amount = 300\n\t\tsales_invoice.save()\n\n\t\titem_tax_map = get_item_tax_map(\n\t\t\tdoc=sales_invoice,\n\t\t\ttax_template=sales_invoice.items[0].item_tax_template,\n\t\t)\n\n\t\tself.assertEqual(sales_invoice.items[0].item_tax_template, \"_Test Account Excise Duty @ 10 - _TC\")\n\t\tself.assertEqual(sales_invoice.items[0].item_tax_rate, item_tax_map)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_with_discount_accounting_enabled": {
      "name": "test_sales_invoice_with_discount_accounting_enabled",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_with_discount_accounting_enabled(self):\n\t\tdiscount_account = create_account(\n\t\t\taccount_name=\"Discount Account\",\n\t\t\tparent_account=\"Indirect Expenses - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\t\tsi = create_sales_invoice(discount_account=discount_account, discount_percentage=10, rate=90)\n\n\t\texpected_gle = [\n\t\t\t[\"Debtors - _TC\", 90.0, 0.0, nowdate()],\n\t\t\t[\"Discount Account - _TC\", 10.0, 0.0, nowdate()],\n\t\t\t[\"Sales - _TC\", 0.0, 100.0, nowdate()],\n\t\t]\n\n\t\tcheck_gl_entries(self, si.name, expected_gle, add_days(nowdate(), -1))"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_additional_discount_for_sales_invoice_with_discount_accounting_enabled": {
      "name": "test_additional_discount_for_sales_invoice_with_discount_accounting_enabled",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_additional_discount_for_sales_invoice_with_discount_accounting_enabled(self):\n\t\tfrom erpnext.accounts.doctype.repost_accounting_ledger.test_repost_accounting_ledger import (\n\t\t\tupdate_repost_settings,\n\t\t)\n\n\t\tupdate_repost_settings()\n\n\t\tadditional_discount_account = create_account(\n\t\t\taccount_name=\"Discount Account\",\n\t\t\tparent_account=\"Indirect Expenses - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\tcreate_account(\n\t\t\taccount_name=\"TDS Payable\",\n\t\t\taccount_type=\"Tax\",\n\t\t\tparent_account=\"Duties and Taxes - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\tsi = create_sales_invoice(parent_cost_center=\"Main - _TC\", do_not_save=1)\n\t\tsi.apply_discount_on = \"Grand Total\"\n\t\tsi.additional_discount_account = additional_discount_account\n\t\tsi.additional_discount_percentage = 20\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"account_head\": \"_Test Account VAT - _TC\",\n\t\t\t\t\"cost_center\": \"Main - _TC\",\n\t\t\t\t\"description\": \"Test\",\n\t\t\t\t\"rate\": 10,\n\t\t\t},\n\t\t)\n\t\tsi.submit()\n\n\t\texpected_gle = [\n\t\t\t[\"_Test Account VAT - _TC\", 0.0, 10.0, nowdate()],\n\t\t\t[\"Debtors - _TC\", 88, 0.0, nowdate()],\n\t\t\t[\"Discount Account - _TC\", 22.0, 0.0, nowdate()],\n\t\t\t[\"Sales - _TC\", 0.0, 100.0, nowdate()],\n\t\t]\n\n\t\tcheck_gl_entries(self, si.name, expected_gle, add_days(nowdate(), -1))\n\n\t\t# Update Invoice post submit and then check GL Entries again\n\n\t\tsi.load_from_db()\n\t\tsi.items[0].income_account = \"Service - _TC\"\n\t\tsi.additional_discount_account = \"_Test Account Sales - _TC\"\n\t\tsi.taxes[0].account_head = \"TDS Payable - _TC\"\n\t\t# Ledger reposted implicitly upon 'Update After Submit'\n\t\tsi.save()\n\n\t\texpected_gle = [\n\t\t\t[\"_Test Account Sales - _TC\", 22.0, 0.0, nowdate()],\n\t\t\t[\"Debtors - _TC\", 88, 0.0, nowdate()],\n\t\t\t[\"Service - _TC\", 0.0, 100.0, nowdate()],\n\t\t\t[\"TDS Payable - _TC\", 0.0, 10.0, nowdate()],\n\t\t]\n\n\t\tcheck_gl_entries(self, si.name, expected_gle, add_days(nowdate(), -1))\n\n\t\t# cases where distributed discount amount is not set\n\t\tfrappe.db.set_value(\n\t\t\t\"Sales Invoice Item\",\n\t\t\t{\"name\": [\"in\", [d.name for d in si.items]]},\n\t\t\t\"distributed_discount_amount\",\n\t\t\t0,\n\t\t)\n\n\t\tsi.load_from_db()\n\t\tsi.additional_discount_account = additional_discount_account\n\t\t# Ledger reposted implicitly upon 'Update After Submit'\n\t\tsi.save()\n\n\t\texpected_gle = [\n\t\t\t[\"Debtors - _TC\", 88, 0.0, nowdate()],\n\t\t\t[\"Discount Account - _TC\", 22.0, 0.0, nowdate()],\n\t\t\t[\"Service - _TC\", 0.0, 100.0, nowdate()],\n\t\t\t[\"TDS Payable - _TC\", 0.0, 10.0, nowdate()],\n\t\t]\n\n\t\tcheck_gl_entries(self, si.name, expected_gle, add_days(nowdate(), -1))"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_asset_depreciation_on_sale_with_pro_rata": {
      "name": "test_asset_depreciation_on_sale_with_pro_rata",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_asset_depreciation_on_sale_with_pro_rata(self):\n\t\t\"\"\"\n\t\tTests if an Asset set to depreciate yearly on June 30, that gets sold on Sept 30, creates an additional depreciation entry on its date of sale.\n\t\t\"\"\"\n\n\t\tcreate_asset_data()\n\t\tasset = create_asset(item_code=\"Macbook Pro\", calculate_depreciation=1, submit=1)\n\t\tpost_depreciation_entries(getdate(\"2021-09-30\"))\n\n\t\tcreate_sales_invoice(\n\t\t\titem_code=\"Macbook Pro\", asset=asset.name, qty=1, rate=90000, posting_date=getdate(\"2021-09-30\")\n\t\t)\n\t\tasset.load_from_db()\n\n\t\texpected_values = [\n\t\t\t[\"2020-06-30\", 1366.12, 1366.12],\n\t\t\t[\"2021-06-30\", 20000.0, 21366.12],\n\t\t\t[\"2021-09-30\", 5041.34, 26407.46],\n\t\t]\n\n\t\tfor i, schedule in enumerate(get_depr_schedule(asset.name, \"Active\")):\n\t\t\tself.assertEqual(getdate(expected_values[i][0]), schedule.schedule_date)\n\t\t\tself.assertEqual(expected_values[i][1], schedule.depreciation_amount)\n\t\t\tself.assertEqual(expected_values[i][2], schedule.accumulated_depreciation_amount)\n\t\t\tself.assertTrue(schedule.journal_entry)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_asset_depreciation_on_sale_without_pro_rata": {
      "name": "test_asset_depreciation_on_sale_without_pro_rata",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_asset_depreciation_on_sale_without_pro_rata(self):\n\t\t\"\"\"\n\t\tTests if an Asset set to depreciate yearly on Dec 31, that gets sold on Dec 31 after two years, created an additional depreciation entry on its date of sale.\n\t\t\"\"\"\n\n\t\tcreate_asset_data()\n\t\tasset = create_asset(\n\t\t\titem_code=\"Macbook Pro\",\n\t\t\tcalculate_depreciation=1,\n\t\t\tavailable_for_use_date=getdate(\"2019-12-31\"),\n\t\t\ttotal_number_of_depreciations=3,\n\t\t\texpected_value_after_useful_life=10000,\n\t\t\tdepreciation_start_date=getdate(\"2020-12-31\"),\n\t\t\tsubmit=1,\n\t\t)\n\n\t\tpost_depreciation_entries(getdate(\"2021-09-30\"))\n\n\t\tcreate_sales_invoice(\n\t\t\titem_code=\"Macbook Pro\", asset=asset.name, qty=1, rate=90000, posting_date=getdate(\"2021-12-31\")\n\t\t)\n\t\tasset.load_from_db()\n\n\t\texpected_values = [[\"2020-12-31\", 30000, 30000], [\"2021-12-31\", 30041.15, 60041.15]]\n\n\t\tfor i, schedule in enumerate(get_depr_schedule(asset.name, \"Active\")):\n\t\t\tself.assertEqual(getdate(expected_values[i][0]), schedule.schedule_date)\n\t\t\tself.assertEqual(expected_values[i][1], schedule.depreciation_amount)\n\t\t\tself.assertEqual(expected_values[i][2], schedule.accumulated_depreciation_amount)\n\t\t\tself.assertTrue(schedule.journal_entry)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_against_supplier": {
      "name": "test_sales_invoice_against_supplier",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_against_supplier(self):\n\t\tfrom erpnext.accounts.doctype.opening_invoice_creation_tool.test_opening_invoice_creation_tool import (\n\t\t\tmake_customer,\n\t\t)\n\t\tfrom erpnext.accounts.doctype.party_link.party_link import create_party_link\n\t\tfrom erpnext.buying.doctype.supplier.test_supplier import create_supplier\n\n\t\t# create a customer\n\t\tcustomer = make_customer(customer=\"_Test Common Supplier\")\n\t\t# create a supplier\n\t\tsupplier = create_supplier(supplier_name=\"_Test Common Supplier\").name\n\n\t\t# create a party link between customer & supplier\n\t\tparty_link = create_party_link(\"Supplier\", supplier, customer)\n\n\t\t# enable common party accounting\n\t\tfrappe.db.set_single_value(\"Accounts Settings\", \"enable_common_party_accounting\", 1)\n\n\t\t# create a sales invoice\n\t\tsi = create_sales_invoice(customer=customer, parent_cost_center=\"_Test Cost Center - _TC\")\n\n\t\t# check outstanding of sales invoice\n\t\tsi.reload()\n\t\tself.assertEqual(si.status, \"Paid\")\n\t\tself.assertEqual(flt(si.outstanding_amount), 0.0)\n\n\t\t# check creation of journal entry\n\t\tjv = frappe.get_all(\n\t\t\t\"Journal Entry Account\",\n\t\t\t{\n\t\t\t\t\"account\": si.debit_to,\n\t\t\t\t\"party_type\": \"Customer\",\n\t\t\t\t\"party\": si.customer,\n\t\t\t\t\"reference_type\": si.doctype,\n\t\t\t\t\"reference_name\": si.name,\n\t\t\t},\n\t\t\tpluck=\"credit_in_account_currency\",\n\t\t)\n\n\t\tself.assertTrue(jv)\n\t\tself.assertEqual(jv[0], si.grand_total)\n\n\t\tparty_link.delete()\n\t\tfrappe.db.set_single_value(\"Accounts Settings\", \"enable_common_party_accounting\", 0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_against_supplier_usd_with_dimensions": {
      "name": "test_sales_invoice_against_supplier_usd_with_dimensions",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_against_supplier_usd_with_dimensions(self):\n\t\tfrom erpnext.accounts.doctype.opening_invoice_creation_tool.test_opening_invoice_creation_tool import (\n\t\t\tmake_customer,\n\t\t)\n\t\tfrom erpnext.accounts.doctype.party_link.party_link import create_party_link\n\t\tfrom erpnext.buying.doctype.supplier.test_supplier import create_supplier\n\n\t\t# create a customer\n\t\tcustomer = make_customer(customer=\"_Test Common Supplier USD\")\n\t\tcust_doc = frappe.get_doc(\"Customer\", customer)\n\t\tcust_doc.default_currency = \"USD\"\n\t\tcust_doc.save()\n\t\t# create a supplier\n\t\tsupplier = create_supplier(supplier_name=\"_Test Common Supplier USD\").name\n\t\tsupp_doc = frappe.get_doc(\"Supplier\", supplier)\n\t\tsupp_doc.default_currency = \"USD\"\n\t\tsupp_doc.save()\n\n\t\t# create a party link between customer & supplier\n\t\tparty_link = create_party_link(\"Supplier\", supplier, customer)\n\n\t\t# enable common party accounting\n\t\tfrappe.db.set_single_value(\"Accounts Settings\", \"enable_common_party_accounting\", 1)\n\n\t\t# create a dimension and make it mandatory\n\t\tif not frappe.get_all(\"Accounting Dimension\", filters={\"document_type\": \"Department\"}):\n\t\t\tdim = frappe.get_doc(\n\t\t\t\t{\n\t\t\t\t\t\"doctype\": \"Accounting Dimension\",\n\t\t\t\t\t\"document_type\": \"Department\",\n\t\t\t\t\t\"dimension_defaults\": [{\"company\": \"_Test Company\", \"mandatory_for_bs\": True}],\n\t\t\t\t}\n\t\t\t)\n\t\t\tdim.save()\n\t\telse:\n\t\t\tdim = frappe.get_doc(\n\t\t\t\t\"Accounting Dimension\",\n\t\t\t\tfrappe.get_all(\"Accounting Dimension\", filters={\"document_type\": \"Department\"})[0],\n\t\t\t)\n\t\t\tdim.disabled = False\n\t\t\tdim.dimension_defaults = []\n\t\t\tdim.append(\"dimension_defaults\", {\"company\": \"_Test Company\", \"mandatory_for_bs\": True})\n\t\t\tdim.save()\n\n\t\t# create a sales invoice\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=customer, parent_cost_center=\"_Test Cost Center - _TC\", do_not_submit=True\n\t\t)\n\t\tsi.department = \"All Departments\"\n\t\tsi.save().submit()\n\n\t\t# check outstanding of sales invoice\n\t\tsi.reload()\n\t\tself.assertEqual(si.status, \"Paid\")\n\t\tself.assertEqual(flt(si.outstanding_amount), 0.0)\n\n\t\t# check creation of journal entry\n\t\tjv = frappe.get_all(\n\t\t\t\"Journal Entry Account\",\n\t\t\t{\n\t\t\t\t\"account\": si.debit_to,\n\t\t\t\t\"party_type\": \"Customer\",\n\t\t\t\t\"party\": si.customer,\n\t\t\t\t\"reference_type\": si.doctype,\n\t\t\t\t\"reference_name\": si.name,\n\t\t\t\t\"department\": \"All Departments\",\n\t\t\t},\n\t\t\tpluck=\"credit_in_account_currency\",\n\t\t)\n\n\t\tself.assertTrue(jv)\n\t\tself.assertEqual(jv[0], si.grand_total)\n\n\t\tdim.disabled = True\n\t\tdim.save()\n\t\tparty_link.delete()\n\t\tfrappe.db.set_single_value(\"Accounts Settings\", \"enable_common_party_accounting\", 0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_cancel_with_common_party_advance_jv": {
      "name": "test_sales_invoice_cancel_with_common_party_advance_jv",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_cancel_with_common_party_advance_jv(self):\n\t\tfrom erpnext.accounts.doctype.opening_invoice_creation_tool.test_opening_invoice_creation_tool import (\n\t\t\tmake_customer,\n\t\t)\n\t\tfrom erpnext.accounts.doctype.party_link.party_link import create_party_link\n\t\tfrom erpnext.buying.doctype.supplier.test_supplier import create_supplier\n\n\t\t# create a customer\n\t\tcustomer = make_customer(customer=\"_Test Common Supplier\")\n\t\t# create a supplier\n\t\tsupplier = create_supplier(supplier_name=\"_Test Common Supplier\").name\n\n\t\t# create a party link between customer & supplier\n\t\tparty_link = create_party_link(\"Supplier\", supplier, customer)\n\n\t\t# enable common party accounting\n\t\tfrappe.db.set_single_value(\"Accounts Settings\", \"enable_common_party_accounting\", 1)\n\n\t\t# create a sales invoice\n\t\tsi = create_sales_invoice(customer=customer)\n\n\t\t# check creation of journal entry\n\t\tjv = frappe.db.get_value(\n\t\t\t\"Journal Entry Account\",\n\t\t\tfilters={\n\t\t\t\t\"reference_type\": si.doctype,\n\t\t\t\t\"reference_name\": si.name,\n\t\t\t\t\"docstatus\": 1,\n\t\t\t},\n\t\t\tfieldname=\"parent\",\n\t\t)\n\n\t\tself.assertTrue(jv)\n\n\t\t# cancel sales invoice\n\t\tsi.cancel()\n\n\t\t# check cancellation of journal entry\n\t\tjv_status = frappe.db.get_value(\"Journal Entry\", jv, \"docstatus\")\n\t\tself.assertEqual(jv_status, 2)\n\n\t\tparty_link.delete()\n\t\tfrappe.db.set_single_value(\"Accounts Settings\", \"enable_common_party_accounting\", 0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_payment_statuses": {
      "name": "test_payment_statuses",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_payment_statuses(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import get_payment_entry\n\n\t\ttoday = nowdate()\n\n\t\t# Test Overdue\n\t\tsi = create_sales_invoice(do_not_submit=True)\n\t\tsi.payment_schedule = []\n\t\tsi.append(\n\t\t\t\"payment_schedule\",\n\t\t\t{\"due_date\": add_days(today, -5), \"invoice_portion\": 50, \"payment_amount\": si.grand_total / 2},\n\t\t)\n\t\tsi.append(\n\t\t\t\"payment_schedule\",\n\t\t\t{\"due_date\": add_days(today, 5), \"invoice_portion\": 50, \"payment_amount\": si.grand_total / 2},\n\t\t)\n\t\tsi.submit()\n\t\tself.assertEqual(si.status, \"Overdue\")\n\n\t\t# Test payment less than due amount\n\t\tpe = get_payment_entry(\"Sales Invoice\", si.name, bank_account=\"_Test Bank - _TC\")\n\t\tpe.reference_no = \"1\"\n\t\tpe.reference_date = nowdate()\n\t\tpe.paid_amount = 1\n\t\tpe.references[0].allocated_amount = pe.paid_amount\n\t\tpe.submit()\n\t\tsi.reload()\n\t\tself.assertEqual(si.status, \"Overdue\")\n\n\t\t# Test Partly Paid\n\t\tpe = frappe.copy_doc(pe)\n\t\tpe.paid_amount = si.grand_total / 2\n\t\tpe.references[0].allocated_amount = pe.paid_amount\n\t\tpe.submit()\n\t\tsi.reload()\n\t\tself.assertEqual(si.status, \"Partly Paid\")\n\n\t\t# Test Paid\n\t\tpe = get_payment_entry(\"Sales Invoice\", si.name, bank_account=\"_Test Bank - _TC\")\n\t\tpe.reference_no = \"1\"\n\t\tpe.reference_date = nowdate()\n\t\tpe.paid_amount = si.outstanding_amount\n\t\tpe.submit()\n\t\tsi.reload()\n\t\tself.assertEqual(si.status, \"Paid\")"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_update_invoice_status": {
      "name": "test_update_invoice_status",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_update_invoice_status(self):\n\t\ttoday = nowdate()\n\n\t\t# Sales Invoice without Payment Schedule\n\t\tsi = create_sales_invoice(posting_date=add_days(today, -5))\n\n\t\t# Sales Invoice with Payment Schedule\n\t\tsi_with_payment_schedule = create_sales_invoice(do_not_submit=True)\n\t\tsi_with_payment_schedule.set(\n\t\t\t\"payment_schedule\",\n\t\t\t[\n\t\t\t\t{\n\t\t\t\t\t\"due_date\": add_days(today, -5),\n\t\t\t\t\t\"invoice_portion\": 50,\n\t\t\t\t\t\"payment_amount\": si_with_payment_schedule.grand_total / 2,\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"due_date\": add_days(today, 5),\n\t\t\t\t\t\"invoice_portion\": 50,\n\t\t\t\t\t\"payment_amount\": si_with_payment_schedule.grand_total / 2,\n\t\t\t\t},\n\t\t\t],\n\t\t)\n\t\tsi_with_payment_schedule.submit()\n\n\t\tfor invoice in (si, si_with_payment_schedule):\n\t\t\tinvoice.db_set(\"status\", \"Unpaid\")\n\t\t\tupdate_invoice_status()\n\t\t\tinvoice.reload()\n\t\t\tself.assertEqual(invoice.status, \"Overdue\")\n\n\t\t\tinvoice.db_set(\"status\", \"Unpaid and Discounted\")\n\t\t\tupdate_invoice_status()\n\t\t\tinvoice.reload()\n\t\t\tself.assertEqual(invoice.status, \"Overdue and Discounted\")"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_commission": {
      "name": "test_sales_commission",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_commission(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\n\t\tfrappe.db.set_value(\"Item\", si.get(\"items\")[0].item_code, \"grant_commission\", 1)\n\t\tfrappe.db.set_value(\"Item\", si.get(\"items\")[1].item_code, \"grant_commission\", 0)\n\n\t\titem = copy.deepcopy(si.get(\"items\")[0])\n\t\titem.update(\n\t\t\t{\n\t\t\t\t\"qty\": 1,\n\t\t\t\t\"rate\": 500,\n\t\t\t}\n\t\t)\n\n\t\titem = copy.deepcopy(si.get(\"items\")[1])\n\t\titem.update(\n\t\t\t{\n\t\t\t\t\"qty\": 1,\n\t\t\t\t\"rate\": 500,\n\t\t\t}\n\t\t)\n\n\t\t# Test valid values\n\t\tfor commission_rate, total_commission in ((0, 0), (10, 50), (100, 500)):\n\t\t\tsi.commission_rate = commission_rate\n\t\t\tsi.save()\n\t\t\tself.assertEqual(si.amount_eligible_for_commission, 500)\n\t\t\tself.assertEqual(si.total_commission, total_commission)\n\n\t\t# Test invalid values\n\t\tfor commission_rate in (101, -1):\n\t\t\tsi.reload()\n\t\t\tsi.commission_rate = commission_rate\n\t\t\tself.assertRaises(frappe.ValidationError, si.save)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_submission_post_account_freezing_date": {
      "name": "test_sales_invoice_submission_post_account_freezing_date",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_submission_post_account_freezing_date(self):\n\t\tfrappe.db.set_value(\"Company\", \"_Test Company\", \"accounts_frozen_till_date\", add_days(getdate(), 1))\n\t\tsi = create_sales_invoice(do_not_save=True)\n\t\tsi.posting_date = add_days(getdate(), 1)\n\t\tsi.save()\n\n\t\tself.assertRaises(frappe.ValidationError, si.submit)\n\t\tsi.posting_date = getdate()\n\t\tsi.submit()\n\t\tfrappe.db.set_value(\"Company\", \"_Test Company\", \"accounts_frozen_till_date\", None)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_over_billing_case_against_delivery_note": {
      "name": "test_over_billing_case_against_delivery_note",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_over_billing_case_against_delivery_note(self):\n\t\t\"\"\"\n\t\tTest a case where duplicating the item with qty = 1 in the invoice\n\t\tallows overbilling even if it is disabled\n\t\t\"\"\"\n\t\tfrom erpnext.stock.doctype.delivery_note.test_delivery_note import create_delivery_note\n\n\t\tdn = create_delivery_note()\n\t\tdn.submit()\n\n\t\tsi = make_sales_invoice(dn.name)\n\t\titem_copy = frappe.copy_doc(si.items[0])\n\t\tsi.save()\n\n\t\tsi.items = []  # Clear existing items\n\t\tsi.append(\"items\", item_copy)\n\t\tsi.save()\n\n\t\tsi.append(\"items\", item_copy)\n\t\twith self.assertRaises(frappe.ValidationError) as err:\n\t\t\tsi.save()\n\n\t\tself.assertTrue(\"cannot overbill\" in str(err.exception).lower())\n\t\tdn.cancel()"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_multi_currency_deferred_revenue_via_journal_entry": {
      "name": "test_multi_currency_deferred_revenue_via_journal_entry",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_multi_currency_deferred_revenue_via_journal_entry(self):\n\t\tdeferred_account = create_account(\n\t\t\taccount_name=\"Deferred Revenue\",\n\t\t\tparent_account=\"Current Liabilities - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\titem = create_item(\"_Test Item for Deferred Accounting\")\n\t\titem.enable_deferred_expense = 1\n\t\titem.item_defaults[0].deferred_revenue_account = deferred_account\n\t\titem.save()\n\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tcurrency=\"USD\",\n\t\t\titem=item.name,\n\t\t\tqty=1,\n\t\t\trate=100,\n\t\t\tconversion_rate=60,\n\t\t\tdo_not_save=True,\n\t\t)\n\n\t\tsi.set_posting_time = 1\n\t\tsi.posting_date = \"2019-01-01\"\n\t\tsi.debit_to = \"_Test Receivable USD - _TC\"\n\t\tsi.items[0].enable_deferred_revenue = 1\n\t\tsi.items[0].service_start_date = \"2019-01-01\"\n\t\tsi.items[0].service_end_date = \"2019-03-30\"\n\t\tsi.items[0].deferred_expense_account = deferred_account\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\tfrappe.db.set_value(\"Company\", \"_Test Company\", \"accounts_frozen_till_date\", getdate(\"2019-01-31\"))\n\n\t\tpda1 = frappe.get_doc(\n\t\t\tdoctype=\"Process Deferred Accounting\",\n\t\t\tposting_date=nowdate(),\n\t\t\tstart_date=\"2019-01-01\",\n\t\t\tend_date=\"2019-03-31\",\n\t\t\ttype=\"Income\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\tpda1.insert()\n\t\tpda1.submit()\n\n\t\texpected_gle = [\n\t\t\t[\"Sales - _TC\", 0.0, 2089.89, \"2019-01-28\"],\n\t\t\t[deferred_account, 2089.89, 0.0, \"2019-01-28\"],\n\t\t\t[\"Sales - _TC\", 0.0, 1887.64, \"2019-02-28\"],\n\t\t\t[deferred_account, 1887.64, 0.0, \"2019-02-28\"],\n\t\t\t[\"Sales - _TC\", 0.0, 2022.47, \"2019-03-15\"],\n\t\t\t[deferred_account, 2022.47, 0.0, \"2019-03-15\"],\n\t\t]\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, debit, credit, posting_date\n\t\t\tfrom `tabGL Entry`\n\t\t\twhere voucher_type='Journal Entry' and voucher_detail_no=%s and posting_date <= %s\n\t\t\torder by posting_date asc, account asc\"\"\",\n\t\t\t(si.items[0].name, si.posting_date),\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tfor i, gle in enumerate(gl_entries):\n\t\t\tself.assertEqual(expected_gle[i][0], gle.account)\n\t\t\tself.assertEqual(expected_gle[i][1], gle.credit)\n\t\t\tself.assertEqual(expected_gle[i][2], gle.debit)\n\t\t\tself.assertEqual(getdate(expected_gle[i][3]), gle.posting_date)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_standalone_serial_no_return": {
      "name": "test_standalone_serial_no_return",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_standalone_serial_no_return(self):\n\t\tsi = create_sales_invoice(\n\t\t\titem_code=\"_Test Serialized Item With Series\", update_stock=True, is_return=True, qty=-1\n\t\t)\n\t\tsi.reload()\n\t\tself.assertTrue(get_serial_nos_from_bundle(si.items[0].serial_and_batch_bundle))"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_with_disabled_account": {
      "name": "test_sales_invoice_with_disabled_account",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_with_disabled_account(self):\n\t\ttry:\n\t\t\taccount_name = \"Sales Expenses - _TC\"\n\t\t\taccount = frappe.get_doc(\"Account\", account_name)\n\t\t\taccount.disabled = 1\n\t\t\taccount.save()\n\n\t\t\tsi = create_sales_invoice(do_not_save=True)\n\t\t\tsi.posting_date = add_days(getdate(), 1)\n\t\t\tsi.taxes = []\n\n\t\t\tsi.append(\n\t\t\t\t\"taxes\",\n\t\t\t\t{\n\t\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\t\"account_head\": account_name,\n\t\t\t\t\t\"cost_center\": \"Main - _TC\",\n\t\t\t\t\t\"description\": \"Commission\",\n\t\t\t\t\t\"rate\": 5,\n\t\t\t\t},\n\t\t\t)\n\t\t\tsi.save()\n\n\t\t\twith self.assertRaises(frappe.ValidationError) as err:\n\t\t\t\tsi.submit()\n\n\t\t\tself.assertTrue(\n\t\t\t\t\"Cannot create accounting entries against disabled accounts\" in str(err.exception)\n\t\t\t)\n\n\t\tfinally:\n\t\t\taccount.disabled = 0\n\t\t\taccount.save()"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_gain_loss_with_advance_entry": {
      "name": "test_gain_loss_with_advance_entry",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_gain_loss_with_advance_entry(self):\n\t\tfrom erpnext.accounts.doctype.journal_entry.test_journal_entry import make_journal_entry\n\n\t\tjv = make_journal_entry(\"_Test Receivable USD - _TC\", \"_Test Bank - _TC\", -7000, save=False)\n\n\t\tjv.accounts[0].exchange_rate = 70\n\t\tjv.accounts[0].credit_in_account_currency = 100\n\t\tjv.accounts[0].party_type = \"Customer\"\n\t\tjv.accounts[0].party = \"_Test Customer USD\"\n\n\t\tjv.save()\n\t\tjv.submit()\n\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"_Test Receivable USD - _TC\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=75,\n\t\t\tdo_not_save=1,\n\t\t\trate=100,\n\t\t)\n\n\t\tsi.append(\n\t\t\t\"advances\",\n\t\t\t{\n\t\t\t\t\"reference_type\": \"Journal Entry\",\n\t\t\t\t\"reference_name\": jv.name,\n\t\t\t\t\"reference_row\": jv.accounts[0].name,\n\t\t\t\t\"advance_amount\": 100,\n\t\t\t\t\"allocated_amount\": 100,\n\t\t\t\t\"ref_exchange_rate\": 70,\n\t\t\t},\n\t\t)\n\t\tsi.save()\n\t\tsi.submit()\n\t\texpected_gle = [\n\t\t\t[\"_Test Receivable USD - _TC\", 7500.0, 0.0, nowdate()],\n\t\t\t[\"Sales - _TC\", 0.0, 7500.0, nowdate()],\n\t\t]\n\t\tcheck_gl_entries(self, si.name, expected_gle, nowdate())\n\n\t\tsi.reload()\n\t\tself.assertEqual(si.outstanding_amount, 0)\n\t\tjournals = frappe.db.get_all(\n\t\t\t\"Journal Entry Account\",\n\t\t\tfilters={\"reference_type\": \"Sales Invoice\", \"reference_name\": si.name, \"docstatus\": 1},\n\t\t\tpluck=\"parent\",\n\t\t)\n\t\tjournals = [x for x in journals if x != jv.name]\n\t\tself.assertEqual(len(journals), 1)\n\t\tje_type = frappe.get_cached_value(\"Journal Entry\", journals[0], \"voucher_type\")\n\t\tself.assertEqual(je_type, \"Exchange Gain Or Loss\")\n\t\tfrappe.db.get_all(\n\t\t\t\"Payment Ledger Entry\",\n\t\t\tfilters={\"against_voucher_no\": si.name, \"delinked\": 0},\n\t\t\tfields=[{\"SUM\": \"amount\"}, {\"SUM\": \"amount_in_account_currency\"}],\n\t\t\tas_list=1,\n\t\t)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_batch_expiry_for_sales_invoice_return": {
      "name": "test_batch_expiry_for_sales_invoice_return",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_batch_expiry_for_sales_invoice_return(self):\n\t\tfrom erpnext.controllers.sales_and_purchase_return import make_return_doc\n\t\tfrom erpnext.stock.doctype.item.test_item import make_item\n\n\t\titem = make_item(\n\t\t\t\"_Test Batch Item For Return Check\",\n\t\t\t{\n\t\t\t\t\"is_purchase_item\": 1,\n\t\t\t\t\"is_stock_item\": 1,\n\t\t\t\t\"has_batch_no\": 1,\n\t\t\t\t\"create_new_batch\": 1,\n\t\t\t\t\"batch_number_series\": \"TBIRC.#####\",\n\t\t\t},\n\t\t)\n\n\t\tpr = make_purchase_receipt(qty=1, item_code=item.name)\n\n\t\tbatch_no = get_batch_from_bundle(pr.items[0].serial_and_batch_bundle)\n\t\tsi = create_sales_invoice(qty=1, item_code=item.name, update_stock=1, batch_no=batch_no)\n\n\t\tsi.load_from_db()\n\t\tbatch_no = get_batch_from_bundle(si.items[0].serial_and_batch_bundle)\n\t\tself.assertTrue(batch_no)\n\n\t\tfrappe.db.set_value(\"Batch\", batch_no, \"expiry_date\", add_days(today(), -1))\n\n\t\treturn_si = make_return_doc(si.doctype, si.name)\n\t\treturn_si.save().submit()\n\n\t\tself.assertTrue(return_si.docstatus == 1)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_with_payable_tax_account": {
      "name": "test_sales_invoice_with_payable_tax_account",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_with_payable_tax_account(self):\n\t\tsi = create_sales_invoice(do_not_submit=True)\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Creditors - _TC\",\n\t\t\t\t\"description\": \"Test\",\n\t\t\t\t\"cost_center\": \"Main - _TC\",\n\t\t\t\t\"tax_amount\": 10,\n\t\t\t\t\"total\": 10,\n\t\t\t\t\"dont_recompute_tax\": 0,\n\t\t\t},\n\t\t)\n\t\tself.assertRaises(frappe.ValidationError, si.submit)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_advance_entries_as_liability": {
      "name": "test_advance_entries_as_liability",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_advance_entries_as_liability(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import create_payment_entry\n\n\t\tadvance_account = create_account(\n\t\t\tparent_account=\"Current Liabilities - _TC\",\n\t\t\taccount_name=\"Advances Received\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_type=\"Receivable\",\n\t\t)\n\n\t\tset_advance_flag(company=\"_Test Company\", flag=1, default_account=advance_account)\n\n\t\tpe = create_payment_entry(\n\t\t\tcompany=\"_Test Company\",\n\t\t\tpayment_type=\"Receive\",\n\t\t\tparty_type=\"Customer\",\n\t\t\tparty=\"_Test Customer\",\n\t\t\tpaid_from=advance_account,\n\t\t\tpaid_to=\"Cash - _TC\",\n\t\t\tpaid_amount=1000,\n\t\t)\n\t\tpe.submit()\n\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=\"_Test Company\",\n\t\t\tcustomer=\"_Test Customer\",\n\t\t\tdo_not_save=True,\n\t\t\tdo_not_submit=True,\n\t\t\trate=500,\n\t\t\tprice_list_rate=500,\n\t\t)\n\t\tsi.base_grand_total = 500\n\t\tsi.grand_total = 500\n\t\tsi.set_advances()\n\t\tfor advance in si.advances:\n\t\t\tadvance.allocated_amount = 500 if advance.reference_name == pe.name else 0\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\tself.assertEqual(si.advances[0].allocated_amount, 500)\n\n\t\t# Check GL Entry against payment doctype\n\t\texpected_gle = [\n\t\t\t[\"Advances Received - _TC\", 0.0, 1000.0, nowdate()],\n\t\t\t[\"Advances Received - _TC\", 500, 0.0, nowdate()],\n\t\t\t[\"Cash - _TC\", 1000, 0.0, nowdate()],\n\t\t\t[\"Debtors - _TC\", 0.0, 500, nowdate()],\n\t\t]\n\n\t\tcheck_gl_entries(self, pe.name, expected_gle, nowdate(), voucher_type=\"Payment Entry\")\n\n\t\tsi.load_from_db()\n\t\tself.assertEqual(si.outstanding_amount, 0)\n\n\t\tset_advance_flag(company=\"_Test Company\", flag=0, default_account=\"\")"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_invoice_without_customer_group_and_territory": {
      "name": "test_sales_invoice_without_customer_group_and_territory",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_invoice_without_customer_group_and_territory(self):\n\t\t# create a customer\n\t\tif not frappe.db.exists(\"Customer\", \"_Test Simple Customer\"):\n\t\t\tcustomer_dict = get_customer_dict(\"_Test Simple Customer\")\n\t\t\tcustomer_dict.pop(\"customer_group\")\n\t\t\tcustomer_dict.pop(\"territory\")\n\t\t\tcustomer = frappe.get_doc(customer_dict).insert(ignore_permissions=True)\n\n\t\t\tself.assertEqual(customer.customer_group, None)\n\t\t\tself.assertEqual(customer.territory, None)\n\n\t\t# create a sales invoice\n\t\tsi = create_sales_invoice(customer=\"_Test Simple Customer\")\n\t\tself.assertEqual(si.docstatus, 1)\n\t\tself.assertEqual(si.customer_group, None)\n\t\tself.assertEqual(si.territory, None)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_sales_return_negative_rate": {
      "name": "test_sales_return_negative_rate",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_sales_return_negative_rate(self):\n\t\tsi = create_sales_invoice(is_return=1, qty=-2, rate=-10, do_not_save=True)\n\t\tself.assertRaises(frappe.ValidationError, si.save)\n\n\t\tsi.items[0].rate = 10\n\t\tsi.save()"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_partial_allocation_on_advance_as_liability": {
      "name": "test_partial_allocation_on_advance_as_liability",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_partial_allocation_on_advance_as_liability(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import create_payment_entry\n\n\t\tcompany = \"_Test Company\"\n\t\tcustomer = \"_Test Customer\"\n\t\tdebtors_acc = \"Debtors - _TC\"\n\t\tadvance_account = create_account(\n\t\t\tparent_account=\"Current Liabilities - _TC\",\n\t\t\taccount_name=\"Advances Received\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_type=\"Receivable\",\n\t\t)\n\n\t\tset_advance_flag(company=\"_Test Company\", flag=1, default_account=advance_account)\n\n\t\tpe = create_payment_entry(\n\t\t\tcompany=company,\n\t\t\tpayment_type=\"Receive\",\n\t\t\tparty_type=\"Customer\",\n\t\t\tparty=customer,\n\t\t\tpaid_from=advance_account,\n\t\t\tpaid_to=\"Cash - _TC\",\n\t\t\tpaid_amount=1000,\n\t\t)\n\t\tpe.submit()\n\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=company,\n\t\t\tcustomer=customer,\n\t\t\tdo_not_save=True,\n\t\t\tdo_not_submit=True,\n\t\t\trate=1000,\n\t\t\tprice_list_rate=1000,\n\t\t)\n\t\tsi.base_grand_total = 1000\n\t\tsi.grand_total = 1000\n\t\tsi.set_advances()\n\t\tfor advance in si.advances:\n\t\t\tadvance.allocated_amount = 200 if advance.reference_name == pe.name else 0\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\tself.assertEqual(si.advances[0].allocated_amount, 200)\n\n\t\t# Check GL Entry against partial from advance\n\t\texpected_gle = [\n\t\t\t[advance_account, 0.0, 1000.0, nowdate()],\n\t\t\t[advance_account, 200.0, 0.0, nowdate()],\n\t\t\t[\"Cash - _TC\", 1000.0, 0.0, nowdate()],\n\t\t\t[debtors_acc, 0.0, 200.0, nowdate()],\n\t\t]\n\t\tcheck_gl_entries(self, pe.name, expected_gle, nowdate(), voucher_type=\"Payment Entry\")\n\t\tsi.reload()\n\t\tself.assertEqual(si.outstanding_amount, 800.0)\n\n\t\tpr = frappe.get_doc(\"Payment Reconciliation\")\n\t\tpr.company = company\n\t\tpr.party_type = \"Customer\"\n\t\tpr.party = customer\n\t\tpr.receivable_payable_account = debtors_acc\n\t\tpr.default_advance_account = advance_account\n\t\tpr.get_unreconciled_entries()\n\n\t\t# allocate some more of the same advance\n\t\t# self.assertEqual(len(pr.invoices), 1)\n\t\t# self.assertEqual(len(pr.payments), 1)\n\t\tinvoices = [x.as_dict() for x in pr.invoices if x.get(\"invoice_number\") == si.name]\n\t\tpayments = [x.as_dict() for x in pr.payments if x.get(\"reference_name\") == pe.name]\n\t\tpr.allocate_entries(frappe._dict({\"invoices\": invoices, \"payments\": payments}))\n\t\tpr.allocation[0].allocated_amount = 300\n\t\tpr.reconcile()\n\n\t\tsi.reload()\n\t\tself.assertEqual(si.outstanding_amount, 500.0)\n\n\t\t# Check GL Entry against multi partial allocations from advance\n\t\texpected_gle = [\n\t\t\t[advance_account, 0.0, 1000.0, nowdate()],\n\t\t\t[advance_account, 200.0, 0.0, nowdate()],\n\t\t\t[advance_account, 300.0, 0.0, nowdate()],\n\t\t\t[\"Cash - _TC\", 1000.0, 0.0, nowdate()],\n\t\t\t[debtors_acc, 0.0, 200.0, nowdate()],\n\t\t\t[debtors_acc, 0.0, 300.0, nowdate()],\n\t\t]\n\t\tcheck_gl_entries(self, pe.name, expected_gle, nowdate(), voucher_type=\"Payment Entry\")\n\t\tset_advance_flag(company=\"_Test Company\", flag=0, default_account=\"\")"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_loyalty_points_redemption_with_shopping_cart": {
      "name": "test_loyalty_points_redemption_with_shopping_cart",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_loyalty_points_redemption_with_shopping_cart(self):\n\t\tfrom erpnext.accounts.doctype.loyalty_program.test_loyalty_program import (\n\t\t\tcreate_records,\n\t\t\tcreate_sales_invoice_record,\n\t\t)\n\t\tfrom erpnext.selling.doctype.sales_order.sales_order import make_sales_invoice\n\t\tfrom erpnext.selling.doctype.sales_order.test_sales_order import make_sales_order\n\n\t\t# Set up loyalty program\n\t\tcreate_records()\n\t\tfrappe.db.set_value(\"Customer\", \"Test Loyalty Customer\", \"loyalty_program\", \"Test Single Loyalty\")\n\t\tcreate_sales_invoice_record(10).insert().submit()\n\n\t\t# Create a sales order\n\t\tso = make_sales_order(qty=10, do_not_save=True, customer=\"Test Loyalty Customer\")\n\t\tso.name = \"_T-Sales Order LP-0001\"\n\t\tso.order_type = \"Shopping Cart\"\n\t\tso.loyalty_points = 50\n\t\tso.loyalty_amount = 50\n\t\tso.insert()\n\t\tso.submit()\n\n\t\t# Create sales invoice from the sales order\n\t\tsi = make_sales_invoice(so.name)\n\t\tfrom frappe.model.trace import traced_field_context\n\n\t\twith traced_field_context(si.__class__, \"loyalty_program\", forbidden_values=[None]):\n\t\t\tsi.insert()\n\t\tsi.submit()\n\n\t\t# Check if loyalty points are applied correctly\n\t\tself.assertEqual(si.loyalty_program, \"Test Single Loyalty\")\n\t\tself.assertEqual(si.loyalty_points, 50)\n\t\tself.assertEqual(si.loyalty_amount, 50)\n\n\t\t# Check GL entries for loyalty points redemption\n\t\tgl_entries = frappe.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_type\": \"Sales Invoice\", \"voucher_no\": si.name},\n\t\t\tfields=[\"account\", \"debit\", \"credit\"],\n\t\t)\n\n\t\tloyalty_account = frappe.db.get_value(\"Loyalty Program\", \"Test Single Loyalty\", \"expense_account\")\n\t\texpected_gl_entries = [\n\t\t\t{\"account\": si.debit_to, \"debit\": si.grand_total, \"credit\": 0},\n\t\t\t{\"account\": si.items[0].income_account, \"debit\": 0, \"credit\": si.net_total},\n\t\t\t{\"account\": loyalty_account, \"debit\": 50, \"credit\": 0},\n\t\t]\n\n\t\tfor entry in expected_gl_entries:\n\t\t\tself.assertTrue(\n\t\t\t\tany(\n\t\t\t\t\tgl_entry.account == entry[\"account\"]\n\t\t\t\t\tand gl_entry.debit == entry[\"debit\"]\n\t\t\t\t\tand gl_entry.credit == entry[\"credit\"]\n\t\t\t\t\tfor gl_entry in gl_entries\n\t\t\t\t)\n\t\t\t)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_pulling_advance_based_on_debit_to": {
      "name": "test_pulling_advance_based_on_debit_to",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_pulling_advance_based_on_debit_to(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import create_payment_entry\n\n\t\tdebtors2 = create_account(\n\t\t\tparent_account=\"Accounts Receivable - _TC\",\n\t\t\taccount_name=\"Debtors 2\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_type=\"Receivable\",\n\t\t)\n\t\tsi = create_sales_invoice(do_not_submit=True)\n\t\tsi.debit_to = debtors2\n\t\tsi.save()\n\n\t\tpe = create_payment_entry(\n\t\t\tcompany=si.company,\n\t\t\tpayment_type=\"Receive\",\n\t\t\tparty_type=\"Customer\",\n\t\t\tparty=si.customer,\n\t\t\tpaid_from=debtors2,\n\t\t\tpaid_to=\"Cash - _TC\",\n\t\t\tpaid_amount=1000,\n\t\t)\n\t\tpe.submit()\n\t\tadvances = si.get_advance_entries()\n\t\tself.assertEqual(1, len(advances))\n\t\tself.assertEqual(advances[0].reference_name, pe.name)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_taxes_merging_from_delivery_note": {
      "name": "test_taxes_merging_from_delivery_note",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_taxes_merging_from_delivery_note(self):\n\t\tfrom erpnext.stock.doctype.delivery_note.test_delivery_note import create_delivery_note\n\n\t\tdn1 = create_delivery_note(do_not_submit=1)\n\t\tdn1.items[0].qty = 10\n\t\tdn1.items[0].rate = 100\n\t\tdn1.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Freight and Forwarding Charges - _TC\",\n\t\t\t\t\"description\": \"movement charges\",\n\t\t\t\t\"tax_amount\": 100,\n\t\t\t},\n\t\t)\n\t\tdn1.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Marketing Expenses - _TC\",\n\t\t\t\t\"description\": \"marketing\",\n\t\t\t\t\"tax_amount\": 150,\n\t\t\t},\n\t\t)\n\t\tdn1.save().submit()\n\n\t\tdn2 = create_delivery_note(do_not_submit=1)\n\t\tdn2.items[0].qty = 5\n\t\tdn2.items[0].rate = 100\n\t\tdn2.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Freight and Forwarding Charges - _TC\",\n\t\t\t\t\"description\": \"movement charges\",\n\t\t\t\t\"tax_amount\": 20,\n\t\t\t},\n\t\t)\n\t\tdn2.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Miscellaneous Expenses - _TC\",\n\t\t\t\t\"description\": \"marketing\",\n\t\t\t\t\"tax_amount\": 60,\n\t\t\t},\n\t\t)\n\t\tdn2.save().submit()\n\n\t\t# si = make_sales_invoice(dn1.name)\n\t\tsi = create_sales_invoice(do_not_submit=True)\n\t\tsi.customer = dn1.customer\n\t\tsi.items.clear()\n\n\t\tfrom frappe.model.mapper import map_docs\n\n\t\tmap_docs(\n\t\t\tmethod=\"erpnext.stock.doctype.delivery_note.delivery_note.make_sales_invoice\",\n\t\t\tsource_names=json.dumps([dn1.name, dn2.name]),\n\t\t\ttarget_doc=si,\n\t\t\targs=json.dumps({\"customer\": dn1.customer, \"merge_taxes\": 1, \"filtered_children\": []}),\n\t\t)\n\t\tsi.save()\n\n\t\texpected = [\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Freight and Forwarding Charges - _TC\",\n\t\t\t\t\"tax_amount\": 120.0,\n\t\t\t\t\"total\": 1620.0,\n\t\t\t\t\"base_total\": 1620.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Marketing Expenses - _TC\",\n\t\t\t\t\"tax_amount\": 150.0,\n\t\t\t\t\"total\": 1770.0,\n\t\t\t\t\"base_total\": 1770.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Miscellaneous Expenses - _TC\",\n\t\t\t\t\"tax_amount\": 60.0,\n\t\t\t\t\"total\": 1830.0,\n\t\t\t\t\"base_total\": 1830.0,\n\t\t\t},\n\t\t]\n\t\tactual = [\n\t\t\tdict(\n\t\t\t\tcharge_type=x.charge_type,\n\t\t\t\taccount_head=x.account_head,\n\t\t\t\ttax_amount=x.tax_amount,\n\t\t\t\ttotal=x.total,\n\t\t\t\tbase_total=x.base_total,\n\t\t\t)\n\t\t\tfor x in si.taxes\n\t\t]\n\t\tself.assertEqual(expected, actual)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_pos_returns_without_update_outstanding_for_self": {
      "name": "test_pos_returns_without_update_outstanding_for_self",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_pos_returns_without_update_outstanding_for_self(self):\n\t\tfrom erpnext.accounts.doctype.sales_invoice.sales_invoice import make_sales_return\n\n\t\tpos_profile = make_pos_profile()\n\t\tpos_profile.payments = []\n\t\tpos_profile.append(\"payments\", {\"default\": 1, \"mode_of_payment\": \"Cash\"})\n\t\tpos_profile.save()\n\n\t\tpos = create_sales_invoice(qty=10, do_not_save=True)\n\t\tpos.is_pos = 1\n\t\tpos.pos_profile = pos_profile.name\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Bank Draft\", \"amount\": 500})\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 500})\n\t\tpos.save().submit()\n\n\t\tpos_return = make_sales_return(pos.name)\n\t\tpos_return.update_outstanding_for_self = False\n\t\tpos_return.save().submit()\n\n\t\tgle = qb.DocType(\"GL Entry\")\n\t\tres = (\n\t\t\tqb.from_(gle)\n\t\t\t.select(gle.against_voucher)\n\t\t\t.distinct()\n\t\t\t.where(\n\t\t\t\tgle.is_cancelled.eq(0) & gle.voucher_no.eq(pos_return.name) & gle.against_voucher.notnull()\n\t\t\t)\n\t\t\t.run(as_list=1)\n\t\t)\n\t\tself.assertEqual(len(res), 1)\n\t\tself.assertEqual(res[0][0], pos_return.return_against)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_validation_on_opening_invoice_with_rounding": {
      "name": "test_validation_on_opening_invoice_with_rounding",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_validation_on_opening_invoice_with_rounding(self):\n\t\tsi = create_sales_invoice(qty=1, rate=99.98, do_not_submit=True)\n\t\tsi.is_opening = \"Yes\"\n\t\tsi.items[0].income_account = \"Temporary Opening - _TC\"\n\t\tsi.save()\n\t\tself.assertRaises(frappe.ValidationError, si.submit)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::_create_opening_roundoff_account": {
      "name": "_create_opening_roundoff_account",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef _create_opening_roundoff_account(self, company_name):\n\t\tliability_root = frappe.db.get_all(\n\t\t\t\"Account\",\n\t\t\tfilters={\"company\": company_name, \"root_type\": \"Liability\", \"disabled\": 0},\n\t\t\torder_by=\"lft\",\n\t\t\tlimit=1,\n\t\t)[0]\n\n\t\t# setup round off account\n\t\tif acc := frappe.db.exists(\n\t\t\t\"Account\",\n\t\t\t{\n\t\t\t\t\"account_name\": \"Round Off for Opening\",\n\t\t\t\t\"account_type\": \"Round Off for Opening\",\n\t\t\t\t\"company\": company_name,\n\t\t\t},\n\t\t):\n\t\t\tfrappe.db.set_value(\"Company\", company_name, \"round_off_for_opening\", acc)\n\t\telse:\n\t\t\tacc = frappe.new_doc(\"Account\")\n\t\t\tacc.company = company_name\n\t\t\tacc.parent_account = liability_root.name\n\t\t\tacc.account_name = \"Round Off for Opening\"\n\t\t\tacc.account_type = \"Round Off for Opening\"\n\t\t\tacc.save()\n\t\t\tfrappe.db.set_value(\"Company\", company_name, \"round_off_for_opening\", acc.name)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_opening_invoice_with_rounding_adjustment": {
      "name": "test_opening_invoice_with_rounding_adjustment",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_opening_invoice_with_rounding_adjustment(self):\n\t\tsi = create_sales_invoice(qty=1, rate=99.98, do_not_submit=True)\n\t\tsi.is_opening = \"Yes\"\n\t\tsi.items[0].income_account = \"Temporary Opening - _TC\"\n\t\tsi.save()\n\n\t\tself._create_opening_roundoff_account(si.company)\n\n\t\tsi.reload()\n\t\tsi.submit()\n\t\tres = frappe.db.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_no\": si.name, \"is_opening\": \"Yes\"},\n\t\t\tfields=[\"account\", \"debit\", \"credit\", \"is_opening\"],\n\t\t)\n\t\tself.assertEqual(len(res), 3)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::_create_opening_invoice_with_inclusive_tax": {
      "name": "_create_opening_invoice_with_inclusive_tax",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef _create_opening_invoice_with_inclusive_tax(self):\n\t\tsi = create_sales_invoice(qty=1, rate=90, do_not_submit=True)\n\t\tsi.is_opening = \"Yes\"\n\t\tsi.items[0].income_account = \"Temporary Opening - _TC\"\n\t\titem_template = si.items[0].as_dict()\n\t\titem_template.name = None\n\t\titem_template.rate = 55\n\t\tsi.append(\"items\", item_template)\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"account_head\": \"_Test Account Service Tax - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"Testing...\",\n\t\t\t\t\"rate\": 5,\n\t\t\t\t\"included_in_print_rate\": True,\n\t\t\t},\n\t\t)\n\t\t# there will be 0.01 precision loss between Dr and Cr\n\t\t# caused by 'included_in_print_tax' option\n\t\tsi.save()\n\t\treturn si"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_rounding_validation_for_opening_with_inclusive_tax": {
      "name": "test_rounding_validation_for_opening_with_inclusive_tax",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_rounding_validation_for_opening_with_inclusive_tax(self):\n\t\tsi = self._create_opening_invoice_with_inclusive_tax()\n\t\t# 'Round Off for Opening' not set in Company master\n\t\t# Ledger level validation must be thrown\n\t\tself.assertRaises(frappe.ValidationError, si.submit)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_ledger_entries_on_opening_invoice_with_rounding_loss_by_inclusive_tax": {
      "name": "test_ledger_entries_on_opening_invoice_with_rounding_loss_by_inclusive_tax",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_ledger_entries_on_opening_invoice_with_rounding_loss_by_inclusive_tax(self):\n\t\tsi = self._create_opening_invoice_with_inclusive_tax()\n\t\t# 'Round Off for Opening' is set in Company master\n\t\tself._create_opening_roundoff_account(si.company)\n\n\t\tsi.submit()\n\t\tactual = frappe.db.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_no\": si.name, \"is_opening\": \"Yes\", \"is_cancelled\": False},\n\t\t\tfields=[\"account\", \"debit\", \"credit\", \"is_opening\"],\n\t\t\torder_by=\"account,debit\",\n\t\t)\n\t\texpected = [\n\t\t\t{\"account\": \"_Test Account Service Tax - _TC\", \"debit\": 0.0, \"credit\": 6.9, \"is_opening\": \"Yes\"},\n\t\t\t{\"account\": \"Debtors - _TC\", \"debit\": 145.0, \"credit\": 0.0, \"is_opening\": \"Yes\"},\n\t\t\t{\"account\": \"Round Off for Opening - _TC\", \"debit\": 0.0, \"credit\": 0.01, \"is_opening\": \"Yes\"},\n\t\t\t{\"account\": \"Temporary Opening - _TC\", \"debit\": 0.0, \"credit\": 138.09, \"is_opening\": \"Yes\"},\n\t\t]\n\t\tself.assertEqual(len(actual), 4)\n\t\tself.assertEqual(expected, actual)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_common_party_with_foreign_currency_jv": {
      "name": "test_common_party_with_foreign_currency_jv",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_common_party_with_foreign_currency_jv(self):\n\t\tfrom erpnext.accounts.doctype.account.test_account import create_account\n\t\tfrom erpnext.accounts.doctype.opening_invoice_creation_tool.test_opening_invoice_creation_tool import (\n\t\t\tmake_customer,\n\t\t)\n\t\tfrom erpnext.accounts.doctype.party_link.party_link import create_party_link\n\t\tfrom erpnext.buying.doctype.supplier.test_supplier import create_supplier\n\t\tfrom erpnext.setup.utils import get_exchange_rate\n\n\t\tcreditors = create_account(\n\t\t\taccount_name=\"Creditors USD\",\n\t\t\tparent_account=\"Accounts Payable - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_currency=\"USD\",\n\t\t\taccount_type=\"Payable\",\n\t\t)\n\t\tdebtors = create_account(\n\t\t\taccount_name=\"Debtors USD\",\n\t\t\tparent_account=\"Accounts Receivable - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_currency=\"USD\",\n\t\t\taccount_type=\"Receivable\",\n\t\t)\n\n\t\t# create a customer\n\t\tcustomer = make_customer(customer=\"_Test Common Party USD\")\n\t\tcust_doc = frappe.get_doc(\"Customer\", customer)\n\t\tcust_doc.default_currency = \"USD\"\n\t\ttest_account_details = {\n\t\t\t\"company\": \"_Test Company\",\n\t\t\t\"account\": debtors,\n\t\t}\n\t\tcust_doc.append(\"accounts\", test_account_details)\n\t\tcust_doc.save()\n\n\t\t# create a supplier\n\t\tsupplier = create_supplier(supplier_name=\"_Test Common Party USD\").name\n\t\tsupp_doc = frappe.get_doc(\"Supplier\", supplier)\n\t\tsupp_doc.default_currency = \"USD\"\n\t\ttest_account_details = {\n\t\t\t\"company\": \"_Test Company\",\n\t\t\t\"account\": creditors,\n\t\t}\n\t\tsupp_doc.append(\"accounts\", test_account_details)\n\t\tsupp_doc.save()\n\n\t\t# create a party link between customer & supplier\n\t\tcreate_party_link(\"Supplier\", supplier, customer)\n\n\t\t# create a sales invoice\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=customer,\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=get_exchange_rate(\"USD\", \"INR\"),\n\t\t\tdebit_to=debtors,\n\t\t\tdo_not_save=1,\n\t\t)\n\t\tsi.party_account_currency = \"USD\"\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\t# check outstanding of sales invoice\n\t\tsi.reload()\n\t\tself.assertEqual(si.status, \"Paid\")\n\t\tself.assertEqual(flt(si.outstanding_amount), 0.0)\n\n\t\t# check creation of journal entry\n\t\tjv = frappe.get_all(\n\t\t\t\"Journal Entry Account\",\n\t\t\t{\n\t\t\t\t\"account\": si.debit_to,\n\t\t\t\t\"party_type\": \"Customer\",\n\t\t\t\t\"party\": si.customer,\n\t\t\t\t\"reference_type\": si.doctype,\n\t\t\t\t\"reference_name\": si.name,\n\t\t\t},\n\t\t\tpluck=\"credit_in_account_currency\",\n\t\t)\n\t\tself.assertTrue(jv)\n\t\tself.assertEqual(jv[0], si.grand_total)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_common_party_with_different_currency_in_debtor_and_creditor": {
      "name": "test_common_party_with_different_currency_in_debtor_and_creditor",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_common_party_with_different_currency_in_debtor_and_creditor(self):\n\t\tfrom erpnext.accounts.doctype.account.test_account import create_account\n\t\tfrom erpnext.accounts.doctype.opening_invoice_creation_tool.test_opening_invoice_creation_tool import (\n\t\t\tmake_customer,\n\t\t)\n\t\tfrom erpnext.accounts.doctype.party_link.party_link import create_party_link\n\t\tfrom erpnext.buying.doctype.supplier.test_supplier import create_supplier\n\t\tfrom erpnext.setup.utils import get_exchange_rate\n\n\t\tcreditors = create_account(\n\t\t\taccount_name=\"Creditors INR\",\n\t\t\tparent_account=\"Accounts Payable - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_currency=\"INR\",\n\t\t\taccount_type=\"Payable\",\n\t\t)\n\t\tdebtors = create_account(\n\t\t\taccount_name=\"Debtors USD\",\n\t\t\tparent_account=\"Accounts Receivable - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_currency=\"USD\",\n\t\t\taccount_type=\"Receivable\",\n\t\t)\n\n\t\t# create a customer\n\t\tcustomer = make_customer(customer=\"_Test Common Party USD\")\n\t\tcust_doc = frappe.get_doc(\"Customer\", customer)\n\t\tcust_doc.default_currency = \"USD\"\n\t\ttest_account_details = {\n\t\t\t\"company\": \"_Test Company\",\n\t\t\t\"account\": debtors,\n\t\t}\n\t\tcust_doc.append(\"accounts\", test_account_details)\n\t\tcust_doc.save()\n\n\t\t# create a supplier\n\t\tsupplier = create_supplier(supplier_name=\"_Test Common Party INR\").name\n\t\tsupp_doc = frappe.get_doc(\"Supplier\", supplier)\n\t\tsupp_doc.default_currency = \"INR\"\n\t\ttest_account_details = {\n\t\t\t\"company\": \"_Test Company\",\n\t\t\t\"account\": creditors,\n\t\t}\n\t\tsupp_doc.append(\"accounts\", test_account_details)\n\t\tsupp_doc.save()\n\n\t\t# create a party link between customer & supplier\n\t\tcreate_party_link(\"Supplier\", supplier, customer)\n\n\t\t# create a sales invoice\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=customer,\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=get_exchange_rate(\"USD\", \"INR\"),\n\t\t\tdebit_to=debtors,\n\t\t\tdo_not_save=1,\n\t\t)\n\t\tsi.party_account_currency = \"USD\"\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\t# check outstanding of sales invoice\n\t\tsi.reload()\n\t\tself.assertEqual(si.status, \"Paid\")\n\t\tself.assertEqual(flt(si.outstanding_amount), 0.0)\n\n\t\t# check creation of journal entry\n\t\tjv = frappe.get_all(\n\t\t\t\"Journal Entry Account\",\n\t\t\t{\n\t\t\t\t\"account\": si.debit_to,\n\t\t\t\t\"party_type\": \"Customer\",\n\t\t\t\t\"party\": si.customer,\n\t\t\t\t\"reference_type\": si.doctype,\n\t\t\t\t\"reference_name\": si.name,\n\t\t\t},\n\t\t\tpluck=\"credit_in_account_currency\",\n\t\t)\n\t\tself.assertTrue(jv)\n\t\tself.assertEqual(jv[0], si.grand_total)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_invoice_remarks": {
      "name": "test_invoice_remarks",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_invoice_remarks(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.po_no = \"Test PO\"\n\t\tsi.po_date = nowdate()\n\t\tsi.save()\n\t\tsi.submit()\n\t\tself.assertEqual(si.remarks, f\"Against Customer Order Test PO dated {format_date(nowdate())}\")"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_gl_voucher_subtype": {
      "name": "test_gl_voucher_subtype",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_gl_voucher_subtype(self):\n\t\tsi = create_sales_invoice()\n\t\tgl_entries = frappe.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_type\": \"Sales Invoice\", \"voucher_no\": si.name},\n\t\t\tpluck=\"voucher_subtype\",\n\t\t)\n\n\t\tself.assertTrue(all([x == \"Sales Invoice\" for x in gl_entries]))\n\n\t\tsi = create_sales_invoice(is_return=1, qty=-1)\n\t\tgl_entries = frappe.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_type\": \"Sales Invoice\", \"voucher_no\": si.name},\n\t\t\tpluck=\"voucher_subtype\",\n\t\t)\n\n\t\tself.assertTrue(all([x == \"Credit Note\" for x in gl_entries]))"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_total_billed_amount": {
      "name": "test_total_billed_amount",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_total_billed_amount(self):\n\t\tsi = create_sales_invoice(do_not_submit=True)\n\n\t\tproject = frappe.new_doc(\"Project\")\n\t\tproject.company = \"_Test Company\"\n\t\tproject.project_name = \"Test Total Billed Amount\"\n\t\tproject.save()\n\n\t\tsi.project = project.name\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\tdoc = frappe.get_doc(\"Project\", project.name)\n\t\tself.assertEqual(doc.total_billed_amount, si.grand_total)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_total_billed_amount_with_different_projects": {
      "name": "test_total_billed_amount_with_different_projects",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_total_billed_amount_with_different_projects(self):\n\t\t# This test case is for checking the scenario where project is set at document level and for **some** child items only, not all\n\t\tfrom copy import copy\n\n\t\tsi = create_sales_invoice(do_not_submit=True)\n\n\t\tproject = frappe.new_doc(\"Project\")\n\t\tproject.company = \"_Test Company\"\n\t\tproject.project_name = \"Test Total Billed Amount\"\n\t\tproject.save()\n\n\t\tsi.project = project.name\n\t\tsi.items.append(copy(si.items[0]))\n\t\tsi.items.append(copy(si.items[0]))\n\t\tsi.items[0].project = project.name\n\t\tsi.items[1].project = project.name\n\t\t# Not setting project on last item\n\t\tsi.items[1].insert()\n\t\tsi.items[2].insert()\n\t\tsi.submit()\n\n\t\tproject.reload()\n\t\tself.assertIsNone(si.items[2].project)\n\t\tself.assertEqual(project.total_billed_amount, 300)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_pos_returns_with_party_account_currency": {
      "name": "test_pos_returns_with_party_account_currency",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_pos_returns_with_party_account_currency(self):\n\t\tfrom erpnext.accounts.doctype.sales_invoice.sales_invoice import make_sales_return\n\n\t\tpos_profile = make_pos_profile()\n\t\tpos_profile.payments = []\n\t\tpos_profile.append(\"payments\", {\"default\": 1, \"mode_of_payment\": \"Cash\"})\n\t\tpos_profile.save()\n\n\t\tpos = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=86.595000000,\n\t\t\tqty=2,\n\t\t\tdo_not_save=True,\n\t\t)\n\t\tpos.is_pos = 1\n\t\tpos.pos_profile = pos_profile.name\n\t\tpos.debit_to = \"_Test Receivable USD - _TC\"\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 20.35})\n\t\tpos.save().submit()\n\n\t\tpos_return = make_sales_return(pos.name)\n\t\tself.assertEqual(abs(pos_return.payments[0].amount), pos.payments[0].amount)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_create_return_invoice_for_self_update": {
      "name": "test_create_return_invoice_for_self_update",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_create_return_invoice_for_self_update(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.payment_entry import get_payment_entry\n\t\tfrom erpnext.accounts.doctype.sales_invoice.test_sales_invoice import create_sales_invoice\n\t\tfrom erpnext.controllers.sales_and_purchase_return import make_return_doc\n\n\t\tinvoice = create_sales_invoice()\n\n\t\tpayment_entry = get_payment_entry(dt=invoice.doctype, dn=invoice.name)\n\t\tpayment_entry.reference_no = \"test001\"\n\t\tpayment_entry.reference_date = getdate()\n\n\t\tpayment_entry.save()\n\t\tpayment_entry.submit()\n\n\t\tr_invoice = make_return_doc(invoice.doctype, invoice.name)\n\n\t\tr_invoice.update_outstanding_for_self = 0\n\t\tr_invoice.save()\n\n\t\tself.assertEqual(r_invoice.update_outstanding_for_self, 1)\n\n\t\tr_invoice.submit()\n\n\t\tself.assertNotEqual(r_invoice.outstanding_amount, 0)\n\n\t\tinvoice.reload()\n\n\t\tself.assertEqual(invoice.outstanding_amount, 0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_prevents_fully_returned_invoice_with_zero_quantity": {
      "name": "test_prevents_fully_returned_invoice_with_zero_quantity",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_prevents_fully_returned_invoice_with_zero_quantity(self):\n\t\tfrom erpnext.controllers.sales_and_purchase_return import StockOverReturnError, make_return_doc\n\n\t\tinvoice = create_sales_invoice(qty=10)\n\n\t\treturn_doc = make_return_doc(invoice.doctype, invoice.name)\n\t\treturn_doc.items[0].qty = -10\n\t\treturn_doc.save().submit()\n\n\t\treturn_doc = make_return_doc(invoice.doctype, invoice.name)\n\t\treturn_doc.items[0].qty = 0\n\n\t\tself.assertRaises(StockOverReturnError, return_doc.save)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_pos_sales_invoice_creation_during_pos_invoice_mode": {
      "name": "test_pos_sales_invoice_creation_during_pos_invoice_mode",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_pos_sales_invoice_creation_during_pos_invoice_mode(self):\n\t\t# Deleting all opening entry\n\t\tfrappe.db.sql(\"delete from `tabPOS Opening Entry`\")\n\n\t\twith self.change_settings(\"POS Settings\", {\"invoice_type\": \"POS Invoice\"}):\n\t\t\tpos_profile = make_pos_profile()\n\n\t\t\tpos_profile.payments = []\n\t\t\tpos_profile.append(\"payments\", {\"default\": 1, \"mode_of_payment\": \"Cash\"})\n\n\t\t\tpos_profile.save()\n\n\t\t\tpos = create_sales_invoice(qty=10, do_not_save=True)\n\n\t\t\tpos.is_pos = 1\n\t\t\tpos.pos_profile = pos_profile.name\n\t\t\tpos.is_created_using_pos = 1\n\n\t\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 1000})\n\t\t\tself.assertRaises(frappe.ValidationError, pos.insert)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_stand_alone_credit_note_valuation": {
      "name": "test_stand_alone_credit_note_valuation",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_stand_alone_credit_note_valuation(self):\n\t\tfrom erpnext.stock.doctype.item.test_item import make_item\n\n\t\titem_code = \"_Test Item for Credit Note Valuation\"\n\t\tmake_item_for_si(\n\t\t\titem_code,\n\t\t\t{\n\t\t\t\t\"is_stock_item\": 1,\n\t\t\t\t\"has_batch_no\": 1,\n\t\t\t\t\"create_new_batch\": 1,\n\t\t\t\t\"batch_number_series\": \"BATCH-TCNV.####\",\n\t\t\t},\n\t\t)\n\n\t\tsi = create_sales_invoice(\n\t\t\titem=item_code,\n\t\t\tqty=-2,\n\t\t\trate=1200,\n\t\t\tis_return=1,\n\t\t\tupdate_stock=1,\n\t\t)\n\n\t\tstock_ledger_entry = frappe.db.get_value(\n\t\t\t\"Stock Ledger Entry\",\n\t\t\t{\n\t\t\t\t\"voucher_type\": \"Sales Invoice\",\n\t\t\t\t\"voucher_no\": si.name,\n\t\t\t\t\"item_code\": item_code,\n\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t},\n\t\t\t[\"incoming_rate\", \"valuation_rate\", \"actual_qty as qty\", \"stock_value_difference\"],\n\t\t\tas_dict=True,\n\t\t)\n\n\t\tself.assertEqual(stock_ledger_entry.incoming_rate, 1200.0)\n\t\tself.assertEqual(stock_ledger_entry.valuation_rate, 1200.0)\n\t\tself.assertEqual(stock_ledger_entry.qty, 2.0)\n\t\tself.assertEqual(stock_ledger_entry.stock_value_difference, 2400.0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_stand_alone_credit_note_zero_valuation": {
      "name": "test_stand_alone_credit_note_zero_valuation",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_stand_alone_credit_note_zero_valuation(self):\n\t\tfrom erpnext.stock.doctype.item.test_item import make_item\n\n\t\titem_code = \"_Test Item for Credit Note Zero Valuation\"\n\t\tmake_item_for_si(\n\t\t\titem_code,\n\t\t\t{\n\t\t\t\t\"is_stock_item\": 1,\n\t\t\t\t\"has_batch_no\": 1,\n\t\t\t\t\"create_new_batch\": 1,\n\t\t\t\t\"batch_number_series\": \"BATCH-TCNZV.####\",\n\t\t\t},\n\t\t)\n\n\t\tsi = create_sales_invoice(\n\t\t\titem=item_code,\n\t\t\tqty=-2,\n\t\t\trate=1200,\n\t\t\tis_return=1,\n\t\t\tupdate_stock=1,\n\t\t\tallow_zero_valuation_rate=1,\n\t\t)\n\n\t\tstock_ledger_entry = frappe.db.get_value(\n\t\t\t\"Stock Ledger Entry\",\n\t\t\t{\n\t\t\t\t\"voucher_type\": \"Sales Invoice\",\n\t\t\t\t\"voucher_no\": si.name,\n\t\t\t\t\"item_code\": item_code,\n\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t},\n\t\t\t[\"incoming_rate\", \"valuation_rate\", \"actual_qty as qty\", \"stock_value_difference\"],\n\t\t\tas_dict=True,\n\t\t)\n\n\t\tself.assertEqual(stock_ledger_entry.incoming_rate, 0.0)\n\t\tself.assertEqual(stock_ledger_entry.valuation_rate, 0.0)\n\t\tself.assertEqual(stock_ledger_entry.qty, 2.0)\n\t\tself.assertEqual(stock_ledger_entry.stock_value_difference, 0.0)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_system_generated_exchange_gain_or_loss_je_after_repost": {
      "name": "test_system_generated_exchange_gain_or_loss_je_after_repost",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_system_generated_exchange_gain_or_loss_je_after_repost(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.payment_entry import get_payment_entry\n\t\tfrom erpnext.accounts.doctype.repost_accounting_ledger.test_repost_accounting_ledger import (\n\t\t\tupdate_repost_settings,\n\t\t)\n\n\t\tupdate_repost_settings()\n\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"_Test Receivable USD - _TC\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=80,\n\t\t)\n\n\t\tpe = get_payment_entry(\"Sales Invoice\", si.name)\n\t\tpe.reference_no = \"10\"\n\t\tpe.reference_date = nowdate()\n\t\tpe.paid_from_account_currency = si.currency\n\t\tpe.paid_to_account_currency = \"INR\"\n\t\tpe.source_exchange_rate = 85\n\t\tpe.target_exchange_rate = 1\n\t\tpe.paid_amount = si.outstanding_amount\n\t\tpe.insert()\n\t\tpe.submit()\n\n\t\tral = frappe.new_doc(\"Repost Accounting Ledger\")\n\t\tral.company = si.company\n\t\tral.append(\"vouchers\", {\"voucher_type\": si.doctype, \"voucher_no\": si.name})\n\t\tral.save()\n\t\tral.submit()\n\n\t\tje = frappe.qb.DocType(\"Journal Entry\")\n\t\tjea = frappe.qb.DocType(\"Journal Entry Account\")\n\t\tq = (\n\t\t\t(\n\t\t\t\tfrappe.qb.from_(je)\n\t\t\t\t.join(jea)\n\t\t\t\t.on(je.name == jea.parent)\n\t\t\t\t.select(je.docstatus)\n\t\t\t\t.where(\n\t\t\t\t\t(je.voucher_type == \"Exchange Gain Or Loss\")\n\t\t\t\t\t& (jea.reference_name == si.name)\n\t\t\t\t\t& (jea.reference_type == \"Sales Invoice\")\n\t\t\t\t\t& (je.is_system_generated == 1)\n\t\t\t\t)\n\t\t\t)\n\t\t\t.limit(1)\n\t\t\t.run()\n\t\t)\n\n\t\tself.assertEqual(q[0][0], 1)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_non_batchwise_valuation_for_moving_average": {
      "name": "test_non_batchwise_valuation_for_moving_average",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "\tdef test_non_batchwise_valuation_for_moving_average(self):\n\t\tfrom erpnext.stock.doctype.item.test_item import make_item\n\n\t\titem_code = \"_Test Item for Non Batchwise Valuation\"\n\t\tmake_item_for_si(\n\t\t\titem_code,\n\t\t\t{\n\t\t\t\t\"is_stock_item\": 1,\n\t\t\t\t\"has_batch_no\": 1,\n\t\t\t\t\"create_new_batch\": 1,\n\t\t\t\t\"batch_number_series\": \"TBATCH-TCNV.####\",\n\t\t\t\t\"valuation_method\": \"Moving Average\",\n\t\t\t},\n\t\t)\n\n\t\tdoc = frappe.get_doc(\"Stock Settings\")\n\t\toriginal_value = cint(doc.do_not_use_batchwise_valuation)\n\n\t\tdoc.db_set(\"do_not_use_batchwise_valuation\", 1)\n\n\t\tse = make_stock_entry(\n\t\t\titem_code=item_code,\n\t\t\tqty=10,\n\t\t\ttarget=\"_Test Warehouse - _TC\",\n\t\t\trate=13.02,\n\t\t\tvaluation_method=\"Moving Average\",\n\t\t\tuse_serial_batch_fields=True,\n\t\t)\n\n\t\tse_batch = get_batch_from_bundle(se.items[0].serial_and_batch_bundle)\n\n\t\t# without use serial and batch fields\n\t\tsi = create_sales_invoice(\n\t\t\titem=item_code,\n\t\t\tqty=1,\n\t\t\trate=120,\n\t\t\tupdate_stock=1,\n\t\t\tuse_serial_batch_fields=False,\n\t\t\twarehouse=\"_Test Warehouse - _TC\",\n\t\t)\n\n\t\tsi.reload()\n\t\tsi_batch = get_batch_from_bundle(si.items[0].serial_and_batch_bundle)\n\n\t\tself.assertEqual(se_batch, si_batch)\n\t\tself.assertEqual(si.items[0].use_serial_batch_fields, 0)\n\n\t\tserial_and_batch_bundle = si.items[0].serial_and_batch_bundle\n\t\tchange_in_value = frappe.db.get_value(\n\t\t\t\"Stock Ledger Entry\",\n\t\t\t{\n\t\t\t\t\"voucher_type\": \"Sales Invoice\",\n\t\t\t\t\"voucher_no\": si.name,\n\t\t\t\t\"item_code\": item_code,\n\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t\t\"serial_and_batch_bundle\": serial_and_batch_bundle,\n\t\t\t},\n\t\t\t\"stock_value_difference\",\n\t\t)\n\n\t\tself.assertEqual(change_in_value, 13.02 * -1)\n\n\t\t# with use serial and batch fields\n\t\tsi = create_sales_invoice(\n\t\t\titem=item_code,\n\t\t\tqty=1,\n\t\t\trate=120,\n\t\t\tupdate_stock=1,\n\t\t\tuse_serial_batch_fields=True,\n\t\t\twarehouse=\"_Test Warehouse - _TC\",\n\t\t)\n\n\t\tsi.reload()\n\n\t\tself.assertEqual(si.items[0].use_serial_batch_fields, 1)\n\n\t\tserial_and_batch_bundle = si.items[0].serial_and_batch_bundle\n\t\tchange_in_value = frappe.db.get_value(\n\t\t\t\"Stock Ledger Entry\",\n\t\t\t{\n\t\t\t\t\"voucher_type\": \"Sales Invoice\",\n\t\t\t\t\"voucher_no\": si.name,\n\t\t\t\t\"item_code\": item_code,\n\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t\t\"serial_and_batch_bundle\": serial_and_batch_bundle,\n\t\t\t},\n\t\t\t\"stock_value_difference\",\n\t\t)\n\n\t\tself.assertEqual(change_in_value, 13.02 * -1)\n\n\t\tdoc.db_set(\"do_not_use_batchwise_valuation\", original_value)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::make_item_for_si": {
      "name": "make_item_for_si",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "def make_item_for_si(item_code, properties=None):\n\tfrom erpnext.stock.doctype.item.test_item import make_item\n\n\titem = make_item(item_code, properties=properties)\n\titem.is_stock_item = 1\n\titem.save()\n\treturn item"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::set_advance_flag": {
      "name": "set_advance_flag",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "def set_advance_flag(company, flag, default_account):\n\tfrappe.db.set_value(\n\t\t\"Company\",\n\t\tcompany,\n\t\t{\n\t\t\t\"book_advance_payments_in_separate_party_account\": flag,\n\t\t\t\"default_advance_received_account\": default_account,\n\t\t},\n\t)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::check_gl_entries": {
      "name": "check_gl_entries",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "def check_gl_entries(doc, voucher_no, expected_gle, posting_date, voucher_type=\"Sales Invoice\"):\n\tgl = frappe.qb.DocType(\"GL Entry\")\n\tq = (\n\t\tfrappe.qb.from_(gl)\n\t\t.select(gl.account, gl.debit, gl.credit, gl.posting_date)\n\t\t.where(\n\t\t\t(gl.voucher_type == voucher_type)\n\t\t\t& (gl.voucher_no == voucher_no)\n\t\t\t& (gl.posting_date >= posting_date)\n\t\t\t& (gl.is_cancelled == 0)\n\t\t)\n\t\t.orderby(gl.posting_date, gl.account, gl.creation)\n\t)\n\tgl_entries = q.run(as_dict=True)\n\n\tdoc.assertGreater(len(gl_entries), 0)\n\n\tfor i, gle in enumerate(gl_entries):\n\t\tdoc.assertEqual(expected_gle[i][0], gle.account)\n\t\tdoc.assertEqual(expected_gle[i][1], gle.debit)\n\t\tdoc.assertEqual(expected_gle[i][2], gle.credit)\n\t\tdoc.assertEqual(getdate(expected_gle[i][3]), gle.posting_date)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::create_sales_invoice": {
      "name": "create_sales_invoice",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "def create_sales_invoice(**args):\n\tsi = frappe.new_doc(\"Sales Invoice\")\n\targs = frappe._dict(args)\n\tif args.posting_date:\n\t\tsi.set_posting_time = 1\n\tsi.posting_date = args.posting_date or nowdate()\n\n\tsi.company = args.company or \"_Test Company\"\n\tsi.customer = args.customer or \"_Test Customer\"\n\tsi.debit_to = args.debit_to or \"Debtors - _TC\"\n\tsi.update_stock = args.update_stock\n\tsi.is_pos = args.is_pos\n\tsi.is_return = args.is_return\n\tsi.return_against = args.return_against\n\tsi.currency = args.currency or \"INR\"\n\tsi.conversion_rate = args.conversion_rate or 1\n\tsi.naming_series = args.naming_series or \"T-SINV-\"\n\tsi.cost_center = args.parent_cost_center\n\tsi.is_internal_customer = args.is_internal_customer or 0\n\tif args.is_created_using_pos:\n\t\tsi.is_pos = 1\n\t\tsi.is_created_using_pos = 1\n\t\tpos_profile = None\n\t\tif not args.pos_profile:\n\t\t\tpos_profile = make_pos_profile()\n\t\t\tpos_profile.save()\n\t\tsi.pos_profile = args.pos_profile or pos_profile.name\n\n\tbundle_id = None\n\tif si.update_stock and (args.get(\"batch_no\") or args.get(\"serial_no\")):\n\t\tbatches = {}\n\t\tqty = args.qty if args.qty is not None else 1\n\t\titem_code = args.item or args.item_code or \"_Test Item\"\n\t\tif args.get(\"batch_no\"):\n\t\t\tbatches = frappe._dict({args.batch_no: qty})\n\n\t\tserial_nos = args.get(\"serial_no\") or []\n\n\t\tbundle_id = make_serial_batch_bundle(\n\t\t\tfrappe._dict(\n\t\t\t\t{\n\t\t\t\t\t\"item_code\": item_code,\n\t\t\t\t\t\"warehouse\": args.warehouse or \"_Test Warehouse - _TC\",\n\t\t\t\t\t\"qty\": qty,\n\t\t\t\t\t\"batches\": batches,\n\t\t\t\t\t\"voucher_type\": \"Sales Invoice\",\n\t\t\t\t\t\"serial_nos\": serial_nos,\n\t\t\t\t\t\"type_of_transaction\": \"Outward\" if not args.is_return else \"Inward\",\n\t\t\t\t\t\"posting_date\": si.posting_date or today(),\n\t\t\t\t\t\"posting_time\": si.posting_time,\n\t\t\t\t\t\"do_not_submit\": True,\n\t\t\t\t}\n\t\t\t)\n\t\t).name\n\n\tsi.append(\n\t\t\"items\",\n\t\t{\n\t\t\t\"item_code\": args.item or args.item_code or \"_Test Item\",\n\t\t\t\"item_name\": args.item_name or \"_Test Item\",\n\t\t\t\"description\": args.description or \"_Test Item\",\n\t\t\t\"warehouse\": args.warehouse or \"_Test Warehouse - _TC\",\n\t\t\t\"target_warehouse\": args.target_warehouse,\n\t\t\t\"qty\": args.qty if args.qty is not None else 1,\n\t\t\t\"uom\": args.uom or \"Nos\",\n\t\t\t\"stock_uom\": args.uom or \"Nos\",\n\t\t\t\"rate\": args.rate if args.get(\"rate\") is not None else 100,\n\t\t\t\"price_list_rate\": args.price_list_rate if args.get(\"price_list_rate\") is not None else 100,\n\t\t\t\"income_account\": args.income_account or \"Sales - _TC\",\n\t\t\t\"expense_account\": args.expense_account or \"Cost of Goods Sold - _TC\",\n\t\t\t\"discount_account\": args.discount_account or None,\n\t\t\t\"discount_amount\": args.discount_amount or 0,\n\t\t\t\"asset\": args.asset or None,\n\t\t\t\"cost_center\": args.cost_center or \"_Test Cost Center - _TC\",\n\t\t\t\"conversion_factor\": args.get(\"conversion_factor\", 1),\n\t\t\t\"incoming_rate\": args.incoming_rate or 0,\n\t\t\t\"serial_and_batch_bundle\": bundle_id,\n\t\t\t\"allow_zero_valuation_rate\": args.allow_zero_valuation_rate or 0,\n\t\t\t\"use_serial_batch_fields\": args.use_serial_batch_fields or 0,\n\t\t},\n\t)\n\n\tif not args.do_not_save:\n\t\tsi.insert()\n\t\tif not args.do_not_submit:\n\t\t\tsi.submit()\n\t\telse:\n\t\t\tsi.payment_schedule = []\n\n\t\tsi.load_from_db()\n\telse:\n\t\tsi.payment_schedule = []\n\n\treturn si"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::create_sales_invoice_against_cost_center": {
      "name": "create_sales_invoice_against_cost_center",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "def create_sales_invoice_against_cost_center(**args):\n\tsi = frappe.new_doc(\"Sales Invoice\")\n\targs = frappe._dict(args)\n\tif args.posting_date:\n\t\tsi.set_posting_time = 1\n\tsi.posting_date = args.posting_date or nowdate()\n\n\tsi.company = args.company or \"_Test Company\"\n\tsi.cost_center = args.cost_center or \"_Test Cost Center - _TC\"\n\tsi.customer = args.customer or \"_Test Customer\"\n\tsi.debit_to = args.debit_to or \"Debtors - _TC\"\n\tsi.update_stock = args.update_stock\n\tsi.is_pos = args.is_pos\n\tsi.is_return = args.is_return\n\tsi.return_against = args.return_against\n\tsi.currency = args.currency or \"INR\"\n\tsi.conversion_rate = args.conversion_rate or 1\n\n\tsi.append(\n\t\t\"items\",\n\t\t{\n\t\t\t\"item_code\": args.item or args.item_code or \"_Test Item\",\n\t\t\t\"warehouse\": args.warehouse or \"_Test Warehouse - _TC\",\n\t\t\t\"qty\": args.qty or 1,\n\t\t\t\"rate\": args.rate or 100,\n\t\t\t\"income_account\": \"Sales - _TC\",\n\t\t\t\"expense_account\": \"Cost of Goods Sold - _TC\",\n\t\t\t\"cost_center\": args.cost_center or \"_Test Cost Center - _TC\",\n\t\t},\n\t)\n\n\tif not args.do_not_save:\n\t\tsi.insert()\n\t\tif not args.do_not_submit:\n\t\t\tsi.submit()\n\t\telse:\n\t\t\tsi.payment_schedule = []\n\telse:\n\t\tsi.payment_schedule = []\n\n\treturn si"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::get_outstanding_amount": {
      "name": "get_outstanding_amount",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "def get_outstanding_amount(against_voucher_type, against_voucher, account, party, party_type):\n\tbal = flt(\n\t\tfrappe.db.sql(\n\t\t\t\"\"\"\n\t\tselect sum(debit_in_account_currency) - sum(credit_in_account_currency)\n\t\tfrom `tabGL Entry`\n\t\twhere against_voucher_type=%s and against_voucher=%s\n\t\tand account = %s and party = %s and party_type = %s\"\"\",\n\t\t\t(against_voucher_type, against_voucher, account, party, party_type),\n\t\t)[0][0]\n\t\tor 0.0\n\t)\n\n\tif against_voucher_type == \"Purchase Invoice\":\n\t\tbal = bal * -1\n\n\treturn bal"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::get_taxes_and_charges": {
      "name": "get_taxes_and_charges",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "def get_taxes_and_charges():\n\treturn [\n\t\t{\n\t\t\t\"account_head\": \"_Test Account Excise Duty - TCP1\",\n\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\"cost_center\": \"Main - TCP1\",\n\t\t\t\"description\": \"Excise Duty\",\n\t\t\t\"doctype\": \"Sales Taxes and Charges\",\n\t\t\t\"idx\": 1,\n\t\t\t\"included_in_print_rate\": 1,\n\t\t\t\"parentfield\": \"taxes\",\n\t\t\t\"rate\": 12,\n\t\t},\n\t\t{\n\t\t\t\"account_head\": \"_Test Account Education Cess - TCP1\",\n\t\t\t\"charge_type\": \"On Previous Row Amount\",\n\t\t\t\"cost_center\": \"Main - TCP1\",\n\t\t\t\"description\": \"Education Cess\",\n\t\t\t\"doctype\": \"Sales Taxes and Charges\",\n\t\t\t\"idx\": 2,\n\t\t\t\"included_in_print_rate\": 1,\n\t\t\t\"parentfield\": \"taxes\",\n\t\t\t\"rate\": 2,\n\t\t\t\"row_id\": 1,\n\t\t},\n\t]"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::create_internal_parties": {
      "name": "create_internal_parties",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "def create_internal_parties():\n\tfrom erpnext.selling.doctype.customer.test_customer import create_internal_customer\n\n\tcreate_internal_customer(\n\t\tcustomer_name=\"_Test Internal Customer\",\n\t\trepresents_company=\"_Test Company 1\",\n\t\tallowed_to_interact_with=\"Wind Power LLC\",\n\t)\n\n\tcreate_internal_customer(\n\t\tcustomer_name=\"_Test Internal Customer 2\",\n\t\trepresents_company=\"_Test Company with perpetual inventory\",\n\t\tallowed_to_interact_with=\"_Test Company with perpetual inventory\",\n\t)\n\n\tcreate_internal_customer(\n\t\tcustomer_name=\"_Test Internal Customer 3\",\n\t\trepresents_company=\"_Test Company\",\n\t\tallowed_to_interact_with=\"_Test Company\",\n\t)\n\n\taccount = create_account(\n\t\taccount_name=\"Unrealized Profit\",\n\t\tparent_account=\"Current Liabilities - _TC\",\n\t\tcompany=\"_Test Company\",\n\t)\n\n\tfrappe.db.set_value(\"Company\", \"_Test Company\", \"unrealized_profit_loss_account\", account)\n\n\tcreate_internal_supplier(\n\t\tsupplier_name=\"_Test Internal Supplier\",\n\t\trepresents_company=\"Wind Power LLC\",\n\t\tallowed_to_interact_with=\"_Test Company 1\",\n\t)\n\n\tcreate_internal_supplier(\n\t\tsupplier_name=\"_Test Internal Supplier 2\",\n\t\trepresents_company=\"_Test Company with perpetual inventory\",\n\t\tallowed_to_interact_with=\"_Test Company with perpetual inventory\",\n\t)\n\n\tcreate_internal_supplier(\n\t\tsupplier_name=\"_Test Internal Customer 3\",\n\t\trepresents_company=\"_Test Company\",\n\t\tallowed_to_interact_with=\"_Test Company\",\n\t)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::create_internal_supplier": {
      "name": "create_internal_supplier",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "def create_internal_supplier(supplier_name, represents_company, allowed_to_interact_with):\n\tif not frappe.db.exists(\"Supplier\", supplier_name):\n\t\tsupplier = frappe.get_doc(\n\t\t\t{\n\t\t\t\t\"supplier_group\": \"_Test Supplier Group\",\n\t\t\t\t\"supplier_name\": supplier_name,\n\t\t\t\t\"doctype\": \"Supplier\",\n\t\t\t\t\"is_internal_supplier\": 1,\n\t\t\t\t\"represents_company\": represents_company,\n\t\t\t}\n\t\t)\n\n\t\tsupplier.append(\"companies\", {\"company\": allowed_to_interact_with})\n\t\tsupplier.insert()\n\t\tsupplier_name = supplier.name\n\telse:\n\t\tsupplier_name = frappe.db.exists(\"Supplier\", supplier_name)\n\n\treturn supplier_name"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::setup_accounts": {
      "name": "setup_accounts",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "def setup_accounts():\n\t## Create internal transfer account\n\taccount = create_account(\n\t\taccount_name=\"Unrealized Profit\",\n\t\tparent_account=\"Current Liabilities - TCP1\",\n\t\tcompany=\"_Test Company with perpetual inventory\",\n\t)\n\n\tfrappe.db.set_value(\n\t\t\"Company\", \"_Test Company with perpetual inventory\", \"unrealized_profit_loss_account\", account\n\t)"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::add_taxes": {
      "name": "add_taxes",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "function_code": "def add_taxes(doc):\n\tdoc.append(\n\t\t\"taxes\",\n\t\t{\n\t\t\t\"account_head\": \"_Test Account Excise Duty - TCP1\",\n\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\"cost_center\": \"Main - TCP1\",\n\t\t\t\"description\": \"Excise Duty\",\n\t\t\t\"rate\": 12,\n\t\t},\n\t)"
    }
  },
  "classes": {
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::TestSalesInvoice": {
      "name": "TestSalesInvoice",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py",
      "class_code": "class TestSalesInvoice(ERPNextTestSuite):\n\tdef setUp(self):\n\t\tfrom erpnext.stock.doctype.stock_ledger_entry.test_stock_ledger_entry import create_items\n\n\t\tcreate_items([\"_Test Internal Transfer Item\"], uoms=[{\"uom\": \"Box\", \"conversion_factor\": 10}])\n\t\tcreate_internal_parties()\n\t\tsetup_accounts()\n\t\tmode_of_payment = frappe.get_doc(\"Mode of Payment\", \"Bank Draft\")\n\t\tset_default_account_for_mode_of_payment(mode_of_payment, \"_Test Company\", \"_Test Bank - _TC\")\n\t\tset_default_account_for_mode_of_payment(\n\t\t\tmode_of_payment, \"_Test Company with perpetual inventory\", \"_Test Bank - TCP1\"\n\t\t)\n\t\tfor company in frappe.get_all(\"Company\", pluck=\"name\"):\n\t\t\tfrappe.db.set_value(\"Company\", company, \"accounts_frozen_till_date\", None)\n\n\t@change_settings(\n\t\t\"Accounts Settings\",\n\t\t{\"maintain_same_internal_transaction_rate\": 1, \"maintain_same_rate_action\": \"Stop\"},\n\t)\n\tdef test_invalid_rate_without_override(self):\n\t\tfrom frappe import ValidationError\n\n\t\tfrom erpnext.accounts.doctype.sales_invoice.sales_invoice import make_inter_company_purchase_invoice\n\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=\"_Test Internal Customer 3\", company=\"_Test Company\", is_internal_customer=1, rate=100\n\t\t)\n\t\tpi = make_inter_company_purchase_invoice(si.name)\n\t\tpi.items[0].rate = 120\n\n\t\twith self.assertRaises(ValidationError) as e:\n\t\t\tpi.insert()\n\t\t\tpi.submit()\n\t\tself.assertIn(\"Rate must be same\", str(e.exception))\n\n\tdef tearDown(self):\n\t\tfrappe.db.rollback()\n\n\tdef make(self):\n\t\tw = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tw.is_pos = 0\n\t\tw.insert()\n\t\tw.submit()\n\t\treturn w\n\n\t@classmethod\n\tdef setUpClass(cls):\n\t\tsuper().setUpClass()\n\t\tcls.enterClassContext(cls.change_settings(\"Selling Settings\", validate_selling_price=0))\n\t\tcls.make_employees()\n\t\tcls.make_sales_person()\n\t\tunlink_payment_on_cancel_of_invoice()\n\n\t@classmethod\n\tdef tearDownClass(self):\n\t\tunlink_payment_on_cancel_of_invoice(0)\n\n\tdef test_sales_invoice_qty(self):\n\t\tsi = create_sales_invoice(qty=0, do_not_save=True)\n\t\twith self.assertRaises(InvalidQtyError):\n\t\t\tsi.save()\n\n\t\t# No error with qty=1\n\t\tsi.items[0].qty = 1\n\t\tsi.save()\n\t\tself.assertEqual(si.items[0].qty, 1)\n\n\tdef test_timestamp_change(self):\n\t\tw = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tw.docstatus = 0\n\t\tw.insert()\n\n\t\tw2 = frappe.get_doc(w.doctype, w.name)\n\n\t\timport time\n\n\t\ttime.sleep(1)\n\t\tw.save()\n\n\t\timport time\n\n\t\ttime.sleep(1)\n\t\tself.assertRaises(frappe.TimestampMismatchError, w2.save)\n\n\tdef test_sales_invoice_change_naming_series(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\t\tsi.insert()\n\t\tsi.naming_series = \"TEST-\"\n\n\t\tself.assertRaises(frappe.CannotChangeConstantError, si.save)\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][1])\n\t\tsi.insert()\n\t\tsi.naming_series = \"TEST-\"\n\n\t\tself.assertRaises(frappe.CannotChangeConstantError, si.save)\n\n\tdef test_add_terms_after_save(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\t\tsi.insert()\n\n\t\tself.assertTrue(si.payment_schedule)\n\t\tself.assertEqual(getdate(si.payment_schedule[0].due_date), getdate(si.due_date))\n\n\tdef test_sales_invoice_calculation_base_currency(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\t\tsi.insert()\n\n\t\texpected_values = {\n\t\t\t\"keys\": [\n\t\t\t\t\"price_list_rate\",\n\t\t\t\t\"discount_percentage\",\n\t\t\t\t\"rate\",\n\t\t\t\t\"amount\",\n\t\t\t\t\"base_price_list_rate\",\n\t\t\t\t\"base_rate\",\n\t\t\t\t\"base_amount\",\n\t\t\t],\n\t\t\t\"_Test Item Home Desktop 100\": [50, 0, 50, 500, 50, 50, 500],\n\t\t\t\"_Test Item Home Desktop 200\": [150, 0, 150, 750, 150, 150, 750],\n\t\t}\n\n\t\t# check if children are saved\n\t\tself.assertEqual(len(si.get(\"items\")), len(expected_values) - 1)\n\n\t\t# check if item values are calculated\n\t\tfor d in si.get(\"items\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.item_code][i])\n\n\t\t# check net total\n\t\tself.assertEqual(si.base_net_total, 1250)\n\t\tself.assertEqual(si.net_total, 1250)\n\n\t\t# check tax calculation\n\t\texpected_values = {\n\t\t\t\"keys\": [\"tax_amount\", \"total\"],\n\t\t\t\"_Test Account Shipping Charges - _TC\": [100, 1350],\n\t\t\t\"_Test Account Customs Duty - _TC\": [125, 1475],\n\t\t\t\"_Test Account Excise Duty - _TC\": [140, 1615],\n\t\t\t\"_Test Account Education Cess - _TC\": [2.8, 1617.8],\n\t\t\t\"_Test Account S&H Education Cess - _TC\": [1.4, 1619.2],\n\t\t\t\"_Test Account CST - _TC\": [32.38, 1651.58],\n\t\t\t\"_Test Account VAT - _TC\": [156.25, 1807.83],\n\t\t\t\"_Test Account Discount - _TC\": [-180.78, 1627.05],\n\t\t}\n\n\t\tfor d in si.get(\"taxes\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.account_head][i])\n\n\t\tself.assertEqual(si.base_grand_total, 1627.05)\n\t\tself.assertEqual(si.grand_total, 1627.05)\n\n\tdef test_payment_entry_unlink_against_invoice(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import get_payment_entry\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.is_pos = 0\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tpe = get_payment_entry(\"Sales Invoice\", si.name, bank_account=\"_Test Bank - _TC\")\n\t\tpe.reference_no = \"1\"\n\t\tpe.reference_date = nowdate()\n\t\tpe.paid_from_account_currency = si.currency\n\t\tpe.paid_to_account_currency = si.currency\n\t\tpe.source_exchange_rate = 1\n\t\tpe.target_exchange_rate = 1\n\t\tpe.paid_amount = si.outstanding_amount\n\t\tpe.insert()\n\t\tpe.submit()\n\n\t\tunlink_payment_on_cancel_of_invoice(0)\n\t\tsi = frappe.get_doc(\"Sales Invoice\", si.name)\n\t\tself.assertRaises(frappe.LinkExistsError, si.cancel)\n\t\tunlink_payment_on_cancel_of_invoice()\n\n\t@IntegrationTestCase.change_settings(\n\t\t\"Accounts Settings\", {\"unlink_payment_on_cancellation_of_invoice\": 1}\n\t)\n\tdef test_payment_entry_unlink_against_standalone_credit_note(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import get_payment_entry\n\n\t\tsi1 = create_sales_invoice(rate=1000)\n\t\tsi2 = create_sales_invoice(rate=300)\n\t\tsi3 = create_sales_invoice(qty=-1, rate=300, is_return=1)\n\n\t\tpe = get_payment_entry(\"Sales Invoice\", si1.name, bank_account=\"_Test Bank - _TC\")\n\t\tpe.append(\n\t\t\t\"references\",\n\t\t\t{\n\t\t\t\t\"reference_doctype\": \"Sales Invoice\",\n\t\t\t\t\"reference_name\": si2.name,\n\t\t\t\t\"total_amount\": si2.grand_total,\n\t\t\t\t\"outstanding_amount\": si2.outstanding_amount,\n\t\t\t\t\"allocated_amount\": si2.outstanding_amount,\n\t\t\t},\n\t\t)\n\n\t\tpe.append(\n\t\t\t\"references\",\n\t\t\t{\n\t\t\t\t\"reference_doctype\": \"Sales Invoice\",\n\t\t\t\t\"reference_name\": si3.name,\n\t\t\t\t\"total_amount\": si3.grand_total,\n\t\t\t\t\"outstanding_amount\": si3.outstanding_amount,\n\t\t\t\t\"allocated_amount\": si3.outstanding_amount,\n\t\t\t},\n\t\t)\n\n\t\tpe.reference_no = \"Test001\"\n\t\tpe.reference_date = nowdate()\n\t\tpe.save()\n\t\tpe.submit()\n\n\t\tsi2.load_from_db()\n\t\tsi2.cancel()\n\n\t\tsi1.load_from_db()\n\t\tself.assertRaises(PaymentEntryUnlinkError, si1.cancel)\n\n\tdef test_sales_invoice_calculation_export_currency(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\t\tsi.currency = \"USD\"\n\t\tsi.conversion_rate = 50\n\t\tsi.get(\"items\")[0].rate = 1\n\t\tsi.get(\"items\")[0].price_list_rate = 1\n\t\tsi.get(\"items\")[1].rate = 3\n\t\tsi.get(\"items\")[1].price_list_rate = 3\n\n\t\t# change shipping to $2\n\t\tsi.get(\"taxes\")[0].tax_amount = 2\n\t\tsi.insert()\n\n\t\texpected_values = {\n\t\t\t\"keys\": [\n\t\t\t\t\"price_list_rate\",\n\t\t\t\t\"discount_percentage\",\n\t\t\t\t\"rate\",\n\t\t\t\t\"amount\",\n\t\t\t\t\"base_price_list_rate\",\n\t\t\t\t\"base_rate\",\n\t\t\t\t\"base_amount\",\n\t\t\t],\n\t\t\t\"_Test Item Home Desktop 100\": [1, 0, 1, 10, 50, 50, 500],\n\t\t\t\"_Test Item Home Desktop 200\": [3, 0, 3, 15, 150, 150, 750],\n\t\t}\n\n\t\t# check if children are saved\n\t\tself.assertEqual(len(si.get(\"items\")), len(expected_values) - 1)\n\n\t\t# check if item values are calculated\n\t\tfor d in si.get(\"items\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.item_code][i])\n\n\t\t# check net total\n\t\tself.assertEqual(si.total, 25)\n\t\tself.assertEqual(si.base_total, 1250)\n\t\tself.assertEqual(si.net_total, 25)\n\t\tself.assertEqual(si.base_net_total, 1250)\n\n\t\t# check tax calculation\n\t\texpected_values = {\n\t\t\t\"keys\": [\"base_tax_amount\", \"base_total\", \"tax_amount\", \"total\"],\n\t\t\t\"_Test Account Shipping Charges - _TC\": [100, 1350, 2, 27],\n\t\t\t\"_Test Account Customs Duty - _TC\": [125, 1475, 2.5, 29.5],\n\t\t\t\"_Test Account Excise Duty - _TC\": [140, 1615, 2.8, 32.3],\n\t\t\t\"_Test Account Education Cess - _TC\": [3, 1618, 0.06, 32.36],\n\t\t\t\"_Test Account S&H Education Cess - _TC\": [1.5, 1619.5, 0.03, 32.39],\n\t\t\t\"_Test Account CST - _TC\": [32.5, 1652, 0.65, 33.04],\n\t\t\t\"_Test Account VAT - _TC\": [156.0, 1808.0, 3.12, 36.16],\n\t\t\t\"_Test Account Discount - _TC\": [-181.0, 1627.0, -3.62, 32.54],\n\t\t}\n\n\t\tfor d in si.get(\"taxes\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.account_head][i])\n\n\t\tself.assertEqual(si.base_grand_total, 1627.0)\n\t\tself.assertEqual(si.grand_total, 32.54)\n\n\tdef test_sales_invoice_with_discount_and_inclusive_tax(self):\n\t\tsi = create_sales_invoice(qty=100, rate=50, do_not_save=True)\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"account_head\": \"_Test Account Service Tax - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"Service Tax\",\n\t\t\t\t\"rate\": 14,\n\t\t\t\t\"included_in_print_rate\": 1,\n\t\t\t},\n\t\t)\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"On Item Quantity\",\n\t\t\t\t\"account_head\": \"_Test Account Education Cess - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"CESS\",\n\t\t\t\t\"rate\": 5,\n\t\t\t\t\"included_in_print_rate\": 1,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\n\t\t# with inclusive tax\n\t\tself.assertEqual(si.items[0].net_amount, 3947.37)\n\t\tself.assertEqual(si.net_total, si.base_net_total)\n\t\tself.assertEqual(si.net_total, 3947.37)\n\t\tself.assertEqual(si.grand_total, 5000)\n\n\t\tsi.reload()\n\n\t\t# additional discount\n\t\tsi.discount_amount = 100\n\t\tsi.apply_discount_on = \"Net Total\"\n\t\tsi.payment_schedule = []\n\n\t\tsi.save()\n\n\t\t# with inclusive tax and additional discount\n\t\tself.assertEqual(si.net_total, 3847.37)\n\t\tself.assertEqual(si.grand_total, 4886)\n\n\t\tsi.reload()\n\n\t\t# additional discount on grand total\n\t\tsi.discount_amount = 100\n\t\tsi.apply_discount_on = \"Grand Total\"\n\t\tsi.payment_schedule = []\n\n\t\tsi.save()\n\n\t\t# with inclusive tax and additional discount\n\t\tself.assertEqual(si.net_total, 3859.65)\n\t\tself.assertEqual(si.grand_total, 4900.00)\n\n\tdef test_sales_invoice_discount_amount(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][3])\n\t\tsi.discount_amount = 104.94\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"On Previous Row Amount\",\n\t\t\t\t\"account_head\": \"_Test Account Service Tax - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"Service Tax\",\n\t\t\t\t\"rate\": 10,\n\t\t\t\t\"row_id\": 8,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\n\t\texpected_values = [\n\t\t\t{\n\t\t\t\t\"item_code\": \"_Test Item Home Desktop 100\",\n\t\t\t\t\"price_list_rate\": 62.5,\n\t\t\t\t\"discount_percentage\": 0,\n\t\t\t\t\"rate\": 62.5,\n\t\t\t\t\"amount\": 625,\n\t\t\t\t\"base_price_list_rate\": 62.5,\n\t\t\t\t\"base_rate\": 62.5,\n\t\t\t\t\"base_amount\": 625,\n\t\t\t\t\"net_rate\": 46.54,\n\t\t\t\t\"net_amount\": 465.37,\n\t\t\t\t\"base_net_rate\": 46.54,\n\t\t\t\t\"base_net_amount\": 465.37,\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"item_code\": \"_Test Item Home Desktop 200\",\n\t\t\t\t\"price_list_rate\": 190.66,\n\t\t\t\t\"discount_percentage\": 0,\n\t\t\t\t\"rate\": 190.66,\n\t\t\t\t\"amount\": 953.3,\n\t\t\t\t\"base_price_list_rate\": 190.66,\n\t\t\t\t\"base_rate\": 190.66,\n\t\t\t\t\"base_amount\": 953.3,\n\t\t\t\t\"net_rate\": 139.62,\n\t\t\t\t\"net_amount\": 698.08,\n\t\t\t\t\"base_net_rate\": 139.62,\n\t\t\t\t\"base_net_amount\": 698.08,\n\t\t\t},\n\t\t]\n\n\t\t# check if children are saved\n\t\tself.assertEqual(len(si.get(\"items\")), len(expected_values))\n\n\t\t# check if item values are calculated\n\t\tfor i, d in enumerate(si.get(\"items\")):\n\t\t\tfor k, v in expected_values[i].items():\n\t\t\t\tself.assertEqual(d.get(k), v)\n\n\t\t# check net total\n\t\tself.assertEqual(si.base_net_total, 1163.45)\n\t\tself.assertEqual(si.total, 1578.3)\n\n\t\t# check tax calculation\n\t\texpected_values = {\n\t\t\t\"keys\": [\"tax_amount\", \"tax_amount_after_discount_amount\", \"total\"],\n\t\t\t\"_Test Account Excise Duty - _TC\": [140, 130.31, 1293.76],\n\t\t\t\"_Test Account Education Cess - _TC\": [2.8, 2.61, 1296.37],\n\t\t\t\"_Test Account S&H Education Cess - _TC\": [1.4, 1.30, 1297.67],\n\t\t\t\"_Test Account CST - _TC\": [27.88, 25.95, 1323.62],\n\t\t\t\"_Test Account VAT - _TC\": [156.25, 145.43, 1469.05],\n\t\t\t\"_Test Account Customs Duty - _TC\": [125, 116.34, 1585.39],\n\t\t\t\"_Test Account Shipping Charges - _TC\": [100, 100, 1685.39],\n\t\t\t\"_Test Account Discount - _TC\": [-180.33, -168.54, 1516.85],\n\t\t\t\"_Test Account Service Tax - _TC\": [-18.03, -16.85, 1500.00],\n\t\t}\n\n\t\tfor d in si.get(\"taxes\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.account_head][i])\n\n\t\tself.assertEqual(si.base_grand_total, 1500)\n\t\tself.assertEqual(si.grand_total, 1500)\n\t\tself.assertEqual(si.rounding_adjustment, 0.0)\n\n\tdef test_discount_amount_gl_entry(self):\n\t\tfrappe.db.set_value(\"Company\", \"_Test Company\", \"round_off_account\", \"Round Off - _TC\")\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][3])\n\t\tsi.discount_amount = 104.94\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"doctype\": \"Sales Taxes and Charges\",\n\t\t\t\t\"charge_type\": \"On Previous Row Amount\",\n\t\t\t\t\"account_head\": \"_Test Account Service Tax - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"Service Tax\",\n\t\t\t\t\"rate\": 10,\n\t\t\t\t\"row_id\": 8,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, debit, credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tself.assertTrue(gl_entries)\n\n\t\texpected_values = dict(\n\t\t\t(d[0], d)\n\t\t\tfor d in [\n\t\t\t\t[si.debit_to, 1500, 0.0],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"items\"][0][\"income_account\"], 0.0, 1163.45],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][0][\"account_head\"], 0.0, 130.31],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][1][\"account_head\"], 0.0, 2.61],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][2][\"account_head\"], 0.0, 1.30],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][3][\"account_head\"], 0.0, 25.95],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][4][\"account_head\"], 0.0, 145.43],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][5][\"account_head\"], 0.0, 116.34],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][6][\"account_head\"], 0.0, 100],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][3][\"taxes\"][7][\"account_head\"], 168.54, 0.0],\n\t\t\t\t[\"_Test Account Service Tax - _TC\", 16.85, 0.0],\n\t\t\t\t[\"Round Off - _TC\", 0.01, 0.0],\n\t\t\t]\n\t\t)\n\n\t\tfor gle in gl_entries:\n\t\t\tself.assertEqual(expected_values[gle.account][0], gle.account)\n\t\t\tself.assertEqual(expected_values[gle.account][1], gle.debit)\n\t\t\tself.assertEqual(expected_values[gle.account][2], gle.credit)\n\n\t\t# cancel\n\t\tsi.cancel()\n\n\t\tgle = frappe.db.sql(\n\t\t\t\"\"\"select * from `tabGL Entry`\n\t\t\twhere voucher_type='Sales Invoice' and voucher_no=%s\"\"\",\n\t\t\tsi.name,\n\t\t)\n\n\t\tself.assertTrue(gle)\n\n\tdef test_tax_calculation_with_multiple_items(self):\n\t\tsi = create_sales_invoice(qty=84, rate=4.6, do_not_save=True)\n\t\titem_row = si.get(\"items\")[0]\n\t\tfor qty in (54, 288, 144, 430):\n\t\t\titem_row_copy = copy.deepcopy(item_row)\n\t\t\titem_row_copy.qty = qty\n\t\t\tsi.append(\"items\", item_row_copy)\n\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"account_head\": \"_Test Account VAT - _TC\",\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"VAT\",\n\t\t\t\t\"doctype\": \"Sales Taxes and Charges\",\n\t\t\t\t\"rate\": 19,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\n\t\tself.assertEqual(si.net_total, 4600)\n\n\t\tself.assertEqual(si.get(\"taxes\")[0].tax_amount, 874.0)\n\t\tself.assertEqual(si.get(\"taxes\")[0].total, 5474.0)\n\n\t\tself.assertEqual(si.grand_total, 5474.0)\n\n\tdef test_tax_calculation_with_item_tax_template(self):\n\t\tsi = create_sales_invoice(qty=84, rate=4.6, do_not_save=True)\n\t\titem_row = si.get(\"items\")[0]\n\n\t\tadd_items = [\n\t\t\t(54, \"_Test Account Excise Duty @ 12 - _TC\"),\n\t\t\t(288, \"_Test Account Excise Duty @ 15 - _TC\"),\n\t\t\t(144, \"_Test Account Excise Duty @ 20 - _TC\"),\n\t\t\t(430, \"_Test Item Tax Template 1 - _TC\"),\n\t\t]\n\t\tfor qty, item_tax_template in add_items:\n\t\t\titem_row_copy = copy.deepcopy(item_row)\n\t\t\titem_row_copy.qty = qty\n\t\t\titem_row_copy.item_tax_template = item_tax_template\n\t\t\tsi.append(\"items\", item_row_copy)\n\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"account_head\": \"_Test Account Excise Duty - _TC\",\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"Excise Duty\",\n\t\t\t\t\"doctype\": \"Sales Taxes and Charges\",\n\t\t\t\t\"rate\": 11,\n\t\t\t},\n\t\t)\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"account_head\": \"_Test Account Education Cess - _TC\",\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"Education Cess\",\n\t\t\t\t\"doctype\": \"Sales Taxes and Charges\",\n\t\t\t\t\"rate\": 0,\n\t\t\t},\n\t\t)\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"account_head\": \"_Test Account S&H Education Cess - _TC\",\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"S&H Education Cess\",\n\t\t\t\t\"doctype\": \"Sales Taxes and Charges\",\n\t\t\t\t\"rate\": 3,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\n\t\tself.assertEqual(si.net_total, 4600)\n\n\t\tself.assertEqual(si.get(\"taxes\")[0].tax_amount, 502.41)\n\t\tself.assertEqual(si.get(\"taxes\")[0].total, 5102.41)\n\n\t\tself.assertEqual(si.get(\"taxes\")[1].tax_amount, 197.80)\n\t\tself.assertEqual(si.get(\"taxes\")[1].total, 5300.21)\n\n\t\tself.assertEqual(si.get(\"taxes\")[2].tax_amount, 375.36)\n\t\tself.assertEqual(si.get(\"taxes\")[2].total, 5675.57)\n\n\t\tself.assertEqual(si.grand_total, 5675.57)\n\t\tself.assertEqual(si.rounding_adjustment, 0.43)\n\t\tself.assertEqual(si.rounded_total, 5676.0)\n\n\tdef test_tax_calculation_with_multiple_items_and_discount(self):\n\t\tsi = create_sales_invoice(qty=1, rate=75, do_not_save=True)\n\t\titem_row = si.get(\"items\")[0]\n\t\tfor rate in (500, 200, 100, 50, 50):\n\t\t\titem_row_copy = copy.deepcopy(item_row)\n\t\t\titem_row_copy.price_list_rate = rate\n\t\t\titem_row_copy.rate = rate\n\t\t\tsi.append(\"items\", item_row_copy)\n\n\t\tsi.apply_discount_on = \"Net Total\"\n\t\tsi.discount_amount = 75.0\n\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"account_head\": \"_Test Account VAT - _TC\",\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"VAT\",\n\t\t\t\t\"doctype\": \"Sales Taxes and Charges\",\n\t\t\t\t\"rate\": 24,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\n\t\tself.assertEqual(si.total, 975)\n\t\tself.assertEqual(si.net_total, 900)\n\n\t\tself.assertEqual(si.get(\"taxes\")[0].tax_amount, 216.0)\n\t\tself.assertEqual(si.get(\"taxes\")[0].total, 1116.0)\n\n\t\tself.assertEqual(si.grand_total, 1116.0)\n\n\tdef test_inclusive_rate_validations(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\t\tfor i, tax in enumerate(si.get(\"taxes\")):\n\t\t\ttax.idx = i + 1\n\n\t\tsi.get(\"items\")[0].price_list_rate = 62.5\n\t\tsi.get(\"items\")[0].price_list_rate = 191\n\t\tfor i in range(6):\n\t\t\tsi.get(\"taxes\")[i].included_in_print_rate = 1\n\n\t\t# tax type \"Actual\" cannot be inclusive\n\t\tself.assertRaises(frappe.ValidationError, si.insert)\n\n\t\t# taxes above included type 'On Previous Row Total' should also be included\n\t\tsi.get(\"taxes\")[0].included_in_print_rate = 0\n\t\tself.assertRaises(frappe.ValidationError, si.insert)\n\n\tdef test_sales_invoice_calculation_base_currency_with_tax_inclusive_price(self):\n\t\t# prepare\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][3])\n\t\tsi.insert()\n\n\t\texpected_values = {\n\t\t\t\"keys\": [\n\t\t\t\t\"price_list_rate\",\n\t\t\t\t\"discount_percentage\",\n\t\t\t\t\"rate\",\n\t\t\t\t\"amount\",\n\t\t\t\t\"base_price_list_rate\",\n\t\t\t\t\"base_rate\",\n\t\t\t\t\"base_amount\",\n\t\t\t\t\"net_rate\",\n\t\t\t\t\"net_amount\",\n\t\t\t],\n\t\t\t\"_Test Item Home Desktop 100\": [\n\t\t\t\t62.5,\n\t\t\t\t0,\n\t\t\t\t62.5,\n\t\t\t\t625.0,\n\t\t\t\t62.5,\n\t\t\t\t62.5,\n\t\t\t\t625.0,\n\t\t\t\t50,\n\t\t\t\t499.98,\n\t\t\t],\n\t\t\t\"_Test Item Home Desktop 200\": [\n\t\t\t\t190.66,\n\t\t\t\t0,\n\t\t\t\t190.66,\n\t\t\t\t953.3,\n\t\t\t\t190.66,\n\t\t\t\t190.66,\n\t\t\t\t953.3,\n\t\t\t\t150,\n\t\t\t\t750,\n\t\t\t],\n\t\t}\n\n\t\t# check if children are saved\n\t\tself.assertEqual(len(si.get(\"items\")), len(expected_values) - 1)\n\n\t\t# check if item values are calculated\n\t\tfor d in si.get(\"items\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.item_code][i])\n\n\t\t# check net total\n\t\tself.assertEqual(si.base_net_total, si.net_total)\n\t\tself.assertEqual(si.net_total, 1249.98)\n\t\tself.assertEqual(si.total, 1578.3)\n\n\t\t# check tax calculation\n\t\texpected_values = {\n\t\t\t\"keys\": [\"tax_amount\", \"total\"],\n\t\t\t\"_Test Account Excise Duty - _TC\": [140, 1389.98],\n\t\t\t\"_Test Account Education Cess - _TC\": [2.8, 1392.78],\n\t\t\t\"_Test Account S&H Education Cess - _TC\": [1.4, 1394.18],\n\t\t\t\"_Test Account CST - _TC\": [27.88, 1422.06],\n\t\t\t\"_Test Account VAT - _TC\": [156.25, 1578.31],\n\t\t\t\"_Test Account Customs Duty - _TC\": [125, 1703.31],\n\t\t\t\"_Test Account Shipping Charges - _TC\": [100, 1803.31],\n\t\t\t\"_Test Account Discount - _TC\": [-180.33, 1622.98],\n\t\t}\n\n\t\tfor d in si.get(\"taxes\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.account_head][i])\n\n\t\tself.assertEqual(si.base_grand_total, 1622.97)\n\t\tself.assertEqual(si.grand_total, 1622.97)\n\n\tdef test_sales_invoice_calculation_export_currency_with_tax_inclusive_price(self):\n\t\t# prepare\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][3])\n\t\tsi.currency = \"USD\"\n\t\tsi.conversion_rate = 50\n\t\tsi.get(\"items\")[0].price_list_rate = 55.56\n\t\tsi.get(\"items\")[0].discount_percentage = 10\n\t\tsi.get(\"items\")[1].price_list_rate = 187.5\n\t\tsi.get(\"items\")[1].discount_percentage = 20\n\n\t\t# change shipping to $2\n\t\tsi.get(\"taxes\")[6].tax_amount = 2\n\n\t\tsi.insert()\n\n\t\texpected_values = [\n\t\t\t{\n\t\t\t\t\"item_code\": \"_Test Item Home Desktop 100\",\n\t\t\t\t\"price_list_rate\": 55.56,\n\t\t\t\t\"discount_percentage\": 10,\n\t\t\t\t\"rate\": 50,\n\t\t\t\t\"amount\": 500,\n\t\t\t\t\"base_price_list_rate\": 2778,\n\t\t\t\t\"base_rate\": 2500,\n\t\t\t\t\"base_amount\": 25000,\n\t\t\t\t\"net_rate\": 40,\n\t\t\t\t\"net_amount\": 399.98,\n\t\t\t\t\"base_net_rate\": 2000,\n\t\t\t\t\"base_net_amount\": 19999,\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"item_code\": \"_Test Item Home Desktop 200\",\n\t\t\t\t\"price_list_rate\": 187.5,\n\t\t\t\t\"discount_percentage\": 20,\n\t\t\t\t\"rate\": 150,\n\t\t\t\t\"amount\": 750,\n\t\t\t\t\"base_price_list_rate\": 9375,\n\t\t\t\t\"base_rate\": 7500,\n\t\t\t\t\"base_amount\": 37500,\n\t\t\t\t\"net_rate\": 118.01,\n\t\t\t\t\"net_amount\": 590.05,\n\t\t\t\t\"base_net_rate\": 5900.5,\n\t\t\t\t\"base_net_amount\": 29502.5,\n\t\t\t},\n\t\t]\n\n\t\t# check if children are saved\n\t\tself.assertEqual(len(si.get(\"items\")), len(expected_values))\n\n\t\t# check if item values are calculated\n\t\tfor i, d in enumerate(si.get(\"items\")):\n\t\t\tfor key, val in expected_values[i].items():\n\t\t\t\tself.assertEqual(d.get(key), val)\n\n\t\t# check net total\n\t\tself.assertEqual(si.base_net_total, 49501.5)\n\t\tself.assertEqual(si.net_total, 990.03)\n\t\tself.assertEqual(si.total, 1250)\n\n\t\t# check tax calculation\n\t\texpected_values = {\n\t\t\t\"keys\": [\"base_tax_amount\", \"base_total\", \"tax_amount\", \"total\"],\n\t\t\t\"_Test Account Excise Duty - _TC\": [5540.0, 55041.5, 110.80, 1100.83],\n\t\t\t\"_Test Account Education Cess - _TC\": [111, 55152.5, 2.22, 1103.05],\n\t\t\t\"_Test Account S&H Education Cess - _TC\": [55.5, 55208.0, 1.11, 1104.16],\n\t\t\t\"_Test Account CST - _TC\": [1104, 56312.0, 22.08, 1126.24],\n\t\t\t\"_Test Account VAT - _TC\": [6187.5, 62499.5, 123.75, 1249.99],\n\t\t\t\"_Test Account Customs Duty - _TC\": [4950.0, 67449.5, 99.0, 1348.99],\n\t\t\t\"_Test Account Shipping Charges - _TC\": [100, 67549.5, 2, 1350.99],\n\t\t\t\"_Test Account Discount - _TC\": [-6755, 60794.5, -135.10, 1215.89],\n\t\t}\n\n\t\tfor d in si.get(\"taxes\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.account_head][i])\n\n\t\tself.assertEqual(si.base_grand_total, 60795)\n\t\tself.assertEqual(si.grand_total, 1215.90)\n\t\t# no rounding adjustment as the Smallest Currency Fraction Value of USD is 0.01\n\t\tif frappe.db.get_value(\"Currency\", \"USD\", \"smallest_currency_fraction_value\") < 0.01:\n\t\t\tself.assertEqual(si.rounding_adjustment, 0.10)\n\t\t\tself.assertEqual(si.base_rounding_adjustment, 5.0)\n\t\telse:\n\t\t\tself.assertEqual(si.rounding_adjustment, 0.0)\n\t\t\tself.assertEqual(si.base_rounding_adjustment, 0.0)\n\n\tdef test_outstanding(self):\n\t\tw = self.make()\n\t\tself.assertEqual(w.outstanding_amount, w.base_rounded_total)\n\n\t@IntegrationTestCase.change_settings(\n\t\t\"Accounts Settings\",\n\t\t{\"add_taxes_from_item_tax_template\": 0, \"add_taxes_from_taxes_and_charges_template\": 0},\n\t)\n\tdef test_rounded_total_with_cash_discount(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\n\t\titem = copy.deepcopy(si.get(\"items\")[0])\n\t\titem.update(\n\t\t\t{\n\t\t\t\t\"qty\": 1,\n\t\t\t\t\"rate\": 14960.66,\n\t\t\t}\n\t\t)\n\n\t\tsi.set(\"items\", [item])\n\t\tsi.set(\"taxes\", [])\n\t\tsi.apply_discount_on = \"Grand Total\"\n\t\tsi.is_cash_or_non_trade_discount = 1\n\t\tsi.discount_amount = 1\n\t\tsi.insert()\n\n\t\tself.assertEqual(si.grand_total, 14959.66)\n\t\tself.assertEqual(si.rounded_total, 14960)\n\t\tself.assertEqual(si.rounding_adjustment, 0.34)\n\n\tdef test_payment(self):\n\t\tw = self.make()\n\t\tjv = frappe.get_doc(frappe.copy_doc(self.globalTestRecords[\"Journal Entry\"][0]))\n\t\tjv.get(\"accounts\")[0].reference_type = w.doctype\n\t\tjv.get(\"accounts\")[0].reference_name = w.name\n\t\tjv.insert()\n\t\tjv.submit()\n\n\t\tself.assertEqual(frappe.db.get_value(\"Sales Invoice\", w.name, \"outstanding_amount\"), 162.0)\n\n\t\tlink_data = get_dynamic_link_map().get(\"Sales Invoice\", [])\n\t\tlink_doctypes = [d.parent for d in link_data]\n\n\t\t# test case for dynamic link order\n\t\tself.assertTrue(link_doctypes.index(\"GL Entry\") > link_doctypes.index(\"Journal Entry Account\"))\n\n\t\tjv.cancel()\n\t\tself.assertEqual(frappe.db.get_value(\"Sales Invoice\", w.name, \"outstanding_amount\"), 562.0)\n\n\tdef test_outstanding_on_cost_center_allocation(self):\n\t\t# setup cost centers\n\t\tfrom erpnext.accounts.doctype.cost_center.test_cost_center import create_cost_center\n\t\tfrom erpnext.accounts.doctype.cost_center_allocation.test_cost_center_allocation import (\n\t\t\tcreate_cost_center_allocation,\n\t\t)\n\n\t\tcost_centers = [\n\t\t\t\"Main Cost Center 1\",\n\t\t\t\"Sub Cost Center 1\",\n\t\t\t\"Sub Cost Center 2\",\n\t\t]\n\t\tfor cc in cost_centers:\n\t\t\tcreate_cost_center(cost_center_name=cc, company=\"_Test Company\")\n\n\t\tcca = create_cost_center_allocation(\n\t\t\t\"_Test Company\",\n\t\t\t\"Main Cost Center 1 - _TC\",\n\t\t\t{\"Sub Cost Center 1 - _TC\": 60, \"Sub Cost Center 2 - _TC\": 40},\n\t\t)\n\n\t\t# make invoice\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.is_pos = 0\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import get_payment_entry\n\n\t\t# make payment - fully paid\n\t\tpe = get_payment_entry(\"Sales Invoice\", si.name, bank_account=\"_Test Bank - _TC\")\n\t\tpe.reference_no = \"1\"\n\t\tpe.reference_date = nowdate()\n\t\tpe.paid_from_account_currency = si.currency\n\t\tpe.paid_to_account_currency = si.currency\n\t\tpe.source_exchange_rate = 1\n\t\tpe.target_exchange_rate = 1\n\t\tpe.paid_amount = si.outstanding_amount\n\t\tpe.cost_center = cca.main_cost_center\n\t\tpe.insert()\n\t\tpe.submit()\n\n\t\t# cancel cost center allocation\n\t\tcca.cancel()\n\n\t\tsi.reload()\n\t\tself.assertEqual(si.outstanding_amount, 0)\n\n\tdef test_sales_invoice_gl_entry_without_perpetual_inventory(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][1])\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, debit, credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tself.assertTrue(gl_entries)\n\n\t\texpected_values = dict(\n\t\t\t(d[0], d)\n\t\t\tfor d in [\n\t\t\t\t[si.debit_to, 630.0, 0.0],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][1][\"items\"][0][\"income_account\"], 0.0, 500.0],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][1][\"taxes\"][0][\"account_head\"], 0.0, 80.0],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][1][\"taxes\"][1][\"account_head\"], 0.0, 50.0],\n\t\t\t]\n\t\t)\n\n\t\tfor _i, gle in enumerate(gl_entries):\n\t\t\tself.assertEqual(expected_values[gle.account][0], gle.account)\n\t\t\tself.assertEqual(expected_values[gle.account][1], gle.debit)\n\t\t\tself.assertEqual(expected_values[gle.account][2], gle.credit)\n\n\t\t# cancel\n\t\tsi.cancel()\n\n\t\tgle = frappe.db.sql(\n\t\t\t\"\"\"select * from `tabGL Entry`\n\t\t\twhere voucher_type='Sales Invoice' and voucher_no=%s\"\"\",\n\t\t\tsi.name,\n\t\t)\n\n\t\tself.assertTrue(gle)\n\n\tdef test_pos_gl_entry_with_perpetual_inventory(self):\n\t\tmake_pos_profile(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\twrite_off_account=\"_Test Write Off - TCP1\",\n\t\t)\n\n\t\tmake_purchase_receipt(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t)\n\n\t\tpos = create_sales_invoice(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\tdo_not_save=True,\n\t\t)\n\n\t\tpos.is_pos = 1\n\t\tpos.update_stock = 1\n\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Bank Draft\", \"amount\": 50})\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 50})\n\n\t\ttaxes = get_taxes_and_charges()\n\t\tpos.taxes = []\n\t\tfor tax in taxes:\n\t\t\tpos.append(\"taxes\", tax)\n\n\t\tsi = frappe.copy_doc(pos)\n\t\tsi.insert()\n\t\tsi.submit()\n\t\tself.assertEqual(si.paid_amount, 100.0)\n\n\t\tself.validate_pos_gl_entry(si, pos, 50)\n\n\tdef test_pos_returns_with_repayment(self):\n\t\tfrom erpnext.accounts.doctype.sales_invoice.sales_invoice import make_sales_return\n\n\t\tpos_profile = make_pos_profile()\n\n\t\tpos_profile.payments = []\n\t\tpos_profile.append(\"payments\", {\"default\": 1, \"mode_of_payment\": \"Cash\"})\n\n\t\tpos_profile.save()\n\n\t\tpos = create_sales_invoice(qty=10, do_not_save=True)\n\n\t\tpos.is_pos = 1\n\t\tpos.pos_profile = pos_profile.name\n\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Bank Draft\", \"amount\": 500})\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 500})\n\t\tpos.insert()\n\t\tpos.submit()\n\n\t\tpos_return = make_sales_return(pos.name)\n\n\t\tpos_return.insert()\n\t\tpos_return.submit()\n\n\t\tself.assertEqual(pos_return.get(\"payments\")[0].amount, -500)\n\t\tself.assertEqual(pos_return.get(\"payments\")[1].amount, -500)\n\n\tdef test_pos_change_amount(self):\n\t\tmake_pos_profile(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\twrite_off_account=\"_Test Write Off - TCP1\",\n\t\t)\n\n\t\tmake_purchase_receipt(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t)\n\n\t\tpos = create_sales_invoice(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\tdo_not_save=True,\n\t\t)\n\n\t\tpos.is_pos = 1\n\t\tpos.update_stock = 1\n\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Bank Draft\", \"amount\": 50})\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 60})\n\n\t\tpos.write_off_outstanding_amount_automatically = 1\n\t\tpos.insert()\n\t\tpos.submit()\n\n\t\tself.assertEqual(pos.grand_total, 100.0)\n\t\tself.assertEqual(pos.write_off_amount, 0)\n\n\tdef test_auto_write_off_amount(self):\n\t\tmake_pos_profile(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\twrite_off_account=\"_Test Write Off - TCP1\",\n\t\t)\n\n\t\tmake_purchase_receipt(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t)\n\n\t\tpos = create_sales_invoice(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\tdo_not_save=True,\n\t\t)\n\n\t\tpos.is_pos = 1\n\t\tpos.update_stock = 1\n\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Bank Draft\", \"amount\": 50})\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 40})\n\n\t\tpos.write_off_outstanding_amount_automatically = 1\n\t\tpos.insert()\n\t\tpos.submit()\n\n\t\tself.assertEqual(pos.grand_total, 100.0)\n\t\tself.assertEqual(pos.write_off_amount, 10)\n\n\tdef test_ledger_entries_of_return_pos_invoice(self):\n\t\tmake_pos_profile()\n\n\t\tpos = create_sales_invoice(do_not_save=True)\n\t\tpos.is_pos = 1\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 100})\n\t\tpos.save().submit()\n\t\tself.assertEqual(pos.outstanding_amount, 0.0)\n\t\tself.assertEqual(pos.status, \"Paid\")\n\n\t\tfrom erpnext.accounts.doctype.sales_invoice.sales_invoice import make_sales_return\n\n\t\tpos_return = make_sales_return(pos.name)\n\t\tpos_return.save().submit()\n\t\tpos_return.reload()\n\t\tpos.reload()\n\t\tself.assertEqual(pos_return.is_return, 1)\n\t\tself.assertEqual(pos_return.return_against, pos.name)\n\t\tself.assertEqual(pos_return.outstanding_amount, 0.0)\n\t\tself.assertEqual(pos_return.status, \"Return\")\n\t\tself.assertEqual(pos.outstanding_amount, 0.0)\n\t\tself.assertEqual(pos.status, \"Credit Note Issued\")\n\n\t\texpected = (\n\t\t\t(\"Cash - _TC\", 0.0, 100.0, pos_return.name, None),\n\t\t\t(\"Debtors - _TC\", 0.0, 100.0, pos_return.name, pos_return.name),\n\t\t\t(\"Debtors - _TC\", 100.0, 0.0, pos_return.name, pos_return.name),\n\t\t\t(\"Sales - _TC\", 100.0, 0.0, pos_return.name, None),\n\t\t)\n\t\tres = frappe.db.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_no\": pos_return.name, \"is_cancelled\": 0},\n\t\t\tfields=[\"account\", \"debit\", \"credit\", \"voucher_no\", \"against_voucher\"],\n\t\t\torder_by=\"account, debit, credit\",\n\t\t\tas_list=1,\n\t\t)\n\t\tself.assertEqual(expected, res)\n\n\tdef test_pos_with_no_gl_entry_for_change_amount(self):\n\t\tfrappe.db.set_single_value(\"POS Settings\", \"post_change_gl_entries\", 0)\n\n\t\tmake_pos_profile(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\twrite_off_account=\"_Test Write Off - TCP1\",\n\t\t)\n\n\t\tmake_purchase_receipt(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t)\n\n\t\tpos = create_sales_invoice(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\titem_code=\"_Test FG Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\tdo_not_save=True,\n\t\t)\n\n\t\tpos.is_pos = 1\n\t\tpos.update_stock = 1\n\n\t\ttaxes = get_taxes_and_charges()\n\t\tpos.taxes = []\n\t\tfor tax in taxes:\n\t\t\tpos.append(\"taxes\", tax)\n\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Bank Draft\", \"amount\": 50})\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 60})\n\n\t\tpos.insert()\n\t\tpos.submit()\n\n\t\tself.assertEqual(pos.grand_total, 100.0)\n\t\tself.assertEqual(pos.change_amount, 10)\n\n\t\tself.validate_pos_gl_entry(pos, pos, 60, validate_without_change_gle=True)\n\n\t\tfrappe.db.set_single_value(\"POS Settings\", \"post_change_gl_entries\", 1)\n\n\tdef validate_pos_gl_entry(self, si, pos, cash_amount, validate_without_change_gle=False):\n\t\tif validate_without_change_gle:\n\t\t\tcash_amount -= pos.change_amount\n\n\t\t# check stock ledger entries\n\t\tsle = frappe.db.sql(\n\t\t\t\"\"\"select * from `tabStock Ledger Entry`\n\t\t\twhere voucher_type = 'Sales Invoice' and voucher_no = %s\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)[0]\n\t\tself.assertTrue(sle)\n\t\tself.assertEqual(\n\t\t\t[sle.item_code, sle.warehouse, sle.actual_qty], [\"_Test FG Item\", \"Stores - TCP1\", -1.0]\n\t\t)\n\n\t\t# check gl entries\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, debit, credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc, debit asc, credit asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\t\tself.assertTrue(gl_entries)\n\n\t\tstock_in_hand = get_inventory_account(\"_Test Company with perpetual inventory\")\n\t\texpected_gl_entries = sorted(\n\t\t\t[\n\t\t\t\t[si.debit_to, 100.0, 0.0],\n\t\t\t\t[pos.items[0].income_account, 0.0, 89.09],\n\t\t\t\t[\"Round Off - TCP1\", 0.0, 0.01],\n\t\t\t\t[pos.taxes[0].account_head, 0.0, 10.69],\n\t\t\t\t[pos.taxes[1].account_head, 0.0, 0.21],\n\t\t\t\t[stock_in_hand, 0.0, abs(sle.stock_value_difference)],\n\t\t\t\t[pos.items[0].expense_account, abs(sle.stock_value_difference), 0.0],\n\t\t\t\t[si.debit_to, 0.0, 50.0],\n\t\t\t\t[si.debit_to, 0.0, cash_amount],\n\t\t\t\t[\"_Test Bank - TCP1\", 50, 0.0],\n\t\t\t\t[\"Cash - TCP1\", cash_amount, 0.0],\n\t\t\t]\n\t\t)\n\n\t\tfor i, gle in enumerate(sorted(gl_entries, key=lambda gle: gle.account)):\n\t\t\tself.assertEqual(expected_gl_entries[i][0], gle.account)\n\t\t\tself.assertEqual(expected_gl_entries[i][1], gle.debit)\n\t\t\tself.assertEqual(expected_gl_entries[i][2], gle.credit)\n\n\t\tsi.cancel()\n\t\tgle = frappe.db.sql(\n\t\t\t\"\"\"select * from `tabGL Entry`\n\t\t\twhere voucher_type='Sales Invoice' and voucher_no=%s\"\"\",\n\t\t\tsi.name,\n\t\t)\n\n\t\tself.assertTrue(gle)\n\n\t\tfrappe.db.sql(\"delete from `tabPOS Profile`\")\n\n\tdef test_bin_details_of_packed_item(self):\n\t\tfrom erpnext.selling.doctype.product_bundle.test_product_bundle import make_product_bundle\n\t\tfrom erpnext.stock.doctype.item.test_item import make_item\n\n\t\t# test Update Items with product bundle\n\t\tif not frappe.db.exists(\"Item\", \"_Test Product Bundle Item New\"):\n\t\t\tbundle_item = make_item(\"_Test Product Bundle Item New\", {\"is_stock_item\": 0})\n\t\t\tbundle_item.append(\n\t\t\t\t\"item_defaults\", {\"company\": \"_Test Company\", \"default_warehouse\": \"_Test Warehouse - _TC\"}\n\t\t\t)\n\t\t\tbundle_item.save(ignore_permissions=True)\n\n\t\tmake_item(\"_Packed Item New 1\", {\"is_stock_item\": 1})\n\t\tmake_product_bundle(\"_Test Product Bundle Item New\", [\"_Packed Item New 1\"], 2)\n\n\t\tsi = create_sales_invoice(\n\t\t\titem_code=\"_Test Product Bundle Item New\",\n\t\t\tupdate_stock=1,\n\t\t\twarehouse=\"_Test Warehouse - _TC\",\n\t\t\ttransaction_date=add_days(nowdate(), -1),\n\t\t\tdo_not_submit=1,\n\t\t)\n\n\t\tmake_stock_entry(item=\"_Packed Item New 1\", target=\"_Test Warehouse - _TC\", qty=120, rate=100)\n\n\t\tbin_details = frappe.db.get_value(\n\t\t\t\"Bin\",\n\t\t\t{\"item_code\": \"_Packed Item New 1\", \"warehouse\": \"_Test Warehouse - _TC\"},\n\t\t\t[\"actual_qty\", \"projected_qty\", \"ordered_qty\"],\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tsi.transaction_date = nowdate()\n\t\tsi.save()\n\n\t\tpacked_item = si.packed_items[0]\n\t\tself.assertEqual(flt(bin_details.actual_qty), flt(packed_item.actual_qty))\n\t\tself.assertEqual(flt(bin_details.projected_qty), flt(packed_item.projected_qty))\n\t\tself.assertEqual(flt(bin_details.ordered_qty), flt(packed_item.ordered_qty))\n\n\tdef test_pos_si_without_payment(self):\n\t\tmake_pos_profile()\n\n\t\tpos = copy.deepcopy(dict(self.globalTestRecords[\"Sales Invoice\"][1]))\n\t\tpos[\"is_pos\"] = 1\n\t\tpos[\"update_stock\"] = 1\n\n\t\tsi = frappe.copy_doc(pos)\n\t\tsi.insert()\n\n\t\t# Check that the invoice cannot be submitted without payments\n\t\tself.assertRaises(frappe.ValidationError, si.submit)\n\n\tdef test_sales_invoice_gl_entry_with_perpetual_inventory_no_item_code(self):\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\tdo_not_save=True,\n\t\t)\n\t\tsi.get(\"items\")[0].item_code = None\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, debit, credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\t\tself.assertTrue(gl_entries)\n\n\t\texpected_values = dict(\n\t\t\t(d[0], d) for d in [[\"Debtors - TCP1\", 100.0, 0.0], [\"Sales - TCP1\", 0.0, 100.0]]\n\t\t)\n\t\tfor _i, gle in enumerate(gl_entries):\n\t\t\tself.assertEqual(expected_values[gle.account][0], gle.account)\n\t\t\tself.assertEqual(expected_values[gle.account][1], gle.debit)\n\t\t\tself.assertEqual(expected_values[gle.account][2], gle.credit)\n\n\tdef test_sales_invoice_gl_entry_with_perpetual_inventory_non_stock_item(self):\n\t\tsi = create_sales_invoice(item=\"_Test Non Stock Item\")\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, debit, credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\t\tself.assertTrue(gl_entries)\n\n\t\texpected_values = dict(\n\t\t\t(d[0], d)\n\t\t\tfor d in [\n\t\t\t\t[si.debit_to, 100.0, 0.0],\n\t\t\t\t[self.globalTestRecords[\"Sales Invoice\"][1][\"items\"][0][\"income_account\"], 0.0, 100.0],\n\t\t\t]\n\t\t)\n\t\tfor _i, gle in enumerate(gl_entries):\n\t\t\tself.assertEqual(expected_values[gle.account][0], gle.account)\n\t\t\tself.assertEqual(expected_values[gle.account][1], gle.debit)\n\t\t\tself.assertEqual(expected_values[gle.account][2], gle.credit)\n\n\tdef _insert_purchase_receipt(self):\n\t\tpr = frappe.copy_doc(self.globalTestRecords[\"Purchase Receipt\"][0])\n\t\tpr.naming_series = \"_T-Purchase Receipt-\"\n\t\tpr.insert()\n\t\tpr.submit()\n\n\tdef _insert_delivery_note(self):\n\t\tdn = frappe.copy_doc(self.globalTestRecords[\"Delivery Note\"][0])\n\t\tdn.naming_series = \"_T-Delivery Note-\"\n\t\tdn.insert()\n\t\tdn.submit()\n\t\treturn dn\n\n\t@IntegrationTestCase.change_settings(\n\t\t\"Accounts Settings\", {\"unlink_payment_on_cancellation_of_invoice\": 1}\n\t)\n\tdef test_sales_invoice_with_advance(self):\n\t\tjv = frappe.copy_doc(self.globalTestRecords[\"Journal Entry\"][0])\n\t\tjv.insert()\n\t\tjv.submit()\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.allocate_advances_automatically = 0\n\t\tsi.append(\n\t\t\t\"advances\",\n\t\t\t{\n\t\t\t\t\"doctype\": \"Sales Invoice Advance\",\n\t\t\t\t\"reference_type\": \"Journal Entry\",\n\t\t\t\t\"reference_name\": jv.name,\n\t\t\t\t\"reference_row\": jv.get(\"accounts\")[0].name,\n\t\t\t\t\"advance_amount\": 400,\n\t\t\t\t\"allocated_amount\": 300,\n\t\t\t\t\"remarks\": jv.remark,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\t\tsi.submit()\n\t\tsi.load_from_db()\n\n\t\tself.assertTrue(\n\t\t\tfrappe.db.sql(\n\t\t\t\t\"\"\"select name from `tabJournal Entry Account`\n\t\t\twhere reference_name=%s\"\"\",\n\t\t\t\tsi.name,\n\t\t\t)\n\t\t)\n\n\t\tself.assertTrue(\n\t\t\tfrappe.db.sql(\n\t\t\t\t\"\"\"select name from `tabJournal Entry Account`\n\t\t\twhere reference_name=%s and credit_in_account_currency=300\"\"\",\n\t\t\t\tsi.name,\n\t\t\t)\n\t\t)\n\n\t\tself.assertEqual(si.outstanding_amount, 262.0)\n\n\t\tsi.cancel()\n\n\tdef test_serialized(self):\n\t\tfrom erpnext.stock.doctype.stock_entry.test_stock_entry import make_serialized_item\n\n\t\tse = make_serialized_item(self)\n\t\tse.load_from_db()\n\t\tserial_nos = get_serial_nos_from_bundle(se.get(\"items\")[0].serial_and_batch_bundle)\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.update_stock = 1\n\t\tsi.get(\"items\")[0].item_code = \"_Test Serialized Item With Series\"\n\t\tsi.get(\"items\")[0].qty = 1\n\t\tsi.get(\"items\")[0].warehouse = se.get(\"items\")[0].t_warehouse\n\t\tsi.get(\"items\")[0].serial_and_batch_bundle = make_serial_batch_bundle(\n\t\t\tfrappe._dict(\n\t\t\t\t{\n\t\t\t\t\t\"item_code\": si.get(\"items\")[0].item_code,\n\t\t\t\t\t\"warehouse\": si.get(\"items\")[0].warehouse,\n\t\t\t\t\t\"company\": si.company,\n\t\t\t\t\t\"qty\": 1,\n\t\t\t\t\t\"voucher_type\": \"Stock Entry\",\n\t\t\t\t\t\"serial_nos\": [serial_nos[0]],\n\t\t\t\t\t\"posting_date\": si.posting_date,\n\t\t\t\t\t\"posting_time\": si.posting_time,\n\t\t\t\t\t\"type_of_transaction\": \"Outward\",\n\t\t\t\t\t\"do_not_submit\": True,\n\t\t\t\t}\n\t\t\t)\n\t\t).name\n\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tself.assertFalse(frappe.db.get_value(\"Serial No\", serial_nos[0], \"warehouse\"))\n\n\t\treturn si\n\n\tdef test_serialized_cancel(self):\n\t\tsi = self.test_serialized()\n\t\tsi.reload()\n\t\tserial_nos = get_serial_nos_from_bundle(si.get(\"items\")[0].serial_and_batch_bundle)\n\n\t\tsi.cancel()\n\n\t\tself.assertEqual(\n\t\t\tfrappe.db.get_value(\"Serial No\", serial_nos[0], \"warehouse\"), \"_Test Warehouse - _TC\"\n\t\t)\n\n\tdef test_serial_numbers_against_delivery_note(self):\n\t\t\"\"\"\n\t\tcheck if the sales invoice item serial numbers and the delivery note items\n\t\tserial numbers are same\n\t\t\"\"\"\n\t\tfrom erpnext.stock.doctype.delivery_note.test_delivery_note import create_delivery_note\n\t\tfrom erpnext.stock.doctype.stock_entry.test_stock_entry import make_serialized_item\n\n\t\tse = make_serialized_item(self)\n\t\tse.load_from_db()\n\t\tserial_nos = get_serial_nos_from_bundle(se.get(\"items\")[0].serial_and_batch_bundle)[0]\n\n\t\tdn = create_delivery_note(item=se.get(\"items\")[0].item_code, serial_no=[serial_nos])\n\t\tdn.submit()\n\t\tdn.load_from_db()\n\n\t\tserial_nos = get_serial_nos_from_bundle(dn.get(\"items\")[0].serial_and_batch_bundle)[0]\n\t\tself.assertTrue(get_serial_nos_from_bundle(se.get(\"items\")[0].serial_and_batch_bundle)[0])\n\n\t\tsi = make_sales_invoice(dn.name)\n\t\tsi.save()\n\n\tdef test_return_sales_invoice(self):\n\t\tmake_stock_entry(item_code=\"_Test Item\", target=\"Stores - TCP1\", qty=50, basic_rate=100)\n\n\t\tactual_qty_0 = get_qty_after_transaction(item_code=\"_Test Item\", warehouse=\"Stores - TCP1\")\n\n\t\tsi = create_sales_invoice(\n\t\t\tqty=5,\n\t\t\trate=500,\n\t\t\tupdate_stock=1,\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\titem_code=\"_Test Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t)\n\n\t\tactual_qty_1 = get_qty_after_transaction(item_code=\"_Test Item\", warehouse=\"Stores - TCP1\")\n\n\t\tself.assertEqual(actual_qty_0 - 5, actual_qty_1)\n\n\t\t# outgoing_rate\n\t\toutgoing_rate = (\n\t\t\tfrappe.db.get_value(\n\t\t\t\t\"Stock Ledger Entry\",\n\t\t\t\t{\"voucher_type\": \"Sales Invoice\", \"voucher_no\": si.name},\n\t\t\t\t\"stock_value_difference\",\n\t\t\t)\n\t\t\t/ 5\n\t\t)\n\n\t\t# return entry\n\t\tsi1 = create_sales_invoice(\n\t\t\tis_return=1,\n\t\t\treturn_against=si.name,\n\t\t\tqty=-2,\n\t\t\trate=500,\n\t\t\tupdate_stock=1,\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\titem_code=\"_Test Item\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t)\n\n\t\tactual_qty_2 = get_qty_after_transaction(item_code=\"_Test Item\", warehouse=\"Stores - TCP1\")\n\t\tself.assertEqual(actual_qty_1 + 2, actual_qty_2)\n\n\t\tincoming_rate, stock_value_difference = frappe.db.get_value(\n\t\t\t\"Stock Ledger Entry\",\n\t\t\t{\"voucher_type\": \"Sales Invoice\", \"voucher_no\": si1.name},\n\t\t\t[\"incoming_rate\", \"stock_value_difference\"],\n\t\t)\n\n\t\tself.assertEqual(flt(incoming_rate, 3), abs(flt(outgoing_rate, 3)))\n\t\tstock_in_hand_account = get_inventory_account(\n\t\t\t\"_Test Company with perpetual inventory\", si1.items[0].warehouse\n\t\t)\n\n\t\t# Check gl entry\n\t\tgle_warehouse_amount = frappe.db.get_value(\n\t\t\t\"GL Entry\",\n\t\t\t{\"voucher_type\": \"Sales Invoice\", \"voucher_no\": si1.name, \"account\": stock_in_hand_account},\n\t\t\t\"debit\",\n\t\t)\n\n\t\tself.assertEqual(gle_warehouse_amount, stock_value_difference)\n\n\t\tparty_credited = frappe.db.get_value(\n\t\t\t\"GL Entry\",\n\t\t\t{\n\t\t\t\t\"voucher_type\": \"Sales Invoice\",\n\t\t\t\t\"voucher_no\": si1.name,\n\t\t\t\t\"account\": \"Debtors - TCP1\",\n\t\t\t\t\"party\": \"_Test Customer\",\n\t\t\t},\n\t\t\t\"credit\",\n\t\t)\n\n\t\tself.assertEqual(party_credited, 1000)\n\n\t\t# Check outstanding amount\n\t\tself.assertEqual(frappe.db.get_value(\"Sales Invoice\", si1.name, \"outstanding_amount\"), -1000)\n\t\tself.assertEqual(frappe.db.get_value(\"Sales Invoice\", si.name, \"outstanding_amount\"), 2500)\n\n\tdef test_zero_qty_return_invoice_with_stock_effect(self):\n\t\tcr_note = create_sales_invoice(qty=-1, rate=300, is_return=1, do_not_submit=True)\n\t\tcr_note.update_stock = True\n\t\tcr_note.items[0].qty = 0\n\t\tself.assertRaises(frappe.ValidationError, cr_note.save)\n\n\tdef test_return_invoice_with_account_mismatch(self):\n\t\tdebtors2 = create_account(\n\t\t\tparent_account=\"Accounts Receivable - _TC\",\n\t\t\taccount_name=\"Debtors 2\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_type=\"Receivable\",\n\t\t)\n\t\tsi = create_sales_invoice(qty=1, rate=1000)\n\t\tcr_note = create_sales_invoice(\n\t\t\tqty=-1, rate=1000, is_return=1, return_against=si.name, debit_to=debtors2, do_not_save=True\n\t\t)\n\t\tself.assertRaises(frappe.ValidationError, cr_note.save)\n\n\tdef test_gle_made_when_asset_is_returned(self):\n\t\tcreate_asset_data()\n\t\tasset = create_asset(item_code=\"Macbook Pro\")\n\n\t\tsi = create_sales_invoice(item_code=\"Macbook Pro\", asset=asset.name, qty=1, rate=90000)\n\t\treturn_si = create_sales_invoice(\n\t\t\tis_return=1,\n\t\t\treturn_against=si.name,\n\t\t\titem_code=\"Macbook Pro\",\n\t\t\tasset=asset.name,\n\t\t\tqty=-1,\n\t\t\trate=90000,\n\t\t)\n\n\t\tdisposal_account = frappe.get_cached_value(\"Company\", \"_Test Company\", \"disposal_account\")\n\n\t\t# Asset value is 100,000 but it was sold for 90,000, so there should be a loss of 10,000\n\t\tloss_for_si = frappe.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_no\": si.name, \"account\": disposal_account},\n\t\t\tfields=[\"credit\", \"debit\"],\n\t\t)[0]\n\n\t\tloss_for_return_si = frappe.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_no\": return_si.name, \"account\": disposal_account},\n\t\t\tfields=[\"credit\", \"debit\"],\n\t\t)[0]\n\n\t\tself.assertEqual(loss_for_si[\"credit\"], loss_for_return_si[\"debit\"])\n\t\tself.assertEqual(loss_for_si[\"debit\"], loss_for_return_si[\"credit\"])\n\n\tdef test_incoming_rate_for_stand_alone_credit_note(self):\n\t\treturn_si = create_sales_invoice(\n\t\t\tis_return=1,\n\t\t\tupdate_stock=1,\n\t\t\tqty=-1,\n\t\t\trate=90000,\n\t\t\tincoming_rate=10,\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t)\n\n\t\tincoming_rate = frappe.db.get_value(\n\t\t\t\"Stock Ledger Entry\", {\"voucher_no\": return_si.name}, \"incoming_rate\"\n\t\t)\n\t\tdebit_amount = frappe.db.get_value(\n\t\t\t\"GL Entry\", {\"voucher_no\": return_si.name, \"account\": \"Stock In Hand - TCP1\"}, \"debit\"\n\t\t)\n\n\t\tself.assertEqual(debit_amount, 10.0)\n\t\tself.assertEqual(incoming_rate, 10.0)\n\n\tdef test_discount_on_net_total(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\t\tsi.apply_discount_on = \"Net Total\"\n\t\tsi.discount_amount = 625\n\t\tsi.insert()\n\n\t\texpected_values = {\n\t\t\t\"keys\": [\n\t\t\t\t\"price_list_rate\",\n\t\t\t\t\"discount_percentage\",\n\t\t\t\t\"rate\",\n\t\t\t\t\"amount\",\n\t\t\t\t\"base_price_list_rate\",\n\t\t\t\t\"base_rate\",\n\t\t\t\t\"base_amount\",\n\t\t\t\t\"net_rate\",\n\t\t\t\t\"base_net_rate\",\n\t\t\t\t\"net_amount\",\n\t\t\t\t\"base_net_amount\",\n\t\t\t],\n\t\t\t\"_Test Item Home Desktop 100\": [50, 0, 50, 500, 50, 50, 500, 25, 25, 250, 250],\n\t\t\t\"_Test Item Home Desktop 200\": [150, 0, 150, 750, 150, 150, 750, 75, 75, 375, 375],\n\t\t}\n\n\t\t# check if children are saved\n\t\tself.assertEqual(len(si.get(\"items\")), len(expected_values) - 1)\n\n\t\t# check if item values are calculated\n\t\tfor d in si.get(\"items\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.item_code][i])\n\n\t\t# check net total\n\t\tself.assertEqual(si.base_total, 1250)\n\t\tself.assertEqual(si.total, 1250)\n\t\tself.assertEqual(si.base_net_total, 625)\n\t\tself.assertEqual(si.net_total, 625)\n\n\t\t# check tax calculation\n\t\texpected_values = {\n\t\t\t\"keys\": [\n\t\t\t\t\"tax_amount\",\n\t\t\t\t\"tax_amount_after_discount_amount\",\n\t\t\t\t\"base_tax_amount_after_discount_amount\",\n\t\t\t],\n\t\t\t\"_Test Account Shipping Charges - _TC\": [100, 100, 100],\n\t\t\t\"_Test Account Customs Duty - _TC\": [62.5, 62.5, 62.5],\n\t\t\t\"_Test Account Excise Duty - _TC\": [70, 70, 70],\n\t\t\t\"_Test Account Education Cess - _TC\": [1.4, 1.4, 1.4],\n\t\t\t\"_Test Account S&H Education Cess - _TC\": [0.7, 0.7, 0.7],\n\t\t\t\"_Test Account CST - _TC\": [17.19, 17.19, 17.19],\n\t\t\t\"_Test Account VAT - _TC\": [78.12, 78.12, 78.12],\n\t\t\t\"_Test Account Discount - _TC\": [-95.49, -95.49, -95.49],\n\t\t}\n\n\t\tfor d in si.get(\"taxes\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tif expected_values.get(d.account_head):\n\t\t\t\t\tself.assertEqual(d.get(k), expected_values[d.account_head][i])\n\n\t\tself.assertEqual(si.total_taxes_and_charges, 234.42)\n\t\tself.assertEqual(si.base_grand_total, 859.42)\n\t\tself.assertEqual(si.grand_total, 859.42)\n\n\tdef test_multi_currency_gle(self):\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"_Test Receivable USD - _TC\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=50,\n\t\t)\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, account_currency, debit, credit,\n\t\t\tdebit_in_account_currency, credit_in_account_currency\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tself.assertTrue(gl_entries)\n\n\t\texpected_values = {\n\t\t\t\"_Test Receivable USD - _TC\": {\n\t\t\t\t\"account_currency\": \"USD\",\n\t\t\t\t\"debit\": 5000,\n\t\t\t\t\"debit_in_account_currency\": 100,\n\t\t\t\t\"credit\": 0,\n\t\t\t\t\"credit_in_account_currency\": 0,\n\t\t\t},\n\t\t\t\"Sales - _TC\": {\n\t\t\t\t\"account_currency\": \"INR\",\n\t\t\t\t\"debit\": 0,\n\t\t\t\t\"debit_in_account_currency\": 0,\n\t\t\t\t\"credit\": 5000,\n\t\t\t\t\"credit_in_account_currency\": 5000,\n\t\t\t},\n\t\t}\n\n\t\tfor field in (\n\t\t\t\"account_currency\",\n\t\t\t\"debit\",\n\t\t\t\"debit_in_account_currency\",\n\t\t\t\"credit\",\n\t\t\t\"credit_in_account_currency\",\n\t\t):\n\t\t\tfor _i, gle in enumerate(gl_entries):\n\t\t\t\tself.assertEqual(expected_values[gle.account][field], gle[field])\n\n\t\t# cancel\n\t\tsi.cancel()\n\n\t\tgle = frappe.db.sql(\n\t\t\t\"\"\"select name from `tabGL Entry`\n\t\t\twhere voucher_type='Sales Invoice' and voucher_no=%s\"\"\",\n\t\t\tsi.name,\n\t\t)\n\n\t\tself.assertTrue(gle)\n\n\tdef test_gle_in_transaction_currency(self):\n\t\t# create multi currency sales invoice with 2 items with same income account\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"_Test Receivable USD - _TC\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=50,\n\t\t\tdo_not_submit=True,\n\t\t)\n\t\t# add 2nd item with same income account\n\t\tsi.append(\n\t\t\t\"items\",\n\t\t\t{\n\t\t\t\t\"item_code\": \"_Test Item\",\n\t\t\t\t\"qty\": 1,\n\t\t\t\t\"rate\": 80,\n\t\t\t\t\"income_account\": \"Sales - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t},\n\t\t)\n\t\tsi.submit()\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select transaction_currency, transaction_exchange_rate,\n\t\t\tdebit_in_transaction_currency, credit_in_transaction_currency\n\t\t\tfrom `tabGL Entry`\n\t\t\twhere voucher_type='Sales Invoice' and voucher_no=%s and account = 'Sales - _TC'\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\texpected_gle = {\n\t\t\t\"transaction_currency\": \"USD\",\n\t\t\t\"transaction_exchange_rate\": 50,\n\t\t\t\"debit_in_transaction_currency\": 0,\n\t\t\t\"credit_in_transaction_currency\": 180,\n\t\t}\n\n\t\tfor gle in gl_entries:\n\t\t\tfor field in expected_gle:\n\t\t\t\tself.assertEqual(expected_gle[field], gle[field])\n\n\tdef test_invalid_currency(self):\n\t\t# Customer currency = USD\n\n\t\t# Transaction currency cannot be INR\n\t\tsi1 = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\", debit_to=\"_Test Receivable USD - _TC\", do_not_save=True\n\t\t)\n\n\t\tself.assertRaises(InvalidCurrency, si1.save)\n\n\t\t# Transaction currency cannot be EUR\n\t\tsi2 = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"_Test Receivable USD - _TC\",\n\t\t\tcurrency=\"EUR\",\n\t\t\tconversion_rate=80,\n\t\t\tdo_not_save=True,\n\t\t)\n\n\t\tself.assertRaises(InvalidCurrency, si2.save)\n\n\t\t# Transaction currency only allowed in USD\n\t\tsi3 = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"_Test Receivable USD - _TC\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=50,\n\t\t)\n\n\t\t# Party Account currency must be in USD, as there is existing GLE with USD\n\t\tsi4 = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"Debtors - _TC\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=50,\n\t\t\tdo_not_submit=True,\n\t\t)\n\n\t\tself.assertRaises(InvalidAccountCurrency, si4.submit)\n\n\t\t# Party Account currency must be in USD, force customer currency as there is no GLE\n\n\t\tsi3.cancel()\n\t\tsi5 = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"Debtors - _TC\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=50,\n\t\t\tdo_not_submit=True,\n\t\t)\n\n\t\tself.assertRaises(InvalidAccountCurrency, si5.submit)\n\n\tdef test_create_so_with_margin(self):\n\t\tsi = create_sales_invoice(item_code=\"_Test Item\", qty=1, do_not_submit=True)\n\t\tprice_list_rate = flt(100) * flt(si.plc_conversion_rate)\n\t\tsi.items[0].price_list_rate = price_list_rate\n\t\tsi.items[0].margin_type = \"Percentage\"\n\t\tsi.items[0].margin_rate_or_amount = 25\n\t\tsi.items[0].discount_amount = 0.0\n\t\tsi.items[0].discount_percentage = 0.0\n\t\tsi.save()\n\t\tself.assertEqual(si.get(\"items\")[0].rate, flt((price_list_rate * 25) / 100 + price_list_rate))\n\n\tdef test_outstanding_amount_after_advance_jv_cancellation(self):\n\t\tjv = frappe.copy_doc(self.globalTestRecords[\"Journal Entry\"][0])\n\t\tjv.accounts[0].is_advance = \"Yes\"\n\t\tjv.insert()\n\t\tjv.submit()\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.append(\n\t\t\t\"advances\",\n\t\t\t{\n\t\t\t\t\"doctype\": \"Sales Invoice Advance\",\n\t\t\t\t\"reference_type\": \"Journal Entry\",\n\t\t\t\t\"reference_name\": jv.name,\n\t\t\t\t\"reference_row\": jv.get(\"accounts\")[0].name,\n\t\t\t\t\"advance_amount\": 400,\n\t\t\t\t\"allocated_amount\": 300,\n\t\t\t\t\"remarks\": jv.remark,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\t\tsi.submit()\n\t\tsi.load_from_db()\n\n\t\t# check outstanding after advance allocation\n\t\tself.assertEqual(\n\t\t\tflt(si.outstanding_amount),\n\t\t\tflt(si.rounded_total - si.total_advance, si.precision(\"outstanding_amount\")),\n\t\t)\n\n\t\t# added to avoid Document has been modified exception\n\t\tjv = frappe.get_doc(\"Journal Entry\", jv.name)\n\t\tjv.cancel()\n\n\t\tsi.load_from_db()\n\t\t# check outstanding after advance cancellation\n\t\tself.assertEqual(\n\t\t\tflt(si.outstanding_amount),\n\t\t\tflt(si.rounded_total + si.total_advance, si.precision(\"outstanding_amount\")),\n\t\t)\n\n\tdef test_outstanding_amount_after_advance_payment_entry_cancellation(self):\n\t\t\"\"\"Test impact of advance PE submission/cancellation on SI and SO.\"\"\"\n\t\tfrom erpnext.selling.doctype.sales_order.test_sales_order import make_sales_order\n\n\t\tsales_order = make_sales_order(item_code=\"138-CMS Shoe\", qty=1, price_list_rate=500)\n\t\tpe = frappe.get_doc(\n\t\t\t{\n\t\t\t\t\"doctype\": \"Payment Entry\",\n\t\t\t\t\"payment_type\": \"Receive\",\n\t\t\t\t\"party_type\": \"Customer\",\n\t\t\t\t\"party\": \"_Test Customer\",\n\t\t\t\t\"company\": \"_Test Company\",\n\t\t\t\t\"paid_from_account_currency\": \"INR\",\n\t\t\t\t\"paid_to_account_currency\": \"INR\",\n\t\t\t\t\"source_exchange_rate\": 1,\n\t\t\t\t\"target_exchange_rate\": 1,\n\t\t\t\t\"reference_no\": \"1\",\n\t\t\t\t\"reference_date\": nowdate(),\n\t\t\t\t\"received_amount\": 300,\n\t\t\t\t\"paid_amount\": 300,\n\t\t\t\t\"paid_from\": \"Debtors - _TC\",\n\t\t\t\t\"paid_to\": \"_Test Cash - _TC\",\n\t\t\t}\n\t\t)\n\t\tpe.append(\n\t\t\t\"references\",\n\t\t\t{\n\t\t\t\t\"reference_doctype\": \"Sales Order\",\n\t\t\t\t\"reference_name\": sales_order.name,\n\t\t\t\t\"total_amount\": sales_order.grand_total,\n\t\t\t\t\"outstanding_amount\": sales_order.grand_total,\n\t\t\t\t\"allocated_amount\": 300,\n\t\t\t},\n\t\t)\n\t\tpe.insert()\n\t\tpe.submit()\n\n\t\tsales_order.reload()\n\t\tself.assertEqual(sales_order.advance_paid, 300)\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.items[0].sales_order = sales_order.name\n\t\tsi.items[0].so_detail = sales_order.get(\"items\")[0].name\n\t\tsi.is_pos = 0\n\t\tsi.append(\n\t\t\t\"advances\",\n\t\t\t{\n\t\t\t\t\"doctype\": \"Sales Invoice Advance\",\n\t\t\t\t\"reference_type\": \"Payment Entry\",\n\t\t\t\t\"reference_name\": pe.name,\n\t\t\t\t\"reference_row\": pe.references[0].name,\n\t\t\t\t\"advance_amount\": 300,\n\t\t\t\t\"allocated_amount\": 300,\n\t\t\t\t\"remarks\": pe.remarks,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tsi.reload()\n\t\tpe.reload()\n\t\tsales_order.reload()\n\n\t\t# Check if SO is unlinked/replaced by SI in PE & if SO advance paid is 0\n\t\tself.assertEqual(pe.references[0].reference_name, si.name)\n\t\tself.assertEqual(sales_order.advance_paid, 300.0)\n\n\t\t# check outstanding after advance allocation\n\t\tself.assertEqual(\n\t\t\tflt(si.outstanding_amount),\n\t\t\tflt(si.rounded_total - si.total_advance, si.precision(\"outstanding_amount\")),\n\t\t)\n\n\t\tpe.cancel()\n\t\tsi.reload()\n\n\t\t# check outstanding after advance cancellation\n\t\tself.assertEqual(\n\t\t\tflt(si.outstanding_amount),\n\t\t\tflt(si.rounded_total + si.total_advance, si.precision(\"outstanding_amount\")),\n\t\t)\n\n\tdef test_multiple_uom_in_selling(self):\n\t\tfrappe.db.sql(\n\t\t\t\"\"\"delete from `tabItem Price`\n\t\t\twhere price_list='_Test Price List' and item_code='_Test Item'\"\"\"\n\t\t)\n\t\titem_price = frappe.new_doc(\"Item Price\")\n\t\titem_price.price_list = \"_Test Price List\"\n\t\titem_price.item_code = \"_Test Item\"\n\t\titem_price.price_list_rate = 100\n\t\titem_price.insert()\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][1])\n\t\tsi.items[0].uom = \"_Test UOM 1\"\n\t\tsi.items[0].conversion_factor = None\n\t\tsi.items[0].price_list_rate = None\n\t\tsi.save()\n\n\t\texpected_values = {\n\t\t\t\"keys\": [\n\t\t\t\t\"price_list_rate\",\n\t\t\t\t\"stock_uom\",\n\t\t\t\t\"uom\",\n\t\t\t\t\"conversion_factor\",\n\t\t\t\t\"rate\",\n\t\t\t\t\"amount\",\n\t\t\t\t\"base_price_list_rate\",\n\t\t\t\t\"base_rate\",\n\t\t\t\t\"base_amount\",\n\t\t\t],\n\t\t\t\"_Test Item\": [1000, \"_Test UOM\", \"_Test UOM 1\", 10.0, 1000, 1000, 1000, 1000, 1000],\n\t\t}\n\n\t\t# check if the conversion_factor and price_list_rate is calculated according to uom\n\t\tfor d in si.get(\"items\"):\n\t\t\tfor i, k in enumerate(expected_values[\"keys\"]):\n\t\t\t\tself.assertEqual(d.get(k), expected_values[d.item_code][i])\n\n\tdef test_item_wise_tax_breakup(self):\n\t\tfrappe.flags.country = \"United States\"\n\n\t\tsi = self.create_si_to_test_tax_breakup()\n\n\t\titemised_tax_data = get_itemised_tax_breakup_data(si)\n\n\t\texpected_itemised_tax = [\n\t\t\t{\n\t\t\t\t\"item\": \"_Test Item\",\n\t\t\t\t\"taxable_amount\": 10000.0,\n\t\t\t\t\"Service Tax\": {\"tax_rate\": 10.0, \"tax_amount\": 1000.0, \"taxable_amount\": 10000.0},\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"item\": \"_Test Item 2\",\n\t\t\t\t\"taxable_amount\": 5000.0,\n\t\t\t\t\"Service Tax\": {\"tax_rate\": 10.0, \"tax_amount\": 500.0, \"taxable_amount\": 5000.0},\n\t\t\t},\n\t\t]\n\n\t\tself.assertEqual(itemised_tax_data, expected_itemised_tax)\n\n\t\tfrappe.flags.country = None\n\n\tdef create_si_to_test_tax_breakup(self):\n\t\tsi = create_sales_invoice(qty=100, rate=50, do_not_save=True)\n\t\tsi.append(\n\t\t\t\"items\",\n\t\t\t{\n\t\t\t\t\"item_code\": \"_Test Item\",\n\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t\t\"qty\": 100,\n\t\t\t\t\"rate\": 50,\n\t\t\t\t\"income_account\": \"Sales - _TC\",\n\t\t\t\t\"expense_account\": \"Cost of Goods Sold - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t},\n\t\t)\n\t\tsi.append(\n\t\t\t\"items\",\n\t\t\t{\n\t\t\t\t\"item_code\": \"_Test Item 2\",\n\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t\t\"qty\": 100,\n\t\t\t\t\"rate\": 50,\n\t\t\t\t\"income_account\": \"Sales - _TC\",\n\t\t\t\t\"expense_account\": \"Cost of Goods Sold - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t},\n\t\t)\n\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"account_head\": \"_Test Account Service Tax - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"Service Tax\",\n\t\t\t\t\"rate\": 10,\n\t\t\t},\n\t\t)\n\t\tsi.insert()\n\t\treturn si\n\n\tdef test_company_monthly_sales(self):\n\t\texisting_current_month_sales = frappe.get_cached_value(\n\t\t\t\"Company\", \"_Test Company\", \"total_monthly_sales\"\n\t\t)\n\n\t\tsi = create_sales_invoice()\n\t\tcurrent_month_sales = frappe.get_cached_value(\"Company\", \"_Test Company\", \"total_monthly_sales\")\n\t\tself.assertEqual(current_month_sales, existing_current_month_sales + si.base_grand_total)\n\n\t\tsi.cancel()\n\t\tcurrent_month_sales = frappe.get_cached_value(\"Company\", \"_Test Company\", \"total_monthly_sales\")\n\t\tself.assertEqual(current_month_sales, existing_current_month_sales)\n\n\tdef test_rounding_adjustment(self):\n\t\tsi = create_sales_invoice(rate=24900, do_not_save=True)\n\t\tfor tax in [\"Tax 1\", \"Tax2\"]:\n\t\t\tsi.append(\n\t\t\t\t\"taxes\",\n\t\t\t\t{\n\t\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\t\"account_head\": \"_Test Account Service Tax - _TC\",\n\t\t\t\t\t\"description\": tax,\n\t\t\t\t\t\"rate\": 14,\n\t\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\t\"included_in_print_rate\": 1,\n\t\t\t\t},\n\t\t\t)\n\t\tsi.save()\n\t\tsi.submit()\n\t\tself.assertEqual(si.net_total, 19453.12)\n\t\tself.assertEqual(si.grand_total, 24900)\n\t\tself.assertEqual(si.total_taxes_and_charges, 5446.88)\n\t\tself.assertEqual(si.rounding_adjustment, 0.0)\n\n\t\texpected_values = dict(\n\t\t\t(d[0], d)\n\t\t\tfor d in [\n\t\t\t\t[si.debit_to, 24900, 0.0],\n\t\t\t\t[\"_Test Account Service Tax - _TC\", 0.0, 5446.88],\n\t\t\t\t[\"Sales - _TC\", 0.0, 19453.12],\n\t\t\t\t[\"Round Off - _TC\", 0.01, 0.0],\n\t\t\t]\n\t\t)\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, debit, credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tfor gle in gl_entries:\n\t\t\tself.assertEqual(expected_values[gle.account][0], gle.account)\n\t\t\tself.assertEqual(expected_values[gle.account][1], gle.debit)\n\t\t\tself.assertEqual(expected_values[gle.account][2], gle.credit)\n\n\tdef test_rounding_adjustment_2(self):\n\t\tsi = create_sales_invoice(rate=400, do_not_save=True)\n\t\tfor rate in [400.25, 600.30, 100.65]:\n\t\t\tsi.append(\n\t\t\t\t\"items\",\n\t\t\t\t{\n\t\t\t\t\t\"item_code\": \"_Test Item\",\n\t\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t\t\t\"qty\": 1,\n\t\t\t\t\t\"rate\": rate,\n\t\t\t\t\t\"income_account\": \"Sales - _TC\",\n\t\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t},\n\t\t\t)\n\t\tfor tax_account in [\"_Test Account VAT - _TC\", \"_Test Account Service Tax - _TC\"]:\n\t\t\tsi.append(\n\t\t\t\t\"taxes\",\n\t\t\t\t{\n\t\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\t\"account_head\": tax_account,\n\t\t\t\t\t\"description\": tax_account,\n\t\t\t\t\t\"rate\": 9,\n\t\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\t\"included_in_print_rate\": 1,\n\t\t\t\t},\n\t\t\t)\n\t\tsi.save()\n\t\tsi.submit()\n\t\tself.assertEqual(si.net_total, si.base_net_total)\n\t\tself.assertEqual(si.net_total, 1272.20)\n\t\tself.assertEqual(si.grand_total, 1501.20)\n\t\tself.assertEqual(si.total_taxes_and_charges, 229)\n\t\tself.assertEqual(si.rounding_adjustment, -0.20)\n\n\t\tround_off_account = frappe.get_cached_value(\"Company\", \"_Test Company\", \"round_off_account\")\n\t\texpected_values = {\n\t\t\t\"_Test Account Service Tax - _TC\": [0.0, 114.50],\n\t\t\t\"_Test Account VAT - _TC\": [0.0, 114.50],\n\t\t\tsi.debit_to: [1501, 0.0],\n\t\t\tround_off_account: [0.20, 0.0],\n\t\t\t\"Sales - _TC\": [0.0, 1272.20],\n\t\t}\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, sum(debit) as debit, sum(credit) as credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\tgroup by account\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tfor gle in gl_entries:\n\t\t\texpected_account_values = expected_values[gle.account]\n\t\t\tself.assertEqual(expected_account_values[0], gle.debit)\n\t\t\tself.assertEqual(expected_account_values[1], gle.credit)\n\n\tdef test_rounding_adjustment_3(self):\n\t\tfrom erpnext.accounts.doctype.accounting_dimension.test_accounting_dimension import create_dimension\n\n\t\t# Dimension creates custom field, which does an implicit DB commit as it is a DDL command\n\t\t# Ensure dimension don't have any mandatory fields\n\t\tcreate_dimension()\n\n\t\t# rollback from tearDown() happens till here\n\t\tsi = create_sales_invoice(do_not_save=True)\n\t\tsi.items = []\n\t\tfor d in [(1122, 2), (1122.01, 1), (1122.01, 1)]:\n\t\t\tsi.append(\n\t\t\t\t\"items\",\n\t\t\t\t{\n\t\t\t\t\t\"item_code\": \"_Test Item\",\n\t\t\t\t\t\"gst_hsn_code\": \"999800\",\n\t\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t\t\t\"qty\": d[1],\n\t\t\t\t\t\"rate\": d[0],\n\t\t\t\t\t\"income_account\": \"Sales - _TC\",\n\t\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t},\n\t\t\t)\n\t\tfor tax_account in [\"_Test Account VAT - _TC\", \"_Test Account Service Tax - _TC\"]:\n\t\t\tsi.append(\n\t\t\t\t\"taxes\",\n\t\t\t\t{\n\t\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\t\"account_head\": tax_account,\n\t\t\t\t\t\"description\": tax_account,\n\t\t\t\t\t\"rate\": 6,\n\t\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\t\"included_in_print_rate\": 1,\n\t\t\t\t},\n\t\t\t)\n\n\t\tsi.cost_center = \"_Test Cost Center 2 - _TC\"\n\t\tsi.location = \"Block 1\"\n\n\t\tsi.save()\n\t\tsi.submit()\n\t\tself.assertEqual(si.net_total, si.base_net_total)\n\t\tself.assertEqual(si.net_total, 4007.15)\n\t\tself.assertEqual(si.grand_total, 4488.02)\n\t\tself.assertEqual(si.total_taxes_and_charges, 480.86)\n\t\tself.assertEqual(si.rounding_adjustment, -0.02)\n\n\t\tround_off_account = frappe.get_cached_value(\"Company\", \"_Test Company\", \"round_off_account\")\n\t\texpected_values = dict(\n\t\t\t(d[0], d)\n\t\t\tfor d in [\n\t\t\t\t[si.debit_to, 4488.0, 0.0],\n\t\t\t\t[\"_Test Account Service Tax - _TC\", 0.0, 240.43],\n\t\t\t\t[\"_Test Account VAT - _TC\", 0.0, 240.43],\n\t\t\t\t[\"Sales - _TC\", 0.0, 4007.15],\n\t\t\t\t[round_off_account, 0.01, 0.0],\n\t\t\t]\n\t\t)\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, sum(debit) as debit, sum(credit) as credit\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\tgroup by account\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tdebit_credit_diff = 0\n\t\tfor gle in gl_entries:\n\t\t\tself.assertEqual(expected_values[gle.account][0], gle.account)\n\t\t\tself.assertEqual(expected_values[gle.account][1], gle.debit)\n\t\t\tself.assertEqual(expected_values[gle.account][2], gle.credit)\n\t\t\tdebit_credit_diff += gle.debit - gle.credit\n\n\t\tself.assertEqual(debit_credit_diff, 0)\n\n\t\tround_off_gle = frappe.db.get_value(\n\t\t\t\"GL Entry\",\n\t\t\t{\"voucher_type\": \"Sales Invoice\", \"voucher_no\": si.name, \"account\": \"Round Off - _TC\"},\n\t\t\t[\"cost_center\", \"location\"],\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tif round_off_gle:\n\t\t\tself.assertEqual(round_off_gle.cost_center, \"_Test Cost Center 2 - _TC\")\n\t\t\tself.assertEqual(round_off_gle.location, \"Block 1\")\n\n\tdef test_sales_invoice_with_shipping_rule(self):\n\t\tfrom erpnext.accounts.doctype.shipping_rule.test_shipping_rule import create_shipping_rule\n\n\t\tshipping_rule = create_shipping_rule(\n\t\t\tshipping_rule_type=\"Selling\", shipping_rule_name=\"Shipping Rule - Sales Invoice Test\"\n\t\t)\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\n\t\tsi.shipping_rule = shipping_rule.name\n\t\tsi.insert()\n\t\tsi.save()\n\n\t\tself.assertEqual(si.net_total, 1250)\n\n\t\tself.assertEqual(si.total_taxes_and_charges, 468.85)\n\t\tself.assertEqual(si.grand_total, 1718.85)\n\n\tdef test_create_invoice_without_terms(self):\n\t\tsi = create_sales_invoice(do_not_save=1)\n\t\tself.assertFalse(si.get(\"payment_schedule\"))\n\n\t\tsi.insert()\n\t\tself.assertTrue(si.get(\"payment_schedule\"))\n\n\tdef test_duplicate_due_date_in_terms(self):\n\t\tsi = create_sales_invoice(do_not_save=1)\n\t\tsi.append(\"payment_schedule\", dict(due_date=\"2017-01-01\", invoice_portion=50.00, payment_amount=50))\n\t\tsi.append(\"payment_schedule\", dict(due_date=\"2017-01-01\", invoice_portion=50.00, payment_amount=50))\n\n\t\tself.assertRaises(frappe.ValidationError, si.insert)\n\n\tdef test_credit_note(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import get_payment_entry\n\n\t\tsi = create_sales_invoice(item_code=\"_Test Item\", qty=(5 * -1), rate=500, is_return=1)\n\n\t\toutstanding_amount = get_outstanding_amount(\n\t\t\tsi.doctype, si.name, \"Debtors - _TC\", si.customer, \"Customer\"\n\t\t)\n\n\t\tself.assertEqual(si.outstanding_amount, outstanding_amount)\n\n\t\tpe = get_payment_entry(\"Sales Invoice\", si.name, bank_account=\"_Test Bank - _TC\")\n\t\tpe.reference_no = \"1\"\n\t\tpe.reference_date = nowdate()\n\t\tpe.paid_from_account_currency = si.currency\n\t\tpe.paid_to_account_currency = si.currency\n\t\tpe.source_exchange_rate = 1\n\t\tpe.target_exchange_rate = 1\n\t\tpe.paid_amount = si.grand_total * -1\n\t\tpe.insert()\n\t\tpe.submit()\n\n\t\tsi_doc = frappe.get_doc(\"Sales Invoice\", si.name)\n\t\tself.assertEqual(si_doc.outstanding_amount, 0)\n\n\tdef test_sales_invoice_with_cost_center(self):\n\t\tfrom erpnext.accounts.doctype.cost_center.test_cost_center import create_cost_center\n\n\t\tcost_center = \"_Test Cost Center for BS Account - _TC\"\n\t\tcreate_cost_center(cost_center_name=\"_Test Cost Center for BS Account\", company=\"_Test Company\")\n\n\t\tsi = create_sales_invoice_against_cost_center(cost_center=cost_center, debit_to=\"Debtors - _TC\")\n\t\tself.assertEqual(si.cost_center, cost_center)\n\n\t\texpected_values = {\n\t\t\t\"Debtors - _TC\": {\"cost_center\": cost_center},\n\t\t\t\"Sales - _TC\": {\"cost_center\": cost_center},\n\t\t}\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, cost_center, account_currency, debit, credit,\n\t\t\tdebit_in_account_currency, credit_in_account_currency\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tself.assertTrue(gl_entries)\n\n\t\tfor gle in gl_entries:\n\t\t\tself.assertEqual(expected_values[gle.account][\"cost_center\"], gle.cost_center)\n\n\tdef test_sales_invoice_with_project_link(self):\n\t\tfrom erpnext.projects.doctype.project.test_project import make_project\n\n\t\tproject = make_project(\n\t\t\t{\n\t\t\t\t\"project_name\": \"Sales Invoice Project\",\n\t\t\t\t\"project_template_name\": \"Test Project Template\",\n\t\t\t\t\"start_date\": \"2020-01-01\",\n\t\t\t}\n\t\t)\n\t\titem_project = make_project(\n\t\t\t{\n\t\t\t\t\"project_name\": \"Sales Invoice Item Project\",\n\t\t\t\t\"project_template_name\": \"Test Project Template\",\n\t\t\t\t\"start_date\": \"2019-06-01\",\n\t\t\t}\n\t\t)\n\n\t\tsales_invoice = create_sales_invoice(do_not_save=1)\n\t\tsales_invoice.items[0].project = item_project.name\n\t\tsales_invoice.project = project.name\n\n\t\tsales_invoice.submit()\n\n\t\texpected_values = {\n\t\t\t\"Debtors - _TC\": {\"project\": project.name},\n\t\t\t\"Sales - _TC\": {\"project\": item_project.name},\n\t\t}\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, cost_center, project, account_currency, debit, credit,\n\t\t\tdebit_in_account_currency, credit_in_account_currency\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsales_invoice.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tself.assertTrue(gl_entries)\n\n\t\tfor gle in gl_entries:\n\t\t\tself.assertEqual(expected_values[gle.account][\"project\"], gle.project)\n\n\tdef test_sales_invoice_without_cost_center(self):\n\t\tcost_center = \"_Test Cost Center - _TC\"\n\t\tsi = create_sales_invoice(debit_to=\"Debtors - _TC\")\n\n\t\texpected_values = {\n\t\t\t\"Debtors - _TC\": {\"cost_center\": None},\n\t\t\t\"Sales - _TC\": {\"cost_center\": cost_center},\n\t\t}\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, cost_center, account_currency, debit, credit,\n\t\t\tdebit_in_account_currency, credit_in_account_currency\n\t\t\tfrom `tabGL Entry` where voucher_type='Sales Invoice' and voucher_no=%s\n\t\t\torder by account asc\"\"\",\n\t\t\tsi.name,\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tself.assertTrue(gl_entries)\n\n\t\tfor gle in gl_entries:\n\t\t\tself.assertEqual(expected_values[gle.account][\"cost_center\"], gle.cost_center)\n\n\t@IntegrationTestCase.change_settings(\n\t\t\"Accounts Settings\",\n\t\t{\"book_deferred_entries_based_on\": \"Days\", \"book_deferred_entries_via_journal_entry\": 0},\n\t)\n\tdef test_deferred_revenue(self):\n\t\tdeferred_account = create_account(\n\t\t\taccount_name=\"Deferred Revenue\",\n\t\t\tparent_account=\"Current Liabilities - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\titem = create_item(\"_Test Item for Deferred Accounting\")\n\t\titem.enable_deferred_revenue = 1\n\t\titem.item_defaults[0].deferred_revenue_account = deferred_account\n\t\titem.no_of_months = 12\n\t\titem.save()\n\n\t\tsi = create_sales_invoice(item=item.name, posting_date=\"2019-01-10\", do_not_submit=True)\n\t\tsi.items[0].enable_deferred_revenue = 1\n\t\tsi.items[0].service_start_date = \"2019-01-10\"\n\t\tsi.items[0].service_end_date = \"2019-03-15\"\n\t\tsi.items[0].deferred_revenue_account = deferred_account\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\tpda1 = frappe.get_doc(\n\t\t\tdoctype=\"Process Deferred Accounting\",\n\t\t\tposting_date=nowdate(),\n\t\t\tstart_date=\"2019-01-01\",\n\t\t\tend_date=\"2019-03-31\",\n\t\t\ttype=\"Income\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\tpda1.insert()\n\t\tpda1.submit()\n\n\t\texpected_gle = [\n\t\t\t[deferred_account, 33.85, 0.0, \"2019-01-31\"],\n\t\t\t[\"Sales - _TC\", 0.0, 33.85, \"2019-01-31\"],\n\t\t\t[deferred_account, 43.08, 0.0, \"2019-02-28\"],\n\t\t\t[\"Sales - _TC\", 0.0, 43.08, \"2019-02-28\"],\n\t\t\t[deferred_account, 23.07, 0.0, \"2019-03-15\"],\n\t\t\t[\"Sales - _TC\", 0.0, 23.07, \"2019-03-15\"],\n\t\t]\n\n\t\tcheck_gl_entries(self, si.name, expected_gle, \"2019-01-30\")\n\n\tdef test_deferred_revenue_missing_account(self):\n\t\tsi = create_sales_invoice(posting_date=\"2019-01-10\", do_not_submit=True)\n\t\tsi.items[0].enable_deferred_revenue = 1\n\t\tsi.items[0].service_start_date = \"2019-01-10\"\n\t\tsi.items[0].service_end_date = \"2019-03-15\"\n\n\t\tself.assertRaises(frappe.ValidationError, si.save)\n\n\t@IntegrationTestCase.change_settings(\n\t\t\"Accounts Settings\",\n\t\t{\"book_deferred_entries_based_on\": \"Months\", \"book_deferred_entries_via_journal_entry\": 0},\n\t)\n\tdef test_fixed_deferred_revenue(self):\n\t\tdeferred_account = create_account(\n\t\t\taccount_name=\"Deferred Revenue\",\n\t\t\tparent_account=\"Current Liabilities - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\titem = create_item(\"_Test Item for Deferred Accounting\")\n\t\titem.enable_deferred_revenue = 1\n\t\titem.deferred_revenue_account = deferred_account\n\t\titem.no_of_months = 12\n\t\titem.save()\n\n\t\tsi = create_sales_invoice(item=item.name, posting_date=\"2019-01-16\", rate=50000, do_not_submit=True)\n\t\tsi.items[0].enable_deferred_revenue = 1\n\t\tsi.items[0].service_start_date = \"2019-01-16\"\n\t\tsi.items[0].service_end_date = \"2019-03-31\"\n\t\tsi.items[0].deferred_revenue_account = deferred_account\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\tpda1 = frappe.get_doc(\n\t\t\tdoctype=\"Process Deferred Accounting\",\n\t\t\tposting_date=\"2019-03-31\",\n\t\t\tstart_date=\"2019-01-01\",\n\t\t\tend_date=\"2019-03-31\",\n\t\t\ttype=\"Income\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\tpda1.insert()\n\t\tpda1.submit()\n\n\t\texpected_gle = [\n\t\t\t[deferred_account, 10000.0, 0.0, \"2019-01-31\"],\n\t\t\t[\"Sales - _TC\", 0.0, 10000.0, \"2019-01-31\"],\n\t\t\t[deferred_account, 20000.0, 0.0, \"2019-02-28\"],\n\t\t\t[\"Sales - _TC\", 0.0, 20000.0, \"2019-02-28\"],\n\t\t\t[deferred_account, 20000.0, 0.0, \"2019-03-31\"],\n\t\t\t[\"Sales - _TC\", 0.0, 20000.0, \"2019-03-31\"],\n\t\t]\n\n\t\tcheck_gl_entries(self, si.name, expected_gle, \"2019-01-30\")\n\n\tdef test_validate_inter_company_transaction_address_links(self):\n\t\tdef _validate_address_link(address, link_doctype, link_name):\n\t\t\treturn frappe.db.get_value(\n\t\t\t\t\"Dynamic Link\",\n\t\t\t\t{\n\t\t\t\t\t\"parent\": address,\n\t\t\t\t\t\"parenttype\": \"Address\",\n\t\t\t\t\t\"link_doctype\": link_doctype,\n\t\t\t\t\t\"link_name\": link_name,\n\t\t\t\t},\n\t\t\t\t\"parent\",\n\t\t\t)\n\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=\"Wind Power LLC\",\n\t\t\tcustomer=\"_Test Internal Customer\",\n\t\t\tdebit_to=\"Debtors - WP\",\n\t\t\twarehouse=\"Stores - WP\",\n\t\t\tincome_account=\"Sales - WP\",\n\t\t\texpense_account=\"Cost of Goods Sold - WP\",\n\t\t\tcost_center=\"Main - WP\",\n\t\t\tcurrency=\"USD\",\n\t\t\tdo_not_save=1,\n\t\t)\n\n\t\tsi.selling_price_list = \"_Test Price List Rest of the World\"\n\t\tsi.submit()\n\n\t\ttarget_doc = make_inter_company_transaction(\"Sales Invoice\", si.name)\n\t\ttarget_doc.items[0].update(\n\t\t\t{\n\t\t\t\t\"expense_account\": \"Cost of Goods Sold - _TC1\",\n\t\t\t\t\"cost_center\": \"Main - _TC1\",\n\t\t\t\t\"warehouse\": \"Stores - _TC1\",\n\t\t\t}\n\t\t)\n\t\ttarget_doc.save()\n\n\t\tif target_doc.doctype in [\"Purchase Invoice\", \"Purchase Order\"]:\n\t\t\tfor details in [\n\t\t\t\t(\"supplier_address\", \"Supplier\", target_doc.supplier),\n\t\t\t\t(\"dispatch_address\", \"Company\", target_doc.company),\n\t\t\t\t(\"shipping_address\", \"Company\", target_doc.company),\n\t\t\t\t(\"billing_address\", \"Company\", target_doc.company),\n\t\t\t]:\n\t\t\t\tif address := target_doc.get(details[0]):\n\t\t\t\t\tself.assertEqual(address, _validate_address_link(address, details[1], details[2]))\n\t\telse:\n\t\t\tfor details in [\n\t\t\t\t(\"company_address\", \"Company\", target_doc.company),\n\t\t\t\t(\"shipping_address_name\", \"Customer\", target_doc.customer),\n\t\t\t\t(\"customer_address\", \"Customer\", target_doc.customer),\n\t\t\t]:\n\t\t\t\tif address := target_doc.get(details[0]):\n\t\t\t\t\tself.assertEqual(address, _validate_address_link(address, details[1], details[2]))\n\n\tdef test_inter_company_transaction(self):\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=\"Wind Power LLC\",\n\t\t\tcustomer=\"_Test Internal Customer\",\n\t\t\tdebit_to=\"Debtors - WP\",\n\t\t\twarehouse=\"Stores - WP\",\n\t\t\tincome_account=\"Sales - WP\",\n\t\t\texpense_account=\"Cost of Goods Sold - WP\",\n\t\t\tcost_center=\"Main - WP\",\n\t\t\tcurrency=\"USD\",\n\t\t\tdo_not_save=1,\n\t\t)\n\n\t\tsi.selling_price_list = \"_Test Price List Rest of the World\"\n\t\tsi.submit()\n\n\t\ttarget_doc = make_inter_company_transaction(\"Sales Invoice\", si.name)\n\t\ttarget_doc.items[0].update(\n\t\t\t{\n\t\t\t\t\"expense_account\": \"Cost of Goods Sold - _TC1\",\n\t\t\t\t\"cost_center\": \"Main - _TC1\",\n\t\t\t\t\"warehouse\": \"Stores - _TC1\",\n\t\t\t}\n\t\t)\n\t\ttarget_doc.submit()\n\n\t\tself.assertEqual(target_doc.company, \"_Test Company 1\")\n\t\tself.assertEqual(target_doc.supplier, \"_Test Internal Supplier\")\n\n\tdef test_inter_company_transaction_without_default_warehouse(self):\n\t\t\"Check mapping (expense account) of inter company SI to PI in absence of default warehouse.\"\n\t\t# setup\n\t\told_negative_stock = frappe.db.get_single_value(\"Stock Settings\", \"allow_negative_stock\")\n\t\tfrappe.db.set_single_value(\"Stock Settings\", \"allow_negative_stock\", 1)\n\n\t\told_perpetual_inventory = erpnext.is_perpetual_inventory_enabled(\"_Test Company 1\")\n\t\tfrappe.local.enable_perpetual_inventory[\"_Test Company 1\"] = 1\n\n\t\tfrappe.db.set_value(\n\t\t\t\"Company\",\n\t\t\t\"_Test Company 1\",\n\t\t\t\"stock_received_but_not_billed\",\n\t\t\t\"Stock Received But Not Billed - _TC1\",\n\t\t)\n\n\t\t# begin test\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=\"Wind Power LLC\",\n\t\t\tcustomer=\"_Test Internal Customer\",\n\t\t\tdebit_to=\"Debtors - WP\",\n\t\t\twarehouse=\"Stores - WP\",\n\t\t\tincome_account=\"Sales - WP\",\n\t\t\texpense_account=\"Cost of Goods Sold - WP\",\n\t\t\tcost_center=\"Main - WP\",\n\t\t\tcurrency=\"USD\",\n\t\t\tupdate_stock=1,\n\t\t\tdo_not_save=1,\n\t\t)\n\t\tsi.selling_price_list = \"_Test Price List Rest of the World\"\n\t\tsi.submit()\n\n\t\ttarget_doc = make_inter_company_transaction(\"Sales Invoice\", si.name)\n\n\t\t# in absence of warehouse Stock Received But Not Billed is set as expense account while mapping\n\t\t# mapping is not obstructed\n\t\tself.assertIsNone(target_doc.items[0].warehouse)\n\t\tself.assertEqual(target_doc.items[0].expense_account, \"Stock Received But Not Billed - _TC1\")\n\n\t\ttarget_doc.items[0].update({\"cost_center\": \"Main - _TC1\"})\n\n\t\t# missing warehouse is validated on save, after mapping\n\t\tself.assertRaises(WarehouseMissingError, target_doc.save)\n\n\t\ttarget_doc.items[0].update({\"warehouse\": \"Stores - _TC1\"})\n\t\ttarget_doc.save()\n\n\t\t# after warehouse is set, linked account or default inventory account is set\n\t\tself.assertEqual(target_doc.items[0].expense_account, \"Stock In Hand - _TC1\")\n\n\t\t# tear down\n\t\tfrappe.local.enable_perpetual_inventory[\"_Test Company 1\"] = old_perpetual_inventory\n\t\tfrappe.db.set_single_value(\"Stock Settings\", \"allow_negative_stock\", old_negative_stock)\n\n\tdef test_sle_for_target_warehouse(self):\n\t\tse = make_stock_entry(\n\t\t\titem_code=\"138-CMS Shoe\",\n\t\t\ttarget=\"Finished Goods - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\tqty=1,\n\t\t\tbasic_rate=500,\n\t\t)\n\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.customer = \"_Test Internal Customer 3\"\n\t\tsi.update_stock = 1\n\t\tsi.set_warehouse = \"Finished Goods - _TC\"\n\t\tsi.set_target_warehouse = \"Stores - _TC\"\n\t\tsi.get(\"items\")[0].warehouse = \"Finished Goods - _TC\"\n\t\tsi.get(\"items\")[0].target_warehouse = \"Stores - _TC\"\n\t\tsi.insert()\n\t\tsi.submit()\n\n\t\tsles = frappe.get_all(\n\t\t\t\"Stock Ledger Entry\", filters={\"voucher_no\": si.name}, fields=[\"name\", \"actual_qty\"]\n\t\t)\n\n\t\t# check if both SLEs are created\n\t\tself.assertEqual(len(sles), 2)\n\t\tself.assertEqual(sum(d.actual_qty for d in sles), 0.0)\n\n\t\t# tear down\n\t\tsi.cancel()\n\t\tse.cancel()\n\n\tdef test_internal_transfer_gl_entry(self):\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tcustomer=\"_Test Internal Customer 2\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\tcurrency=\"INR\",\n\t\t\tdo_not_save=1,\n\t\t)\n\n\t\tsi.selling_price_list = \"_Test Price List Rest of the World\"\n\t\tsi.update_stock = 1\n\t\tsi.items[0].target_warehouse = \"Work In Progress - TCP1\"\n\n\t\t# Add stock to stores for successful stock transfer\n\t\tmake_stock_entry(\n\t\t\ttarget=\"Stores - TCP1\", company=\"_Test Company with perpetual inventory\", qty=1, basic_rate=100\n\t\t)\n\n\t\tadd_taxes(si)\n\t\tsi.save()\n\n\t\trate = 0.0\n\t\tfor d in si.get(\"items\"):\n\t\t\trate = get_incoming_rate(\n\t\t\t\t{\n\t\t\t\t\t\"item_code\": d.item_code,\n\t\t\t\t\t\"warehouse\": d.warehouse,\n\t\t\t\t\t\"posting_date\": si.posting_date,\n\t\t\t\t\t\"posting_time\": si.posting_time,\n\t\t\t\t\t\"qty\": -1 * flt(d.get(\"stock_qty\")),\n\t\t\t\t\t\"serial_and_batch_bundle\": d.serial_and_batch_bundle,\n\t\t\t\t\t\"company\": si.company,\n\t\t\t\t\t\"voucher_type\": \"Sales Invoice\",\n\t\t\t\t\t\"voucher_no\": si.name,\n\t\t\t\t\t\"allow_zero_valuation\": d.get(\"allow_zero_valuation\"),\n\t\t\t\t\t\"voucher_detail_no\": d.name,\n\t\t\t\t},\n\t\t\t\traise_error_if_no_rate=False,\n\t\t\t)\n\n\t\t\trate = flt(rate, 2)\n\n\t\tsi.submit()\n\n\t\ttarget_doc = make_inter_company_transaction(\"Sales Invoice\", si.name)\n\t\ttarget_doc.company = \"_Test Company with perpetual inventory\"\n\t\ttarget_doc.items[0].warehouse = \"Finished Goods - TCP1\"\n\t\tadd_taxes(target_doc)\n\t\ttarget_doc.save()\n\t\ttarget_doc.submit()\n\n\t\ttax_amount = flt(rate * (12 / 100), 2)\n\t\tsi_gl_entries = [\n\t\t\t[\"_Test Account Excise Duty - TCP1\", 0.0, tax_amount, nowdate()],\n\t\t\t[\"Unrealized Profit - TCP1\", tax_amount, 0.0, nowdate()],\n\t\t]\n\n\t\tcheck_gl_entries(self, si.name, si_gl_entries, add_days(nowdate(), -1))\n\n\t\tpi_gl_entries = [\n\t\t\t[\"_Test Account Excise Duty - TCP1\", tax_amount, 0.0, nowdate()],\n\t\t\t[\"Unrealized Profit - TCP1\", 0.0, tax_amount, nowdate()],\n\t\t]\n\n\t\t# Sale and Purchase both should be at valuation rate\n\t\tself.assertEqual(si.items[0].rate, rate)\n\t\tself.assertEqual(target_doc.items[0].rate, rate)\n\n\t\tcheck_gl_entries(\n\t\t\tself, target_doc.name, pi_gl_entries, add_days(nowdate(), -1), voucher_type=\"Purchase Invoice\"\n\t\t)\n\n\tdef test_internal_transfer_gl_precision_issues(self):\n\t\t# Make a stock queue of an item with two valuations\n\n\t\t# Remove all existing stock for this\n\t\tif get_stock_balance(\"_Test Internal Transfer Item\", \"Stores - TCP1\", \"2022-04-10\"):\n\t\t\tcreate_stock_reconciliation(\n\t\t\t\titem_code=\"_Test Internal Transfer Item\",\n\t\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\t\tqty=0,\n\t\t\t\trate=0,\n\t\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\t\texpense_account=\"Stock Adjustment - TCP1\"\n\t\t\t\tif frappe.get_all(\"Stock Ledger Entry\")\n\t\t\t\telse \"Temporary Opening - TCP1\",\n\t\t\t\tposting_date=\"2020-04-10\",\n\t\t\t\tposting_time=\"14:00\",\n\t\t\t)\n\n\t\tmake_stock_entry(\n\t\t\titem_code=\"_Test Internal Transfer Item\",\n\t\t\ttarget=\"Stores - TCP1\",\n\t\t\tqty=9000000,\n\t\t\tbasic_rate=52.0,\n\t\t\tposting_date=\"2020-04-10\",\n\t\t\tposting_time=\"14:00\",\n\t\t)\n\t\tmake_stock_entry(\n\t\t\titem_code=\"_Test Internal Transfer Item\",\n\t\t\ttarget=\"Stores - TCP1\",\n\t\t\tqty=60000000,\n\t\t\tbasic_rate=52.349777,\n\t\t\tposting_date=\"2020-04-10\",\n\t\t\tposting_time=\"14:00\",\n\t\t)\n\n\t\t# Make an internal transfer Sales Invoice Stock in non stock uom to check\n\t\t# for rounding errors while converting to stock uom\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=\"_Test Company with perpetual inventory\",\n\t\t\tcustomer=\"_Test Internal Customer 2\",\n\t\t\titem_code=\"_Test Internal Transfer Item\",\n\t\t\tqty=5000000,\n\t\t\tuom=\"Box\",\n\t\t\tdebit_to=\"Debtors - TCP1\",\n\t\t\twarehouse=\"Stores - TCP1\",\n\t\t\tincome_account=\"Sales - TCP1\",\n\t\t\texpense_account=\"Cost of Goods Sold - TCP1\",\n\t\t\tcost_center=\"Main - TCP1\",\n\t\t\tcurrency=\"INR\",\n\t\t\tdo_not_save=1,\n\t\t)\n\n\t\t# Check GL Entries with precision\n\t\tsi.update_stock = 1\n\t\tsi.items[0].target_warehouse = \"Work In Progress - TCP1\"\n\t\tsi.items[0].conversion_factor = 10\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\t# Check if adjustment entry is created\n\t\tself.assertTrue(\n\t\t\tfrappe.db.exists(\n\t\t\t\t\"GL Entry\",\n\t\t\t\t{\n\t\t\t\t\t\"voucher_type\": \"Sales Invoice\",\n\t\t\t\t\t\"voucher_no\": si.name,\n\t\t\t\t\t\"remarks\": \"Rounding gain/loss Entry for Stock Transfer\",\n\t\t\t\t},\n\t\t\t)\n\t\t)\n\n\tdef test_item_tax_net_range(self):\n\t\titem = create_item(\"T Shirt\")\n\n\t\titem.set(\"taxes\", [])\n\t\titem.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"item_tax_template\": \"_Test Account Excise Duty @ 10 - _TC\",\n\t\t\t\t\"minimum_net_rate\": 0,\n\t\t\t\t\"maximum_net_rate\": 500,\n\t\t\t},\n\t\t)\n\n\t\titem.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"item_tax_template\": \"_Test Account Excise Duty @ 12 - _TC\",\n\t\t\t\t\"minimum_net_rate\": 501,\n\t\t\t\t\"maximum_net_rate\": 1000,\n\t\t\t},\n\t\t)\n\n\t\titem.save()\n\n\t\tsales_invoice = create_sales_invoice(item=\"T Shirt\", rate=700, do_not_submit=True)\n\t\titem_tax_map = get_item_tax_map(\n\t\t\tdoc=sales_invoice,\n\t\t\ttax_template=sales_invoice.items[0].item_tax_template,\n\t\t)\n\n\t\tself.assertEqual(sales_invoice.items[0].item_tax_template, \"_Test Account Excise Duty @ 12 - _TC\")\n\t\tself.assertEqual(sales_invoice.items[0].item_tax_rate, item_tax_map)\n\n\t\t# Apply discount\n\t\tsales_invoice.apply_discount_on = \"Net Total\"\n\t\tsales_invoice.discount_amount = 300\n\t\tsales_invoice.save()\n\n\t\titem_tax_map = get_item_tax_map(\n\t\t\tdoc=sales_invoice,\n\t\t\ttax_template=sales_invoice.items[0].item_tax_template,\n\t\t)\n\n\t\tself.assertEqual(sales_invoice.items[0].item_tax_template, \"_Test Account Excise Duty @ 10 - _TC\")\n\t\tself.assertEqual(sales_invoice.items[0].item_tax_rate, item_tax_map)\n\n\t@IntegrationTestCase.change_settings(\"Selling Settings\", {\"enable_discount_accounting\": 1})\n\tdef test_sales_invoice_with_discount_accounting_enabled(self):\n\t\tdiscount_account = create_account(\n\t\t\taccount_name=\"Discount Account\",\n\t\t\tparent_account=\"Indirect Expenses - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\t\tsi = create_sales_invoice(discount_account=discount_account, discount_percentage=10, rate=90)\n\n\t\texpected_gle = [\n\t\t\t[\"Debtors - _TC\", 90.0, 0.0, nowdate()],\n\t\t\t[\"Discount Account - _TC\", 10.0, 0.0, nowdate()],\n\t\t\t[\"Sales - _TC\", 0.0, 100.0, nowdate()],\n\t\t]\n\n\t\tcheck_gl_entries(self, si.name, expected_gle, add_days(nowdate(), -1))\n\n\t@IntegrationTestCase.change_settings(\"Selling Settings\", {\"enable_discount_accounting\": 1})\n\tdef test_additional_discount_for_sales_invoice_with_discount_accounting_enabled(self):\n\t\tfrom erpnext.accounts.doctype.repost_accounting_ledger.test_repost_accounting_ledger import (\n\t\t\tupdate_repost_settings,\n\t\t)\n\n\t\tupdate_repost_settings()\n\n\t\tadditional_discount_account = create_account(\n\t\t\taccount_name=\"Discount Account\",\n\t\t\tparent_account=\"Indirect Expenses - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\tcreate_account(\n\t\t\taccount_name=\"TDS Payable\",\n\t\t\taccount_type=\"Tax\",\n\t\t\tparent_account=\"Duties and Taxes - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\tsi = create_sales_invoice(parent_cost_center=\"Main - _TC\", do_not_save=1)\n\t\tsi.apply_discount_on = \"Grand Total\"\n\t\tsi.additional_discount_account = additional_discount_account\n\t\tsi.additional_discount_percentage = 20\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"account_head\": \"_Test Account VAT - _TC\",\n\t\t\t\t\"cost_center\": \"Main - _TC\",\n\t\t\t\t\"description\": \"Test\",\n\t\t\t\t\"rate\": 10,\n\t\t\t},\n\t\t)\n\t\tsi.submit()\n\n\t\texpected_gle = [\n\t\t\t[\"_Test Account VAT - _TC\", 0.0, 10.0, nowdate()],\n\t\t\t[\"Debtors - _TC\", 88, 0.0, nowdate()],\n\t\t\t[\"Discount Account - _TC\", 22.0, 0.0, nowdate()],\n\t\t\t[\"Sales - _TC\", 0.0, 100.0, nowdate()],\n\t\t]\n\n\t\tcheck_gl_entries(self, si.name, expected_gle, add_days(nowdate(), -1))\n\n\t\t# Update Invoice post submit and then check GL Entries again\n\n\t\tsi.load_from_db()\n\t\tsi.items[0].income_account = \"Service - _TC\"\n\t\tsi.additional_discount_account = \"_Test Account Sales - _TC\"\n\t\tsi.taxes[0].account_head = \"TDS Payable - _TC\"\n\t\t# Ledger reposted implicitly upon 'Update After Submit'\n\t\tsi.save()\n\n\t\texpected_gle = [\n\t\t\t[\"_Test Account Sales - _TC\", 22.0, 0.0, nowdate()],\n\t\t\t[\"Debtors - _TC\", 88, 0.0, nowdate()],\n\t\t\t[\"Service - _TC\", 0.0, 100.0, nowdate()],\n\t\t\t[\"TDS Payable - _TC\", 0.0, 10.0, nowdate()],\n\t\t]\n\n\t\tcheck_gl_entries(self, si.name, expected_gle, add_days(nowdate(), -1))\n\n\t\t# cases where distributed discount amount is not set\n\t\tfrappe.db.set_value(\n\t\t\t\"Sales Invoice Item\",\n\t\t\t{\"name\": [\"in\", [d.name for d in si.items]]},\n\t\t\t\"distributed_discount_amount\",\n\t\t\t0,\n\t\t)\n\n\t\tsi.load_from_db()\n\t\tsi.additional_discount_account = additional_discount_account\n\t\t# Ledger reposted implicitly upon 'Update After Submit'\n\t\tsi.save()\n\n\t\texpected_gle = [\n\t\t\t[\"Debtors - _TC\", 88, 0.0, nowdate()],\n\t\t\t[\"Discount Account - _TC\", 22.0, 0.0, nowdate()],\n\t\t\t[\"Service - _TC\", 0.0, 100.0, nowdate()],\n\t\t\t[\"TDS Payable - _TC\", 0.0, 10.0, nowdate()],\n\t\t]\n\n\t\tcheck_gl_entries(self, si.name, expected_gle, add_days(nowdate(), -1))\n\n\tdef test_asset_depreciation_on_sale_with_pro_rata(self):\n\t\t\"\"\"\n\t\tTests if an Asset set to depreciate yearly on June 30, that gets sold on Sept 30, creates an additional depreciation entry on its date of sale.\n\t\t\"\"\"\n\n\t\tcreate_asset_data()\n\t\tasset = create_asset(item_code=\"Macbook Pro\", calculate_depreciation=1, submit=1)\n\t\tpost_depreciation_entries(getdate(\"2021-09-30\"))\n\n\t\tcreate_sales_invoice(\n\t\t\titem_code=\"Macbook Pro\", asset=asset.name, qty=1, rate=90000, posting_date=getdate(\"2021-09-30\")\n\t\t)\n\t\tasset.load_from_db()\n\n\t\texpected_values = [\n\t\t\t[\"2020-06-30\", 1366.12, 1366.12],\n\t\t\t[\"2021-06-30\", 20000.0, 21366.12],\n\t\t\t[\"2021-09-30\", 5041.34, 26407.46],\n\t\t]\n\n\t\tfor i, schedule in enumerate(get_depr_schedule(asset.name, \"Active\")):\n\t\t\tself.assertEqual(getdate(expected_values[i][0]), schedule.schedule_date)\n\t\t\tself.assertEqual(expected_values[i][1], schedule.depreciation_amount)\n\t\t\tself.assertEqual(expected_values[i][2], schedule.accumulated_depreciation_amount)\n\t\t\tself.assertTrue(schedule.journal_entry)\n\n\tdef test_asset_depreciation_on_sale_without_pro_rata(self):\n\t\t\"\"\"\n\t\tTests if an Asset set to depreciate yearly on Dec 31, that gets sold on Dec 31 after two years, created an additional depreciation entry on its date of sale.\n\t\t\"\"\"\n\n\t\tcreate_asset_data()\n\t\tasset = create_asset(\n\t\t\titem_code=\"Macbook Pro\",\n\t\t\tcalculate_depreciation=1,\n\t\t\tavailable_for_use_date=getdate(\"2019-12-31\"),\n\t\t\ttotal_number_of_depreciations=3,\n\t\t\texpected_value_after_useful_life=10000,\n\t\t\tdepreciation_start_date=getdate(\"2020-12-31\"),\n\t\t\tsubmit=1,\n\t\t)\n\n\t\tpost_depreciation_entries(getdate(\"2021-09-30\"))\n\n\t\tcreate_sales_invoice(\n\t\t\titem_code=\"Macbook Pro\", asset=asset.name, qty=1, rate=90000, posting_date=getdate(\"2021-12-31\")\n\t\t)\n\t\tasset.load_from_db()\n\n\t\texpected_values = [[\"2020-12-31\", 30000, 30000], [\"2021-12-31\", 30041.15, 60041.15]]\n\n\t\tfor i, schedule in enumerate(get_depr_schedule(asset.name, \"Active\")):\n\t\t\tself.assertEqual(getdate(expected_values[i][0]), schedule.schedule_date)\n\t\t\tself.assertEqual(expected_values[i][1], schedule.depreciation_amount)\n\t\t\tself.assertEqual(expected_values[i][2], schedule.accumulated_depreciation_amount)\n\t\t\tself.assertTrue(schedule.journal_entry)\n\n\tdef test_sales_invoice_against_supplier(self):\n\t\tfrom erpnext.accounts.doctype.opening_invoice_creation_tool.test_opening_invoice_creation_tool import (\n\t\t\tmake_customer,\n\t\t)\n\t\tfrom erpnext.accounts.doctype.party_link.party_link import create_party_link\n\t\tfrom erpnext.buying.doctype.supplier.test_supplier import create_supplier\n\n\t\t# create a customer\n\t\tcustomer = make_customer(customer=\"_Test Common Supplier\")\n\t\t# create a supplier\n\t\tsupplier = create_supplier(supplier_name=\"_Test Common Supplier\").name\n\n\t\t# create a party link between customer & supplier\n\t\tparty_link = create_party_link(\"Supplier\", supplier, customer)\n\n\t\t# enable common party accounting\n\t\tfrappe.db.set_single_value(\"Accounts Settings\", \"enable_common_party_accounting\", 1)\n\n\t\t# create a sales invoice\n\t\tsi = create_sales_invoice(customer=customer, parent_cost_center=\"_Test Cost Center - _TC\")\n\n\t\t# check outstanding of sales invoice\n\t\tsi.reload()\n\t\tself.assertEqual(si.status, \"Paid\")\n\t\tself.assertEqual(flt(si.outstanding_amount), 0.0)\n\n\t\t# check creation of journal entry\n\t\tjv = frappe.get_all(\n\t\t\t\"Journal Entry Account\",\n\t\t\t{\n\t\t\t\t\"account\": si.debit_to,\n\t\t\t\t\"party_type\": \"Customer\",\n\t\t\t\t\"party\": si.customer,\n\t\t\t\t\"reference_type\": si.doctype,\n\t\t\t\t\"reference_name\": si.name,\n\t\t\t},\n\t\t\tpluck=\"credit_in_account_currency\",\n\t\t)\n\n\t\tself.assertTrue(jv)\n\t\tself.assertEqual(jv[0], si.grand_total)\n\n\t\tparty_link.delete()\n\t\tfrappe.db.set_single_value(\"Accounts Settings\", \"enable_common_party_accounting\", 0)\n\n\tdef test_sales_invoice_against_supplier_usd_with_dimensions(self):\n\t\tfrom erpnext.accounts.doctype.opening_invoice_creation_tool.test_opening_invoice_creation_tool import (\n\t\t\tmake_customer,\n\t\t)\n\t\tfrom erpnext.accounts.doctype.party_link.party_link import create_party_link\n\t\tfrom erpnext.buying.doctype.supplier.test_supplier import create_supplier\n\n\t\t# create a customer\n\t\tcustomer = make_customer(customer=\"_Test Common Supplier USD\")\n\t\tcust_doc = frappe.get_doc(\"Customer\", customer)\n\t\tcust_doc.default_currency = \"USD\"\n\t\tcust_doc.save()\n\t\t# create a supplier\n\t\tsupplier = create_supplier(supplier_name=\"_Test Common Supplier USD\").name\n\t\tsupp_doc = frappe.get_doc(\"Supplier\", supplier)\n\t\tsupp_doc.default_currency = \"USD\"\n\t\tsupp_doc.save()\n\n\t\t# create a party link between customer & supplier\n\t\tparty_link = create_party_link(\"Supplier\", supplier, customer)\n\n\t\t# enable common party accounting\n\t\tfrappe.db.set_single_value(\"Accounts Settings\", \"enable_common_party_accounting\", 1)\n\n\t\t# create a dimension and make it mandatory\n\t\tif not frappe.get_all(\"Accounting Dimension\", filters={\"document_type\": \"Department\"}):\n\t\t\tdim = frappe.get_doc(\n\t\t\t\t{\n\t\t\t\t\t\"doctype\": \"Accounting Dimension\",\n\t\t\t\t\t\"document_type\": \"Department\",\n\t\t\t\t\t\"dimension_defaults\": [{\"company\": \"_Test Company\", \"mandatory_for_bs\": True}],\n\t\t\t\t}\n\t\t\t)\n\t\t\tdim.save()\n\t\telse:\n\t\t\tdim = frappe.get_doc(\n\t\t\t\t\"Accounting Dimension\",\n\t\t\t\tfrappe.get_all(\"Accounting Dimension\", filters={\"document_type\": \"Department\"})[0],\n\t\t\t)\n\t\t\tdim.disabled = False\n\t\t\tdim.dimension_defaults = []\n\t\t\tdim.append(\"dimension_defaults\", {\"company\": \"_Test Company\", \"mandatory_for_bs\": True})\n\t\t\tdim.save()\n\n\t\t# create a sales invoice\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=customer, parent_cost_center=\"_Test Cost Center - _TC\", do_not_submit=True\n\t\t)\n\t\tsi.department = \"All Departments\"\n\t\tsi.save().submit()\n\n\t\t# check outstanding of sales invoice\n\t\tsi.reload()\n\t\tself.assertEqual(si.status, \"Paid\")\n\t\tself.assertEqual(flt(si.outstanding_amount), 0.0)\n\n\t\t# check creation of journal entry\n\t\tjv = frappe.get_all(\n\t\t\t\"Journal Entry Account\",\n\t\t\t{\n\t\t\t\t\"account\": si.debit_to,\n\t\t\t\t\"party_type\": \"Customer\",\n\t\t\t\t\"party\": si.customer,\n\t\t\t\t\"reference_type\": si.doctype,\n\t\t\t\t\"reference_name\": si.name,\n\t\t\t\t\"department\": \"All Departments\",\n\t\t\t},\n\t\t\tpluck=\"credit_in_account_currency\",\n\t\t)\n\n\t\tself.assertTrue(jv)\n\t\tself.assertEqual(jv[0], si.grand_total)\n\n\t\tdim.disabled = True\n\t\tdim.save()\n\t\tparty_link.delete()\n\t\tfrappe.db.set_single_value(\"Accounts Settings\", \"enable_common_party_accounting\", 0)\n\n\tdef test_sales_invoice_cancel_with_common_party_advance_jv(self):\n\t\tfrom erpnext.accounts.doctype.opening_invoice_creation_tool.test_opening_invoice_creation_tool import (\n\t\t\tmake_customer,\n\t\t)\n\t\tfrom erpnext.accounts.doctype.party_link.party_link import create_party_link\n\t\tfrom erpnext.buying.doctype.supplier.test_supplier import create_supplier\n\n\t\t# create a customer\n\t\tcustomer = make_customer(customer=\"_Test Common Supplier\")\n\t\t# create a supplier\n\t\tsupplier = create_supplier(supplier_name=\"_Test Common Supplier\").name\n\n\t\t# create a party link between customer & supplier\n\t\tparty_link = create_party_link(\"Supplier\", supplier, customer)\n\n\t\t# enable common party accounting\n\t\tfrappe.db.set_single_value(\"Accounts Settings\", \"enable_common_party_accounting\", 1)\n\n\t\t# create a sales invoice\n\t\tsi = create_sales_invoice(customer=customer)\n\n\t\t# check creation of journal entry\n\t\tjv = frappe.db.get_value(\n\t\t\t\"Journal Entry Account\",\n\t\t\tfilters={\n\t\t\t\t\"reference_type\": si.doctype,\n\t\t\t\t\"reference_name\": si.name,\n\t\t\t\t\"docstatus\": 1,\n\t\t\t},\n\t\t\tfieldname=\"parent\",\n\t\t)\n\n\t\tself.assertTrue(jv)\n\n\t\t# cancel sales invoice\n\t\tsi.cancel()\n\n\t\t# check cancellation of journal entry\n\t\tjv_status = frappe.db.get_value(\"Journal Entry\", jv, \"docstatus\")\n\t\tself.assertEqual(jv_status, 2)\n\n\t\tparty_link.delete()\n\t\tfrappe.db.set_single_value(\"Accounts Settings\", \"enable_common_party_accounting\", 0)\n\n\tdef test_payment_statuses(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import get_payment_entry\n\n\t\ttoday = nowdate()\n\n\t\t# Test Overdue\n\t\tsi = create_sales_invoice(do_not_submit=True)\n\t\tsi.payment_schedule = []\n\t\tsi.append(\n\t\t\t\"payment_schedule\",\n\t\t\t{\"due_date\": add_days(today, -5), \"invoice_portion\": 50, \"payment_amount\": si.grand_total / 2},\n\t\t)\n\t\tsi.append(\n\t\t\t\"payment_schedule\",\n\t\t\t{\"due_date\": add_days(today, 5), \"invoice_portion\": 50, \"payment_amount\": si.grand_total / 2},\n\t\t)\n\t\tsi.submit()\n\t\tself.assertEqual(si.status, \"Overdue\")\n\n\t\t# Test payment less than due amount\n\t\tpe = get_payment_entry(\"Sales Invoice\", si.name, bank_account=\"_Test Bank - _TC\")\n\t\tpe.reference_no = \"1\"\n\t\tpe.reference_date = nowdate()\n\t\tpe.paid_amount = 1\n\t\tpe.references[0].allocated_amount = pe.paid_amount\n\t\tpe.submit()\n\t\tsi.reload()\n\t\tself.assertEqual(si.status, \"Overdue\")\n\n\t\t# Test Partly Paid\n\t\tpe = frappe.copy_doc(pe)\n\t\tpe.paid_amount = si.grand_total / 2\n\t\tpe.references[0].allocated_amount = pe.paid_amount\n\t\tpe.submit()\n\t\tsi.reload()\n\t\tself.assertEqual(si.status, \"Partly Paid\")\n\n\t\t# Test Paid\n\t\tpe = get_payment_entry(\"Sales Invoice\", si.name, bank_account=\"_Test Bank - _TC\")\n\t\tpe.reference_no = \"1\"\n\t\tpe.reference_date = nowdate()\n\t\tpe.paid_amount = si.outstanding_amount\n\t\tpe.submit()\n\t\tsi.reload()\n\t\tself.assertEqual(si.status, \"Paid\")\n\n\tdef test_update_invoice_status(self):\n\t\ttoday = nowdate()\n\n\t\t# Sales Invoice without Payment Schedule\n\t\tsi = create_sales_invoice(posting_date=add_days(today, -5))\n\n\t\t# Sales Invoice with Payment Schedule\n\t\tsi_with_payment_schedule = create_sales_invoice(do_not_submit=True)\n\t\tsi_with_payment_schedule.set(\n\t\t\t\"payment_schedule\",\n\t\t\t[\n\t\t\t\t{\n\t\t\t\t\t\"due_date\": add_days(today, -5),\n\t\t\t\t\t\"invoice_portion\": 50,\n\t\t\t\t\t\"payment_amount\": si_with_payment_schedule.grand_total / 2,\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"due_date\": add_days(today, 5),\n\t\t\t\t\t\"invoice_portion\": 50,\n\t\t\t\t\t\"payment_amount\": si_with_payment_schedule.grand_total / 2,\n\t\t\t\t},\n\t\t\t],\n\t\t)\n\t\tsi_with_payment_schedule.submit()\n\n\t\tfor invoice in (si, si_with_payment_schedule):\n\t\t\tinvoice.db_set(\"status\", \"Unpaid\")\n\t\t\tupdate_invoice_status()\n\t\t\tinvoice.reload()\n\t\t\tself.assertEqual(invoice.status, \"Overdue\")\n\n\t\t\tinvoice.db_set(\"status\", \"Unpaid and Discounted\")\n\t\t\tupdate_invoice_status()\n\t\t\tinvoice.reload()\n\t\t\tself.assertEqual(invoice.status, \"Overdue and Discounted\")\n\n\tdef test_sales_commission(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][2])\n\n\t\tfrappe.db.set_value(\"Item\", si.get(\"items\")[0].item_code, \"grant_commission\", 1)\n\t\tfrappe.db.set_value(\"Item\", si.get(\"items\")[1].item_code, \"grant_commission\", 0)\n\n\t\titem = copy.deepcopy(si.get(\"items\")[0])\n\t\titem.update(\n\t\t\t{\n\t\t\t\t\"qty\": 1,\n\t\t\t\t\"rate\": 500,\n\t\t\t}\n\t\t)\n\n\t\titem = copy.deepcopy(si.get(\"items\")[1])\n\t\titem.update(\n\t\t\t{\n\t\t\t\t\"qty\": 1,\n\t\t\t\t\"rate\": 500,\n\t\t\t}\n\t\t)\n\n\t\t# Test valid values\n\t\tfor commission_rate, total_commission in ((0, 0), (10, 50), (100, 500)):\n\t\t\tsi.commission_rate = commission_rate\n\t\t\tsi.save()\n\t\t\tself.assertEqual(si.amount_eligible_for_commission, 500)\n\t\t\tself.assertEqual(si.total_commission, total_commission)\n\n\t\t# Test invalid values\n\t\tfor commission_rate in (101, -1):\n\t\t\tsi.reload()\n\t\t\tsi.commission_rate = commission_rate\n\t\t\tself.assertRaises(frappe.ValidationError, si.save)\n\n\tdef test_sales_invoice_submission_post_account_freezing_date(self):\n\t\tfrappe.db.set_value(\"Company\", \"_Test Company\", \"accounts_frozen_till_date\", add_days(getdate(), 1))\n\t\tsi = create_sales_invoice(do_not_save=True)\n\t\tsi.posting_date = add_days(getdate(), 1)\n\t\tsi.save()\n\n\t\tself.assertRaises(frappe.ValidationError, si.submit)\n\t\tsi.posting_date = getdate()\n\t\tsi.submit()\n\t\tfrappe.db.set_value(\"Company\", \"_Test Company\", \"accounts_frozen_till_date\", None)\n\n\t@IntegrationTestCase.change_settings(\"Accounts Settings\", {\"over_billing_allowance\": 0})\n\tdef test_over_billing_case_against_delivery_note(self):\n\t\t\"\"\"\n\t\tTest a case where duplicating the item with qty = 1 in the invoice\n\t\tallows overbilling even if it is disabled\n\t\t\"\"\"\n\t\tfrom erpnext.stock.doctype.delivery_note.test_delivery_note import create_delivery_note\n\n\t\tdn = create_delivery_note()\n\t\tdn.submit()\n\n\t\tsi = make_sales_invoice(dn.name)\n\t\titem_copy = frappe.copy_doc(si.items[0])\n\t\tsi.save()\n\n\t\tsi.items = []  # Clear existing items\n\t\tsi.append(\"items\", item_copy)\n\t\tsi.save()\n\n\t\tsi.append(\"items\", item_copy)\n\t\twith self.assertRaises(frappe.ValidationError) as err:\n\t\t\tsi.save()\n\n\t\tself.assertTrue(\"cannot overbill\" in str(err.exception).lower())\n\t\tdn.cancel()\n\n\t@IntegrationTestCase.change_settings(\n\t\t\"Accounts Settings\",\n\t\t{\n\t\t\t\"book_deferred_entries_via_journal_entry\": 1,\n\t\t\t\"submit_journal_entries\": 1,\n\t\t},\n\t)\n\tdef test_multi_currency_deferred_revenue_via_journal_entry(self):\n\t\tdeferred_account = create_account(\n\t\t\taccount_name=\"Deferred Revenue\",\n\t\t\tparent_account=\"Current Liabilities - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\titem = create_item(\"_Test Item for Deferred Accounting\")\n\t\titem.enable_deferred_expense = 1\n\t\titem.item_defaults[0].deferred_revenue_account = deferred_account\n\t\titem.save()\n\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tcurrency=\"USD\",\n\t\t\titem=item.name,\n\t\t\tqty=1,\n\t\t\trate=100,\n\t\t\tconversion_rate=60,\n\t\t\tdo_not_save=True,\n\t\t)\n\n\t\tsi.set_posting_time = 1\n\t\tsi.posting_date = \"2019-01-01\"\n\t\tsi.debit_to = \"_Test Receivable USD - _TC\"\n\t\tsi.items[0].enable_deferred_revenue = 1\n\t\tsi.items[0].service_start_date = \"2019-01-01\"\n\t\tsi.items[0].service_end_date = \"2019-03-30\"\n\t\tsi.items[0].deferred_expense_account = deferred_account\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\tfrappe.db.set_value(\"Company\", \"_Test Company\", \"accounts_frozen_till_date\", getdate(\"2019-01-31\"))\n\n\t\tpda1 = frappe.get_doc(\n\t\t\tdoctype=\"Process Deferred Accounting\",\n\t\t\tposting_date=nowdate(),\n\t\t\tstart_date=\"2019-01-01\",\n\t\t\tend_date=\"2019-03-31\",\n\t\t\ttype=\"Income\",\n\t\t\tcompany=\"_Test Company\",\n\t\t)\n\n\t\tpda1.insert()\n\t\tpda1.submit()\n\n\t\texpected_gle = [\n\t\t\t[\"Sales - _TC\", 0.0, 2089.89, \"2019-01-28\"],\n\t\t\t[deferred_account, 2089.89, 0.0, \"2019-01-28\"],\n\t\t\t[\"Sales - _TC\", 0.0, 1887.64, \"2019-02-28\"],\n\t\t\t[deferred_account, 1887.64, 0.0, \"2019-02-28\"],\n\t\t\t[\"Sales - _TC\", 0.0, 2022.47, \"2019-03-15\"],\n\t\t\t[deferred_account, 2022.47, 0.0, \"2019-03-15\"],\n\t\t]\n\n\t\tgl_entries = frappe.db.sql(\n\t\t\t\"\"\"select account, debit, credit, posting_date\n\t\t\tfrom `tabGL Entry`\n\t\t\twhere voucher_type='Journal Entry' and voucher_detail_no=%s and posting_date <= %s\n\t\t\torder by posting_date asc, account asc\"\"\",\n\t\t\t(si.items[0].name, si.posting_date),\n\t\t\tas_dict=1,\n\t\t)\n\n\t\tfor i, gle in enumerate(gl_entries):\n\t\t\tself.assertEqual(expected_gle[i][0], gle.account)\n\t\t\tself.assertEqual(expected_gle[i][1], gle.credit)\n\t\t\tself.assertEqual(expected_gle[i][2], gle.debit)\n\t\t\tself.assertEqual(getdate(expected_gle[i][3]), gle.posting_date)\n\n\tdef test_standalone_serial_no_return(self):\n\t\tsi = create_sales_invoice(\n\t\t\titem_code=\"_Test Serialized Item With Series\", update_stock=True, is_return=True, qty=-1\n\t\t)\n\t\tsi.reload()\n\t\tself.assertTrue(get_serial_nos_from_bundle(si.items[0].serial_and_batch_bundle))\n\n\tdef test_sales_invoice_with_disabled_account(self):\n\t\ttry:\n\t\t\taccount_name = \"Sales Expenses - _TC\"\n\t\t\taccount = frappe.get_doc(\"Account\", account_name)\n\t\t\taccount.disabled = 1\n\t\t\taccount.save()\n\n\t\t\tsi = create_sales_invoice(do_not_save=True)\n\t\t\tsi.posting_date = add_days(getdate(), 1)\n\t\t\tsi.taxes = []\n\n\t\t\tsi.append(\n\t\t\t\t\"taxes\",\n\t\t\t\t{\n\t\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\t\"account_head\": account_name,\n\t\t\t\t\t\"cost_center\": \"Main - _TC\",\n\t\t\t\t\t\"description\": \"Commission\",\n\t\t\t\t\t\"rate\": 5,\n\t\t\t\t},\n\t\t\t)\n\t\t\tsi.save()\n\n\t\t\twith self.assertRaises(frappe.ValidationError) as err:\n\t\t\t\tsi.submit()\n\n\t\t\tself.assertTrue(\n\t\t\t\t\"Cannot create accounting entries against disabled accounts\" in str(err.exception)\n\t\t\t)\n\n\t\tfinally:\n\t\t\taccount.disabled = 0\n\t\t\taccount.save()\n\n\t@IntegrationTestCase.change_settings(\n\t\t\"Accounts Settings\", {\"unlink_payment_on_cancellation_of_invoice\": 1}\n\t)\n\tdef test_gain_loss_with_advance_entry(self):\n\t\tfrom erpnext.accounts.doctype.journal_entry.test_journal_entry import make_journal_entry\n\n\t\tjv = make_journal_entry(\"_Test Receivable USD - _TC\", \"_Test Bank - _TC\", -7000, save=False)\n\n\t\tjv.accounts[0].exchange_rate = 70\n\t\tjv.accounts[0].credit_in_account_currency = 100\n\t\tjv.accounts[0].party_type = \"Customer\"\n\t\tjv.accounts[0].party = \"_Test Customer USD\"\n\n\t\tjv.save()\n\t\tjv.submit()\n\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"_Test Receivable USD - _TC\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=75,\n\t\t\tdo_not_save=1,\n\t\t\trate=100,\n\t\t)\n\n\t\tsi.append(\n\t\t\t\"advances\",\n\t\t\t{\n\t\t\t\t\"reference_type\": \"Journal Entry\",\n\t\t\t\t\"reference_name\": jv.name,\n\t\t\t\t\"reference_row\": jv.accounts[0].name,\n\t\t\t\t\"advance_amount\": 100,\n\t\t\t\t\"allocated_amount\": 100,\n\t\t\t\t\"ref_exchange_rate\": 70,\n\t\t\t},\n\t\t)\n\t\tsi.save()\n\t\tsi.submit()\n\t\texpected_gle = [\n\t\t\t[\"_Test Receivable USD - _TC\", 7500.0, 0.0, nowdate()],\n\t\t\t[\"Sales - _TC\", 0.0, 7500.0, nowdate()],\n\t\t]\n\t\tcheck_gl_entries(self, si.name, expected_gle, nowdate())\n\n\t\tsi.reload()\n\t\tself.assertEqual(si.outstanding_amount, 0)\n\t\tjournals = frappe.db.get_all(\n\t\t\t\"Journal Entry Account\",\n\t\t\tfilters={\"reference_type\": \"Sales Invoice\", \"reference_name\": si.name, \"docstatus\": 1},\n\t\t\tpluck=\"parent\",\n\t\t)\n\t\tjournals = [x for x in journals if x != jv.name]\n\t\tself.assertEqual(len(journals), 1)\n\t\tje_type = frappe.get_cached_value(\"Journal Entry\", journals[0], \"voucher_type\")\n\t\tself.assertEqual(je_type, \"Exchange Gain Or Loss\")\n\t\tfrappe.db.get_all(\n\t\t\t\"Payment Ledger Entry\",\n\t\t\tfilters={\"against_voucher_no\": si.name, \"delinked\": 0},\n\t\t\tfields=[{\"SUM\": \"amount\"}, {\"SUM\": \"amount_in_account_currency\"}],\n\t\t\tas_list=1,\n\t\t)\n\n\tdef test_batch_expiry_for_sales_invoice_return(self):\n\t\tfrom erpnext.controllers.sales_and_purchase_return import make_return_doc\n\t\tfrom erpnext.stock.doctype.item.test_item import make_item\n\n\t\titem = make_item(\n\t\t\t\"_Test Batch Item For Return Check\",\n\t\t\t{\n\t\t\t\t\"is_purchase_item\": 1,\n\t\t\t\t\"is_stock_item\": 1,\n\t\t\t\t\"has_batch_no\": 1,\n\t\t\t\t\"create_new_batch\": 1,\n\t\t\t\t\"batch_number_series\": \"TBIRC.#####\",\n\t\t\t},\n\t\t)\n\n\t\tpr = make_purchase_receipt(qty=1, item_code=item.name)\n\n\t\tbatch_no = get_batch_from_bundle(pr.items[0].serial_and_batch_bundle)\n\t\tsi = create_sales_invoice(qty=1, item_code=item.name, update_stock=1, batch_no=batch_no)\n\n\t\tsi.load_from_db()\n\t\tbatch_no = get_batch_from_bundle(si.items[0].serial_and_batch_bundle)\n\t\tself.assertTrue(batch_no)\n\n\t\tfrappe.db.set_value(\"Batch\", batch_no, \"expiry_date\", add_days(today(), -1))\n\n\t\treturn_si = make_return_doc(si.doctype, si.name)\n\t\treturn_si.save().submit()\n\n\t\tself.assertTrue(return_si.docstatus == 1)\n\n\tdef test_sales_invoice_with_payable_tax_account(self):\n\t\tsi = create_sales_invoice(do_not_submit=True)\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Creditors - _TC\",\n\t\t\t\t\"description\": \"Test\",\n\t\t\t\t\"cost_center\": \"Main - _TC\",\n\t\t\t\t\"tax_amount\": 10,\n\t\t\t\t\"total\": 10,\n\t\t\t\t\"dont_recompute_tax\": 0,\n\t\t\t},\n\t\t)\n\t\tself.assertRaises(frappe.ValidationError, si.submit)\n\n\tdef test_advance_entries_as_liability(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import create_payment_entry\n\n\t\tadvance_account = create_account(\n\t\t\tparent_account=\"Current Liabilities - _TC\",\n\t\t\taccount_name=\"Advances Received\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_type=\"Receivable\",\n\t\t)\n\n\t\tset_advance_flag(company=\"_Test Company\", flag=1, default_account=advance_account)\n\n\t\tpe = create_payment_entry(\n\t\t\tcompany=\"_Test Company\",\n\t\t\tpayment_type=\"Receive\",\n\t\t\tparty_type=\"Customer\",\n\t\t\tparty=\"_Test Customer\",\n\t\t\tpaid_from=advance_account,\n\t\t\tpaid_to=\"Cash - _TC\",\n\t\t\tpaid_amount=1000,\n\t\t)\n\t\tpe.submit()\n\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=\"_Test Company\",\n\t\t\tcustomer=\"_Test Customer\",\n\t\t\tdo_not_save=True,\n\t\t\tdo_not_submit=True,\n\t\t\trate=500,\n\t\t\tprice_list_rate=500,\n\t\t)\n\t\tsi.base_grand_total = 500\n\t\tsi.grand_total = 500\n\t\tsi.set_advances()\n\t\tfor advance in si.advances:\n\t\t\tadvance.allocated_amount = 500 if advance.reference_name == pe.name else 0\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\tself.assertEqual(si.advances[0].allocated_amount, 500)\n\n\t\t# Check GL Entry against payment doctype\n\t\texpected_gle = [\n\t\t\t[\"Advances Received - _TC\", 0.0, 1000.0, nowdate()],\n\t\t\t[\"Advances Received - _TC\", 500, 0.0, nowdate()],\n\t\t\t[\"Cash - _TC\", 1000, 0.0, nowdate()],\n\t\t\t[\"Debtors - _TC\", 0.0, 500, nowdate()],\n\t\t]\n\n\t\tcheck_gl_entries(self, pe.name, expected_gle, nowdate(), voucher_type=\"Payment Entry\")\n\n\t\tsi.load_from_db()\n\t\tself.assertEqual(si.outstanding_amount, 0)\n\n\t\tset_advance_flag(company=\"_Test Company\", flag=0, default_account=\"\")\n\n\t@IntegrationTestCase.change_settings(\"Selling Settings\", {\"customer_group\": None, \"territory\": None})\n\tdef test_sales_invoice_without_customer_group_and_territory(self):\n\t\t# create a customer\n\t\tif not frappe.db.exists(\"Customer\", \"_Test Simple Customer\"):\n\t\t\tcustomer_dict = get_customer_dict(\"_Test Simple Customer\")\n\t\t\tcustomer_dict.pop(\"customer_group\")\n\t\t\tcustomer_dict.pop(\"territory\")\n\t\t\tcustomer = frappe.get_doc(customer_dict).insert(ignore_permissions=True)\n\n\t\t\tself.assertEqual(customer.customer_group, None)\n\t\t\tself.assertEqual(customer.territory, None)\n\n\t\t# create a sales invoice\n\t\tsi = create_sales_invoice(customer=\"_Test Simple Customer\")\n\t\tself.assertEqual(si.docstatus, 1)\n\t\tself.assertEqual(si.customer_group, None)\n\t\tself.assertEqual(si.territory, None)\n\n\t@IntegrationTestCase.change_settings(\"Selling Settings\", {\"allow_negative_rates_for_items\": 0})\n\tdef test_sales_return_negative_rate(self):\n\t\tsi = create_sales_invoice(is_return=1, qty=-2, rate=-10, do_not_save=True)\n\t\tself.assertRaises(frappe.ValidationError, si.save)\n\n\t\tsi.items[0].rate = 10\n\t\tsi.save()\n\n\tdef test_partial_allocation_on_advance_as_liability(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import create_payment_entry\n\n\t\tcompany = \"_Test Company\"\n\t\tcustomer = \"_Test Customer\"\n\t\tdebtors_acc = \"Debtors - _TC\"\n\t\tadvance_account = create_account(\n\t\t\tparent_account=\"Current Liabilities - _TC\",\n\t\t\taccount_name=\"Advances Received\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_type=\"Receivable\",\n\t\t)\n\n\t\tset_advance_flag(company=\"_Test Company\", flag=1, default_account=advance_account)\n\n\t\tpe = create_payment_entry(\n\t\t\tcompany=company,\n\t\t\tpayment_type=\"Receive\",\n\t\t\tparty_type=\"Customer\",\n\t\t\tparty=customer,\n\t\t\tpaid_from=advance_account,\n\t\t\tpaid_to=\"Cash - _TC\",\n\t\t\tpaid_amount=1000,\n\t\t)\n\t\tpe.submit()\n\n\t\tsi = create_sales_invoice(\n\t\t\tcompany=company,\n\t\t\tcustomer=customer,\n\t\t\tdo_not_save=True,\n\t\t\tdo_not_submit=True,\n\t\t\trate=1000,\n\t\t\tprice_list_rate=1000,\n\t\t)\n\t\tsi.base_grand_total = 1000\n\t\tsi.grand_total = 1000\n\t\tsi.set_advances()\n\t\tfor advance in si.advances:\n\t\t\tadvance.allocated_amount = 200 if advance.reference_name == pe.name else 0\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\tself.assertEqual(si.advances[0].allocated_amount, 200)\n\n\t\t# Check GL Entry against partial from advance\n\t\texpected_gle = [\n\t\t\t[advance_account, 0.0, 1000.0, nowdate()],\n\t\t\t[advance_account, 200.0, 0.0, nowdate()],\n\t\t\t[\"Cash - _TC\", 1000.0, 0.0, nowdate()],\n\t\t\t[debtors_acc, 0.0, 200.0, nowdate()],\n\t\t]\n\t\tcheck_gl_entries(self, pe.name, expected_gle, nowdate(), voucher_type=\"Payment Entry\")\n\t\tsi.reload()\n\t\tself.assertEqual(si.outstanding_amount, 800.0)\n\n\t\tpr = frappe.get_doc(\"Payment Reconciliation\")\n\t\tpr.company = company\n\t\tpr.party_type = \"Customer\"\n\t\tpr.party = customer\n\t\tpr.receivable_payable_account = debtors_acc\n\t\tpr.default_advance_account = advance_account\n\t\tpr.get_unreconciled_entries()\n\n\t\t# allocate some more of the same advance\n\t\t# self.assertEqual(len(pr.invoices), 1)\n\t\t# self.assertEqual(len(pr.payments), 1)\n\t\tinvoices = [x.as_dict() for x in pr.invoices if x.get(\"invoice_number\") == si.name]\n\t\tpayments = [x.as_dict() for x in pr.payments if x.get(\"reference_name\") == pe.name]\n\t\tpr.allocate_entries(frappe._dict({\"invoices\": invoices, \"payments\": payments}))\n\t\tpr.allocation[0].allocated_amount = 300\n\t\tpr.reconcile()\n\n\t\tsi.reload()\n\t\tself.assertEqual(si.outstanding_amount, 500.0)\n\n\t\t# Check GL Entry against multi partial allocations from advance\n\t\texpected_gle = [\n\t\t\t[advance_account, 0.0, 1000.0, nowdate()],\n\t\t\t[advance_account, 200.0, 0.0, nowdate()],\n\t\t\t[advance_account, 300.0, 0.0, nowdate()],\n\t\t\t[\"Cash - _TC\", 1000.0, 0.0, nowdate()],\n\t\t\t[debtors_acc, 0.0, 200.0, nowdate()],\n\t\t\t[debtors_acc, 0.0, 300.0, nowdate()],\n\t\t]\n\t\tcheck_gl_entries(self, pe.name, expected_gle, nowdate(), voucher_type=\"Payment Entry\")\n\t\tset_advance_flag(company=\"_Test Company\", flag=0, default_account=\"\")\n\n\tdef test_loyalty_points_redemption_with_shopping_cart(self):\n\t\tfrom erpnext.accounts.doctype.loyalty_program.test_loyalty_program import (\n\t\t\tcreate_records,\n\t\t\tcreate_sales_invoice_record,\n\t\t)\n\t\tfrom erpnext.selling.doctype.sales_order.sales_order import make_sales_invoice\n\t\tfrom erpnext.selling.doctype.sales_order.test_sales_order import make_sales_order\n\n\t\t# Set up loyalty program\n\t\tcreate_records()\n\t\tfrappe.db.set_value(\"Customer\", \"Test Loyalty Customer\", \"loyalty_program\", \"Test Single Loyalty\")\n\t\tcreate_sales_invoice_record(10).insert().submit()\n\n\t\t# Create a sales order\n\t\tso = make_sales_order(qty=10, do_not_save=True, customer=\"Test Loyalty Customer\")\n\t\tso.name = \"_T-Sales Order LP-0001\"\n\t\tso.order_type = \"Shopping Cart\"\n\t\tso.loyalty_points = 50\n\t\tso.loyalty_amount = 50\n\t\tso.insert()\n\t\tso.submit()\n\n\t\t# Create sales invoice from the sales order\n\t\tsi = make_sales_invoice(so.name)\n\t\tfrom frappe.model.trace import traced_field_context\n\n\t\twith traced_field_context(si.__class__, \"loyalty_program\", forbidden_values=[None]):\n\t\t\tsi.insert()\n\t\tsi.submit()\n\n\t\t# Check if loyalty points are applied correctly\n\t\tself.assertEqual(si.loyalty_program, \"Test Single Loyalty\")\n\t\tself.assertEqual(si.loyalty_points, 50)\n\t\tself.assertEqual(si.loyalty_amount, 50)\n\n\t\t# Check GL entries for loyalty points redemption\n\t\tgl_entries = frappe.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_type\": \"Sales Invoice\", \"voucher_no\": si.name},\n\t\t\tfields=[\"account\", \"debit\", \"credit\"],\n\t\t)\n\n\t\tloyalty_account = frappe.db.get_value(\"Loyalty Program\", \"Test Single Loyalty\", \"expense_account\")\n\t\texpected_gl_entries = [\n\t\t\t{\"account\": si.debit_to, \"debit\": si.grand_total, \"credit\": 0},\n\t\t\t{\"account\": si.items[0].income_account, \"debit\": 0, \"credit\": si.net_total},\n\t\t\t{\"account\": loyalty_account, \"debit\": 50, \"credit\": 0},\n\t\t]\n\n\t\tfor entry in expected_gl_entries:\n\t\t\tself.assertTrue(\n\t\t\t\tany(\n\t\t\t\t\tgl_entry.account == entry[\"account\"]\n\t\t\t\t\tand gl_entry.debit == entry[\"debit\"]\n\t\t\t\t\tand gl_entry.credit == entry[\"credit\"]\n\t\t\t\t\tfor gl_entry in gl_entries\n\t\t\t\t)\n\t\t\t)\n\n\tdef test_pulling_advance_based_on_debit_to(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.test_payment_entry import create_payment_entry\n\n\t\tdebtors2 = create_account(\n\t\t\tparent_account=\"Accounts Receivable - _TC\",\n\t\t\taccount_name=\"Debtors 2\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_type=\"Receivable\",\n\t\t)\n\t\tsi = create_sales_invoice(do_not_submit=True)\n\t\tsi.debit_to = debtors2\n\t\tsi.save()\n\n\t\tpe = create_payment_entry(\n\t\t\tcompany=si.company,\n\t\t\tpayment_type=\"Receive\",\n\t\t\tparty_type=\"Customer\",\n\t\t\tparty=si.customer,\n\t\t\tpaid_from=debtors2,\n\t\t\tpaid_to=\"Cash - _TC\",\n\t\t\tpaid_amount=1000,\n\t\t)\n\t\tpe.submit()\n\t\tadvances = si.get_advance_entries()\n\t\tself.assertEqual(1, len(advances))\n\t\tself.assertEqual(advances[0].reference_name, pe.name)\n\n\tdef test_taxes_merging_from_delivery_note(self):\n\t\tfrom erpnext.stock.doctype.delivery_note.test_delivery_note import create_delivery_note\n\n\t\tdn1 = create_delivery_note(do_not_submit=1)\n\t\tdn1.items[0].qty = 10\n\t\tdn1.items[0].rate = 100\n\t\tdn1.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Freight and Forwarding Charges - _TC\",\n\t\t\t\t\"description\": \"movement charges\",\n\t\t\t\t\"tax_amount\": 100,\n\t\t\t},\n\t\t)\n\t\tdn1.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Marketing Expenses - _TC\",\n\t\t\t\t\"description\": \"marketing\",\n\t\t\t\t\"tax_amount\": 150,\n\t\t\t},\n\t\t)\n\t\tdn1.save().submit()\n\n\t\tdn2 = create_delivery_note(do_not_submit=1)\n\t\tdn2.items[0].qty = 5\n\t\tdn2.items[0].rate = 100\n\t\tdn2.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Freight and Forwarding Charges - _TC\",\n\t\t\t\t\"description\": \"movement charges\",\n\t\t\t\t\"tax_amount\": 20,\n\t\t\t},\n\t\t)\n\t\tdn2.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Miscellaneous Expenses - _TC\",\n\t\t\t\t\"description\": \"marketing\",\n\t\t\t\t\"tax_amount\": 60,\n\t\t\t},\n\t\t)\n\t\tdn2.save().submit()\n\n\t\t# si = make_sales_invoice(dn1.name)\n\t\tsi = create_sales_invoice(do_not_submit=True)\n\t\tsi.customer = dn1.customer\n\t\tsi.items.clear()\n\n\t\tfrom frappe.model.mapper import map_docs\n\n\t\tmap_docs(\n\t\t\tmethod=\"erpnext.stock.doctype.delivery_note.delivery_note.make_sales_invoice\",\n\t\t\tsource_names=json.dumps([dn1.name, dn2.name]),\n\t\t\ttarget_doc=si,\n\t\t\targs=json.dumps({\"customer\": dn1.customer, \"merge_taxes\": 1, \"filtered_children\": []}),\n\t\t)\n\t\tsi.save()\n\n\t\texpected = [\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Freight and Forwarding Charges - _TC\",\n\t\t\t\t\"tax_amount\": 120.0,\n\t\t\t\t\"total\": 1620.0,\n\t\t\t\t\"base_total\": 1620.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Marketing Expenses - _TC\",\n\t\t\t\t\"tax_amount\": 150.0,\n\t\t\t\t\"total\": 1770.0,\n\t\t\t\t\"base_total\": 1770.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"charge_type\": \"Actual\",\n\t\t\t\t\"account_head\": \"Miscellaneous Expenses - _TC\",\n\t\t\t\t\"tax_amount\": 60.0,\n\t\t\t\t\"total\": 1830.0,\n\t\t\t\t\"base_total\": 1830.0,\n\t\t\t},\n\t\t]\n\t\tactual = [\n\t\t\tdict(\n\t\t\t\tcharge_type=x.charge_type,\n\t\t\t\taccount_head=x.account_head,\n\t\t\t\ttax_amount=x.tax_amount,\n\t\t\t\ttotal=x.total,\n\t\t\t\tbase_total=x.base_total,\n\t\t\t)\n\t\t\tfor x in si.taxes\n\t\t]\n\t\tself.assertEqual(expected, actual)\n\n\tdef test_pos_returns_without_update_outstanding_for_self(self):\n\t\tfrom erpnext.accounts.doctype.sales_invoice.sales_invoice import make_sales_return\n\n\t\tpos_profile = make_pos_profile()\n\t\tpos_profile.payments = []\n\t\tpos_profile.append(\"payments\", {\"default\": 1, \"mode_of_payment\": \"Cash\"})\n\t\tpos_profile.save()\n\n\t\tpos = create_sales_invoice(qty=10, do_not_save=True)\n\t\tpos.is_pos = 1\n\t\tpos.pos_profile = pos_profile.name\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Bank Draft\", \"amount\": 500})\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 500})\n\t\tpos.save().submit()\n\n\t\tpos_return = make_sales_return(pos.name)\n\t\tpos_return.update_outstanding_for_self = False\n\t\tpos_return.save().submit()\n\n\t\tgle = qb.DocType(\"GL Entry\")\n\t\tres = (\n\t\t\tqb.from_(gle)\n\t\t\t.select(gle.against_voucher)\n\t\t\t.distinct()\n\t\t\t.where(\n\t\t\t\tgle.is_cancelled.eq(0) & gle.voucher_no.eq(pos_return.name) & gle.against_voucher.notnull()\n\t\t\t)\n\t\t\t.run(as_list=1)\n\t\t)\n\t\tself.assertEqual(len(res), 1)\n\t\tself.assertEqual(res[0][0], pos_return.return_against)\n\n\tdef test_validation_on_opening_invoice_with_rounding(self):\n\t\tsi = create_sales_invoice(qty=1, rate=99.98, do_not_submit=True)\n\t\tsi.is_opening = \"Yes\"\n\t\tsi.items[0].income_account = \"Temporary Opening - _TC\"\n\t\tsi.save()\n\t\tself.assertRaises(frappe.ValidationError, si.submit)\n\n\tdef _create_opening_roundoff_account(self, company_name):\n\t\tliability_root = frappe.db.get_all(\n\t\t\t\"Account\",\n\t\t\tfilters={\"company\": company_name, \"root_type\": \"Liability\", \"disabled\": 0},\n\t\t\torder_by=\"lft\",\n\t\t\tlimit=1,\n\t\t)[0]\n\n\t\t# setup round off account\n\t\tif acc := frappe.db.exists(\n\t\t\t\"Account\",\n\t\t\t{\n\t\t\t\t\"account_name\": \"Round Off for Opening\",\n\t\t\t\t\"account_type\": \"Round Off for Opening\",\n\t\t\t\t\"company\": company_name,\n\t\t\t},\n\t\t):\n\t\t\tfrappe.db.set_value(\"Company\", company_name, \"round_off_for_opening\", acc)\n\t\telse:\n\t\t\tacc = frappe.new_doc(\"Account\")\n\t\t\tacc.company = company_name\n\t\t\tacc.parent_account = liability_root.name\n\t\t\tacc.account_name = \"Round Off for Opening\"\n\t\t\tacc.account_type = \"Round Off for Opening\"\n\t\t\tacc.save()\n\t\t\tfrappe.db.set_value(\"Company\", company_name, \"round_off_for_opening\", acc.name)\n\n\tdef test_opening_invoice_with_rounding_adjustment(self):\n\t\tsi = create_sales_invoice(qty=1, rate=99.98, do_not_submit=True)\n\t\tsi.is_opening = \"Yes\"\n\t\tsi.items[0].income_account = \"Temporary Opening - _TC\"\n\t\tsi.save()\n\n\t\tself._create_opening_roundoff_account(si.company)\n\n\t\tsi.reload()\n\t\tsi.submit()\n\t\tres = frappe.db.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_no\": si.name, \"is_opening\": \"Yes\"},\n\t\t\tfields=[\"account\", \"debit\", \"credit\", \"is_opening\"],\n\t\t)\n\t\tself.assertEqual(len(res), 3)\n\n\tdef _create_opening_invoice_with_inclusive_tax(self):\n\t\tsi = create_sales_invoice(qty=1, rate=90, do_not_submit=True)\n\t\tsi.is_opening = \"Yes\"\n\t\tsi.items[0].income_account = \"Temporary Opening - _TC\"\n\t\titem_template = si.items[0].as_dict()\n\t\titem_template.name = None\n\t\titem_template.rate = 55\n\t\tsi.append(\"items\", item_template)\n\t\tsi.append(\n\t\t\t\"taxes\",\n\t\t\t{\n\t\t\t\t\"charge_type\": \"On Net Total\",\n\t\t\t\t\"account_head\": \"_Test Account Service Tax - _TC\",\n\t\t\t\t\"cost_center\": \"_Test Cost Center - _TC\",\n\t\t\t\t\"description\": \"Testing...\",\n\t\t\t\t\"rate\": 5,\n\t\t\t\t\"included_in_print_rate\": True,\n\t\t\t},\n\t\t)\n\t\t# there will be 0.01 precision loss between Dr and Cr\n\t\t# caused by 'included_in_print_tax' option\n\t\tsi.save()\n\t\treturn si\n\n\tdef test_rounding_validation_for_opening_with_inclusive_tax(self):\n\t\tsi = self._create_opening_invoice_with_inclusive_tax()\n\t\t# 'Round Off for Opening' not set in Company master\n\t\t# Ledger level validation must be thrown\n\t\tself.assertRaises(frappe.ValidationError, si.submit)\n\n\tdef test_ledger_entries_on_opening_invoice_with_rounding_loss_by_inclusive_tax(self):\n\t\tsi = self._create_opening_invoice_with_inclusive_tax()\n\t\t# 'Round Off for Opening' is set in Company master\n\t\tself._create_opening_roundoff_account(si.company)\n\n\t\tsi.submit()\n\t\tactual = frappe.db.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_no\": si.name, \"is_opening\": \"Yes\", \"is_cancelled\": False},\n\t\t\tfields=[\"account\", \"debit\", \"credit\", \"is_opening\"],\n\t\t\torder_by=\"account,debit\",\n\t\t)\n\t\texpected = [\n\t\t\t{\"account\": \"_Test Account Service Tax - _TC\", \"debit\": 0.0, \"credit\": 6.9, \"is_opening\": \"Yes\"},\n\t\t\t{\"account\": \"Debtors - _TC\", \"debit\": 145.0, \"credit\": 0.0, \"is_opening\": \"Yes\"},\n\t\t\t{\"account\": \"Round Off for Opening - _TC\", \"debit\": 0.0, \"credit\": 0.01, \"is_opening\": \"Yes\"},\n\t\t\t{\"account\": \"Temporary Opening - _TC\", \"debit\": 0.0, \"credit\": 138.09, \"is_opening\": \"Yes\"},\n\t\t]\n\t\tself.assertEqual(len(actual), 4)\n\t\tself.assertEqual(expected, actual)\n\n\t@IntegrationTestCase.change_settings(\"Accounts Settings\", {\"enable_common_party_accounting\": True})\n\tdef test_common_party_with_foreign_currency_jv(self):\n\t\tfrom erpnext.accounts.doctype.account.test_account import create_account\n\t\tfrom erpnext.accounts.doctype.opening_invoice_creation_tool.test_opening_invoice_creation_tool import (\n\t\t\tmake_customer,\n\t\t)\n\t\tfrom erpnext.accounts.doctype.party_link.party_link import create_party_link\n\t\tfrom erpnext.buying.doctype.supplier.test_supplier import create_supplier\n\t\tfrom erpnext.setup.utils import get_exchange_rate\n\n\t\tcreditors = create_account(\n\t\t\taccount_name=\"Creditors USD\",\n\t\t\tparent_account=\"Accounts Payable - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_currency=\"USD\",\n\t\t\taccount_type=\"Payable\",\n\t\t)\n\t\tdebtors = create_account(\n\t\t\taccount_name=\"Debtors USD\",\n\t\t\tparent_account=\"Accounts Receivable - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_currency=\"USD\",\n\t\t\taccount_type=\"Receivable\",\n\t\t)\n\n\t\t# create a customer\n\t\tcustomer = make_customer(customer=\"_Test Common Party USD\")\n\t\tcust_doc = frappe.get_doc(\"Customer\", customer)\n\t\tcust_doc.default_currency = \"USD\"\n\t\ttest_account_details = {\n\t\t\t\"company\": \"_Test Company\",\n\t\t\t\"account\": debtors,\n\t\t}\n\t\tcust_doc.append(\"accounts\", test_account_details)\n\t\tcust_doc.save()\n\n\t\t# create a supplier\n\t\tsupplier = create_supplier(supplier_name=\"_Test Common Party USD\").name\n\t\tsupp_doc = frappe.get_doc(\"Supplier\", supplier)\n\t\tsupp_doc.default_currency = \"USD\"\n\t\ttest_account_details = {\n\t\t\t\"company\": \"_Test Company\",\n\t\t\t\"account\": creditors,\n\t\t}\n\t\tsupp_doc.append(\"accounts\", test_account_details)\n\t\tsupp_doc.save()\n\n\t\t# create a party link between customer & supplier\n\t\tcreate_party_link(\"Supplier\", supplier, customer)\n\n\t\t# create a sales invoice\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=customer,\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=get_exchange_rate(\"USD\", \"INR\"),\n\t\t\tdebit_to=debtors,\n\t\t\tdo_not_save=1,\n\t\t)\n\t\tsi.party_account_currency = \"USD\"\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\t# check outstanding of sales invoice\n\t\tsi.reload()\n\t\tself.assertEqual(si.status, \"Paid\")\n\t\tself.assertEqual(flt(si.outstanding_amount), 0.0)\n\n\t\t# check creation of journal entry\n\t\tjv = frappe.get_all(\n\t\t\t\"Journal Entry Account\",\n\t\t\t{\n\t\t\t\t\"account\": si.debit_to,\n\t\t\t\t\"party_type\": \"Customer\",\n\t\t\t\t\"party\": si.customer,\n\t\t\t\t\"reference_type\": si.doctype,\n\t\t\t\t\"reference_name\": si.name,\n\t\t\t},\n\t\t\tpluck=\"credit_in_account_currency\",\n\t\t)\n\t\tself.assertTrue(jv)\n\t\tself.assertEqual(jv[0], si.grand_total)\n\n\t@IntegrationTestCase.change_settings(\"Accounts Settings\", {\"enable_common_party_accounting\": True})\n\tdef test_common_party_with_different_currency_in_debtor_and_creditor(self):\n\t\tfrom erpnext.accounts.doctype.account.test_account import create_account\n\t\tfrom erpnext.accounts.doctype.opening_invoice_creation_tool.test_opening_invoice_creation_tool import (\n\t\t\tmake_customer,\n\t\t)\n\t\tfrom erpnext.accounts.doctype.party_link.party_link import create_party_link\n\t\tfrom erpnext.buying.doctype.supplier.test_supplier import create_supplier\n\t\tfrom erpnext.setup.utils import get_exchange_rate\n\n\t\tcreditors = create_account(\n\t\t\taccount_name=\"Creditors INR\",\n\t\t\tparent_account=\"Accounts Payable - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_currency=\"INR\",\n\t\t\taccount_type=\"Payable\",\n\t\t)\n\t\tdebtors = create_account(\n\t\t\taccount_name=\"Debtors USD\",\n\t\t\tparent_account=\"Accounts Receivable - _TC\",\n\t\t\tcompany=\"_Test Company\",\n\t\t\taccount_currency=\"USD\",\n\t\t\taccount_type=\"Receivable\",\n\t\t)\n\n\t\t# create a customer\n\t\tcustomer = make_customer(customer=\"_Test Common Party USD\")\n\t\tcust_doc = frappe.get_doc(\"Customer\", customer)\n\t\tcust_doc.default_currency = \"USD\"\n\t\ttest_account_details = {\n\t\t\t\"company\": \"_Test Company\",\n\t\t\t\"account\": debtors,\n\t\t}\n\t\tcust_doc.append(\"accounts\", test_account_details)\n\t\tcust_doc.save()\n\n\t\t# create a supplier\n\t\tsupplier = create_supplier(supplier_name=\"_Test Common Party INR\").name\n\t\tsupp_doc = frappe.get_doc(\"Supplier\", supplier)\n\t\tsupp_doc.default_currency = \"INR\"\n\t\ttest_account_details = {\n\t\t\t\"company\": \"_Test Company\",\n\t\t\t\"account\": creditors,\n\t\t}\n\t\tsupp_doc.append(\"accounts\", test_account_details)\n\t\tsupp_doc.save()\n\n\t\t# create a party link between customer & supplier\n\t\tcreate_party_link(\"Supplier\", supplier, customer)\n\n\t\t# create a sales invoice\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=customer,\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=get_exchange_rate(\"USD\", \"INR\"),\n\t\t\tdebit_to=debtors,\n\t\t\tdo_not_save=1,\n\t\t)\n\t\tsi.party_account_currency = \"USD\"\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\t# check outstanding of sales invoice\n\t\tsi.reload()\n\t\tself.assertEqual(si.status, \"Paid\")\n\t\tself.assertEqual(flt(si.outstanding_amount), 0.0)\n\n\t\t# check creation of journal entry\n\t\tjv = frappe.get_all(\n\t\t\t\"Journal Entry Account\",\n\t\t\t{\n\t\t\t\t\"account\": si.debit_to,\n\t\t\t\t\"party_type\": \"Customer\",\n\t\t\t\t\"party\": si.customer,\n\t\t\t\t\"reference_type\": si.doctype,\n\t\t\t\t\"reference_name\": si.name,\n\t\t\t},\n\t\t\tpluck=\"credit_in_account_currency\",\n\t\t)\n\t\tself.assertTrue(jv)\n\t\tself.assertEqual(jv[0], si.grand_total)\n\n\tdef test_invoice_remarks(self):\n\t\tsi = frappe.copy_doc(self.globalTestRecords[\"Sales Invoice\"][0])\n\t\tsi.po_no = \"Test PO\"\n\t\tsi.po_date = nowdate()\n\t\tsi.save()\n\t\tsi.submit()\n\t\tself.assertEqual(si.remarks, f\"Against Customer Order Test PO dated {format_date(nowdate())}\")\n\n\tdef test_gl_voucher_subtype(self):\n\t\tsi = create_sales_invoice()\n\t\tgl_entries = frappe.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_type\": \"Sales Invoice\", \"voucher_no\": si.name},\n\t\t\tpluck=\"voucher_subtype\",\n\t\t)\n\n\t\tself.assertTrue(all([x == \"Sales Invoice\" for x in gl_entries]))\n\n\t\tsi = create_sales_invoice(is_return=1, qty=-1)\n\t\tgl_entries = frappe.get_all(\n\t\t\t\"GL Entry\",\n\t\t\tfilters={\"voucher_type\": \"Sales Invoice\", \"voucher_no\": si.name},\n\t\t\tpluck=\"voucher_subtype\",\n\t\t)\n\n\t\tself.assertTrue(all([x == \"Credit Note\" for x in gl_entries]))\n\n\tdef test_total_billed_amount(self):\n\t\tsi = create_sales_invoice(do_not_submit=True)\n\n\t\tproject = frappe.new_doc(\"Project\")\n\t\tproject.company = \"_Test Company\"\n\t\tproject.project_name = \"Test Total Billed Amount\"\n\t\tproject.save()\n\n\t\tsi.project = project.name\n\t\tsi.save()\n\t\tsi.submit()\n\n\t\tdoc = frappe.get_doc(\"Project\", project.name)\n\t\tself.assertEqual(doc.total_billed_amount, si.grand_total)\n\n\tdef test_total_billed_amount_with_different_projects(self):\n\t\t# This test case is for checking the scenario where project is set at document level and for **some** child items only, not all\n\t\tfrom copy import copy\n\n\t\tsi = create_sales_invoice(do_not_submit=True)\n\n\t\tproject = frappe.new_doc(\"Project\")\n\t\tproject.company = \"_Test Company\"\n\t\tproject.project_name = \"Test Total Billed Amount\"\n\t\tproject.save()\n\n\t\tsi.project = project.name\n\t\tsi.items.append(copy(si.items[0]))\n\t\tsi.items.append(copy(si.items[0]))\n\t\tsi.items[0].project = project.name\n\t\tsi.items[1].project = project.name\n\t\t# Not setting project on last item\n\t\tsi.items[1].insert()\n\t\tsi.items[2].insert()\n\t\tsi.submit()\n\n\t\tproject.reload()\n\t\tself.assertIsNone(si.items[2].project)\n\t\tself.assertEqual(project.total_billed_amount, 300)\n\n\tdef test_pos_returns_with_party_account_currency(self):\n\t\tfrom erpnext.accounts.doctype.sales_invoice.sales_invoice import make_sales_return\n\n\t\tpos_profile = make_pos_profile()\n\t\tpos_profile.payments = []\n\t\tpos_profile.append(\"payments\", {\"default\": 1, \"mode_of_payment\": \"Cash\"})\n\t\tpos_profile.save()\n\n\t\tpos = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=86.595000000,\n\t\t\tqty=2,\n\t\t\tdo_not_save=True,\n\t\t)\n\t\tpos.is_pos = 1\n\t\tpos.pos_profile = pos_profile.name\n\t\tpos.debit_to = \"_Test Receivable USD - _TC\"\n\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 20.35})\n\t\tpos.save().submit()\n\n\t\tpos_return = make_sales_return(pos.name)\n\t\tself.assertEqual(abs(pos_return.payments[0].amount), pos.payments[0].amount)\n\n\tdef test_create_return_invoice_for_self_update(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.payment_entry import get_payment_entry\n\t\tfrom erpnext.accounts.doctype.sales_invoice.test_sales_invoice import create_sales_invoice\n\t\tfrom erpnext.controllers.sales_and_purchase_return import make_return_doc\n\n\t\tinvoice = create_sales_invoice()\n\n\t\tpayment_entry = get_payment_entry(dt=invoice.doctype, dn=invoice.name)\n\t\tpayment_entry.reference_no = \"test001\"\n\t\tpayment_entry.reference_date = getdate()\n\n\t\tpayment_entry.save()\n\t\tpayment_entry.submit()\n\n\t\tr_invoice = make_return_doc(invoice.doctype, invoice.name)\n\n\t\tr_invoice.update_outstanding_for_self = 0\n\t\tr_invoice.save()\n\n\t\tself.assertEqual(r_invoice.update_outstanding_for_self, 1)\n\n\t\tr_invoice.submit()\n\n\t\tself.assertNotEqual(r_invoice.outstanding_amount, 0)\n\n\t\tinvoice.reload()\n\n\t\tself.assertEqual(invoice.outstanding_amount, 0)\n\n\tdef test_prevents_fully_returned_invoice_with_zero_quantity(self):\n\t\tfrom erpnext.controllers.sales_and_purchase_return import StockOverReturnError, make_return_doc\n\n\t\tinvoice = create_sales_invoice(qty=10)\n\n\t\treturn_doc = make_return_doc(invoice.doctype, invoice.name)\n\t\treturn_doc.items[0].qty = -10\n\t\treturn_doc.save().submit()\n\n\t\treturn_doc = make_return_doc(invoice.doctype, invoice.name)\n\t\treturn_doc.items[0].qty = 0\n\n\t\tself.assertRaises(StockOverReturnError, return_doc.save)\n\n\tdef test_pos_sales_invoice_creation_during_pos_invoice_mode(self):\n\t\t# Deleting all opening entry\n\t\tfrappe.db.sql(\"delete from `tabPOS Opening Entry`\")\n\n\t\twith self.change_settings(\"POS Settings\", {\"invoice_type\": \"POS Invoice\"}):\n\t\t\tpos_profile = make_pos_profile()\n\n\t\t\tpos_profile.payments = []\n\t\t\tpos_profile.append(\"payments\", {\"default\": 1, \"mode_of_payment\": \"Cash\"})\n\n\t\t\tpos_profile.save()\n\n\t\t\tpos = create_sales_invoice(qty=10, do_not_save=True)\n\n\t\t\tpos.is_pos = 1\n\t\t\tpos.pos_profile = pos_profile.name\n\t\t\tpos.is_created_using_pos = 1\n\n\t\t\tpos.append(\"payments\", {\"mode_of_payment\": \"Cash\", \"amount\": 1000})\n\t\t\tself.assertRaises(frappe.ValidationError, pos.insert)\n\n\tdef test_stand_alone_credit_note_valuation(self):\n\t\tfrom erpnext.stock.doctype.item.test_item import make_item\n\n\t\titem_code = \"_Test Item for Credit Note Valuation\"\n\t\tmake_item_for_si(\n\t\t\titem_code,\n\t\t\t{\n\t\t\t\t\"is_stock_item\": 1,\n\t\t\t\t\"has_batch_no\": 1,\n\t\t\t\t\"create_new_batch\": 1,\n\t\t\t\t\"batch_number_series\": \"BATCH-TCNV.####\",\n\t\t\t},\n\t\t)\n\n\t\tsi = create_sales_invoice(\n\t\t\titem=item_code,\n\t\t\tqty=-2,\n\t\t\trate=1200,\n\t\t\tis_return=1,\n\t\t\tupdate_stock=1,\n\t\t)\n\n\t\tstock_ledger_entry = frappe.db.get_value(\n\t\t\t\"Stock Ledger Entry\",\n\t\t\t{\n\t\t\t\t\"voucher_type\": \"Sales Invoice\",\n\t\t\t\t\"voucher_no\": si.name,\n\t\t\t\t\"item_code\": item_code,\n\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t},\n\t\t\t[\"incoming_rate\", \"valuation_rate\", \"actual_qty as qty\", \"stock_value_difference\"],\n\t\t\tas_dict=True,\n\t\t)\n\n\t\tself.assertEqual(stock_ledger_entry.incoming_rate, 1200.0)\n\t\tself.assertEqual(stock_ledger_entry.valuation_rate, 1200.0)\n\t\tself.assertEqual(stock_ledger_entry.qty, 2.0)\n\t\tself.assertEqual(stock_ledger_entry.stock_value_difference, 2400.0)\n\n\tdef test_stand_alone_credit_note_zero_valuation(self):\n\t\tfrom erpnext.stock.doctype.item.test_item import make_item\n\n\t\titem_code = \"_Test Item for Credit Note Zero Valuation\"\n\t\tmake_item_for_si(\n\t\t\titem_code,\n\t\t\t{\n\t\t\t\t\"is_stock_item\": 1,\n\t\t\t\t\"has_batch_no\": 1,\n\t\t\t\t\"create_new_batch\": 1,\n\t\t\t\t\"batch_number_series\": \"BATCH-TCNZV.####\",\n\t\t\t},\n\t\t)\n\n\t\tsi = create_sales_invoice(\n\t\t\titem=item_code,\n\t\t\tqty=-2,\n\t\t\trate=1200,\n\t\t\tis_return=1,\n\t\t\tupdate_stock=1,\n\t\t\tallow_zero_valuation_rate=1,\n\t\t)\n\n\t\tstock_ledger_entry = frappe.db.get_value(\n\t\t\t\"Stock Ledger Entry\",\n\t\t\t{\n\t\t\t\t\"voucher_type\": \"Sales Invoice\",\n\t\t\t\t\"voucher_no\": si.name,\n\t\t\t\t\"item_code\": item_code,\n\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t},\n\t\t\t[\"incoming_rate\", \"valuation_rate\", \"actual_qty as qty\", \"stock_value_difference\"],\n\t\t\tas_dict=True,\n\t\t)\n\n\t\tself.assertEqual(stock_ledger_entry.incoming_rate, 0.0)\n\t\tself.assertEqual(stock_ledger_entry.valuation_rate, 0.0)\n\t\tself.assertEqual(stock_ledger_entry.qty, 2.0)\n\t\tself.assertEqual(stock_ledger_entry.stock_value_difference, 0.0)\n\n\tdef test_system_generated_exchange_gain_or_loss_je_after_repost(self):\n\t\tfrom erpnext.accounts.doctype.payment_entry.payment_entry import get_payment_entry\n\t\tfrom erpnext.accounts.doctype.repost_accounting_ledger.test_repost_accounting_ledger import (\n\t\t\tupdate_repost_settings,\n\t\t)\n\n\t\tupdate_repost_settings()\n\n\t\tsi = create_sales_invoice(\n\t\t\tcustomer=\"_Test Customer USD\",\n\t\t\tdebit_to=\"_Test Receivable USD - _TC\",\n\t\t\tcurrency=\"USD\",\n\t\t\tconversion_rate=80,\n\t\t)\n\n\t\tpe = get_payment_entry(\"Sales Invoice\", si.name)\n\t\tpe.reference_no = \"10\"\n\t\tpe.reference_date = nowdate()\n\t\tpe.paid_from_account_currency = si.currency\n\t\tpe.paid_to_account_currency = \"INR\"\n\t\tpe.source_exchange_rate = 85\n\t\tpe.target_exchange_rate = 1\n\t\tpe.paid_amount = si.outstanding_amount\n\t\tpe.insert()\n\t\tpe.submit()\n\n\t\tral = frappe.new_doc(\"Repost Accounting Ledger\")\n\t\tral.company = si.company\n\t\tral.append(\"vouchers\", {\"voucher_type\": si.doctype, \"voucher_no\": si.name})\n\t\tral.save()\n\t\tral.submit()\n\n\t\tje = frappe.qb.DocType(\"Journal Entry\")\n\t\tjea = frappe.qb.DocType(\"Journal Entry Account\")\n\t\tq = (\n\t\t\t(\n\t\t\t\tfrappe.qb.from_(je)\n\t\t\t\t.join(jea)\n\t\t\t\t.on(je.name == jea.parent)\n\t\t\t\t.select(je.docstatus)\n\t\t\t\t.where(\n\t\t\t\t\t(je.voucher_type == \"Exchange Gain Or Loss\")\n\t\t\t\t\t& (jea.reference_name == si.name)\n\t\t\t\t\t& (jea.reference_type == \"Sales Invoice\")\n\t\t\t\t\t& (je.is_system_generated == 1)\n\t\t\t\t)\n\t\t\t)\n\t\t\t.limit(1)\n\t\t\t.run()\n\t\t)\n\n\t\tself.assertEqual(q[0][0], 1)\n\n\tdef test_non_batchwise_valuation_for_moving_average(self):\n\t\tfrom erpnext.stock.doctype.item.test_item import make_item\n\n\t\titem_code = \"_Test Item for Non Batchwise Valuation\"\n\t\tmake_item_for_si(\n\t\t\titem_code,\n\t\t\t{\n\t\t\t\t\"is_stock_item\": 1,\n\t\t\t\t\"has_batch_no\": 1,\n\t\t\t\t\"create_new_batch\": 1,\n\t\t\t\t\"batch_number_series\": \"TBATCH-TCNV.####\",\n\t\t\t\t\"valuation_method\": \"Moving Average\",\n\t\t\t},\n\t\t)\n\n\t\tdoc = frappe.get_doc(\"Stock Settings\")\n\t\toriginal_value = cint(doc.do_not_use_batchwise_valuation)\n\n\t\tdoc.db_set(\"do_not_use_batchwise_valuation\", 1)\n\n\t\tse = make_stock_entry(\n\t\t\titem_code=item_code,\n\t\t\tqty=10,\n\t\t\ttarget=\"_Test Warehouse - _TC\",\n\t\t\trate=13.02,\n\t\t\tvaluation_method=\"Moving Average\",\n\t\t\tuse_serial_batch_fields=True,\n\t\t)\n\n\t\tse_batch = get_batch_from_bundle(se.items[0].serial_and_batch_bundle)\n\n\t\t# without use serial and batch fields\n\t\tsi = create_sales_invoice(\n\t\t\titem=item_code,\n\t\t\tqty=1,\n\t\t\trate=120,\n\t\t\tupdate_stock=1,\n\t\t\tuse_serial_batch_fields=False,\n\t\t\twarehouse=\"_Test Warehouse - _TC\",\n\t\t)\n\n\t\tsi.reload()\n\t\tsi_batch = get_batch_from_bundle(si.items[0].serial_and_batch_bundle)\n\n\t\tself.assertEqual(se_batch, si_batch)\n\t\tself.assertEqual(si.items[0].use_serial_batch_fields, 0)\n\n\t\tserial_and_batch_bundle = si.items[0].serial_and_batch_bundle\n\t\tchange_in_value = frappe.db.get_value(\n\t\t\t\"Stock Ledger Entry\",\n\t\t\t{\n\t\t\t\t\"voucher_type\": \"Sales Invoice\",\n\t\t\t\t\"voucher_no\": si.name,\n\t\t\t\t\"item_code\": item_code,\n\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t\t\"serial_and_batch_bundle\": serial_and_batch_bundle,\n\t\t\t},\n\t\t\t\"stock_value_difference\",\n\t\t)\n\n\t\tself.assertEqual(change_in_value, 13.02 * -1)\n\n\t\t# with use serial and batch fields\n\t\tsi = create_sales_invoice(\n\t\t\titem=item_code,\n\t\t\tqty=1,\n\t\t\trate=120,\n\t\t\tupdate_stock=1,\n\t\t\tuse_serial_batch_fields=True,\n\t\t\twarehouse=\"_Test Warehouse - _TC\",\n\t\t)\n\n\t\tsi.reload()\n\n\t\tself.assertEqual(si.items[0].use_serial_batch_fields, 1)\n\n\t\tserial_and_batch_bundle = si.items[0].serial_and_batch_bundle\n\t\tchange_in_value = frappe.db.get_value(\n\t\t\t\"Stock Ledger Entry\",\n\t\t\t{\n\t\t\t\t\"voucher_type\": \"Sales Invoice\",\n\t\t\t\t\"voucher_no\": si.name,\n\t\t\t\t\"item_code\": item_code,\n\t\t\t\t\"warehouse\": \"_Test Warehouse - _TC\",\n\t\t\t\t\"serial_and_batch_bundle\": serial_and_batch_bundle,\n\t\t\t},\n\t\t\t\"stock_value_difference\",\n\t\t)\n\n\t\tself.assertEqual(change_in_value, 13.02 * -1)\n\n\t\tdoc.db_set(\"do_not_use_batchwise_valuation\", original_value)"
    }
  },
  "variables": {
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::mode_of_payment": {
      "name": "mode_of_payment",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::si": {
      "name": "si",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::pi": {
      "name": "pi",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::w": {
      "name": "w",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::w2": {
      "name": "w2",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::expected_values": {
      "name": "expected_values",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::pe": {
      "name": "pe",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::si1": {
      "name": "si1",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::si2": {
      "name": "si2",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::si3": {
      "name": "si3",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::gl_entries": {
      "name": "gl_entries",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::gle": {
      "name": "gle",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::item_row": {
      "name": "item_row",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::item_row_copy": {
      "name": "item_row_copy",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::add_items": {
      "name": "add_items",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::item": {
      "name": "item",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::jv": {
      "name": "jv",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::link_data": {
      "name": "link_data",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::link_doctypes": {
      "name": "link_doctypes",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::cost_centers": {
      "name": "cost_centers",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::cca": {
      "name": "cca",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::pos": {
      "name": "pos",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::taxes": {
      "name": "taxes",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::pos_profile": {
      "name": "pos_profile",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::pos_return": {
      "name": "pos_return",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::expected": {
      "name": "expected",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::res": {
      "name": "res",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::sle": {
      "name": "sle",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::stock_in_hand": {
      "name": "stock_in_hand",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::expected_gl_entries": {
      "name": "expected_gl_entries",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::bundle_item": {
      "name": "bundle_item",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::bin_details": {
      "name": "bin_details",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::packed_item": {
      "name": "packed_item",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::pr": {
      "name": "pr",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::dn": {
      "name": "dn",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::se": {
      "name": "se",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::serial_nos": {
      "name": "serial_nos",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::actual_qty_0": {
      "name": "actual_qty_0",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::actual_qty_1": {
      "name": "actual_qty_1",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::outgoing_rate": {
      "name": "outgoing_rate",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::actual_qty_2": {
      "name": "actual_qty_2",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::stock_in_hand_account": {
      "name": "stock_in_hand_account",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::gle_warehouse_amount": {
      "name": "gle_warehouse_amount",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::party_credited": {
      "name": "party_credited",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::cr_note": {
      "name": "cr_note",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::debtors2": {
      "name": "debtors2",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::asset": {
      "name": "asset",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::return_si": {
      "name": "return_si",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::disposal_account": {
      "name": "disposal_account",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::loss_for_si": {
      "name": "loss_for_si",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::loss_for_return_si": {
      "name": "loss_for_return_si",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::incoming_rate": {
      "name": "incoming_rate",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::debit_amount": {
      "name": "debit_amount",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::expected_gle": {
      "name": "expected_gle",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::si4": {
      "name": "si4",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::si5": {
      "name": "si5",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::price_list_rate": {
      "name": "price_list_rate",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::sales_order": {
      "name": "sales_order",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::item_price": {
      "name": "item_price",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::itemised_tax_data": {
      "name": "itemised_tax_data",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::expected_itemised_tax": {
      "name": "expected_itemised_tax",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::existing_current_month_sales": {
      "name": "existing_current_month_sales",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::current_month_sales": {
      "name": "current_month_sales",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::round_off_account": {
      "name": "round_off_account",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::expected_account_values": {
      "name": "expected_account_values",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::debit_credit_diff": {
      "name": "debit_credit_diff",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::round_off_gle": {
      "name": "round_off_gle",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::shipping_rule": {
      "name": "shipping_rule",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::outstanding_amount": {
      "name": "outstanding_amount",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::si_doc": {
      "name": "si_doc",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::cost_center": {
      "name": "cost_center",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::project": {
      "name": "project",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::item_project": {
      "name": "item_project",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::sales_invoice": {
      "name": "sales_invoice",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::deferred_account": {
      "name": "deferred_account",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::pda1": {
      "name": "pda1",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::target_doc": {
      "name": "target_doc",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::old_negative_stock": {
      "name": "old_negative_stock",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::old_perpetual_inventory": {
      "name": "old_perpetual_inventory",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::sles": {
      "name": "sles",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::rate": {
      "name": "rate",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::tax_amount": {
      "name": "tax_amount",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::si_gl_entries": {
      "name": "si_gl_entries",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::pi_gl_entries": {
      "name": "pi_gl_entries",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::item_tax_map": {
      "name": "item_tax_map",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::discount_account": {
      "name": "discount_account",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::additional_discount_account": {
      "name": "additional_discount_account",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::customer": {
      "name": "customer",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::supplier": {
      "name": "supplier",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::party_link": {
      "name": "party_link",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::cust_doc": {
      "name": "cust_doc",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::supp_doc": {
      "name": "supp_doc",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::dim": {
      "name": "dim",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::jv_status": {
      "name": "jv_status",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::today": {
      "name": "today",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::si_with_payment_schedule": {
      "name": "si_with_payment_schedule",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::item_copy": {
      "name": "item_copy",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::account_name": {
      "name": "account_name",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::account": {
      "name": "account",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::journals": {
      "name": "journals",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::je_type": {
      "name": "je_type",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::batch_no": {
      "name": "batch_no",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::advance_account": {
      "name": "advance_account",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::customer_dict": {
      "name": "customer_dict",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::company": {
      "name": "company",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::debtors_acc": {
      "name": "debtors_acc",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::invoices": {
      "name": "invoices",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::payments": {
      "name": "payments",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::so": {
      "name": "so",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::loyalty_account": {
      "name": "loyalty_account",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::advances": {
      "name": "advances",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::dn1": {
      "name": "dn1",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::dn2": {
      "name": "dn2",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::actual": {
      "name": "actual",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::liability_root": {
      "name": "liability_root",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::acc": {
      "name": "acc",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::item_template": {
      "name": "item_template",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::creditors": {
      "name": "creditors",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::debtors": {
      "name": "debtors",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::test_account_details": {
      "name": "test_account_details",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::doc": {
      "name": "doc",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::invoice": {
      "name": "invoice",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::payment_entry": {
      "name": "payment_entry",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::r_invoice": {
      "name": "r_invoice",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::return_doc": {
      "name": "return_doc",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::item_code": {
      "name": "item_code",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::stock_ledger_entry": {
      "name": "stock_ledger_entry",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::ral": {
      "name": "ral",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::je": {
      "name": "je",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::jea": {
      "name": "jea",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::q": {
      "name": "q",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::original_value": {
      "name": "original_value",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::se_batch": {
      "name": "se_batch",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::si_batch": {
      "name": "si_batch",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::serial_and_batch_bundle": {
      "name": "serial_and_batch_bundle",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::change_in_value": {
      "name": "change_in_value",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::gl": {
      "name": "gl",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::args": {
      "name": "args",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::bundle_id": {
      "name": "bundle_id",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::batches": {
      "name": "batches",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::qty": {
      "name": "qty",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::EXTRA_TEST_RECORD_DEPENDENCIES": {
      "name": "EXTRA_TEST_RECORD_DEPENDENCIES",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::bal": {
      "name": "bal",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    },
    "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py::supplier_name": {
      "name": "supplier_name",
      "file": "D:\\ananta\\AI_engineer_Intership\\Day2\\samples\\sale_invoice.py"
    }
  }
}